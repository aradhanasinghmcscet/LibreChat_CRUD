"use strict";var dataSchemas=require("@librechat/data-schemas"),types_js=require("@modelcontextprotocol/sdk/types.js"),require$$3=require("crypto"),auth_js=require("@modelcontextprotocol/sdk/client/auth.js"),auth_js$1=require("@modelcontextprotocol/sdk/shared/auth.js"),fs$2=require("fs"),path$2=require("path"),require$$2=require("os"),crypto$2=require("node:crypto"),events=require("events"),index_js=require("@modelcontextprotocol/sdk/client/index.js"),sse_js=require("@modelcontextprotocol/sdk/client/sse.js"),stdio_js=require("@modelcontextprotocol/sdk/client/stdio.js"),websocket_js=require("@modelcontextprotocol/sdk/client/websocket.js"),streamableHttp_js=require("@modelcontextprotocol/sdk/client/streamableHttp.js"),librechatDataProvider=require("librechat-data-provider"),axios$1=require("axios"),fetch$1=require("node-fetch"),agents=require("@librechat/agents"),tiktoken=require("tiktoken"),yaml=require("js-yaml"),keyv=require("keyv"),zod=require("zod"),v3=require("zod/v3"),core=require("zod/v4/core"),undici=require("undici"),require$$1=require("util"),require$$0$1=require("stream"),require$$3$1=require("http"),require$$4$1=require("https"),require$$5=require("url");function _interopNamespaceDefault(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(a){if("default"!==a){var n=Object.getOwnPropertyDescriptor(e,a);Object.defineProperty(t,a,n.get?n:{enumerable:!0,get:function(){return e[a]}})}})),t.default=e,Object.freeze(t)}var fs__namespace=_interopNamespaceDefault(fs$2),path__namespace=_interopNamespaceDefault(path$2),CONSTANTS;function __rest(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(a[n[i]]=e[n[i]])}return a}function __awaiter(e,t,a,n){return new(a||(a=Promise))((function(i,o){function r(e){try{c(n.next(e))}catch(e){o(e)}}function s(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(r,s)}c((n=n.apply(e,t||[])).next())}))}function isSystemUserId(e){return e===CONSTANTS.SYSTEM_USER_ID}"function"==typeof SuppressedError&&SuppressedError,function(e){e.mcp_delimiter="_mcp_",e.SYSTEM_USER_ID="000000000000000000000000"}(CONSTANTS||(CONSTANTS={}));class MCPOAuthHandler{static discoverMetadata(e){var t;return __awaiter(this,void 0,void 0,(function*(){dataSchemas.logger.debug(`[MCPOAuth] discoverMetadata called with serverUrl: ${e}`);let a,n=new URL(e);try{dataSchemas.logger.debug(`[MCPOAuth] Attempting to discover protected resource metadata from ${e}`),a=yield auth_js.discoverOAuthProtectedResourceMetadata(e),(null===(t=null==a?void 0:a.authorization_servers)||void 0===t?void 0:t.length)?(n=new URL(a.authorization_servers[0]),dataSchemas.logger.debug(`[MCPOAuth] Found authorization server from resource metadata: ${n}`)):dataSchemas.logger.debug("[MCPOAuth] No authorization servers found in resource metadata")}catch(e){dataSchemas.logger.debug("[MCPOAuth] Resource metadata discovery failed, continuing with server URL",{error:e})}dataSchemas.logger.debug(`[MCPOAuth] Discovering OAuth metadata from ${n}`);const i=yield auth_js.discoverOAuthMetadata(n);if(!i)throw dataSchemas.logger.error(`[MCPOAuth] Failed to discover OAuth metadata from ${n}`),new Error("Failed to discover OAuth metadata");dataSchemas.logger.debug("[MCPOAuth] OAuth metadata discovered successfully");const o=yield auth_js$1.OAuthMetadataSchema.parseAsync(i);return dataSchemas.logger.debug("[MCPOAuth] OAuth metadata parsed successfully"),{metadata:o,resourceMetadata:a,authServerUrl:n}}))}static registerOAuthClient(e,t,a,n){return __awaiter(this,void 0,void 0,(function*(){dataSchemas.logger.debug(`[MCPOAuth] Starting client registration for ${e}, server metadata:`,{grant_types_supported:t.grant_types_supported,response_types_supported:t.response_types_supported,token_endpoint_auth_methods_supported:t.token_endpoint_auth_methods_supported,scopes_supported:t.scopes_supported});const i={client_name:"LibreChat MCP Client",redirect_uris:[n||this.getDefaultRedirectUri()],grant_types:["authorization_code"],response_types:["code"],token_endpoint_auth_method:"client_secret_basic",scope:void 0},o=["authorization_code"];(t.grant_types_supported||["authorization_code"]).includes("refresh_token")?(o.push("refresh_token"),dataSchemas.logger.debug(`[MCPOAuth] Server ${e} supports \`refresh_token\` grant type, adding to request`)):dataSchemas.logger.debug(`[MCPOAuth] Server ${e} does not support \`refresh_token\` grant type`),i.grant_types=o,i.response_types=t.response_types_supported||["code"],t.token_endpoint_auth_methods_supported&&(t.token_endpoint_auth_methods_supported.includes("client_secret_basic")?i.token_endpoint_auth_method="client_secret_basic":t.token_endpoint_auth_methods_supported.includes("client_secret_post")?i.token_endpoint_auth_method="client_secret_post":t.token_endpoint_auth_methods_supported.includes("none")?i.token_endpoint_auth_method="none":i.token_endpoint_auth_method=t.token_endpoint_auth_methods_supported[0]);const r=(null==a?void 0:a.scopes_supported)||t.scopes_supported;r&&(i.scope=r.join(" ")),dataSchemas.logger.debug(`[MCPOAuth] Registering client for ${e} with metadata:`,i);const s=yield auth_js.registerClient(e,{metadata:t,clientMetadata:i});return dataSchemas.logger.debug(`[MCPOAuth] Client registered successfully for ${e}:`,{client_id:s.client_id,has_client_secret:!!s.client_secret,grant_types:s.grant_types,scope:s.scope}),s}))}static initiateOAuthFlow(e,t,a,n){var i,o,r,s;return __awaiter(this,void 0,void 0,(function*(){dataSchemas.logger.debug(`[MCPOAuth] initiateOAuthFlow called for ${e} with URL: ${t}`);const c=this.generateFlowId(a,e),l=this.generateState();dataSchemas.logger.debug(`[MCPOAuth] Generated flowId: ${c}, state: ${l}`);try{if((null==n?void 0:n.authorization_url)&&(null==n?void 0:n.token_url)&&(null==n?void 0:n.client_id)){dataSchemas.logger.debug(`[MCPOAuth] Using pre-configured OAuth settings for ${e}`);const r={authorization_endpoint:n.authorization_url,token_endpoint:n.token_url,issuer:t,scopes_supported:null===(i=n.scope)||void 0===i?void 0:i.split(" ")},s={client_id:n.client_id,client_secret:n.client_secret,redirect_uris:[n.redirect_uri||this.getDefaultRedirectUri(e)],scope:n.scope};dataSchemas.logger.debug("[MCPOAuth] Starting authorization with pre-configured settings");const{authorizationUrl:p,codeVerifier:d}=yield auth_js.startAuthorization(t,{metadata:r,clientInformation:s,redirectUrl:(null===(o=s.redirect_uris)||void 0===o?void 0:o[0])||this.getDefaultRedirectUri(e),scope:n.scope});p.searchParams.set("state",c),dataSchemas.logger.debug("[MCPOAuth] Added state parameter to authorization URL");const u={serverName:e,userId:a,serverUrl:t,state:l,codeVerifier:d,clientInfo:s,metadata:r};return dataSchemas.logger.debug(`[MCPOAuth] Authorization URL generated: ${p.toString()}`),{authorizationUrl:p.toString(),flowId:c,flowMetadata:u}}dataSchemas.logger.debug(`[MCPOAuth] Starting auto-discovery of OAuth metadata from ${t}`);const{metadata:p,resourceMetadata:d,authServerUrl:u}=yield this.discoverMetadata(t);dataSchemas.logger.debug(`[MCPOAuth] OAuth metadata discovered, auth server URL: ${u}`);const m=(null==n?void 0:n.redirect_uri)||this.getDefaultRedirectUri(e);dataSchemas.logger.debug(`[MCPOAuth] Registering OAuth client with redirect URI: ${m}`);const h=yield this.registerOAuthClient(u.toString(),p,d,m);dataSchemas.logger.debug(`[MCPOAuth] Client registered with ID: ${h.client_id}`);const f=(null==n?void 0:n.scope)||(null===(r=null==d?void 0:d.scopes_supported)||void 0===r?void 0:r.join(" "))||(null===(s=p.scopes_supported)||void 0===s?void 0:s.join(" "));let g,v;dataSchemas.logger.debug(`[MCPOAuth] Starting authorization with scope: ${f}`);try{dataSchemas.logger.debug("[MCPOAuth] Calling startAuthorization...");const e=yield auth_js.startAuthorization(t,{metadata:p,clientInformation:h,redirectUrl:m,scope:f});g=e.authorizationUrl,v=e.codeVerifier,dataSchemas.logger.debug("[MCPOAuth] startAuthorization completed successfully"),dataSchemas.logger.debug(`[MCPOAuth] Authorization URL: ${g.toString()}`),g.searchParams.set("state",c),dataSchemas.logger.debug("[MCPOAuth] Added state parameter to authorization URL")}catch(e){throw dataSchemas.logger.error("[MCPOAuth] startAuthorization failed:",e),e}const b={serverName:e,userId:a,serverUrl:t,state:l,codeVerifier:v,clientInfo:h,metadata:p,resourceMetadata:d};dataSchemas.logger.debug(`[MCPOAuth] Authorization URL generated for ${e}: ${g.toString()}`);const y={authorizationUrl:g.toString(),flowId:c,flowMetadata:b};return dataSchemas.logger.debug(`[MCPOAuth] Returning from initiateOAuthFlow with result ${c} for ${e}`,y),y}catch(t){throw dataSchemas.logger.error("[MCPOAuth] Failed to initiate OAuth flow",{error:t,serverName:e,userId:a}),t}}))}static completeOAuthFlow(e,t,a){var n;return __awaiter(this,void 0,void 0,(function*(){try{const i=yield a.getFlowState(e,this.FLOW_TYPE);if(!i)throw new Error("OAuth flow not found");const o=i.metadata;if(!o)throw new Error("OAuth flow metadata not found");const r=o;if(!r.metadata||!r.clientInfo||!r.codeVerifier)throw new Error("Invalid flow metadata");const s=yield auth_js.exchangeAuthorization(r.serverUrl,{metadata:r.metadata,clientInformation:r.clientInfo,authorizationCode:t,codeVerifier:r.codeVerifier,redirectUri:(null===(n=r.clientInfo.redirect_uris)||void 0===n?void 0:n[0])||this.getDefaultRedirectUri()});dataSchemas.logger.debug("[MCPOAuth] Raw tokens from exchange:",{access_token:s.access_token?"[REDACTED]":void 0,refresh_token:s.refresh_token?"[REDACTED]":void 0,expires_in:s.expires_in,token_type:s.token_type,scope:s.scope});const c=Object.assign(Object.assign({},s),{obtained_at:Date.now(),expires_at:s.expires_in?Date.now()+1e3*s.expires_in:void 0});return yield a.completeFlow(e,this.FLOW_TYPE,c),c}catch(t){throw dataSchemas.logger.error("[MCPOAuth] Failed to complete OAuth flow",{error:t,flowId:e}),yield a.failFlow(e,this.FLOW_TYPE,t),t}}))}static getFlowState(e,t){return __awaiter(this,void 0,void 0,(function*(){const a=yield t.getFlowState(e,this.FLOW_TYPE);return a?a.metadata:null}))}static generateFlowId(e,t){return`${e}:${t}`}static generateState(){return require$$3.randomBytes(32).toString("base64url")}static getDefaultRedirectUri(e){const t=process.env.DOMAIN_SERVER||"http://localhost:3080";return e?`${t}/api/mcp/${e}/oauth/callback`:`${t}/api/mcp/oauth/callback`}static refreshOAuthTokens(e,t,a){var n;return __awaiter(this,void 0,void 0,(function*(){dataSchemas.logger.debug(`[MCPOAuth] Refreshing tokens for ${t.serverName}`);try{if(null===(n=t.clientInfo)||void 0===n?void 0:n.client_id){let n;if(dataSchemas.logger.debug(`[MCPOAuth] Using stored client information for token refresh for ${t.serverName}`),dataSchemas.logger.debug(`[MCPOAuth] Client ID: ${t.clientInfo.client_id} for ${t.serverName}`),dataSchemas.logger.debug(`[MCPOAuth] Has client secret: ${!!t.clientInfo.client_secret} for ${t.serverName}`),dataSchemas.logger.debug(`[MCPOAuth] Stored client info for ${t.serverName}:`,{client_id:t.clientInfo.client_id,has_client_secret:!!t.clientInfo.client_secret,grant_types:t.clientInfo.grant_types,scope:t.clientInfo.scope}),null==a?void 0:a.token_url)n=a.token_url;else{if(!t.serverUrl)throw new Error("No token URL available for refresh");{const{metadata:e}=yield this.discoverMetadata(t.serverUrl);if(!e.token_endpoint)throw new Error("No token endpoint found in OAuth metadata");n=e.token_endpoint}}const i=new URLSearchParams({grant_type:"refresh_token",refresh_token:e});t.clientInfo.scope&&i.append("scope",t.clientInfo.scope);const o={"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"};if(t.clientInfo.client_secret){const e=Buffer.from(`${t.clientInfo.client_id}:${t.clientInfo.client_secret}`).toString("base64");o.Authorization=`Basic ${e}`}else i.append("client_id",t.clientInfo.client_id);dataSchemas.logger.debug(`[MCPOAuth] Refresh request to: ${n}`,{body:i.toString(),headers:o});const r=yield fetch(n,{method:"POST",headers:o,body:i});if(!r.ok){const e=yield r.text();throw new Error(`Token refresh failed: ${r.status} ${r.statusText} - ${e}`)}const s=yield r.json();return Object.assign(Object.assign({},s),{obtained_at:Date.now(),expires_at:s.expires_in?Date.now()+1e3*s.expires_in:void 0})}if((null==a?void 0:a.token_url)&&(null==a?void 0:a.client_id)){dataSchemas.logger.debug("[MCPOAuth] Using pre-configured OAuth settings for token refresh");const t=new URL(a.token_url),n=a.client_secret?Buffer.from(`${a.client_id}:${a.client_secret}`).toString("base64"):null,i=new URLSearchParams({grant_type:"refresh_token",refresh_token:e});a.scope&&i.append("scope",a.scope);const o={"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"};n?o.Authorization=`Basic ${n}`:i.append("client_id",a.client_id);const r=yield fetch(t,{method:"POST",headers:o,body:i});if(!r.ok){const e=yield r.text();throw new Error(`Token refresh failed: ${r.status} ${r.statusText} - ${e}`)}const s=yield r.json();return Object.assign(Object.assign({},s),{obtained_at:Date.now(),expires_at:s.expires_in?Date.now()+1e3*s.expires_in:void 0})}if(!t.serverUrl)throw new Error("Server URL required for auto-discovered OAuth token refresh");const{metadata:i}=yield this.discoverMetadata(t.serverUrl);if(!i.token_endpoint)throw new Error("No token endpoint found in OAuth metadata");const o=new URL(i.token_endpoint),r=new URLSearchParams({grant_type:"refresh_token",refresh_token:e}),s={"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},c=yield fetch(o,{method:"POST",headers:s,body:r});if(!c.ok){const e=yield c.text();throw new Error(`Token refresh failed: ${c.status} ${c.statusText} - ${e}`)}const l=yield c.json();return Object.assign(Object.assign({},l),{obtained_at:Date.now(),expires_at:l.expires_in?Date.now()+1e3*l.expires_in:void 0})}catch(e){throw dataSchemas.logger.error(`[MCPOAuth] Failed to refresh tokens for ${t.serverName}`,e),e}}))}}function getDefaultExportFromCjs(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}MCPOAuthHandler.FLOW_TYPE="mcp_oauth",MCPOAuthHandler.FLOW_TTL=6e5;var main={exports:{}},version$1="16.4.7",require$$4={version:version$1};const fs$1=fs$2,path$1=path$2,os=require$$2,crypto$1=require$$3,packageJson=require$$4,version=packageJson.version,LINE=/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/gm;function parse$1(e){const t={};let a,n=e.toString();for(n=n.replace(/\r\n?/gm,"\n");null!=(a=LINE.exec(n));){const e=a[1];let n=a[2]||"";n=n.trim();const i=n[0];n=n.replace(/^(['"`])([\s\S]*)\1$/gm,"$2"),'"'===i&&(n=n.replace(/\\n/g,"\n"),n=n.replace(/\\r/g,"\r")),t[e]=n}return t}function _parseVault(e){const t=_vaultPath(e),a=DotenvModule.configDotenv({path:t});if(!a.parsed){const e=new Error(`MISSING_DATA: Cannot parse ${t} for an unknown reason`);throw e.code="MISSING_DATA",e}const n=_dotenvKey(e).split(","),i=n.length;let o;for(let e=0;e<i;e++)try{const t=_instructions(a,n[e].trim());o=DotenvModule.decrypt(t.ciphertext,t.key);break}catch(t){if(e+1>=i)throw t}return DotenvModule.parse(o)}function _log(e){console.log(`[dotenv@${version}][INFO] ${e}`)}function _warn(e){console.log(`[dotenv@${version}][WARN] ${e}`)}function _debug(e){console.log(`[dotenv@${version}][DEBUG] ${e}`)}function _dotenvKey(e){return e&&e.DOTENV_KEY&&e.DOTENV_KEY.length>0?e.DOTENV_KEY:process.env.DOTENV_KEY&&process.env.DOTENV_KEY.length>0?process.env.DOTENV_KEY:""}function _instructions(e,t){let a;try{a=new URL(t)}catch(e){if("ERR_INVALID_URL"===e.code){const e=new Error("INVALID_DOTENV_KEY: Wrong format. Must be in valid uri format like dotenv://:key_1234@dotenvx.com/vault/.env.vault?environment=development");throw e.code="INVALID_DOTENV_KEY",e}throw e}const n=a.password;if(!n){const e=new Error("INVALID_DOTENV_KEY: Missing key part");throw e.code="INVALID_DOTENV_KEY",e}const i=a.searchParams.get("environment");if(!i){const e=new Error("INVALID_DOTENV_KEY: Missing environment part");throw e.code="INVALID_DOTENV_KEY",e}const o=`DOTENV_VAULT_${i.toUpperCase()}`,r=e.parsed[o];if(!r){const e=new Error(`NOT_FOUND_DOTENV_ENVIRONMENT: Cannot locate environment ${o} in your .env.vault file.`);throw e.code="NOT_FOUND_DOTENV_ENVIRONMENT",e}return{ciphertext:r,key:n}}function _vaultPath(e){let t=null;if(e&&e.path&&e.path.length>0)if(Array.isArray(e.path))for(const a of e.path)fs$1.existsSync(a)&&(t=a.endsWith(".vault")?a:`${a}.vault`);else t=e.path.endsWith(".vault")?e.path:`${e.path}.vault`;else t=path$1.resolve(process.cwd(),".env.vault");return fs$1.existsSync(t)?t:null}function _resolveHome(e){return"~"===e[0]?path$1.join(os.homedir(),e.slice(1)):e}function _configVault(e){_log("Loading env from encrypted .env.vault");const t=DotenvModule._parseVault(e);let a=process.env;return e&&null!=e.processEnv&&(a=e.processEnv),DotenvModule.populate(a,t,e),{parsed:t}}function configDotenv(e){const t=path$1.resolve(process.cwd(),".env");let a="utf8";const n=Boolean(e&&e.debug);e&&e.encoding?a=e.encoding:n&&_debug("No encoding is specified. UTF-8 is used by default");let i,o=[t];if(e&&e.path)if(Array.isArray(e.path)){o=[];for(const t of e.path)o.push(_resolveHome(t))}else o=[_resolveHome(e.path)];const r={};for(const t of o)try{const n=DotenvModule.parse(fs$1.readFileSync(t,{encoding:a}));DotenvModule.populate(r,n,e)}catch(e){n&&_debug(`Failed to load ${t} ${e.message}`),i=e}let s=process.env;return e&&null!=e.processEnv&&(s=e.processEnv),DotenvModule.populate(s,r,e),i?{parsed:r,error:i}:{parsed:r}}function config(e){if(0===_dotenvKey(e).length)return DotenvModule.configDotenv(e);const t=_vaultPath(e);return t?DotenvModule._configVault(e):(_warn(`You set DOTENV_KEY but you are missing a .env.vault file at ${t}. Did you forget to build it?`),DotenvModule.configDotenv(e))}function decrypt$1(e,t){const a=Buffer.from(t.slice(-64),"hex");let n=Buffer.from(e,"base64");const i=n.subarray(0,12),o=n.subarray(-16);n=n.subarray(12,-16);try{const e=crypto$1.createDecipheriv("aes-256-gcm",a,i);return e.setAuthTag(o),`${e.update(n)}${e.final()}`}catch(e){const t=e instanceof RangeError,a="Invalid key length"===e.message,n="Unsupported state or unable to authenticate data"===e.message;if(t||a){const e=new Error("INVALID_DOTENV_KEY: It must be 64 characters long (or more)");throw e.code="INVALID_DOTENV_KEY",e}if(n){const e=new Error("DECRYPTION_FAILED: Please check your DOTENV_KEY");throw e.code="DECRYPTION_FAILED",e}throw e}}function populate$2(e,t,a={}){const n=Boolean(a&&a.debug),i=Boolean(a&&a.override);if("object"!=typeof t){const e=new Error("OBJECT_REQUIRED: Please check the processEnv argument being passed to populate");throw e.code="OBJECT_REQUIRED",e}for(const a of Object.keys(t))Object.prototype.hasOwnProperty.call(e,a)?(!0===i&&(e[a]=t[a]),n&&_debug(!0===i?`"${a}" is already defined and WAS overwritten`:`"${a}" is already defined and was NOT overwritten`)):e[a]=t[a]}const DotenvModule={configDotenv:configDotenv,_configVault:_configVault,_parseVault:_parseVault,config:config,decrypt:decrypt$1,parse:parse$1,populate:populate$2};main.exports.configDotenv=DotenvModule.configDotenv,main.exports._configVault=DotenvModule._configVault,main.exports._parseVault=DotenvModule._parseVault,main.exports.config=DotenvModule.config,main.exports.decrypt=DotenvModule.decrypt,main.exports.parse=DotenvModule.parse,main.exports.populate=DotenvModule.populate,main.exports=DotenvModule;var mainExports=main.exports;const options={};null!=process.env.DOTENV_CONFIG_ENCODING&&(options.encoding=process.env.DOTENV_CONFIG_ENCODING),null!=process.env.DOTENV_CONFIG_PATH&&(options.path=process.env.DOTENV_CONFIG_PATH),null!=process.env.DOTENV_CONFIG_DEBUG&&(options.debug=process.env.DOTENV_CONFIG_DEBUG),null!=process.env.DOTENV_CONFIG_OVERRIDE&&(options.override=process.env.DOTENV_CONFIG_OVERRIDE),null!=process.env.DOTENV_CONFIG_DOTENV_KEY&&(options.DOTENV_KEY=process.env.DOTENV_CONFIG_DOTENV_KEY);var envOptions=options;const re$3=/^dotenv_config_(encoding|path|debug|override|DOTENV_KEY)=(.+)$/;var cliOptions=function(e){return e.reduce((function(e,t){const a=t.match(re$3);return a&&(e[a[1]]=a[2]),e}),{})},_a,_b;mainExports.config(Object.assign({},envOptions,cliOptions(process.argv)));const{webcrypto:webcrypto}=crypto$2,key=Buffer.from(null!==(_a=process.env.CREDS_KEY)&&void 0!==_a?_a:"","hex"),iv=Buffer.from(null!==(_b=process.env.CREDS_IV)&&void 0!==_b?_b:"","hex"),algorithm="AES-CBC";function encrypt(e){return __awaiter(this,void 0,void 0,(function*(){const t=yield webcrypto.subtle.importKey("raw",key,{name:algorithm},!1,["encrypt"]),a=(new TextEncoder).encode(e),n=yield webcrypto.subtle.encrypt({name:algorithm,iv:iv},t,a);return Buffer.from(n).toString("hex")}))}function decrypt(e){return __awaiter(this,void 0,void 0,(function*(){const t=yield webcrypto.subtle.importKey("raw",key,{name:algorithm},!1,["decrypt"]),a=Buffer.from(e,"hex"),n=yield webcrypto.subtle.decrypt({name:algorithm,iv:iv},t,a);return(new TextDecoder).decode(n)}))}function encryptV2(e){return __awaiter(this,void 0,void 0,(function*(){const t=webcrypto.getRandomValues(new Uint8Array(16)),a=yield webcrypto.subtle.importKey("raw",key,{name:algorithm},!1,["encrypt"]),n=(new TextEncoder).encode(e),i=yield webcrypto.subtle.encrypt({name:algorithm,iv:t},a,n);return Buffer.from(t).toString("hex")+":"+Buffer.from(i).toString("hex")}))}function decryptV2(e){var t;return __awaiter(this,void 0,void 0,(function*(){const a=e.split(":");if(1===a.length)return a[0];const n=Buffer.from(null!==(t=a.shift())&&void 0!==t?t:"","hex"),i=a.join(":"),o=yield webcrypto.subtle.importKey("raw",key,{name:algorithm},!1,["decrypt"]),r=Buffer.from(i,"hex"),s=yield webcrypto.subtle.decrypt({name:algorithm,iv:n},o,r);return(new TextDecoder).decode(s)}))}const algorithm_v3="aes-256-ctr";function encryptV3(e){if(32!==key.length)throw new Error(`Invalid key length: expected 32 bytes, got ${key.length} bytes`);const t=crypto$2.randomBytes(16),a=crypto$2.createCipheriv(algorithm_v3,key,t),n=Buffer.concat([a.update(e,"utf8"),a.final()]);return`v3:${t.toString("hex")}:${n.toString("hex")}`}function decryptV3(e){const t=e.split(":");if("v3"!==t[0])throw new Error("Not a v3 encrypted value");const a=Buffer.from(t[1],"hex"),n=Buffer.from(t.slice(2).join(":"),"hex"),i=crypto$2.createDecipheriv(algorithm_v3,key,a);return Buffer.concat([i.update(n),i.final()]).toString("utf8")}function getRandomValues$2(e){return __awaiter(this,void 0,void 0,(function*(){if(!Number.isInteger(e)||e<=0)throw new Error("Length must be a positive integer");const t=new Uint8Array(e);return webcrypto.getRandomValues(t),Buffer.from(t).toString("hex")}))}function hashBackupCode(e){return __awaiter(this,void 0,void 0,(function*(){const t=(new TextEncoder).encode(e),a=yield webcrypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(a)).map((e=>e.toString(16).padStart(2,"0"))).join("")}))}class MCPTokenStorage{static getLogPrefix(e,t){return isSystemUserId(e)?`[MCP][${t}]`:`[MCP][User: ${e}][${t}]`}static storeTokens({userId:e,serverName:t,tokens:a,createToken:n,updateToken:i,findToken:o,clientInfo:r,existingTokens:s}){return __awaiter(this,void 0,void 0,(function*(){const c=this.getLogPrefix(e,t);try{const l=`mcp:${t}`,p=yield encryptV2(a.access_token);let d;dataSchemas.logger.debug(`${c} Token expires_in: ${"expires_in"in a?a.expires_in:"N/A"}, expires_at: ${"expires_at"in a?a.expires_at:"N/A"}`),"expires_at"in a&&a.expires_at?(dataSchemas.logger.debug(`${c} Using expires_at: ${a.expires_at}`),d=new Date(a.expires_at)):a.expires_in?(dataSchemas.logger.debug(`${c} Using expires_in: ${a.expires_in}`),d=new Date(Date.now()+1e3*a.expires_in)):(dataSchemas.logger.debug(`${c} No expiry provided, using default`),d=new Date(Date.now()+31536e6)),dataSchemas.logger.debug(`${c} Calculated expiry date: ${d.toISOString()}`),dataSchemas.logger.debug(`${c} Date object: ${JSON.stringify({time:d.getTime(),valid:!isNaN(d.getTime()),iso:d.toISOString()})}`),isNaN(d.getTime())&&(dataSchemas.logger.error(`${c} Invalid expiry date calculated, using default`),d=new Date(Date.now()+31536e6));const u=Math.floor((d.getTime()-Date.now())/1e3),m={userId:e,type:"mcp_oauth",identifier:l,token:p,expiresIn:u>0?u:31536e3};if(o&&i){(void 0!==(null==s?void 0:s.accessToken)?s.accessToken:yield o({userId:e,identifier:l}))?(yield i({userId:e,identifier:l},m),dataSchemas.logger.debug(`${c} Updated existing access token`)):(yield n(m),dataSchemas.logger.debug(`${c} Created new access token`))}else yield n(m),dataSchemas.logger.debug(`${c} Created access token (no update methods available)`);if(a.refresh_token){const t=yield encryptV2(a.refresh_token),r=a,p=r.refresh_token_expires_in?new Date(Date.now()+1e3*r.refresh_token_expires_in):new Date(Date.now()+31536e6),d=Math.floor((p.getTime()-Date.now())/1e3),u={userId:e,type:"mcp_oauth_refresh",identifier:`${l}:refresh`,token:t,expiresIn:d>0?d:31536e3};if(o&&i){(void 0!==(null==s?void 0:s.refreshToken)?s.refreshToken:yield o({userId:e,identifier:`${l}:refresh`}))?(yield i({userId:e,identifier:`${l}:refresh`},u),dataSchemas.logger.debug(`${c} Updated existing refresh token`)):(yield n(u),dataSchemas.logger.debug(`${c} Created new refresh token`))}else yield n(u),dataSchemas.logger.debug(`${c} Created refresh token (no update methods available)`)}if(r){dataSchemas.logger.debug(`${c} Storing client info:`,{client_id:r.client_id,has_client_secret:!!r.client_secret});const t=yield encryptV2(JSON.stringify(r)),a={userId:e,type:"mcp_oauth_client",identifier:`${l}:client`,token:t,expiresIn:31536e3};if(o&&i){(void 0!==(null==s?void 0:s.clientInfoToken)?s.clientInfoToken:yield o({userId:e,identifier:`${l}:client`}))?(yield i({userId:e,identifier:`${l}:client`},a),dataSchemas.logger.debug(`${c} Updated existing client info`)):(yield n(a),dataSchemas.logger.debug(`${c} Created new client info`))}else yield n(a),dataSchemas.logger.debug(`${c} Created client info (no update methods available)`)}dataSchemas.logger.debug(`${c} Stored OAuth tokens`)}catch(a){const n=this.getLogPrefix(e,t);throw dataSchemas.logger.error(`${n} Failed to store tokens`,a),a}}))}static getTokens({userId:e,serverName:t,findToken:a,createToken:n,updateToken:i,refreshTokens:o}){var r;return __awaiter(this,void 0,void 0,(function*(){const s=this.getLogPrefix(e,t);try{const c=`mcp:${t}`,l=yield a({userId:e,type:"mcp_oauth",identifier:c}),p=!l,d=(null==l?void 0:l.expiresAt)&&new Date>=l.expiresAt;if(p||d){dataSchemas.logger.info(`${s} Access token ${p?"missing":"expired"}`);const r=yield a({userId:e,type:"mcp_oauth_refresh",identifier:`${c}:refresh`});if(!r)return dataSchemas.logger.info(`${s} Access token ${p?"missing":"expired"} and no refresh token available`),null;if(!o)return dataSchemas.logger.warn(`${s} Access token ${p?"missing":"expired"}, refresh token available but no \`refreshTokens\` provided`),null;if(!n)return dataSchemas.logger.warn(`${s} Access token ${p?"missing":"expired"}, refresh token available but no \`createToken\` function provided`),null;try{dataSchemas.logger.info(`${s} Attempting to refresh token`);const p=yield decryptV2(r.token);let d,u;try{if(u=yield a({userId:e,type:"mcp_oauth_client",identifier:`${c}:client`}),u){const e=yield decryptV2(u.token);d=JSON.parse(e),dataSchemas.logger.debug(`${s} Retrieved client info:`,{client_id:d.client_id,has_client_secret:!!d.client_secret})}}catch(e){dataSchemas.logger.debug(`${s} No client info found`)}const m={userId:e,serverName:t,identifier:c,clientInfo:d},h=yield o(p,m);return yield this.storeTokens({userId:e,serverName:t,tokens:h,createToken:n,updateToken:i,findToken:a,clientInfo:d,existingTokens:{accessToken:l,refreshToken:r,clientInfoToken:u}}),dataSchemas.logger.info(`${s} Successfully refreshed and stored OAuth tokens`),h}catch(e){dataSchemas.logger.error(`${s} Failed to refresh tokens`,e);return(e instanceof Error?e.message:String(e)).includes("unauthorized_client")&&dataSchemas.logger.info(`${s} Server does not support refresh tokens for this client. New authentication required.`),null}}if(!l)return null;const u=yield decryptV2(l.token),m=yield a({userId:e,type:"mcp_oauth_refresh",identifier:`${c}:refresh`}),h={access_token:u,token_type:"Bearer",obtained_at:l.createdAt.getTime(),expires_at:null===(r=l.expiresAt)||void 0===r?void 0:r.getTime()};return m&&(h.refresh_token=yield decryptV2(m.token)),dataSchemas.logger.debug(`${s} Loaded existing OAuth tokens from storage`),h}catch(e){return dataSchemas.logger.error(`${s} Failed to retrieve tokens`,e),null}}))}}const RECOGNIZED_PROVIDERS=new Set(["google","anthropic","openai","openrouter","xai","deepseek","ollama","bedrock"]),CONTENT_ARRAY_PROVIDERS=new Set(["google","anthropic","openai"]),imageFormatters={default:e=>({type:"image_url",image_url:{url:e.data.startsWith("http")?e.data:`data:${e.mimeType};base64,${e.data}`}})};function isImageContent(e){return"image"===e.type}function parseAsString(e){var t;const a=null!==(t=null==e?void 0:e.content)&&void 0!==t?t:[];if(!a.length)return"(No response)";return a.map((e=>{if("text"===e.type)return e.text;if("resource"===e.type){const t=[];return null!=e.resource.text&&e.resource.text&&t.push(e.resource.text),e.resource.uri&&t.push(`Resource URI: ${e.resource.uri}`),e.resource.name&&t.push(`Resource: ${e.resource.name}`),e.resource.description&&t.push(`Description: ${e.resource.description}`),null!=e.resource.mimeType&&e.resource.mimeType&&t.push(`Type: ${e.resource.mimeType}`),t.join("\n")}return JSON.stringify(e,null,2)})).filter(Boolean).join("\n\n")}function formatToolContent(e,t){var a;if(!RECOGNIZED_PROVIDERS.has(t))return[parseAsString(e),void 0];const n=null!==(a=null==e?void 0:e.content)&&void 0!==a?a:[];if(!n.length)return[[{type:"text",text:"(No response)"}],void 0];const i=[],o=[];let r="";const s={text:e=>{r+=(r?"\n\n":"")+e.text},image:e=>{if(!isImageContent(e))return;CONTENT_ARRAY_PROVIDERS.has(t)&&r&&(i.push({type:"text",text:r}),r="");const a=(0,imageFormatters.default)(e);"image_url"===a.type?o.push(a):i.push(a)},resource:e=>{const t=[];null!=e.resource.text&&e.resource.text&&t.push(e.resource.text),e.resource.uri.length&&t.push(`Resource URI: ${e.resource.uri}`),e.resource.name&&t.push(`Resource: ${e.resource.name}`),e.resource.description&&t.push(`Description: ${e.resource.description}`),null!=e.resource.mimeType&&e.resource.mimeType&&t.push(`Type: ${e.resource.mimeType}`),r+=(r?"\n\n":"")+t.join("\n")}};for(const e of n){const t=s[e.type];if(t)t(e);else{const t=JSON.stringify(e,null,2);r+=(r?"\n\n":"")+t}}CONTENT_ARRAY_PROVIDERS.has(t)&&r&&i.push({type:"text",text:r});const c=o.length?{content:o}:void 0;return CONTENT_ARRAY_PROVIDERS.has(t)?[i,c]:[r,c]}function isStdioOptions(e){return"command"in e}function isWebSocketOptions(e){if("url"in e){const t=new URL(e.url).protocol;return"ws:"===t||"wss:"===t}return!1}function isSSEOptions(e){if("url"in e){const t=new URL(e.url).protocol;return"ws:"!==t&&"wss:"!==t}return!1}function isStreamableHTTPOptions(e){if("url"in e&&"streamable-http"===e.type){const t=new URL(e.url).protocol;return"ws:"!==t&&"wss:"!==t}return!1}const FIVE_MINUTES=3e5;class MCPConnection extends events.EventEmitter{constructor(e,t,a,n){super(),this.options=t,this.transport=null,this.connectionState="disconnected",this.connectPromise=null,this.lastError=null,this.lastConfigUpdate=0,this.CONFIG_TTL=3e5,this.MAX_RECONNECT_ATTEMPTS=3,this.shouldStopReconnecting=!1,this.isReconnecting=!1,this.isInitializing=!1,this.reconnectAttempts=0,this.oauthRequired=!1,this.serverName=e,this.userId=a,this.iconPath=t.iconPath,this.timeout=t.timeout,this.lastPingTime=Date.now(),n&&(this.oauthTokens=n),this.client=new index_js.Client({name:"@librechat/api-client",version:"1.2.3"},{capabilities:{}}),this.setupEventListeners()}getLogPrefix(){return`[MCP]${this.userId?`[User: ${this.userId}]`:""}[${this.serverName}]`}static getInstance(e,t,a){return MCPConnection.instance||(MCPConnection.instance=new MCPConnection(e,t,a)),MCPConnection.instance}static getExistingInstance(){return MCPConnection.instance}static destroyInstance(){return __awaiter(this,void 0,void 0,(function*(){MCPConnection.instance&&(yield MCPConnection.instance.disconnect(),MCPConnection.instance=null)}))}emitError(e,t){const a=e instanceof Error?e.message:String(e);dataSchemas.logger.error(`${this.getLogPrefix()} ${t}: ${a}`),this.emit("error",new Error(`${t}: ${a}`))}constructTransport(e){var t,a,n;try{let i;if(isStdioOptions(e))i="stdio";else if(isWebSocketOptions(e))i="websocket";else if(isStreamableHTTPOptions(e))i="streamable-http";else{if(!isSSEOptions(e))throw new Error("Cannot infer transport type: options.type is not provided and cannot be inferred from other properties.");i="sse"}switch(i){case"stdio":if(!isStdioOptions(e))throw new Error("Invalid options for stdio transport.");return new stdio_js.StdioClientTransport({command:e.command,args:e.args,env:Object.assign(Object.assign({},stdio_js.getDefaultEnvironment()),null!==(t=e.env)&&void 0!==t?t:{})});case"websocket":if(!isWebSocketOptions(e))throw new Error("Invalid options for websocket transport.");return this.url=e.url,new websocket_js.WebSocketClientTransport(new URL(e.url));case"sse":{if(!isSSEOptions(e))throw new Error("Invalid options for sse transport.");this.url=e.url;const t=new URL(e.url);dataSchemas.logger.info(`${this.getLogPrefix()} Creating SSE transport: ${t.toString()}`);const n=new AbortController,i=Object.assign({},e.headers);(null===(a=this.oauthTokens)||void 0===a?void 0:a.access_token)&&(i.Authorization=`Bearer ${this.oauthTokens.access_token}`);const o=new sse_js.SSEClientTransport(t,{requestInit:{headers:i,signal:n.signal},eventSourceInit:{fetch:(e,t)=>{const a=new Headers(Object.assign({},null==t?void 0:t.headers,i));return fetch(e,Object.assign(Object.assign({},t),{headers:a}))}}});return o.onclose=()=>{dataSchemas.logger.info(`${this.getLogPrefix()} SSE transport closed`),this.emit("connectionChange","disconnected")},o.onerror=e=>{dataSchemas.logger.error(`${this.getLogPrefix()} SSE transport error:`,e),this.emitError(e,"SSE transport error:")},o.onmessage=e=>{dataSchemas.logger.info(`${this.getLogPrefix()} Message received: ${JSON.stringify(e)}`)},this.setupTransportErrorHandlers(o),o}case"streamable-http":{if(!isStreamableHTTPOptions(e))throw new Error("Invalid options for streamable-http transport.");this.url=e.url;const t=new URL(e.url);dataSchemas.logger.info(`${this.getLogPrefix()} Creating streamable-http transport: ${t.toString()}`);const a=new AbortController,i=Object.assign({},e.headers);(null===(n=this.oauthTokens)||void 0===n?void 0:n.access_token)&&(i.Authorization=`Bearer ${this.oauthTokens.access_token}`);const o=new streamableHttp_js.StreamableHTTPClientTransport(t,{requestInit:{headers:i,signal:a.signal}});return o.onclose=()=>{dataSchemas.logger.info(`${this.getLogPrefix()} Streamable-http transport closed`),this.emit("connectionChange","disconnected")},o.onerror=e=>{dataSchemas.logger.error(`${this.getLogPrefix()} Streamable-http transport error:`,e),this.emitError(e,"Streamable-http transport error:")},o.onmessage=e=>{dataSchemas.logger.info(`${this.getLogPrefix()} Message received: ${JSON.stringify(e)}`)},this.setupTransportErrorHandlers(o),o}default:throw new Error(`Unsupported transport type: ${i}`)}}catch(e){throw this.emitError(e,"Failed to construct transport:"),e}}setupEventListeners(){this.isInitializing=!0,this.on("connectionChange",(e=>{this.connectionState=e,"connected"===e?(this.isReconnecting=!1,this.isInitializing=!1,this.shouldStopReconnecting=!1,this.reconnectAttempts=0):"error"!==e||this.isReconnecting||this.isInitializing||this.handleReconnection().catch((e=>{dataSchemas.logger.error(`${this.getLogPrefix()} Reconnection handler failed:`,e)}))})),this.subscribeToResources()}handleReconnection(){return __awaiter(this,void 0,void 0,(function*(){if(this.isReconnecting||this.shouldStopReconnecting||this.isInitializing||this.oauthRequired)return void(this.oauthRequired&&dataSchemas.logger.info(`${this.getLogPrefix()} OAuth required, skipping reconnection attempts`));this.isReconnecting=!0;try{for(;this.reconnectAttempts<this.MAX_RECONNECT_ATTEMPTS&&!this.shouldStopReconnecting;){this.reconnectAttempts++;const t=(e=this.reconnectAttempts,Math.min(1e3*Math.pow(2,e),3e4));dataSchemas.logger.info(`${this.getLogPrefix()} Reconnecting ${this.reconnectAttempts}/${this.MAX_RECONNECT_ATTEMPTS} (delay: ${t}ms)`),yield new Promise((e=>setTimeout(e,t)));try{return yield this.connect(),void(this.reconnectAttempts=0)}catch(e){if(dataSchemas.logger.error(`${this.getLogPrefix()} Reconnection attempt failed:`,e),this.reconnectAttempts===this.MAX_RECONNECT_ATTEMPTS||this.shouldStopReconnecting)return void dataSchemas.logger.error(`${this.getLogPrefix()} Stopping reconnection attempts`)}}}finally{this.isReconnecting=!1}var e}))}subscribeToResources(){this.client.setNotificationHandler(types_js.ResourceListChangedNotificationSchema,(()=>__awaiter(this,void 0,void 0,(function*(){this.invalidateCache(),this.emit("resourcesChanged")}))))}invalidateCache(){this.lastConfigUpdate=0}connectClient(){return __awaiter(this,void 0,void 0,(function*(){if("connected"!==this.connectionState){if(this.connectPromise)return this.connectPromise;if(!this.shouldStopReconnecting)return this.emit("connectionChange","connecting"),this.connectPromise=(()=>__awaiter(this,void 0,void 0,(function*(){var e,t;try{if(this.transport)try{yield this.client.close(),this.transport=null}catch(e){dataSchemas.logger.warn(`${this.getLogPrefix()} Error closing connection:`,e)}this.transport=this.constructTransport(this.options),this.setupTransportDebugHandlers();const t=null!==(e=this.options.initTimeout)&&void 0!==e?e:12e4;yield Promise.race([this.client.connect(this.transport),new Promise(((e,a)=>setTimeout((()=>a(new Error(`Connection timeout after ${t}ms`))),t)))]),this.connectionState="connected",this.emit("connectionChange","connected"),this.reconnectAttempts=0}catch(e){if(this.isOAuthError(e)){dataSchemas.logger.warn(`${this.getLogPrefix()} OAuth authentication required`),this.oauthRequired=!0;const a=this.url;dataSchemas.logger.debug(`${this.getLogPrefix()} Server URL for OAuth: ${a}`);const n=null!==(t=this.options.initTimeout)&&void 0!==t?t:6e4,i=new Promise(((e,t)=>{let a=null,i=null,o=null;const r=()=>{a&&clearTimeout(a),i&&this.off("oauthHandled",i),o&&this.off("oauthFailed",o)};i=()=>{r(),e()},o=e=>{r(),t(e)},a=setTimeout((()=>{r(),t(new Error(`OAuth handling timeout after ${n}ms`))}),n),this.once("oauthHandled",i),this.once("oauthFailed",o)}));this.emit("oauthRequired",{serverName:this.serverName,error:e,serverUrl:a,userId:this.userId});try{return yield i,this.oauthRequired=!1,void dataSchemas.logger.info(`${this.getLogPrefix()} OAuth handled successfully, connection will be retried`)}catch(t){throw this.oauthRequired=!1,dataSchemas.logger.error(`${this.getLogPrefix()} OAuth handling failed:`,t),e}}throw this.connectionState="error",this.emit("connectionChange","error"),e}finally{this.connectPromise=null}})))(),this.connectPromise}}))}setupTransportDebugHandlers(){if(!this.transport)return;this.transport.onmessage=e=>{dataSchemas.logger.debug(`${this.getLogPrefix()} Transport received: ${JSON.stringify(e)}`)};const e=this.transport.send.bind(this.transport);this.transport.send=t=>__awaiter(this,void 0,void 0,(function*(){var a;if("result"in t&&!("method"in t)&&0===Object.keys(null!==(a=t.result)&&void 0!==a?a:{}).length){if(Date.now()-this.lastPingTime<FIVE_MINUTES)throw new Error("Empty result");this.lastPingTime=Date.now()}return dataSchemas.logger.debug(`${this.getLogPrefix()} Transport sending: ${JSON.stringify(t)}`),e(t)}))}connect(){return __awaiter(this,void 0,void 0,(function*(){try{if(yield this.disconnect(),yield this.connectClient(),!this.isConnected())throw new Error("Connection not established")}catch(e){throw dataSchemas.logger.error(`${this.getLogPrefix()} Connection failed:`,e),e}}))}setupTransportErrorHandlers(e){e.onerror=e=>{if(dataSchemas.logger.error(`${this.getLogPrefix()} Transport error:`,e),e&&"object"==typeof e&&"code"in e){const t=e.code;401!==t&&403!==t||(dataSchemas.logger.warn(`${this.getLogPrefix()} OAuth authentication error detected`),this.emit("oauthError",e))}this.emit("connectionChange","error")}}disconnect(){return __awaiter(this,void 0,void 0,(function*(){try{if(this.transport&&(yield this.client.close(),this.transport=null),"disconnected"===this.connectionState)return;this.connectionState="disconnected",this.emit("connectionChange","disconnected")}catch(e){throw this.emit("error",e),e}finally{this.invalidateCache(),this.connectPromise=null}}))}fetchResources(){return __awaiter(this,void 0,void 0,(function*(){try{const{resources:e}=yield this.client.listResources();return e}catch(e){return this.emitError(e,"Failed to fetch resources:"),[]}}))}fetchTools(){return __awaiter(this,void 0,void 0,(function*(){try{const{tools:e}=yield this.client.listTools();return e}catch(e){return this.emitError(e,"Failed to fetch tools:"),[]}}))}fetchPrompts(){return __awaiter(this,void 0,void 0,(function*(){try{const{prompts:e}=yield this.client.listPrompts();return e}catch(e){return this.emitError(e,"Failed to fetch prompts:"),[]}}))}isConnected(){return __awaiter(this,void 0,void 0,(function*(){try{return yield this.client.ping(),"connected"===this.connectionState}catch(e){return dataSchemas.logger.error(`${this.getLogPrefix()} Ping failed:`,e),!1}}))}setOAuthTokens(e){this.oauthTokens=e}isOAuthError(e){if(!e||"object"!=typeof e)return!1;if("message"in e&&"string"==typeof e.message)return e.message.includes("401")||e.message.includes("Non-200 status code (401)");if("code"in e){const t=e.code;return 401===t||403===t}return!1}}MCPConnection.instance=null;const ALLOWED_USER_FIELDS=["id","name","username","email","provider","role","googleId","facebookId","openidId","samlId","ldapId","githubId","discordId","appleId","emailVerified","twoFactorEnabled","termsAccepted"];function processUserPlaceholders(e,t){if(!t||"string"!=typeof e)return e;for(const a of ALLOWED_USER_FIELDS){const n=`{{LIBRECHAT_USER_${a.toUpperCase()}}}`;if(!e.includes(n))continue;const i=t[a];if(!(a in t))continue;if("id"===a&&(void 0===i||""===i))continue;const o=null==i?"":String(i);e=e.replace(new RegExp(n,"g"),o)}return e}function processSingleValue({originalValue:e,customUserVars:t,user:a}){let n=e;if(t)for(const[e,a]of Object.entries(t)){const t=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),i=new RegExp(`\\{\\{${t}\\}\\}`,"g");n=n.replace(i,a)}return n=processUserPlaceholders(n,a),n=librechatDataProvider.extractEnvVariable(n),n}function processMCPEnv(e,t,a){if(null==e)return e;const n=structuredClone(e);if("env"in n&&n.env){const e={};for(const[i,o]of Object.entries(n.env))e[i]=processSingleValue({originalValue:o,customUserVars:a,user:t});n.env=e}if("headers"in n&&n.headers){const e={};for(const[i,o]of Object.entries(n.headers))e[i]=processSingleValue({originalValue:o,customUserVars:a,user:t});n.headers=e}return"url"in n&&n.url&&(n.url=processSingleValue({originalValue:n.url,customUserVars:a,user:t})),n}function resolveHeaders(e,t,a){const n=Object.assign({},null!=e?e:{});return e&&"object"==typeof e&&!Array.isArray(e)&&Object.keys(e).forEach((i=>{n[i]=processSingleValue({originalValue:e[i],customUserVars:a,user:t})})),n}class MCPManager{constructor(){this.connections=new Map,this.userConnections=new Map,this.userLastActivity=new Map,this.USER_CONNECTION_IDLE_TIMEOUT=9e5,this.mcpConfigs={},this.serverInstructions=new Map}static getInstance(){return MCPManager.instance||(MCPManager.instance=new MCPManager),MCPManager.instance.checkIdleConnections(),MCPManager.instance}initializeMCP({mcpServers:e,flowManager:t,tokenMethods:a}){return __awaiter(this,void 0,void 0,(function*(){this.mcpConfigs=e,t||dataSchemas.logger.info("[MCP] No flow manager provided, OAuth will not be available"),a||dataSchemas.logger.info("[MCP] No token methods provided, token persistence will not be available");const n=Object.entries(e),i=new Set,o=yield Promise.allSettled(n.map((([e,n],o)=>__awaiter(this,void 0,void 0,(function*(){var r;const s=processMCPEnv(n);let c=null;if(null==a?void 0:a.findToken)try{const n=(e,t)=>__awaiter(this,void 0,void 0,(function*(){const a=s.url;return yield MCPOAuthHandler.refreshOAuthTokens(e,{serverName:t.serverName,serverUrl:a,clientInfo:t.clientInfo},s.oauth)})),i=`tokens:${CONSTANTS.SYSTEM_USER_ID}:${e}`;c=yield t.createFlowWithHandler(i,"mcp_get_tokens",(()=>__awaiter(this,void 0,void 0,(function*(){return yield MCPTokenStorage.getTokens({userId:CONSTANTS.SYSTEM_USER_ID,serverName:e,findToken:a.findToken,refreshTokens:n,createToken:a.createToken,updateToken:a.updateToken})}))))}catch(t){dataSchemas.logger.debug(`[MCP][${e}] No existing tokens found`)}c&&dataSchemas.logger.info(`[MCP][${e}] Loaded OAuth tokens`);const l=new MCPConnection(e,s,void 0,c);dataSchemas.logger.info(`[MCP][${e}] Setting up OAuth event listener`),l.on("oauthRequired",(n=>__awaiter(this,void 0,void 0,(function*(){dataSchemas.logger.debug(`[MCP][${e}] oauthRequired event received`);const i=yield this.handleOAuthRequired(Object.assign(Object.assign({},n),{flowManager:t}));if((null==i?void 0:i.tokens)&&(null==a?void 0:a.createToken))try{l.setOAuthTokens(i.tokens),yield MCPTokenStorage.storeTokens({userId:CONSTANTS.SYSTEM_USER_ID,serverName:e,tokens:i.tokens,createToken:a.createToken,updateToken:a.updateToken,findToken:a.findToken,clientInfo:i.clientInfo}),dataSchemas.logger.info(`[MCP][${e}] OAuth tokens saved to storage`)}catch(t){dataSchemas.logger.error(`[MCP][${e}] Failed to save OAuth tokens to storage`,t)}(null==i?void 0:i.tokens)?l.emit("oauthHandled"):(dataSchemas.logger.warn(`[MCP][${e}] OAuth failed, emitting oauthFailed event`),l.emit("oauthFailed",new Error("OAuth authentication failed")))}))));try{const a=null!==(r=s.initTimeout)&&void 0!==r?r:3e4,n=new Promise(((e,t)=>setTimeout((()=>t(new Error(`Connection timeout after ${a}ms`))),a))),c=this.initializeServer({connection:l,logPrefix:`[MCP][${e}]`,flowManager:t,handleOAuth:!1});if(yield Promise.race([c,n]),yield l.isConnected()){i.add(o),this.connections.set(e,l);const t=s.serverInstructions;if(void 0!==t)if("string"==typeof t)this.serverInstructions.set(e,t),dataSchemas.logger.info(`[MCP][${e}] Custom instructions stored for context inclusion: ${t}`);else if(!0===t){const t=l.client.getInstructions();t?(this.serverInstructions.set(e,t),dataSchemas.logger.info(`[MCP][${e}] Server instructions stored for context inclusion: ${t}`)):dataSchemas.logger.info(`[MCP][${e}] serverInstructions=true but no server instructions available`)}else dataSchemas.logger.info(`[MCP][${e}] Instructions explicitly disabled (serverInstructions=false)`);else dataSchemas.logger.info(`[MCP][${e}] Instructions not included (serverInstructions not configured)`);const a=l.client.getServerCapabilities();if(dataSchemas.logger.info(`[MCP][${e}] Capabilities: ${JSON.stringify(a)}`),null==a?void 0:a.tools){const t=yield l.client.listTools();t.tools.length&&dataSchemas.logger.info(`[MCP][${e}] Available tools: ${t.tools.map((e=>e.name)).join(", ")}`)}}}catch(t){throw dataSchemas.logger.error(`[MCP][${e}] Initialization failed`,t),t}}))))),r=o.filter((e=>"rejected"===e.status));dataSchemas.logger.info(`[MCP] Initialized ${i.size}/${n.length} app-level server(s)`),r.length>0&&dataSchemas.logger.warn(`[MCP] ${r.length}/${n.length} app-level server(s) failed to initialize`),n.forEach((([e],t)=>{i.has(t)?dataSchemas.logger.info(`[MCP][${e}] ✓ Initialized`):dataSchemas.logger.info(`[MCP][${e}] ✗ Failed`)})),i.size===n.length?dataSchemas.logger.info("[MCP] All app-level servers initialized successfully"):0===i.size&&dataSchemas.logger.warn("[MCP] No app-level servers initialized")}))}initializeServer({connection:e,logPrefix:t,flowManager:a,handleOAuth:n=!0}){return __awaiter(this,void 0,void 0,(function*(){let i=0,o=!1;for(;i<3;)try{if(yield e.connect(),yield e.isConnected())return;throw new Error("Connection attempt succeeded but status is not connected")}catch(r){if(i++,this.isOAuthError(r)){if(n){const n=r;if(!o&&(null==n?void 0:n.isOAuthError)){o=!0,dataSchemas.logger.info(`${t} Handling OAuth`);const n=e.url;n&&(yield this.handleOAuthRequired({serverName:e.serverName,serverUrl:n,flowManager:a}))}else dataSchemas.logger.info(`${t} OAuth already handled by connection`)}throw dataSchemas.logger.info(`${t} OAuth required, stopping connection attempts`),r}if(3===i)throw dataSchemas.logger.error(`${t} Failed to connect after 3 attempts`,r),r;yield new Promise((e=>setTimeout(e,2e3*i)))}}))}isOAuthError(e){if(!e||"object"!=typeof e)return!1;if("message"in e&&"string"==typeof e.message)return e.message.includes("401")||e.message.includes("Non-200 status code (401)");if("code"in e){const t=e.code;return 401===t||403===t}return!1}checkIdleConnections(e){const t=Date.now();for(const[a,n]of this.userLastActivity.entries())e&&e===a||t-n>this.USER_CONNECTION_IDLE_TIMEOUT&&(dataSchemas.logger.info(`[MCP][User: ${a}] User idle for too long. Disconnecting all connections...`),this.disconnectUserConnections(a).catch((e=>dataSchemas.logger.error(`[MCP][User: ${a}] Error disconnecting idle connections:`,e))))}updateUserLastActivity(e){const t=Date.now();this.userLastActivity.set(e,t),dataSchemas.logger.debug(`[MCP][User: ${e}] Updated last activity timestamp: ${new Date(t).toISOString()}`)}getUserConnection({user:e,serverName:t,flowManager:a,customUserVars:n,tokenMethods:i,oauthStart:o,oauthEnd:r,signal:s}){var c,l,p;return __awaiter(this,void 0,void 0,(function*(){const d=e.id;if(!d)throw new types_js.McpError(types_js.ErrorCode.InvalidRequest,"[MCP] User object missing id property");const u=this.userConnections.get(d);let m=null==u?void 0:u.get(t);const h=Date.now(),f=this.userLastActivity.get(d);if(f&&h-f>this.USER_CONNECTION_IDLE_TIMEOUT){dataSchemas.logger.info(`[MCP][User: ${d}] User idle for too long. Disconnecting all connections.`);try{yield this.disconnectUserConnections(d)}catch(e){dataSchemas.logger.error(`[MCP][User: ${d}] Error disconnecting idle connections:`,e)}m=void 0}else if(m){if(yield m.isConnected())return dataSchemas.logger.debug(`[MCP][User: ${d}][${t}] Reusing active connection`),this.updateUserLastActivity(d),m;dataSchemas.logger.warn(`[MCP][User: ${d}][${t}] Found existing but disconnected connection object. Cleaning up.`),this.removeUserConnection(d,t),m=void 0}m||dataSchemas.logger.info(`[MCP][User: ${d}][${t}] Establishing new connection`);let g=this.mcpConfigs[t];if(!g)throw new types_js.McpError(types_js.ErrorCode.InvalidRequest,`[MCP][User: ${d}] Configuration for server "${t}" not found.`);g=Object.assign({},null!==(c=processMCPEnv(g,e,n))&&void 0!==c?c:{});let v=null;if(null==i?void 0:i.findToken)try{const e=(e,t)=>__awaiter(this,void 0,void 0,(function*(){const a=g.url;return yield MCPOAuthHandler.refreshOAuthTokens(e,{serverName:t.serverName,serverUrl:a,clientInfo:t.clientInfo},g.oauth)})),n=`tokens:${d}:${t}`;v=yield a.createFlowWithHandler(n,"mcp_get_tokens",(()=>__awaiter(this,void 0,void 0,(function*(){return yield MCPTokenStorage.getTokens({userId:d,serverName:t,findToken:i.findToken,refreshTokens:e,createToken:i.createToken,updateToken:i.updateToken})}))),s)}catch(e){dataSchemas.logger.error(`[MCP][User: ${d}][${t}] Error loading OAuth tokens from storage`,e)}v&&dataSchemas.logger.info(`[MCP][User: ${d}][${t}] Loaded OAuth tokens`),m=new MCPConnection(t,g,d,v),m.on("oauthRequired",(e=>__awaiter(this,void 0,void 0,(function*(){dataSchemas.logger.info(`[MCP][User: ${d}][${t}] oauthRequired event received`);const n=yield this.handleOAuthRequired(Object.assign(Object.assign({},e),{flowManager:a,oauthStart:o,oauthEnd:r}));if((null==n?void 0:n.tokens)&&(null==i?void 0:i.createToken))try{null==m||m.setOAuthTokens(n.tokens),yield MCPTokenStorage.storeTokens({userId:d,serverName:t,tokens:n.tokens,createToken:i.createToken,updateToken:i.updateToken,findToken:i.findToken,clientInfo:n.clientInfo}),dataSchemas.logger.info(`[MCP][User: ${d}][${t}] OAuth tokens saved to storage`)}catch(e){dataSchemas.logger.error(`[MCP][User: ${d}][${t}] Failed to save OAuth tokens to storage`,e)}(null==n?void 0:n.tokens)?null==m||m.emit("oauthHandled"):(dataSchemas.logger.warn(`[MCP][User: ${d}][${t}] OAuth failed, emitting oauthFailed event`),null==m||m.emit("oauthFailed",new Error("OAuth authentication failed")))}))));try{const e=null!==(l=g.initTimeout)&&void 0!==l?l:3e4,n=new Promise(((t,a)=>setTimeout((()=>a(new Error(`Connection timeout after ${e}ms`))),e))),i=this.initializeServer({connection:m,logPrefix:`[MCP][User: ${d}][${t}]`,flowManager:a});if(yield Promise.race([i,n]),!(yield null==m?void 0:m.isConnected()))throw new Error("Failed to establish connection after initialization attempt.");return this.userConnections.has(d)||this.userConnections.set(d,new Map),null===(p=this.userConnections.get(d))||void 0===p||p.set(t,m),dataSchemas.logger.info(`[MCP][User: ${d}][${t}] Connection successfully established`),this.updateUserLastActivity(d),m}catch(e){throw dataSchemas.logger.error(`[MCP][User: ${d}][${t}] Failed to establish connection`,e),yield null==m?void 0:m.disconnect().catch((e=>{dataSchemas.logger.error(`[MCP][User: ${d}][${t}] Error during cleanup after failed connection`,e)})),this.removeUserConnection(d,t),e}}))}removeUserConnection(e,t){const a=this.userConnections.get(e);a&&(a.delete(t),0===a.size&&(this.userConnections.delete(e),this.userLastActivity.delete(e))),dataSchemas.logger.debug(`[MCP][User: ${e}][${t}] Removed connection entry.`)}disconnectUserConnection(e,t){return __awaiter(this,void 0,void 0,(function*(){const a=this.userConnections.get(e),n=null==a?void 0:a.get(t);n&&(dataSchemas.logger.info(`[MCP][User: ${e}][${t}] Disconnecting...`),yield n.disconnect(),this.removeUserConnection(e,t))}))}disconnectUserConnections(e){return __awaiter(this,void 0,void 0,(function*(){const t=this.userConnections.get(e),a=[];if(t){dataSchemas.logger.info(`[MCP][User: ${e}] Disconnecting all servers...`);const n=Array.from(t.keys());for(const t of n)a.push(this.disconnectUserConnection(e,t).catch((a=>{dataSchemas.logger.error(`[MCP][User: ${e}][${t}] Error during disconnection:`,a)})));yield Promise.allSettled(a),this.userLastActivity.delete(e),dataSchemas.logger.info(`[MCP][User: ${e}] All connections processed for disconnection.`)}}))}getConnection(e){return this.connections.get(e)}getAllConnections(){return this.connections}isConnectionActive({serverName:e,connection:t,flowManager:a,skipReconnect:n=!1}){return __awaiter(this,void 0,void 0,(function*(){if(yield t.isConnected())return!0;if(n)return dataSchemas.logger.warn(`[MCP][${e}] App-level connection is disconnected, skipping reconnection attempt`),!1;dataSchemas.logger.warn(`[MCP][${e}] App-level connection disconnected, attempting to reconnect...`);try{return this.mcpConfigs[e]?(yield this.initializeServer({connection:t,logPrefix:`[MCP][${e}]`,flowManager:a}),(yield t.isConnected())?(dataSchemas.logger.info(`[MCP][${e}] App-level connection successfully reconnected`),!0):(dataSchemas.logger.warn(`[MCP][${e}] App-level connection reconnection failed`),!1)):(dataSchemas.logger.error(`[MCP][${e}] Configuration not found for reconnection`),!1)}catch(t){return dataSchemas.logger.error(`[MCP][${e}] Error during app-level connection reconnection:`,t),!1}}))}mapAvailableTools(e,t){return __awaiter(this,void 0,void 0,(function*(){for(const[a,n]of this.connections.entries())try{if(!(yield this.isConnectionActive({serverName:a,connection:n,flowManager:t}))){dataSchemas.logger.warn(`[MCP][${a}] Connection not available. Skipping tool mapping.`);continue}const i=yield n.fetchTools();for(const t of i){const n=`${t.name}${CONSTANTS.mcp_delimiter}${a}`;e[n]={type:"function",function:{name:n,description:t.description,parameters:t.inputSchema}}}}catch(e){dataSchemas.logger.warn(`[MCP][${a}] Error fetching tools`,e)}}))}loadManifestTools({flowManager:e,serverToolsCallback:t,getServerTools:a}){var n;return __awaiter(this,void 0,void 0,(function*(){const i=[];for(const[o,r]of this.connections.entries())try{if(!(yield this.isConnectionActive({serverName:o,connection:r,flowManager:e,skipReconnect:!0}))){if(dataSchemas.logger.warn(`[MCP][${o}] Connection not available for ${o} manifest tools.`),"function"!=typeof a){dataSchemas.logger.warn(`[MCP][${o}] No \`getServerTools\` function provided, skipping tool loading.`);continue}const e=yield a(o);e&&e.length>0&&(dataSchemas.logger.info(`[MCP][${o}] Loaded tools from cache for manifest`),i.push(...e));continue}const s=yield r.fetchTools(),c=[];for(const e of s){const t=`${e.name}${CONSTANTS.mcp_delimiter}${o}`,a=this.mcpConfigs[o],s={name:e.name,pluginKey:t,description:null!==(n=e.description)&&void 0!==n?n:"",icon:r.iconPath,authConfig:(null==a?void 0:a.customUserVars)?Object.entries(a.customUserVars).map((([e,t])=>({authField:e,label:t.title||e,description:t.description||""}))):void 0};!1===(null==a?void 0:a.chatMenu)&&(s.chatMenu=!1),i.push(s),c.push(s)}"function"==typeof t&&(yield t(o,c))}catch(e){dataSchemas.logger.error(`[MCP][${o}] Error fetching tools for manifest:`,e)}return i}))}callTool({user:e,serverName:t,toolName:a,provider:n,toolArguments:i,options:o,tokenMethods:r,flowManager:s,oauthStart:c,oauthEnd:l,customUserVars:p}){return __awaiter(this,void 0,void 0,(function*(){let d;const u=null==e?void 0:e.id,m=u?`[MCP][User: ${u}][${t}]`:`[MCP][${t}]`;try{if(u&&e)this.updateUserLastActivity(u),d=yield this.getUserConnection({user:e,serverName:t,flowManager:s,tokenMethods:r,oauthStart:c,oauthEnd:l,signal:null==o?void 0:o.signal,customUserVars:p});else if(d=this.connections.get(t),!d)throw new types_js.McpError(types_js.ErrorCode.InvalidRequest,`${m} No app-level connection found. Cannot execute tool ${a}.`);if(!(yield d.isConnected()))throw new types_js.McpError(types_js.ErrorCode.InternalError,`${m} Connection is not active. Cannot execute tool ${a}.`);const h=yield d.client.request({method:"tools/call",params:{name:a,arguments:i}},types_js.CallToolResultSchema,Object.assign({timeout:d.timeout},o));return u&&this.updateUserLastActivity(u),this.checkIdleConnections(),formatToolContent(h,n)}catch(e){throw dataSchemas.logger.error(`${m}[${a}] Tool call failed`,e),e}}))}disconnectServer(e){return __awaiter(this,void 0,void 0,(function*(){const t=this.connections.get(e);t&&(dataSchemas.logger.info(`[MCP][${e}] Disconnecting...`),yield t.disconnect(),this.connections.delete(e))}))}disconnectAll(){return __awaiter(this,void 0,void 0,(function*(){dataSchemas.logger.info("[MCP] Disconnecting all app-level and user-level connections...");const e=Array.from(this.userConnections.keys()).map((e=>this.disconnectUserConnections(e)));yield Promise.allSettled(e),this.userLastActivity.clear();const t=Array.from(this.connections.values()).map((e=>e.disconnect().catch((t=>{dataSchemas.logger.error(`[MCP][${e.serverName}] Error during disconnectAll:`,t)}))));yield Promise.allSettled(t),this.connections.clear(),dataSchemas.logger.info("[MCP] All connections processed for disconnection.")}))}static destroyInstance(){return __awaiter(this,void 0,void 0,(function*(){MCPManager.instance&&(yield MCPManager.instance.disconnectAll(),MCPManager.instance=null,dataSchemas.logger.info("[MCP] Manager instance destroyed."))}))}getInstructions(e){const t={};if(e&&0!==e.length)for(const a of e){const e=this.serverInstructions.get(a);e&&(t[a]=e)}else for(const[e,a]of this.serverInstructions.entries())t[e]=a;return t}formatInstructionsForContext(e){const t=this.getInstructions(e);if(0===Object.keys(t).length)return"";return`# MCP Server Instructions\n\nThe following MCP servers are available with their specific instructions:\n\n${Object.entries(t).map((([e,t])=>`## ${e} MCP Server Instructions\n\n${t}`)).join("\n\n")}\n\nPlease follow these instructions when using tools from the respective MCP servers.`}handleOAuthRequired({serverName:e,serverUrl:t,flowManager:a,userId:n=CONSTANTS.SYSTEM_USER_ID,oauthStart:i,oauthEnd:o}){return __awaiter(this,void 0,void 0,(function*(){const r=`[MCP]${isSystemUserId(n)?"":`[User: ${n}]`}[${e}]`;if(dataSchemas.logger.debug(`${r} \`handleOAuthRequired\` called with serverUrl: ${t}`),!a||!t)return dataSchemas.logger.error(`${r} OAuth required but flow manager not available or server URL missing for ${e}`),dataSchemas.logger.warn(`${r} Please configure OAuth credentials for ${e}`),null;try{const s=this.mcpConfigs[e];dataSchemas.logger.debug(`${r} Checking for existing OAuth flow for ${e}...`);const c=MCPOAuthHandler.generateFlowId(n,e),l=yield a.getFlowState(c,"mcp_oauth");if(l&&"PENDING"===l.status){dataSchemas.logger.debug(`${r} OAuth flow already exists for ${c}, waiting for completion`);const t=yield a.createFlow(c,"mcp_oauth");"function"==typeof o&&(yield o()),dataSchemas.logger.info(`${r} OAuth flow completed, tokens received for ${e}`);const n=l.metadata;return{tokens:t,clientInfo:null==n?void 0:n.clientInfo}}dataSchemas.logger.debug(`${r} Initiating new OAuth flow for ${e}...`);const{authorizationUrl:p,flowId:d,flowMetadata:u}=yield MCPOAuthHandler.initiateOAuthFlow(e,t,n,null==s?void 0:s.oauth);"function"==typeof i?(dataSchemas.logger.info(`${r} OAuth flow started, issued authorization URL to user`),yield i(p)):dataSchemas.logger.info(`\n═══════════════════════════════════════════════════════════════════════\nPlease visit the following URL to authenticate:\n\n${p}\n\n${r} Flow ID: ${d}\n═══════════════════════════════════════════════════════════════════════\n`);const m=yield a.createFlow(d,"mcp_oauth",u);"function"==typeof o&&(yield o()),dataSchemas.logger.info(`${r} OAuth flow completed, tokens received for ${e}`);return{tokens:m,clientInfo:null==u?void 0:u.clientInfo}}catch(t){return dataSchemas.logger.error(`${r} Failed to complete OAuth flow for ${e}`,t),null}}))}}function getPluginAuthMap({userId:e,pluginKeys:t,throwError:a=!0,findPluginAuthsByKeys:n}){return __awaiter(this,void 0,void 0,(function*(){try{if(!(null==t?void 0:t.length))return{};const i=yield n({userId:e,pluginKeys:t}),o=new Map;for(const t of i){if(!t.pluginKey){dataSchemas.logger.warn(`[getPluginAuthMap] Missing pluginKey for userId ${e}`);continue}const a=o.get(t.pluginKey)||[];a.push(t),o.set(t.pluginKey,a)}const r={},s=[];for(const n of t){r[n]={};const t=o.get(n)||[];for(const i of t)s.push((()=>__awaiter(this,void 0,void 0,(function*(){try{const e=yield decrypt(i.value);r[n][i.authField]=e}catch(t){const o=t instanceof Error?t.message:"Unknown error";if(dataSchemas.logger.error(`[getPluginAuthMap] Decryption failed for userId ${e}, plugin ${n}, field ${i.authField}: ${o}`),a)throw new Error(`Decryption failed for plugin ${n}, field ${i.authField}: ${o}`)}})))())}return yield Promise.all(s),r}catch(n){if(!a)return t.reduce(((e,t)=>(e[t]={},e)),{});const i=n instanceof Error?n.message:"Unknown error";throw dataSchemas.logger.error(`[getPluginAuthMap] Failed to fetch auth values for userId ${e}, plugins: ${t.join(", ")}: ${i}`),n}}))}MCPManager.instance=null;const mcpToolPattern=new RegExp(`^.+${librechatDataProvider.Constants.mcp_delimiter}.+$`);function normalizeServerName(e){if(/^[a-zA-Z0-9_.-]+$/.test(e))return e;const t=e.replace(/[^a-zA-Z0-9_.-]/g,"_").replace(/^_+|_+$/g,"");if(!t){let t=0;for(let a=0;a<e.length;a++)t=(t<<5)-t+e.charCodeAt(a),t|=0;return`server_${Math.abs(t)}`}return t}function getUserMCPAuthMap({userId:e,tools:t,appTools:a,findPluginAuthsByKeys:n}){return __awaiter(this,void 0,void 0,(function*(){if(!t||0===t.length)return{};const i=new Set;for(const e of t){const t=e.name;if(t&&a[t]&&mcpToolPattern.test(t)){const e=t.split(librechatDataProvider.Constants.mcp_delimiter),a=e[e.length-1];i.add(`${librechatDataProvider.Constants.mcp_prefix}${a}`)}}if(0===i.size)return{};const o=Array.from(i);let r={};try{r=yield getPluginAuthMap({userId:e,pluginKeys:o,throwError:!1,findPluginAuthsByKeys:n})}catch(t){dataSchemas.logger.error(`[handleTools] Error batch fetching customUserVars for MCP tools (keys: ${o.join(", ")}), user ${e}: ${t instanceof Error?t.message:"Unknown error"}`,t)}return r}))}const logAxiosError=({message:e,error:t})=>{var a,n;let i=e;try{const o=t.stack||"No stack trace available";if(null===(a=t.response)||void 0===a?void 0:a.status){const{status:a,headers:n,data:r}=t.response;i=`${e} The server responded with status ${a}: ${t.message}`,dataSchemas.logger.error(i,{status:a,headers:n,data:r,stack:o})}else if(t.request){const{method:a,url:n}=t.config||{};i=`${e} No response received for ${a?a.toUpperCase():""} ${n||""}: ${t.message}`,dataSchemas.logger.error(i,{requestInfo:{method:a,url:n},stack:o})}else(null===(n=null==t?void 0:t.message)||void 0===n?void 0:n.includes("Cannot read properties of undefined (reading 'status')"))?(i=`${e} It appears the request timed out or was unsuccessful: ${t.message}`,dataSchemas.logger.error(i,{stack:o})):(i=`${e} An error occurred while setting up the request: ${t.message}`,dataSchemas.logger.error(i,{stack:o}))}catch(e){i=`Error in logAxiosError: ${e.message}`,dataSchemas.logger.error(i,{stack:e.stack||"No stack trace available"})}return i};function createAxiosInstance(){const e=axios$1.create();if(process.env.proxy)try{const t=new URL(process.env.proxy),a={host:t.hostname.replace(/^\[|\]$/g,""),protocol:t.protocol.replace(":","")};t.port&&(a.port=parseInt(t.port,10)),e.defaults.proxy=a}catch(e){throw console.error("Error parsing proxy URL:",e),new Error(`Invalid proxy URL: ${process.env.proxy}`)}return e}function isEnabled(e){return"boolean"==typeof e?e:"string"==typeof e&&"true"===e.toLowerCase().trim()}const isUserProvided=e=>"user_provided"===e;function optionalChainWithEmptyCheck(...e){for(const t of e)if(null!=t&&""!==t)return t;return e[e.length-1]}const sanitizeModelName=e=>e.replace(/\./g,""),genAzureEndpoint=({azureOpenAIApiInstanceName:e,azureOpenAIApiDeploymentName:t})=>`https://${e}.openai.azure.com/openai/deployments/${t}`,genAzureChatCompletion=({azureOpenAIApiInstanceName:e,azureOpenAIApiDeploymentName:t,azureOpenAIApiVersion:a},n,i)=>{let o;if(isEnabled(process.env.AZURE_USE_MODEL_AS_DEPLOYMENT_NAME)&&n){const e=sanitizeModelName(n);o=e,i&&"object"==typeof i&&(i.azure.azureOpenAIApiDeploymentName=e)}else if(t)o=t;else{if(!process.env.AZURE_OPENAI_BASEURL)throw new Error("Either a model name with the `AZURE_USE_MODEL_AS_DEPLOYMENT_NAME` setting or a deployment name must be provided if `AZURE_OPENAI_BASEURL` is omitted.");o=""}return`https://${e}.openai.azure.com/openai/deployments/${o}/chat/completions?api-version=${a}`},getAzureCredentials=()=>{var e;return{azureOpenAIApiKey:null!==(e=process.env.AZURE_API_KEY)&&void 0!==e?e:process.env.AZURE_OPENAI_API_KEY,azureOpenAIApiInstanceName:process.env.AZURE_OPENAI_API_INSTANCE_NAME,azureOpenAIApiDeploymentName:process.env.AZURE_OPENAI_API_DEPLOYMENT_NAME,azureOpenAIApiVersion:process.env.AZURE_OPENAI_API_VERSION}};function constructAzureURL({baseURL:e,azureOptions:t}){var a,n;let i=e;return t&&(i=i.replace("${INSTANCE_NAME}",null!==(a=t.azureOpenAIApiInstanceName)&&void 0!==a?a:""),i=i.replace("${DEPLOYMENT_NAME}",null!==(n=t.azureOpenAIApiDeploymentName)&&void 0!==n?n:"")),i}function sendEvent(e,t){"string"==typeof t.data&&0===t.data.length||e.write(`event: message\ndata: ${JSON.stringify(t)}\n\n`)}function handleError(e,t){e.write(`event: error\ndata: ${JSON.stringify(t)}\n\n`),e.end()}function sanitizeFilename(e){let t=path$2.basename(e);t=t.replace(/[^a-zA-Z0-9.-]/g,"_"),(t.startsWith(".")||""===t)&&(t="_"+t);if(t.length>255){const e=path$2.extname(t);t=path$2.basename(t,e).slice(0,255-e.length-7)+"-"+crypto$2.randomBytes(3).toString("hex")+e}return t}function createFetch({directEndpoint:e=!1,reverseProxyUrl:t=""}){return function(a,n){return __awaiter(this,void 0,void 0,(function*(){let i=a;return e&&(i=t),dataSchemas.logger.debug(`Making request to ${i}`),yield fetch$1(i,n)}))}}function createStreamEventHandlers(e){return{[agents.GraphEvents.ON_RUN_STEP]:function(t){e&&sendEvent(e,t)},[agents.GraphEvents.ON_MESSAGE_DELTA]:function(t){e&&sendEvent(e,t)},[agents.GraphEvents.ON_REASONING_DELTA]:function(t){e&&sendEvent(e,t)}}}function createHandleLLMNewToken(e){return function(){return __awaiter(this,void 0,void 0,(function*(){e&&(yield agents.sleep(e))}))}}function extractLibreChatParams(e){var t;if(!e)return{modelOptions:{},resendFiles:librechatDataProvider.librechat.resendFiles.default};const a=Object.assign({},e),n=null!==(delete a.resendFiles,t=e.resendFiles)&&void 0!==t?t:librechatDataProvider.librechat.resendFiles.default,i=(delete a.promptPrefix,e.promptPrefix),o=(delete a.maxContextTokens,e.maxContextTokens),r=(delete a.modelLabel,e.modelLabel);return{modelOptions:a,maxContextTokens:o,promptPrefix:i,resendFiles:n,modelLabel:r}}function math(str,fallbackValue){const fallback=void 0!==fallbackValue&&"number"==typeof fallbackValue;if("string"!=typeof str&&"number"==typeof str)return str;if("string"!=typeof str){if(fallback)return fallbackValue;throw new Error(`str is ${typeof str}, but should be a string`)}const validStr=/^[+\-\d.\s*/%()]+$/.test(str);if(!validStr){if(fallback)return fallbackValue;throw new Error("Invalid characters in string")}const value=eval(str);if("number"!=typeof value){if(fallback)return fallbackValue;throw new Error("[math] str did not evaluate to a number but to a "+typeof value)}return value}function safeStringify(e,t=1e3){try{const a=JSON.stringify(e,((e,t)=>"client_secret"===e||"Authorization"===e||e.toLowerCase().includes("token")||e.toLowerCase().includes("password")?"string"==typeof t&&t.length>6?`${t.substring(0,3)}...${t.substring(t.length-3)}`:"***MASKED***":t));return a&&a.length>t?`${a.substring(0,t)}... (truncated)`:a}catch(e){return`[Error stringifying object: ${e.message}]`}}function logHeaders(e){const t={};if(!e||"function"!=typeof e.entries)return"No headers available";for(const[a,n]of e.entries())"authorization"===a.toLowerCase()||a.toLowerCase().includes("secret")?t[a]="***MASKED***":t[a]=n;return safeStringify(t)}const DEFAULT_RETENTION_HOURS=720,MIN_RETENTION_HOURS=1,MAX_RETENTION_HOURS=8760;function getTempChatRetentionHours(e){var t;let a=DEFAULT_RETENTION_HOURS;if(process.env.TEMP_CHAT_RETENTION_HOURS){const e=parseInt(process.env.TEMP_CHAT_RETENTION_HOURS,10);isNaN(e)?dataSchemas.logger.warn(`Invalid TEMP_CHAT_RETENTION_HOURS environment variable: ${process.env.TEMP_CHAT_RETENTION_HOURS}. Using default: ${DEFAULT_RETENTION_HOURS} hours.`):a=e}if(void 0!==(null===(t=null==e?void 0:e.interface)||void 0===t?void 0:t.temporaryChatRetention)){const t=e.interface.temporaryChatRetention;"number"!=typeof t||isNaN(t)?dataSchemas.logger.warn(`Invalid temporaryChatRetention in config: ${t}. Using ${a} hours.`):a=t}return a<MIN_RETENTION_HOURS?(dataSchemas.logger.warn(`Temporary chat retention period ${a} is below minimum ${MIN_RETENTION_HOURS} hours. Using minimum value.`),a=MIN_RETENTION_HOURS):a>MAX_RETENTION_HOURS&&(dataSchemas.logger.warn(`Temporary chat retention period ${a} exceeds maximum ${MAX_RETENTION_HOURS} hours. Using maximum value.`),a=MAX_RETENTION_HOURS),a}function createTempChatExpirationDate(e){const t=getTempChatRetentionHours(e),a=new Date;return a.setHours(a.getHours()+t),a}class Tokenizer{constructor(){this.tokenizersCache={},this.tokenizerCallsCount=0}getTokenizer(e,t=!1,a={}){let n;return this.tokenizersCache[e]?n=this.tokenizersCache[e]:(n=t?tiktoken.encoding_for_model(e,a):tiktoken.get_encoding(e,a),this.tokenizersCache[e]=n),n}freeAndResetAllEncoders(){try{Object.keys(this.tokenizersCache).forEach((e=>{this.tokenizersCache[e]&&(this.tokenizersCache[e].free(),delete this.tokenizersCache[e])})),this.tokenizerCallsCount=1}catch(e){dataSchemas.logger.error("[Tokenizer] Free and reset encoders error",e)}}resetTokenizersIfNecessary(){var e;this.tokenizerCallsCount>=25&&((null===(e=this.options)||void 0===e?void 0:e.debug)&&dataSchemas.logger.debug("[Tokenizer] freeAndResetAllEncoders: reached 25 encodings, resetting..."),this.freeAndResetAllEncoders()),this.tokenizerCallsCount++}getTokenCount(e,t="cl100k_base"){this.resetTokenizersIfNecessary();try{return this.getTokenizer(t).encode(e,"all").length}catch(a){dataSchemas.logger.error("[Tokenizer] Error getting token count:",a),this.freeAndResetAllEncoders();return this.getTokenizer(t).encode(e,"all").length}}}const TokenizerSingleton=new Tokenizer;function loadYaml(e){try{const t=fs$2.readFileSync(e,"utf8");return yaml.load(t)}catch(e){return e}}function createHandleOAuthToken({findToken:e,updateToken:t,createToken:a}){return function({token:n,userId:i,identifier:o,expiresIn:r,metadata:s,type:c="oauth"}){return __awaiter(this,void 0,void 0,(function*(){const l=yield encryptV2(n);let p=3600;"number"==typeof r?p=r:null!=r&&(p=parseInt(r,10)||3600);const d={type:c,userId:i,metadata:s,identifier:o,token:l,expiresIn:p};return(yield e({userId:i,identifier:o}))?yield t({identifier:o},d):yield a(d)}))}}function processAccessTokens(e,{userId:t,identifier:a},{findToken:n,updateToken:i,createToken:o}){return __awaiter(this,void 0,void 0,(function*(){const{access_token:r,expires_in:s=3600,refresh_token:c,refresh_token_expires_in:l}=e;if(!r)throw dataSchemas.logger.error("Access token not found: ",e),new Error("Access token not found");const p=createHandleOAuthToken({findToken:n,updateToken:i,createToken:o});yield p({identifier:a,token:r,expiresIn:s,userId:t}),null!=c&&(dataSchemas.logger.debug("Processing refresh token"),yield p({token:c,type:"oauth_refresh",userId:t,identifier:`${a}:refresh`,expiresIn:null!=l?l:null})),dataSchemas.logger.debug("Access tokens processed")}))}function refreshAccessToken({userId:e,client_url:t,identifier:a,refresh_token:n,token_exchange_method:i,encrypted_oauth_client_id:o,encrypted_oauth_client_secret:r},{findToken:s,updateToken:c,createToken:l}){return __awaiter(this,void 0,void 0,(function*(){try{const p=yield decryptV2(o),d=yield decryptV2(r),u={"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},m=new URLSearchParams({grant_type:"refresh_token",refresh_token:n});if(i===librechatDataProvider.TokenExchangeMethodEnum.BasicAuthHeader){const e=Buffer.from(`${p}:${d}`).toString("base64");u.Authorization=`Basic ${e}`}else m.append("client_id",p),m.append("client_secret",d);const h=yield axios$1({method:"POST",url:t,headers:u,data:m.toString()});return yield processAccessTokens(h.data,{userId:e,identifier:a},{findToken:s,updateToken:c,createToken:l}),dataSchemas.logger.debug(`Access token refreshed successfully for ${a}`),h.data}catch(e){throw new Error(logAxiosError({message:"Error refreshing OAuth tokens",error:e}))}}))}function getAccessToken({code:e,userId:t,identifier:a,client_url:n,redirect_uri:i,token_exchange_method:o,encrypted_oauth_client_id:r,encrypted_oauth_client_secret:s},{findToken:c,updateToken:l,createToken:p}){return __awaiter(this,void 0,void 0,(function*(){const d=yield decryptV2(r),u=yield decryptV2(s),m={"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},h=new URLSearchParams({code:e,grant_type:"authorization_code",redirect_uri:i});if(o===librechatDataProvider.TokenExchangeMethodEnum.BasicAuthHeader){const e=Buffer.from(`${d}:${u}`).toString("base64");m.Authorization=`Basic ${e}`}else h.append("client_id",d),h.append("client_secret",u);try{const e=yield axios$1({method:"POST",url:n,headers:m,data:h.toString()});return yield processAccessTokens(e.data,{userId:t,identifier:a},{findToken:c,updateToken:l,createToken:p}),dataSchemas.logger.debug(`Access tokens successfully created for ${a}`),e.data}catch(e){throw new Error(logAxiosError({message:"Error exchanging OAuth code",error:e}))}}))}class FlowStateManager{constructor(e,t){t||(t={ttl:18e4});const{ci:a=!1,ttl:n}=t;if(!(a||e instanceof keyv.Keyv))throw new Error("Invalid store provided to FlowStateManager");this.ttl=n,this.keyv=e,this.intervals=new Set,this.setupCleanupHandlers()}setupCleanupHandlers(){const e=()=>{dataSchemas.logger.info("Cleaning up FlowStateManager intervals..."),this.intervals.forEach((e=>clearInterval(e))),this.intervals.clear(),process.exit(0)};process.on("SIGTERM",e),process.on("SIGINT",e),process.on("SIGQUIT",e),process.on("SIGHUP",e)}getFlowKey(e,t){return`${t}:${e}`}createFlow(e,t,a={},n){return __awaiter(this,void 0,void 0,(function*(){const i=this.getFlowKey(e,t);let o=yield this.keyv.get(i);if(o)return dataSchemas.logger.debug(`[${i}] Flow already exists`),this.monitorFlow(i,t,n);if(yield new Promise((e=>setTimeout(e,250))),o=yield this.keyv.get(i),o)return dataSchemas.logger.debug(`[${i}] Flow exists on 2nd check`),this.monitorFlow(i,t,n);const r={type:t,status:"PENDING",metadata:a,createdAt:Date.now()};return dataSchemas.logger.debug("Creating initial flow state:",i),yield this.keyv.set(i,r,this.ttl),this.monitorFlow(i,t,n)}))}monitorFlow(e,t,a){return new Promise(((n,i)=>{let o=0;const r=setInterval((()=>__awaiter(this,void 0,void 0,(function*(){var s;try{const c=yield this.keyv.get(e);if(!c)return clearInterval(r),this.intervals.delete(r),dataSchemas.logger.error(`[${e}] Flow state not found`),void i(new Error(`${t} Flow state not found`));if(null==a?void 0:a.aborted){clearInterval(r),this.intervals.delete(r),dataSchemas.logger.warn(`[${e}] Flow aborted`);const a=`${t} flow aborted`;return yield this.keyv.delete(e),void i(new Error(a))}if("PENDING"!==c.status)return clearInterval(r),this.intervals.delete(r),dataSchemas.logger.debug(`[${e}] Flow completed`),void("COMPLETED"===c.status&&void 0!==c.result?n(c.result):"FAILED"===c.status&&(yield this.keyv.delete(e),i(new Error(null!==(s=c.error)&&void 0!==s?s:`${t} flow failed`))));o+=2e3,o>=this.ttl&&(clearInterval(r),this.intervals.delete(r),dataSchemas.logger.error(`[${e}] Flow timed out | Elapsed time: ${o} | TTL: ${this.ttl}`),yield this.keyv.delete(e),i(new Error(`${t} flow timed out`))),dataSchemas.logger.debug(`[${e}] Flow state elapsed time: ${o}, checking again...`)}catch(t){dataSchemas.logger.error(`[${e}] Error checking flow state:`,t),clearInterval(r),this.intervals.delete(r),i(t)}}))),2e3);this.intervals.add(r)}))}completeFlow(e,t,a){return __awaiter(this,void 0,void 0,(function*(){const n=this.getFlowKey(e,t),i=yield this.keyv.get(n);if(!i)return!1;const o=Object.assign(Object.assign({},i),{status:"COMPLETED",result:a,completedAt:Date.now()});return yield this.keyv.set(n,o,this.ttl),!0}))}failFlow(e,t,a){return __awaiter(this,void 0,void 0,(function*(){const n=this.getFlowKey(e,t),i=yield this.keyv.get(n);if(!i)return!1;const o=Object.assign(Object.assign({},i),{status:"FAILED",error:a instanceof Error?a.message:a,failedAt:Date.now()});return yield this.keyv.set(n,o,this.ttl),!0}))}getFlowState(e,t){return __awaiter(this,void 0,void 0,(function*(){const a=this.getFlowKey(e,t);return this.keyv.get(a)}))}createFlowWithHandler(e,t,a,n){return __awaiter(this,void 0,void 0,(function*(){const i=this.getFlowKey(e,t);let o=yield this.keyv.get(i);if(o)return dataSchemas.logger.debug(`[${i}] Flow already exists`),this.monitorFlow(i,t,n);if(yield new Promise((e=>setTimeout(e,250))),o=yield this.keyv.get(i),o)return dataSchemas.logger.debug(`[${i}] Flow exists on 2nd check`),this.monitorFlow(i,t,n);const r={type:t,status:"PENDING",metadata:{},createdAt:Date.now()};dataSchemas.logger.debug(`[${i}] Creating initial flow state`),yield this.keyv.set(i,r,this.ttl);try{const n=yield a();return yield this.completeFlow(e,t,n),n}catch(a){throw yield this.failFlow(e,t,a instanceof Error?a:new Error(String(a))),a}}))}}function skipAgentCheck(e){var t,a;return!(!e||!(null===(t=null==e?void 0:e.body)||void 0===t?void 0:t.endpoint))&&("POST"===e.method&&(!!(null===(a=e.originalUrl)||void 0===a?void 0:a.includes(librechatDataProvider.EndpointURLs[librechatDataProvider.EModelEndpoint.agents]))&&!librechatDataProvider.isAgentsEndpoint(e.body.endpoint)))}const checkAccess=({req:e,user:t,permissionType:a,permissions:n,getRoleByName:i,bodyProps:o={},checkObject:r={},skipCheck:s})=>__awaiter(void 0,void 0,void 0,(function*(){if(s&&s(e))return!0;if(!t||!t.role)return!1;const c=yield i(t.role);if(c&&c.permissions&&c.permissions[a]){const e=n.some((e=>{var t,n;return!!(null===(n=null===(t=c.permissions)||void 0===t?void 0:t[a])||void 0===n?void 0:n[e])||!(!o[e]||!r)&&o[e].some((e=>Object.prototype.hasOwnProperty.call(r,e)))}));return e}return!1})),generateCheckAccess=({permissionType:e,permissions:t,bodyProps:a={},skipCheck:n,getRoleByName:i})=>(o,r,s)=>__awaiter(void 0,void 0,void 0,(function*(){var c;try{return(yield checkAccess({req:o,user:o.user,permissionType:e,permissions:t,bodyProps:a,checkObject:o.body,skipCheck:n,getRoleByName:i}))?s():(dataSchemas.logger.warn(`[${e}] Forbidden: "${o.originalUrl}" - Insufficient permissions for User ${null===(c=o.user)||void 0===c?void 0:c.id}: ${t.join(", ")}`),r.status(403).json({message:"Forbidden: Insufficient permissions"}))}catch(e){return dataSchemas.logger.error(e),r.status(500).json({message:`Server error: ${e instanceof Error?e.message:"Unknown error"}`})}}));function agentsConfigSetup(e,t){var a;const n=null===(a=null==e?void 0:e.endpoints)||void 0===a?void 0:a[librechatDataProvider.EModelEndpoint.agents];if(!n)return t||librechatDataProvider.agentsEndpointSchema.parse({});return librechatDataProvider.agentsEndpointSchema.parse(n)}function deepCompareStrict(e,t){const a=typeof e;if(a!==typeof t)return!1;if(Array.isArray(e)){if(!Array.isArray(t))return!1;const a=e.length;if(a!==t.length)return!1;for(let n=0;n<a;n++)if(!deepCompareStrict(e[n],t[n]))return!1;return!0}if("object"===a){if(!e||!t)return e===t;const a=Object.keys(e),n=Object.keys(t);if(a.length!==n.length)return!1;for(const n of a)if(!deepCompareStrict(e[n],t[n]))return!1;return!0}return e===t}function encodePointer(e){return encodeURI(escapePointer(e))}function escapePointer(e){return e.replace(/~/g,"~0").replace(/\//g,"~1")}const schemaArrayKeyword={prefixItems:!0,items:!0,allOf:!0,anyOf:!0,oneOf:!0},schemaMapKeyword={$defs:!0,definitions:!0,properties:!0,patternProperties:!0,dependentSchemas:!0},ignoredKeyword={id:!0,$id:!0,$ref:!0,$schema:!0,$anchor:!0,$vocabulary:!0,$comment:!0,default:!0,enum:!0,const:!0,required:!0,type:!0,maximum:!0,minimum:!0,exclusiveMaximum:!0,exclusiveMinimum:!0,multipleOf:!0,maxLength:!0,minLength:!0,pattern:!0,format:!0,maxItems:!0,minItems:!0,uniqueItems:!0,maxProperties:!0,minProperties:!0};let initialBaseURI="undefined"!=typeof self&&self.location&&"null"!==self.location.origin?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker");function dereference(e,t=Object.create(null),a=initialBaseURI,n=""){if(e&&"object"==typeof e&&!Array.isArray(e)){const i=e.$id||e.id;if(i){const o=new URL(i,a.href);o.hash.length>1?t[o.href]=e:(o.hash="",""===n?a=o:dereference(e,t,a))}}else if(!0!==e&&!1!==e)return t;const i=a.href+(n?"#"+n:"");if(void 0!==t[i])throw new Error(`Duplicate schema URI "${i}".`);if(t[i]=e,!0===e||!1===e)return t;if(void 0===e.__absolute_uri__&&Object.defineProperty(e,"__absolute_uri__",{enumerable:!1,value:i}),e.$ref&&void 0===e.__absolute_ref__){const t=new URL(e.$ref,a.href);t.hash=t.hash,Object.defineProperty(e,"__absolute_ref__",{enumerable:!1,value:t.href})}if(e.$recursiveRef&&void 0===e.__absolute_recursive_ref__){const t=new URL(e.$recursiveRef,a.href);t.hash=t.hash,Object.defineProperty(e,"__absolute_recursive_ref__",{enumerable:!1,value:t.href})}if(e.$anchor){t[new URL("#"+e.$anchor,a.href).href]=e}for(let i in e){if(ignoredKeyword[i])continue;const o=`${n}/${encodePointer(i)}`,r=e[i];if(Array.isArray(r)){if(schemaArrayKeyword[i]){const e=r.length;for(let n=0;n<e;n++)dereference(r[n],t,a,`${o}/${n}`)}}else if(schemaMapKeyword[i])for(let e in r)dereference(r[e],t,a,`${o}/${encodePointer(e)}`);else dereference(r,t,a,o)}return t}const DATE=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,DAYS=[0,31,28,31,30,31,30,31,31,30,31,30,31],TIME=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i,HOSTNAME=/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,URIREF=/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,URITEMPLATE=/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,URL_=/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu,UUID=/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,JSON_POINTER=/^(?:\/(?:[^~/]|~0|~1)*)*$/,JSON_POINTER_URI_FRAGMENT=/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,RELATIVE_JSON_POINTER=/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/,FASTDATE=/^\d\d\d\d-[0-1]\d-[0-3]\d$/,FASTTIME=/^(?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)?$/i,FASTDATETIME=/^\d\d\d\d-[0-1]\d-[0-3]\d[t\s](?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)$/i,FASTURIREFERENCE=/^(?:(?:[a-z][a-z0-9+-.]*:)?\/?\/)?(?:[^\\\s#][^\s#]*)?(?:#[^\\\s]*)?$/i,EMAIL=e=>{if('"'===e[0])return!1;const[t,a,...n]=e.split("@");return!(!t||!a||0!==n.length||t.length>64||a.length>253)&&("."!==t[0]&&!t.endsWith(".")&&!t.includes("..")&&(!(!/^[a-z0-9.-]+$/i.test(a)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(t))&&a.split(".").every((e=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(e)))))},IPV4=/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,IPV6=/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i,DURATION=e=>e.length>1&&e.length<80&&(/^P\d+([.,]\d+)?W$/.test(e)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(e)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(e));function bind(e){return e.test.bind(e)}const fullFormat={date:date,time:time.bind(void 0,!1),"date-time":date_time,duration:DURATION,uri:uri,"uri-reference":bind(URIREF),"uri-template":bind(URITEMPLATE),url:bind(URL_),email:EMAIL,hostname:bind(HOSTNAME),ipv4:bind(IPV4),ipv6:bind(IPV6),regex:regex,uuid:bind(UUID),"json-pointer":bind(JSON_POINTER),"json-pointer-uri-fragment":bind(JSON_POINTER_URI_FRAGMENT),"relative-json-pointer":bind(RELATIVE_JSON_POINTER)},fastFormat={...fullFormat,date:bind(FASTDATE),time:bind(FASTTIME),"date-time":bind(FASTDATETIME),"uri-reference":bind(FASTURIREFERENCE)};function isLeapYear(e){return e%4==0&&(e%100!=0||e%400==0)}function date(e){const t=e.match(DATE);if(!t)return!1;const a=+t[1],n=+t[2],i=+t[3];return n>=1&&n<=12&&i>=1&&i<=(2==n&&isLeapYear(a)?29:DAYS[n])}function time(e,t){const a=t.match(TIME);if(!a)return!1;const n=+a[1],i=+a[2],o=+a[3],r=!!a[5];return(n<=23&&i<=59&&o<=59||23==n&&59==i&&60==o)&&(!e||r)}const DATE_TIME_SEPARATOR=/t|\s/i;function date_time(e){const t=e.split(DATE_TIME_SEPARATOR);return 2==t.length&&date(t[0])&&time(!0,t[1])}const NOT_URI_FRAGMENT=/\/|:/,URI_PATTERN=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i;function uri(e){return NOT_URI_FRAGMENT.test(e)&&URI_PATTERN.test(e)}const Z_ANCHOR=/[^\\]\\Z/;function regex(e){if(Z_ANCHOR.test(e))return!1;try{return new RegExp(e,"u"),!0}catch(e){return!1}}function ucs2length(e){let t,a=0,n=e.length,i=0;for(;i<n;)a++,t=e.charCodeAt(i++),t>=55296&&t<=56319&&i<n&&(t=e.charCodeAt(i),56320==(64512&t)&&i++);return a}function validate$3(e,t,a="2019-09",n=dereference(t),i=!0,o=null,r="#",s="#",c=Object.create(null)){if(!0===t)return{valid:!0,errors:[]};if(!1===t)return{valid:!1,errors:[{instanceLocation:r,keyword:"false",keywordLocation:r,error:"False boolean schema."}]};const l=typeof e;let p;switch(l){case"boolean":case"number":case"string":p=l;break;case"object":p=null===e?"null":Array.isArray(e)?"array":"object";break;default:throw new Error(`Instances of "${l}" type are not supported.`)}const{$ref:d,$recursiveRef:u,$recursiveAnchor:m,type:h,const:f,enum:g,required:v,not:b,anyOf:y,allOf:_,oneOf:x,if:w,then:E,else:S,format:$,properties:T,patternProperties:O,additionalProperties:k,unevaluatedProperties:I,minProperties:A,maxProperties:R,propertyNames:C,dependentRequired:P,dependentSchemas:N,dependencies:j,prefixItems:L,items:M,additionalItems:D,unevaluatedItems:U,contains:F,minContains:z,maxContains:B,minItems:H,maxItems:q,uniqueItems:V,minimum:G,maximum:K,exclusiveMinimum:Z,exclusiveMaximum:J,multipleOf:W,minLength:Y,maxLength:X,pattern:Q,__absolute_ref__:ee,__absolute_recursive_ref__:te}=t,ae=[];if(!0===m&&null===o&&(o=t),"#"===u){const l=null===o?n[te]:o,p=`${s}/$recursiveRef`,d=validate$3(e,null===o?t:o,a,n,i,l,r,p,c);d.valid||ae.push({instanceLocation:r,keyword:"$recursiveRef",keywordLocation:p,error:"A subschema had errors."},...d.errors)}if(void 0!==d){const t=n[ee||d];if(void 0===t){let e=`Unresolved $ref "${d}".`;throw ee&&ee!==d&&(e+=`  Absolute URI "${ee}".`),e+=`\nKnown schemas:\n- ${Object.keys(n).join("\n- ")}`,new Error(e)}const l=`${s}/$ref`,p=validate$3(e,t,a,n,i,o,r,l,c);if(p.valid||ae.push({instanceLocation:r,keyword:"$ref",keywordLocation:l,error:"A subschema had errors."},...p.errors),"4"===a||"7"===a)return{valid:0===ae.length,errors:ae}}if(Array.isArray(h)){let t=h.length,a=!1;for(let n=0;n<t;n++)if(p===h[n]||"integer"===h[n]&&"number"===p&&e%1==0&&e==e){a=!0;break}a||ae.push({instanceLocation:r,keyword:"type",keywordLocation:`${s}/type`,error:`Instance type "${p}" is invalid. Expected "${h.join('", "')}".`})}else"integer"===h?("number"!==p||e%1||e!=e)&&ae.push({instanceLocation:r,keyword:"type",keywordLocation:`${s}/type`,error:`Instance type "${p}" is invalid. Expected "${h}".`}):void 0!==h&&p!==h&&ae.push({instanceLocation:r,keyword:"type",keywordLocation:`${s}/type`,error:`Instance type "${p}" is invalid. Expected "${h}".`});if(void 0!==f&&("object"===p||"array"===p?deepCompareStrict(e,f)||ae.push({instanceLocation:r,keyword:"const",keywordLocation:`${s}/const`,error:`Instance does not match ${JSON.stringify(f)}.`}):e!==f&&ae.push({instanceLocation:r,keyword:"const",keywordLocation:`${s}/const`,error:`Instance does not match ${JSON.stringify(f)}.`})),void 0!==g&&("object"===p||"array"===p?g.some((t=>deepCompareStrict(e,t)))||ae.push({instanceLocation:r,keyword:"enum",keywordLocation:`${s}/enum`,error:`Instance does not match any of ${JSON.stringify(g)}.`}):g.some((t=>e===t))||ae.push({instanceLocation:r,keyword:"enum",keywordLocation:`${s}/enum`,error:`Instance does not match any of ${JSON.stringify(g)}.`})),void 0!==b){const t=`${s}/not`;validate$3(e,b,a,n,i,o,r,t).valid&&ae.push({instanceLocation:r,keyword:"not",keywordLocation:t,error:'Instance matched "not" schema.'})}let ne=[];if(void 0!==y){const t=`${s}/anyOf`,l=ae.length;let p=!1;for(let s=0;s<y.length;s++){const l=y[s],d=Object.create(c),u=validate$3(e,l,a,n,i,!0===m?o:null,r,`${t}/${s}`,d);ae.push(...u.errors),p=p||u.valid,u.valid&&ne.push(d)}p?ae.length=l:ae.splice(l,0,{instanceLocation:r,keyword:"anyOf",keywordLocation:t,error:"Instance does not match any subschemas."})}if(void 0!==_){const t=`${s}/allOf`,l=ae.length;let p=!0;for(let s=0;s<_.length;s++){const l=_[s],d=Object.create(c),u=validate$3(e,l,a,n,i,!0===m?o:null,r,`${t}/${s}`,d);ae.push(...u.errors),p=p&&u.valid,u.valid&&ne.push(d)}p?ae.length=l:ae.splice(l,0,{instanceLocation:r,keyword:"allOf",keywordLocation:t,error:"Instance does not match every subschema."})}if(void 0!==x){const t=`${s}/oneOf`,l=ae.length,p=x.filter(((s,l)=>{const p=Object.create(c),d=validate$3(e,s,a,n,i,!0===m?o:null,r,`${t}/${l}`,p);return ae.push(...d.errors),d.valid&&ne.push(p),d.valid})).length;1===p?ae.length=l:ae.splice(l,0,{instanceLocation:r,keyword:"oneOf",keywordLocation:t,error:`Instance does not match exactly one subschema (${p} matches).`})}if("object"!==p&&"array"!==p||Object.assign(c,...ne),void 0!==w){const t=`${s}/if`;if(validate$3(e,w,a,n,i,o,r,t,c).valid){if(void 0!==E){const l=validate$3(e,E,a,n,i,o,r,`${s}/then`,c);l.valid||ae.push({instanceLocation:r,keyword:"if",keywordLocation:t,error:'Instance does not match "then" schema.'},...l.errors)}}else if(void 0!==S){const l=validate$3(e,S,a,n,i,o,r,`${s}/else`,c);l.valid||ae.push({instanceLocation:r,keyword:"if",keywordLocation:t,error:'Instance does not match "else" schema.'},...l.errors)}}if("object"===p){if(void 0!==v)for(const t of v)t in e||ae.push({instanceLocation:r,keyword:"required",keywordLocation:`${s}/required`,error:`Instance does not have required property "${t}".`});const t=Object.keys(e);if(void 0!==A&&t.length<A&&ae.push({instanceLocation:r,keyword:"minProperties",keywordLocation:`${s}/minProperties`,error:`Instance does not have at least ${A} properties.`}),void 0!==R&&t.length>R&&ae.push({instanceLocation:r,keyword:"maxProperties",keywordLocation:`${s}/maxProperties`,error:`Instance does not have at least ${R} properties.`}),void 0!==C){const t=`${s}/propertyNames`;for(const s in e){const e=`${r}/${encodePointer(s)}`,c=validate$3(s,C,a,n,i,o,e,t);c.valid||ae.push({instanceLocation:r,keyword:"propertyNames",keywordLocation:t,error:`Property name "${s}" does not match schema.`},...c.errors)}}if(void 0!==P){const t=`${s}/dependantRequired`;for(const a in P)if(a in e){const n=P[a];for(const i of n)i in e||ae.push({instanceLocation:r,keyword:"dependentRequired",keywordLocation:t,error:`Instance has "${a}" but does not have "${i}".`})}}if(void 0!==N)for(const t in N){const l=`${s}/dependentSchemas`;if(t in e){const s=validate$3(e,N[t],a,n,i,o,r,`${l}/${encodePointer(t)}`,c);s.valid||ae.push({instanceLocation:r,keyword:"dependentSchemas",keywordLocation:l,error:`Instance has "${t}" but does not match dependant schema.`},...s.errors)}}if(void 0!==j){const t=`${s}/dependencies`;for(const s in j)if(s in e){const c=j[s];if(Array.isArray(c))for(const a of c)a in e||ae.push({instanceLocation:r,keyword:"dependencies",keywordLocation:t,error:`Instance has "${s}" but does not have "${a}".`});else{const l=validate$3(e,c,a,n,i,o,r,`${t}/${encodePointer(s)}`);l.valid||ae.push({instanceLocation:r,keyword:"dependencies",keywordLocation:t,error:`Instance has "${s}" but does not match dependant schema.`},...l.errors)}}}const l=Object.create(null);let p=!1;if(void 0!==T){const t=`${s}/properties`;for(const s in T){if(!(s in e))continue;const d=`${r}/${encodePointer(s)}`,u=validate$3(e[s],T[s],a,n,i,o,d,`${t}/${encodePointer(s)}`);if(u.valid)c[s]=l[s]=!0;else if(p=i,ae.push({instanceLocation:r,keyword:"properties",keywordLocation:t,error:`Property "${s}" does not match schema.`},...u.errors),p)break}}if(!p&&void 0!==O){const t=`${s}/patternProperties`;for(const s in O){const d=new RegExp(s,"u"),u=O[s];for(const m in e){if(!d.test(m))continue;const h=`${r}/${encodePointer(m)}`,f=validate$3(e[m],u,a,n,i,o,h,`${t}/${encodePointer(s)}`);f.valid?c[m]=l[m]=!0:(p=i,ae.push({instanceLocation:r,keyword:"patternProperties",keywordLocation:t,error:`Property "${m}" matches pattern "${s}" but does not match associated schema.`},...f.errors))}}}if(p||void 0===k){if(!p&&void 0!==I){const t=`${s}/unevaluatedProperties`;for(const s in e)if(!c[s]){const l=`${r}/${encodePointer(s)}`,p=validate$3(e[s],I,a,n,i,o,l,t);p.valid?c[s]=!0:ae.push({instanceLocation:r,keyword:"unevaluatedProperties",keywordLocation:t,error:`Property "${s}" does not match unevaluated properties schema.`},...p.errors)}}}else{const t=`${s}/additionalProperties`;for(const s in e){if(l[s])continue;const d=`${r}/${encodePointer(s)}`,u=validate$3(e[s],k,a,n,i,o,d,t);u.valid?c[s]=!0:(p=i,ae.push({instanceLocation:r,keyword:"additionalProperties",keywordLocation:t,error:`Property "${s}" does not match additional properties schema.`},...u.errors))}}}else if("array"===p){void 0!==q&&e.length>q&&ae.push({instanceLocation:r,keyword:"maxItems",keywordLocation:`${s}/maxItems`,error:`Array has too many items (${e.length} > ${q}).`}),void 0!==H&&e.length<H&&ae.push({instanceLocation:r,keyword:"minItems",keywordLocation:`${s}/minItems`,error:`Array has too few items (${e.length} < ${H}).`});const t=e.length;let l=0,p=!1;if(void 0!==L){const d=`${s}/prefixItems`,u=Math.min(L.length,t);for(;l<u;l++){const t=validate$3(e[l],L[l],a,n,i,o,`${r}/${l}`,`${d}/${l}`);if(c[l]=!0,!t.valid&&(p=i,ae.push({instanceLocation:r,keyword:"prefixItems",keywordLocation:d,error:"Items did not match schema."},...t.errors),p))break}}if(void 0!==M){const d=`${s}/items`;if(Array.isArray(M)){const s=Math.min(M.length,t);for(;l<s;l++){const t=validate$3(e[l],M[l],a,n,i,o,`${r}/${l}`,`${d}/${l}`);if(c[l]=!0,!t.valid&&(p=i,ae.push({instanceLocation:r,keyword:"items",keywordLocation:d,error:"Items did not match schema."},...t.errors),p))break}}else for(;l<t;l++){const t=validate$3(e[l],M,a,n,i,o,`${r}/${l}`,d);if(c[l]=!0,!t.valid&&(p=i,ae.push({instanceLocation:r,keyword:"items",keywordLocation:d,error:"Items did not match schema."},...t.errors),p))break}if(!p&&void 0!==D){const d=`${s}/additionalItems`;for(;l<t;l++){const t=validate$3(e[l],D,a,n,i,o,`${r}/${l}`,d);c[l]=!0,t.valid||(p=i,ae.push({instanceLocation:r,keyword:"additionalItems",keywordLocation:d,error:"Items did not match additional items schema."},...t.errors))}}}if(void 0!==F)if(0===t&&void 0===z)ae.push({instanceLocation:r,keyword:"contains",keywordLocation:`${s}/contains`,error:"Array is empty. It must contain at least one item matching the schema."});else if(void 0!==z&&t<z)ae.push({instanceLocation:r,keyword:"minContains",keywordLocation:`${s}/minContains`,error:`Array has less items (${t}) than minContains (${z}).`});else{const l=`${s}/contains`,p=ae.length;let d=0;for(let s=0;s<t;s++){const t=validate$3(e[s],F,a,n,i,o,`${r}/${s}`,l);t.valid?(c[s]=!0,d++):ae.push(...t.errors)}d>=(z||0)&&(ae.length=p),void 0===z&&void 0===B&&0===d?ae.splice(p,0,{instanceLocation:r,keyword:"contains",keywordLocation:l,error:"Array does not contain item matching schema."}):void 0!==z&&d<z?ae.push({instanceLocation:r,keyword:"minContains",keywordLocation:`${s}/minContains`,error:`Array must contain at least ${z} items matching schema. Only ${d} items were found.`}):void 0!==B&&d>B&&ae.push({instanceLocation:r,keyword:"maxContains",keywordLocation:`${s}/maxContains`,error:`Array may contain at most ${B} items matching schema. ${d} items were found.`})}if(!p&&void 0!==U){const p=`${s}/unevaluatedItems`;for(;l<t;l++){if(c[l])continue;const t=validate$3(e[l],U,a,n,i,o,`${r}/${l}`,p);c[l]=!0,t.valid||ae.push({instanceLocation:r,keyword:"unevaluatedItems",keywordLocation:p,error:"Items did not match unevaluated items schema."},...t.errors)}}if(V)for(let a=0;a<t;a++){const n=e[a],i="object"==typeof n&&null!==n;for(let o=0;o<t;o++){if(a===o)continue;const t=e[o];(n===t||i&&("object"==typeof t&&null!==t)&&deepCompareStrict(n,t))&&(ae.push({instanceLocation:r,keyword:"uniqueItems",keywordLocation:`${s}/uniqueItems`,error:`Duplicate items at indexes ${a} and ${o}.`}),a=Number.MAX_SAFE_INTEGER,o=Number.MAX_SAFE_INTEGER)}}}else if("number"===p){if("4"===a?(void 0!==G&&(!0===Z&&e<=G||e<G)&&ae.push({instanceLocation:r,keyword:"minimum",keywordLocation:`${s}/minimum`,error:`${e} is less than ${Z?"or equal to ":""} ${G}.`}),void 0!==K&&(!0===J&&e>=K||e>K)&&ae.push({instanceLocation:r,keyword:"maximum",keywordLocation:`${s}/maximum`,error:`${e} is greater than ${J?"or equal to ":""} ${K}.`})):(void 0!==G&&e<G&&ae.push({instanceLocation:r,keyword:"minimum",keywordLocation:`${s}/minimum`,error:`${e} is less than ${G}.`}),void 0!==K&&e>K&&ae.push({instanceLocation:r,keyword:"maximum",keywordLocation:`${s}/maximum`,error:`${e} is greater than ${K}.`}),void 0!==Z&&e<=Z&&ae.push({instanceLocation:r,keyword:"exclusiveMinimum",keywordLocation:`${s}/exclusiveMinimum`,error:`${e} is less than ${Z}.`}),void 0!==J&&e>=J&&ae.push({instanceLocation:r,keyword:"exclusiveMaximum",keywordLocation:`${s}/exclusiveMaximum`,error:`${e} is greater than or equal to ${J}.`})),void 0!==W){const t=e%W;Math.abs(0-t)>=1.1920929e-7&&Math.abs(W-t)>=1.1920929e-7&&ae.push({instanceLocation:r,keyword:"multipleOf",keywordLocation:`${s}/multipleOf`,error:`${e} is not a multiple of ${W}.`})}}else if("string"===p){const t=void 0===Y&&void 0===X?0:ucs2length(e);void 0!==Y&&t<Y&&ae.push({instanceLocation:r,keyword:"minLength",keywordLocation:`${s}/minLength`,error:`String is too short (${t} < ${Y}).`}),void 0!==X&&t>X&&ae.push({instanceLocation:r,keyword:"maxLength",keywordLocation:`${s}/maxLength`,error:`String is too long (${t} > ${X}).`}),void 0===Q||new RegExp(Q,"u").test(e)||ae.push({instanceLocation:r,keyword:"pattern",keywordLocation:`${s}/pattern`,error:"String does not match pattern."}),void 0!==$&&fastFormat[$]&&!fastFormat[$](e)&&ae.push({instanceLocation:r,keyword:"format",keywordLocation:`${s}/format`,error:`String does not match format "${$}".`})}return{valid:0===ae.length,errors:ae}}var REGEX$1=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function validate$2(e){return"string"==typeof e&&REGEX$1.test(e)}for(var byteToHex$1=[],i$2=0,getRandomValues$1;i$2<256;++i$2)byteToHex$1.push((i$2+256).toString(16).slice(1));function unsafeStringify$1(e,t=0){return(byteToHex$1[e[t+0]]+byteToHex$1[e[t+1]]+byteToHex$1[e[t+2]]+byteToHex$1[e[t+3]]+"-"+byteToHex$1[e[t+4]]+byteToHex$1[e[t+5]]+"-"+byteToHex$1[e[t+6]]+byteToHex$1[e[t+7]]+"-"+byteToHex$1[e[t+8]]+byteToHex$1[e[t+9]]+"-"+byteToHex$1[e[t+10]]+byteToHex$1[e[t+11]]+byteToHex$1[e[t+12]]+byteToHex$1[e[t+13]]+byteToHex$1[e[t+14]]+byteToHex$1[e[t+15]]).toLowerCase()}var rnds8$1=new Uint8Array(16);function rng$1(){if(!getRandomValues$1&&!(getRandomValues$1="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return getRandomValues$1(rnds8$1)}var randomUUID$1="undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),native$1={randomUUID:randomUUID$1};function v4$1(e,t,a){if(native$1.randomUUID&&!e)return native$1.randomUUID();var n=(e=e||{}).random||(e.rng||rng$1)();return n[6]=15&n[6]|64,n[8]=63&n[8]|128,unsafeStringify$1(n)}var decamelize=function(e,t){if("string"!=typeof e)throw new TypeError("Expected a string");return t=void 0===t?"_":t,e.replace(/([a-z\d])([A-Z])/g,"$1"+t+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+t+"$2").toLowerCase()},snakeCase=getDefaultExportFromCjs(decamelize),camelcase={exports:{}};const UPPERCASE=/[\p{Lu}]/u,LOWERCASE=/[\p{Ll}]/u,LEADING_CAPITAL=/^[\p{Lu}](?![\p{Lu}])/gu,IDENTIFIER=/([\p{Alpha}\p{N}_]|$)/u,SEPARATORS=/[_.\- ]+/,LEADING_SEPARATORS=new RegExp("^"+SEPARATORS.source),SEPARATORS_AND_IDENTIFIER=new RegExp(SEPARATORS.source+IDENTIFIER.source,"gu"),NUMBERS_AND_IDENTIFIER=new RegExp("\\d+"+IDENTIFIER.source,"gu"),preserveCamelCase=(e,t,a)=>{let n=!1,i=!1,o=!1;for(let r=0;r<e.length;r++){const s=e[r];n&&UPPERCASE.test(s)?(e=e.slice(0,r)+"-"+e.slice(r),n=!1,o=i,i=!0,r++):i&&o&&LOWERCASE.test(s)?(e=e.slice(0,r-1)+"-"+e.slice(r-1),o=i,i=!1,n=!0):(n=t(s)===s&&a(s)!==s,o=i,i=a(s)===s&&t(s)!==s)}return e},preserveConsecutiveUppercase=(e,t)=>(LEADING_CAPITAL.lastIndex=0,e.replace(LEADING_CAPITAL,(e=>t(e)))),postProcess=(e,t)=>(SEPARATORS_AND_IDENTIFIER.lastIndex=0,NUMBERS_AND_IDENTIFIER.lastIndex=0,e.replace(SEPARATORS_AND_IDENTIFIER,((e,a)=>t(a))).replace(NUMBERS_AND_IDENTIFIER,(e=>t(e)))),camelCase=(e,t)=>{if("string"!=typeof e&&!Array.isArray(e))throw new TypeError("Expected the input to be `string | string[]`");if(t={pascalCase:!1,preserveConsecutiveUppercase:!1,...t},0===(e=Array.isArray(e)?e.map((e=>e.trim())).filter((e=>e.length)).join("-"):e.trim()).length)return"";const a=!1===t.locale?e=>e.toLowerCase():e=>e.toLocaleLowerCase(t.locale),n=!1===t.locale?e=>e.toUpperCase():e=>e.toLocaleUpperCase(t.locale);if(1===e.length)return t.pascalCase?n(e):a(e);return e!==a(e)&&(e=preserveCamelCase(e,a,n)),e=e.replace(LEADING_SEPARATORS,""),e=t.preserveConsecutiveUppercase?preserveConsecutiveUppercase(e,a):a(e),t.pascalCase&&(e=n(e.charAt(0))+e.slice(1)),postProcess(e,n)};function keyToJson(e,t){return t?.[e]||snakeCase(e)}function mapKeys(e,t,a){const n={};for(const i in e)Object.hasOwn(e,i)&&(n[t(i,a)]=e[i]);return n}function shallowCopy(e){return Array.isArray(e)?[...e]:{...e}}function replaceSecrets(e,t){const a=shallowCopy(e);for(const[e,n]of Object.entries(t)){const[t,...i]=e.split(".").reverse();let o=a;for(const e of i.reverse()){if(void 0===o[e])break;o[e]=shallowCopy(o[e]),o=o[e]}void 0!==o[t]&&(o[t]={lc:1,type:"secret",id:[n]})}return a}function get_lc_unique_name(e){const t=Object.getPrototypeOf(e);return"function"==typeof e.lc_name&&("function"!=typeof t.lc_name||e.lc_name()!==t.lc_name())?e.lc_name():e.name}camelcase.exports=camelCase,camelcase.exports.default=camelCase;class Serializable{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,get_lc_unique_name(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),void 0!==this.lc_serializable_keys?this.lc_kwargs=Object.fromEntries(Object.entries(e||{}).filter((([e])=>this.lc_serializable_keys?.includes(e)))):this.lc_kwargs=e??{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof Serializable||"object"!=typeof this.lc_kwargs||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},a=Object.keys(this.lc_kwargs).reduce(((e,t)=>(e[t]=t in this?this[t]:this.lc_kwargs[t],e)),{});for(let n=Object.getPrototypeOf(this);n;n=Object.getPrototypeOf(n))Object.assign(e,Reflect.get(n,"lc_aliases",this)),Object.assign(t,Reflect.get(n,"lc_secrets",this)),Object.assign(a,Reflect.get(n,"lc_attributes",this));return Object.keys(t).forEach((e=>{let t=this,n=a;const[i,...o]=e.split(".").reverse();for(const e of o.reverse()){if(!(e in t)||void 0===t[e])return;e in n&&void 0!==n[e]||("object"==typeof t[e]&&null!=t[e]?n[e]={}:Array.isArray(t[e])&&(n[e]=[])),t=t[e],n=n[e]}i in t&&void 0!==t[i]&&(n[i]=n[i]||t[i])})),{lc:1,type:"constructor",id:this.lc_id,kwargs:mapKeys(Object.keys(t).length?replaceSecrets(a,t):a,keyToJson,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}const isBrowser$1=()=>"undefined"!=typeof window&&void 0!==window.document,isWebWorker$1=()=>"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name,isJsDom$1=()=>"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&navigator.userAgent.includes("jsdom"),isDeno$1=()=>"undefined"!=typeof Deno,isNode$1=()=>"undefined"!=typeof process&&void 0!==process.versions&&void 0!==process.versions.node&&!isDeno$1(),getEnv$1=()=>{let e;return e=isBrowser$1()?"browser":isNode$1()?"node":isWebWorker$1()?"webworker":isJsDom$1()?"jsdom":isDeno$1()?"deno":"other",e};let runtimeEnvironment$1;function getRuntimeEnvironmentSync(){if(void 0===runtimeEnvironment$1){const e=getEnv$1();runtimeEnvironment$1={library:"langchain-js",runtime:e}}return runtimeEnvironment$1}function getEnvironmentVariable$1(e){try{return"undefined"!=typeof process?process.env?.[e]:isDeno$1()?Deno?.env.get(e):void 0}catch(e){return}}class BaseCallbackHandlerMethodsClass{}class BaseCallbackHandler extends BaseCallbackHandlerMethodsClass{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,get_lc_unique_name(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:"false"===getEnvironmentVariable$1("LANGCHAIN_CALLBACKS_BACKGROUND")}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return Serializable.prototype.toJSON.call(this)}toJSONNotImplemented(){return Serializable.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){return new class extends BaseCallbackHandler{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:v4$1()}),Object.assign(this,e)}}}}const isBaseCallbackHandler=e=>{const t=e;return void 0!==t&&"function"==typeof t.copy&&"string"==typeof t.name&&"boolean"==typeof t.awaitHandlers};var ansiStyles={exports:{}};ansiStyles.exports,function(e){const t=(e=0)=>t=>`[${38+e};5;${t}m`,a=(e=0)=>(t,a,n)=>`[${38+e};2;${t};${a};${n}m`;Object.defineProperty(e,"exports",{enumerable:!0,get:function(){const e=new Map,n={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};n.color.gray=n.color.blackBright,n.bgColor.bgGray=n.bgColor.bgBlackBright,n.color.grey=n.color.blackBright,n.bgColor.bgGrey=n.bgColor.bgBlackBright;for(const[t,a]of Object.entries(n)){for(const[t,i]of Object.entries(a))n[t]={open:`[${i[0]}m`,close:`[${i[1]}m`},a[t]=n[t],e.set(i[0],i[1]);Object.defineProperty(n,t,{value:a,enumerable:!1})}return Object.defineProperty(n,"codes",{value:e,enumerable:!1}),n.color.close="[39m",n.bgColor.close="[49m",n.color.ansi256=t(),n.color.ansi16m=a(),n.bgColor.ansi256=t(10),n.bgColor.ansi16m=a(10),Object.defineProperties(n,{rgbToAnsi256:{value:(e,t,a)=>e===t&&t===a?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(a/255*5),enumerable:!1},hexToRgb:{value:e=>{const t=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(e.toString(16));if(!t)return[0,0,0];let{colorString:a}=t.groups;3===a.length&&(a=a.split("").map((e=>e+e)).join(""));const n=Number.parseInt(a,16);return[n>>16&255,n>>8&255,255&n]},enumerable:!1},hexToAnsi256:{value:e=>n.rgbToAnsi256(...n.hexToRgb(e)),enumerable:!1}}),n}})}(ansiStyles);var ansiStylesExports=ansiStyles.exports,styles=getDefaultExportFromCjs(ansiStylesExports),REGEX=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function validate$1(e){return"string"==typeof e&&REGEX.test(e)}function parse(e){if(!validate$1(e))throw TypeError("Invalid UUID");var t,a=new Uint8Array(16);return a[0]=(t=parseInt(e.slice(0,8),16))>>>24,a[1]=t>>>16&255,a[2]=t>>>8&255,a[3]=255&t,a[4]=(t=parseInt(e.slice(9,13),16))>>>8,a[5]=255&t,a[6]=(t=parseInt(e.slice(14,18),16))>>>8,a[7]=255&t,a[8]=(t=parseInt(e.slice(19,23),16))>>>8,a[9]=255&t,a[10]=(t=parseInt(e.slice(24,36),16))/1099511627776&255,a[11]=t/4294967296&255,a[12]=t>>>24&255,a[13]=t>>>16&255,a[14]=t>>>8&255,a[15]=255&t,a}for(var byteToHex=[],i$1=0,getRandomValues;i$1<256;++i$1)byteToHex.push((i$1+256).toString(16).slice(1));function unsafeStringify(e,t=0){return(byteToHex[e[t+0]]+byteToHex[e[t+1]]+byteToHex[e[t+2]]+byteToHex[e[t+3]]+"-"+byteToHex[e[t+4]]+byteToHex[e[t+5]]+"-"+byteToHex[e[t+6]]+byteToHex[e[t+7]]+"-"+byteToHex[e[t+8]]+byteToHex[e[t+9]]+"-"+byteToHex[e[t+10]]+byteToHex[e[t+11]]+byteToHex[e[t+12]]+byteToHex[e[t+13]]+byteToHex[e[t+14]]+byteToHex[e[t+15]]).toLowerCase()}var rnds8=new Uint8Array(16);function rng(){if(!getRandomValues&&!(getRandomValues="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return getRandomValues(rnds8)}function stringToBytes(e){e=unescape(encodeURIComponent(e));for(var t=[],a=0;a<e.length;++a)t.push(e.charCodeAt(a));return t}var DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8",URL$1="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function v35(e,t,a){function n(e,n,i,o){var r;if("string"==typeof e&&(e=stringToBytes(e)),"string"==typeof n&&(n=parse(n)),16!==(null===(r=n)||void 0===r?void 0:r.length))throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var s=new Uint8Array(16+e.length);if(s.set(n),s.set(e,n.length),(s=a(s))[6]=15&s[6]|t,s[8]=63&s[8]|128,i){o=o||0;for(var c=0;c<16;++c)i[o+c]=s[c];return i}return unsafeStringify(s)}try{n.name=e}catch(e){}return n.DNS=DNS,n.URL=URL$1,n}var randomUUID="undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),native={randomUUID:randomUUID};function v4(e,t,a){if(native.randomUUID&&!e)return native.randomUUID();var n=(e=e||{}).random||(e.rng||rng)();return n[6]=15&n[6]|64,n[8]=63&n[8]|128,unsafeStringify(n)}function f(e,t,a,n){switch(e){case 0:return t&a^~t&n;case 1:case 3:return t^a^n;case 2:return t&a^t&n^a&n}}function ROTL(e,t){return e<<t|e>>>32-t}function sha1(e){var t=[1518500249,1859775393,2400959708,3395469782],a=[1732584193,4023233417,2562383102,271733878,3285377520];if("string"==typeof e){var n=unescape(encodeURIComponent(e));e=[];for(var i=0;i<n.length;++i)e.push(n.charCodeAt(i))}else Array.isArray(e)||(e=Array.prototype.slice.call(e));e.push(128);for(var o=e.length/4+2,r=Math.ceil(o/16),s=new Array(r),c=0;c<r;++c){for(var l=new Uint32Array(16),p=0;p<16;++p)l[p]=e[64*c+4*p]<<24|e[64*c+4*p+1]<<16|e[64*c+4*p+2]<<8|e[64*c+4*p+3];s[c]=l}s[r-1][14]=8*(e.length-1)/Math.pow(2,32),s[r-1][14]=Math.floor(s[r-1][14]),s[r-1][15]=8*(e.length-1)&4294967295;for(var d=0;d<r;++d){for(var u=new Uint32Array(80),m=0;m<16;++m)u[m]=s[d][m];for(var h=16;h<80;++h)u[h]=ROTL(u[h-3]^u[h-8]^u[h-14]^u[h-16],1);for(var g=a[0],v=a[1],b=a[2],y=a[3],_=a[4],x=0;x<80;++x){var w=Math.floor(x/20),E=ROTL(g,5)+f(w,v,b,y)+_+t[w]+u[x]>>>0;_=y,y=b,b=ROTL(v,30)>>>0,v=g,g=E}a[0]=a[0]+g>>>0,a[1]=a[1]+v>>>0,a[2]=a[2]+b>>>0,a[3]=a[3]+y>>>0,a[4]=a[4]+_>>>0}return[a[0]>>24&255,a[0]>>16&255,a[0]>>8&255,255&a[0],a[1]>>24&255,a[1]>>16&255,a[1]>>8&255,255&a[1],a[2]>>24&255,a[2]>>16&255,a[2]>>8&255,255&a[2],a[3]>>24&255,a[3]>>16&255,a[3]>>8&255,255&a[3],a[4]>>24&255,a[4]>>16&255,a[4]>>8&255,255&a[4]]}var v5=v35("v5",80,sha1),pRetry$2={exports:{}},retry$2={};function RetryOperation(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var retry_operation=RetryOperation;RetryOperation.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},RetryOperation.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},RetryOperation.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var a=this._timeouts.shift();if(void 0===a){if(!this._cachedTimeouts)return!1;this._errors.splice(0,this._errors.length-1),a=this._cachedTimeouts.slice(-1)}var n=this;return this._timer=setTimeout((function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout((function(){n._operationTimeoutCb(n._attempts)}),n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)}),a),this._options.unref&&this._timer.unref(),!0},RetryOperation.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var a=this;this._operationTimeoutCb&&(this._timeout=setTimeout((function(){a._operationTimeoutCb()}),a._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},RetryOperation.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},RetryOperation.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},RetryOperation.prototype.start=RetryOperation.prototype.try,RetryOperation.prototype.errors=function(){return this._errors},RetryOperation.prototype.attempts=function(){return this._attempts},RetryOperation.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,a=0,n=0;n<this._errors.length;n++){var i=this._errors[n],o=i.message,r=(e[o]||0)+1;e[o]=r,r>=a&&(t=i,a=r)}return t},function(e){var t=retry_operation;e.operation=function(a){var n=e.timeouts(a);return new t(n,{forever:a&&(a.forever||a.retries===1/0),unref:a&&a.unref,maxRetryTime:a&&a.maxRetryTime})},e.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var a in e)t[a]=e[a];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var n=[],i=0;i<t.retries;i++)n.push(this.createTimeout(i,t));return e&&e.forever&&!n.length&&n.push(this.createTimeout(i,t)),n.sort((function(e,t){return e-t})),n},e.createTimeout=function(e,t){var a=t.randomize?Math.random()+1:1,n=Math.round(a*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return n=Math.min(n,t.maxTimeout)},e.wrap=function(t,a,n){if(a instanceof Array&&(n=a,a=null),!n)for(var i in n=[],t)"function"==typeof t[i]&&n.push(i);for(var o=0;o<n.length;o++){var r=n[o],s=t[r];t[r]=function(n){var i=e.operation(a),o=Array.prototype.slice.call(arguments,1),r=o.pop();o.push((function(e){i.retry(e)||(e&&(arguments[0]=i.mainError()),r.apply(this,arguments))})),i.attempt((function(){n.apply(t,o)}))}.bind(t,s),t[r].options=a}}}(retry$2);var retry$1=retry$2;const retry=retry$1,networkErrorMsgs=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class AbortError extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const decorateErrorWithCounts=(e,t,a)=>{const n=a.retries-(t-1);return e.attemptNumber=t,e.retriesLeft=n,e},isNetworkError=e=>networkErrorMsgs.includes(e),pRetry=(e,t)=>new Promise(((a,n)=>{t={onFailedAttempt:()=>{},retries:10,...t};const i=retry.operation(t);i.attempt((async o=>{try{a(await e(o))}catch(e){if(!(e instanceof Error))return void n(new TypeError(`Non-error was thrown: "${e}". You should only throw errors.`));if(e instanceof AbortError)i.stop(),n(e.originalError);else if(e instanceof TypeError&&!isNetworkError(e.message))i.stop(),n(e);else{decorateErrorWithCounts(e,o,t);try{await t.onFailedAttempt(e)}catch(e){return void n(e)}i.retry(e)||n(i.mainError())}}}))}));pRetry$2.exports=pRetry,pRetry$2.exports.default=pRetry,pRetry$2.exports.AbortError=AbortError;var pRetryExports=pRetry$2.exports,pRetry$1=getDefaultExportFromCjs(pRetryExports),dist={},eventemitter3={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,a="~";function n(){}function i(e,t,a){this.fn=e,this.context=t,this.once=a||!1}function o(e,t,n,o,r){if("function"!=typeof n)throw new TypeError("The listener must be a function");var s=new i(n,o||e,r),c=a?a+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],s]:e._events[c].push(s):(e._events[c]=s,e._eventsCount++),e}function r(e,t){0==--e._eventsCount?e._events=new n:delete e._events[t]}function s(){this._events=new n,this._eventsCount=0}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(a=!1)),s.prototype.eventNames=function(){var e,n,i=[];if(0===this._eventsCount)return i;for(n in e=this._events)t.call(e,n)&&i.push(a?n.slice(1):n);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},s.prototype.listeners=function(e){var t=a?a+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var i=0,o=n.length,r=new Array(o);i<o;i++)r[i]=n[i].fn;return r},s.prototype.listenerCount=function(e){var t=a?a+e:e,n=this._events[t];return n?n.fn?1:n.length:0},s.prototype.emit=function(e,t,n,i,o,r){var s=a?a+e:e;if(!this._events[s])return!1;var c,l,p=this._events[s],d=arguments.length;if(p.fn){switch(p.once&&this.removeListener(e,p.fn,void 0,!0),d){case 1:return p.fn.call(p.context),!0;case 2:return p.fn.call(p.context,t),!0;case 3:return p.fn.call(p.context,t,n),!0;case 4:return p.fn.call(p.context,t,n,i),!0;case 5:return p.fn.call(p.context,t,n,i,o),!0;case 6:return p.fn.call(p.context,t,n,i,o,r),!0}for(l=1,c=new Array(d-1);l<d;l++)c[l-1]=arguments[l];p.fn.apply(p.context,c)}else{var u,m=p.length;for(l=0;l<m;l++)switch(p[l].once&&this.removeListener(e,p[l].fn,void 0,!0),d){case 1:p[l].fn.call(p[l].context);break;case 2:p[l].fn.call(p[l].context,t);break;case 3:p[l].fn.call(p[l].context,t,n);break;case 4:p[l].fn.call(p[l].context,t,n,i);break;default:if(!c)for(u=1,c=new Array(d-1);u<d;u++)c[u-1]=arguments[u];p[l].fn.apply(p[l].context,c)}}return!0},s.prototype.on=function(e,t,a){return o(this,e,t,a,!1)},s.prototype.once=function(e,t,a){return o(this,e,t,a,!0)},s.prototype.removeListener=function(e,t,n,i){var o=a?a+e:e;if(!this._events[o])return this;if(!t)return r(this,o),this;var s=this._events[o];if(s.fn)s.fn!==t||i&&!s.once||n&&s.context!==n||r(this,o);else{for(var c=0,l=[],p=s.length;c<p;c++)(s[c].fn!==t||i&&!s[c].once||n&&s[c].context!==n)&&l.push(s[c]);l.length?this._events[o]=1===l.length?l[0]:l:r(this,o)}return this},s.prototype.removeAllListeners=function(e){var t;return e?(t=a?a+e:e,this._events[t]&&r(this,t)):(this._events=new n,this._eventsCount=0),this},s.prototype.off=s.prototype.removeListener,s.prototype.addListener=s.prototype.on,s.prefixed=a,s.EventEmitter=s,e.exports=s}(eventemitter3);var eventemitter3Exports=eventemitter3.exports,pTimeout$1={exports:{}},pFinally$1=(e,t)=>(t=t||(()=>{}),e.then((e=>new Promise((e=>{e(t())})).then((()=>e))),(e=>new Promise((e=>{e(t())})).then((()=>{throw e})))));const pFinally=pFinally$1;class TimeoutError extends Error{constructor(e){super(e),this.name="TimeoutError"}}const pTimeout=(e,t,a)=>new Promise(((n,i)=>{if("number"!=typeof t||t<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(t===1/0)return void n(e);const o=setTimeout((()=>{if("function"==typeof a){try{n(a())}catch(e){i(e)}return}const o=a instanceof Error?a:new TimeoutError("string"==typeof a?a:`Promise timed out after ${t} milliseconds`);"function"==typeof e.cancel&&e.cancel(),i(o)}),t);pFinally(e.then(n,i),(()=>{clearTimeout(o)}))}));pTimeout$1.exports=pTimeout,pTimeout$1.exports.default=pTimeout,pTimeout$1.exports.TimeoutError=TimeoutError;var pTimeoutExports=pTimeout$1.exports,priorityQueue={},lowerBound$1={};function lowerBound(e,t,a){let n=0,i=e.length;for(;i>0;){const o=i/2|0;let r=n+o;a(e[r],t)<=0?(n=++r,i-=o+1):i=o}return n}Object.defineProperty(lowerBound$1,"__esModule",{value:!0}),lowerBound$1.default=lowerBound,Object.defineProperty(priorityQueue,"__esModule",{value:!0});const lower_bound_1=lowerBound$1;class PriorityQueue{constructor(){this._queue=[]}enqueue(e,t){const a={priority:(t=Object.assign({priority:0},t)).priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority)return void this._queue.push(a);const n=lower_bound_1.default(this._queue,a,((e,t)=>t.priority-e.priority));this._queue.splice(n,0,a)}dequeue(){const e=this._queue.shift();return null==e?void 0:e.run}filter(e){return this._queue.filter((t=>t.priority===e.priority)).map((e=>e.run))}get size(){return this._queue.length}}priorityQueue.default=PriorityQueue,Object.defineProperty(dist,"__esModule",{value:!0});const EventEmitter=eventemitter3Exports,p_timeout_1=pTimeoutExports,priority_queue_1=priorityQueue,empty=()=>{},timeoutError=new p_timeout_1.TimeoutError;class PQueue extends EventEmitter{constructor(e){var t,a,n,i;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=empty,this._resolveIdle=empty,!("number"==typeof(e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:priority_queue_1.default},e)).intervalCap&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${null!==(a=null===(t=e.intervalCap)||void 0===t?void 0:t.toString())&&void 0!==a?a:""}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${null!==(i=null===(n=e.interval)||void 0===n?void 0:n.toString())&&void 0!==i?i:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||0===e.interval,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=!0===e.throwOnTimeout,this._isPaused=!1===e.autoStart}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=empty,0===this._pendingCount&&(this._resolveIdle(),this._resolveIdle=empty,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(void 0===this._intervalId){const t=this._intervalEnd-e;if(!(t<0))return void 0===this._timeoutId&&(this._timeoutId=setTimeout((()=>{this._onResumeInterval()}),t)),!0;this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0}return!1}_tryToStartAnother(){if(0===this._queue.size)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return!!t&&(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0)}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||void 0!==this._intervalId||(this._intervalId=setInterval((()=>{this._onInterval()}),this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){0===this._intervalCount&&0===this._pendingCount&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!("number"==typeof e&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise(((a,n)=>{this._queue.enqueue((async()=>{this._pendingCount++,this._intervalCount++;try{const i=void 0===this._timeout&&void 0===t.timeout?e():p_timeout_1.default(Promise.resolve(e()),void 0===t.timeout?this._timeout:t.timeout,(()=>{(void 0===t.throwOnTimeout?this._throwOnTimeout:t.throwOnTimeout)&&n(timeoutError)}));a(await i)}catch(e){n(e)}this._next()}),t),this._tryToStartAnother(),this.emit("add")}))}async addAll(e,t){return Promise.all(e.map((async e=>this.add(e,t))))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(0!==this._queue.size)return new Promise((e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}}))}async onIdle(){if(0!==this._pendingCount||0!==this._queue.size)return new Promise((e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}}))}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}var _default=dist.default=PQueue;const getDefaultProjectName=()=>getLangSmithEnvironmentVariable("PROJECT")??getEnvironmentVariable("LANGCHAIN_SESSION")??"default",__version__="0.3.33";let globalEnv;const isBrowser=()=>"undefined"!=typeof window&&void 0!==window.document,isWebWorker=()=>"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name,isJsDom=()=>"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&navigator.userAgent.includes("jsdom"),isDeno=()=>"undefined"!=typeof Deno,isNode=()=>"undefined"!=typeof process&&void 0!==process.versions&&void 0!==process.versions.node&&!isDeno(),getEnv=()=>globalEnv||(globalEnv=isBrowser()?"browser":isNode()?"node":isWebWorker()?"webworker":isJsDom()?"jsdom":isDeno()?"deno":"other",globalEnv);let runtimeEnvironment,cachedCommitSHAs;function getRuntimeEnvironment(){if(void 0===runtimeEnvironment){const e=getEnv(),t=getShas();runtimeEnvironment={library:"langsmith",runtime:e,sdk:"langsmith-js",sdk_version:__version__,...t}}return runtimeEnvironment}function getLangChainEnvVarsMetadata(){const e=getEnvironmentVariables()||{},t={},a=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(const[n,i]of Object.entries(e))!n.startsWith("LANGCHAIN_")&&!n.startsWith("LANGSMITH_")||"string"!=typeof i||a.includes(n)||n.toLowerCase().includes("key")||n.toLowerCase().includes("secret")||n.toLowerCase().includes("token")||("LANGCHAIN_REVISION_ID"===n?t.revision_id=i:t[n]=i);return t}function getEnvironmentVariables(){try{return"undefined"!=typeof process&&process.env?Object.entries(process.env).reduce(((e,[t,a])=>(e[t]=String(a),e)),{}):void 0}catch(e){return}}function getEnvironmentVariable(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}function getLangSmithEnvironmentVariable(e){return getEnvironmentVariable(`LANGSMITH_${e}`)||getEnvironmentVariable(`LANGCHAIN_${e}`)}function getShas(){if(void 0!==cachedCommitSHAs)return cachedCommitSHAs;const e=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],t={};for(const a of e){const e=getEnvironmentVariable(a);void 0!==e&&(t[a]=e)}return cachedCommitSHAs=t,t}const DEFAULT_FETCH_IMPLEMENTATION=(...e)=>fetch(...e),LANGSMITH_FETCH_IMPLEMENTATION_KEY=Symbol.for("ls:fetch_implementation"),_globalFetchImplementationIsNodeFetch=()=>{const e=globalThis[LANGSMITH_FETCH_IMPLEMENTATION_KEY];return!!e&&("function"==typeof e&&"Headers"in e&&"Request"in e&&"Response"in e)},_getFetchImplementation=e=>async(...t)=>{if(e||"true"===getLangSmithEnvironmentVariable("DEBUG")){const[e,a]=t;console.log(`→ ${a?.method||"GET"} ${e}`)}const a=await(globalThis[LANGSMITH_FETCH_IMPLEMENTATION_KEY]??DEFAULT_FETCH_IMPLEMENTATION)(...t);return(e||"true"===getLangSmithEnvironmentVariable("DEBUG"))&&console.log(`← ${a.status} ${a.statusText} ${a.url}`),a},STATUS_NO_RETRY$1=[400,401,403,404,405,406,407,408],STATUS_IGNORE=[409];let AsyncCaller$1=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.debug=e.debug,this.queue="default"in _default?new _default.default({concurrency:this.maxConcurrency}):new _default({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){const a=this.onFailedResponseHook;return this.queue.add((()=>pRetry$1((()=>e(...t).catch((e=>{throw e instanceof Error?e:new Error(e)}))),{async onFailedAttempt(e){if(e.message.startsWith("Cancel")||e.message.startsWith("TimeoutError")||e.message.startsWith("AbortError"))throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response,n=t?.status;if(n){if(STATUS_NO_RETRY$1.includes(+n))throw e;if(STATUS_IGNORE.includes(+n))return;a&&await a(t)}},retries:this.maxRetries,randomize:!0})),{throwOnTimeout:!0})}callWithOptions(e,t,...a){return e.signal?Promise.race([this.call(t,...a),new Promise(((t,a)=>{e.signal?.addEventListener("abort",(()=>{a(new Error("AbortError"))}))}))]):this.call(t,...a)}fetch(...e){return this.call((()=>_getFetchImplementation(this.debug)(...e).then((e=>e.ok?e:Promise.reject(e)))))}};function isLangChainMessage(e){return"function"==typeof e?._getType}function convertLangChainMessageToExample(e){const t={type:e._getType(),data:{content:e.content}};return e?.additional_kwargs&&Object.keys(e.additional_kwargs).length>0&&(t.data.additional_kwargs={...e.additional_kwargs}),t}function assertUuid(e,t){if(!validate$1(e)){throw new Error(void 0!==t?`Invalid UUID for ${t}: ${e}`:`Invalid UUID: ${e}`)}return e}const warnedMessages={};function warnOnce(e){warnedMessages[e]||(console.warn(e),warnedMessages[e]=!0)}var re$2={exports:{}};const SEMVER_SPEC_VERSION="2.0.0",MAX_LENGTH$1=256,MAX_SAFE_INTEGER$1=Number.MAX_SAFE_INTEGER||9007199254740991,MAX_SAFE_COMPONENT_LENGTH=16,MAX_SAFE_BUILD_LENGTH=MAX_LENGTH$1-6,RELEASE_TYPES=["major","premajor","minor","preminor","patch","prepatch","prerelease"];var constants$1={MAX_LENGTH:MAX_LENGTH$1,MAX_SAFE_COMPONENT_LENGTH:MAX_SAFE_COMPONENT_LENGTH,MAX_SAFE_BUILD_LENGTH:MAX_SAFE_BUILD_LENGTH,MAX_SAFE_INTEGER:MAX_SAFE_INTEGER$1,RELEASE_TYPES:RELEASE_TYPES,SEMVER_SPEC_VERSION:SEMVER_SPEC_VERSION,FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2};const debug$1="object"==typeof process&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?(...e)=>console.error("SEMVER",...e):()=>{};var debug_1=debug$1;!function(e,t){const{MAX_SAFE_COMPONENT_LENGTH:a,MAX_SAFE_BUILD_LENGTH:n,MAX_LENGTH:i}=constants$1,o=debug_1,r=(t=e.exports={}).re=[],s=t.safeRe=[],c=t.src=[],l=t.t={};let p=0;const d="[a-zA-Z0-9-]",u=[["\\s",1],["\\d",i],[d,n]],m=(e,t,a)=>{const n=(e=>{for(const[t,a]of u)e=e.split(`${t}*`).join(`${t}{0,${a}}`).split(`${t}+`).join(`${t}{1,${a}}`);return e})(t),i=p++;o(e,i,t),l[e]=i,c[i]=t,r[i]=new RegExp(t,a?"g":void 0),s[i]=new RegExp(n,a?"g":void 0)};m("NUMERICIDENTIFIER","0|[1-9]\\d*"),m("NUMERICIDENTIFIERLOOSE","\\d+"),m("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${d}*`),m("MAINVERSION",`(${c[l.NUMERICIDENTIFIER]})\\.(${c[l.NUMERICIDENTIFIER]})\\.(${c[l.NUMERICIDENTIFIER]})`),m("MAINVERSIONLOOSE",`(${c[l.NUMERICIDENTIFIERLOOSE]})\\.(${c[l.NUMERICIDENTIFIERLOOSE]})\\.(${c[l.NUMERICIDENTIFIERLOOSE]})`),m("PRERELEASEIDENTIFIER",`(?:${c[l.NUMERICIDENTIFIER]}|${c[l.NONNUMERICIDENTIFIER]})`),m("PRERELEASEIDENTIFIERLOOSE",`(?:${c[l.NUMERICIDENTIFIERLOOSE]}|${c[l.NONNUMERICIDENTIFIER]})`),m("PRERELEASE",`(?:-(${c[l.PRERELEASEIDENTIFIER]}(?:\\.${c[l.PRERELEASEIDENTIFIER]})*))`),m("PRERELEASELOOSE",`(?:-?(${c[l.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${c[l.PRERELEASEIDENTIFIERLOOSE]})*))`),m("BUILDIDENTIFIER",`${d}+`),m("BUILD",`(?:\\+(${c[l.BUILDIDENTIFIER]}(?:\\.${c[l.BUILDIDENTIFIER]})*))`),m("FULLPLAIN",`v?${c[l.MAINVERSION]}${c[l.PRERELEASE]}?${c[l.BUILD]}?`),m("FULL",`^${c[l.FULLPLAIN]}$`),m("LOOSEPLAIN",`[v=\\s]*${c[l.MAINVERSIONLOOSE]}${c[l.PRERELEASELOOSE]}?${c[l.BUILD]}?`),m("LOOSE",`^${c[l.LOOSEPLAIN]}$`),m("GTLT","((?:<|>)?=?)"),m("XRANGEIDENTIFIERLOOSE",`${c[l.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),m("XRANGEIDENTIFIER",`${c[l.NUMERICIDENTIFIER]}|x|X|\\*`),m("XRANGEPLAIN",`[v=\\s]*(${c[l.XRANGEIDENTIFIER]})(?:\\.(${c[l.XRANGEIDENTIFIER]})(?:\\.(${c[l.XRANGEIDENTIFIER]})(?:${c[l.PRERELEASE]})?${c[l.BUILD]}?)?)?`),m("XRANGEPLAINLOOSE",`[v=\\s]*(${c[l.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[l.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[l.XRANGEIDENTIFIERLOOSE]})(?:${c[l.PRERELEASELOOSE]})?${c[l.BUILD]}?)?)?`),m("XRANGE",`^${c[l.GTLT]}\\s*${c[l.XRANGEPLAIN]}$`),m("XRANGELOOSE",`^${c[l.GTLT]}\\s*${c[l.XRANGEPLAINLOOSE]}$`),m("COERCEPLAIN",`(^|[^\\d])(\\d{1,${a}})(?:\\.(\\d{1,${a}}))?(?:\\.(\\d{1,${a}}))?`),m("COERCE",`${c[l.COERCEPLAIN]}(?:$|[^\\d])`),m("COERCEFULL",c[l.COERCEPLAIN]+`(?:${c[l.PRERELEASE]})?`+`(?:${c[l.BUILD]})?(?:$|[^\\d])`),m("COERCERTL",c[l.COERCE],!0),m("COERCERTLFULL",c[l.COERCEFULL],!0),m("LONETILDE","(?:~>?)"),m("TILDETRIM",`(\\s*)${c[l.LONETILDE]}\\s+`,!0),t.tildeTrimReplace="$1~",m("TILDE",`^${c[l.LONETILDE]}${c[l.XRANGEPLAIN]}$`),m("TILDELOOSE",`^${c[l.LONETILDE]}${c[l.XRANGEPLAINLOOSE]}$`),m("LONECARET","(?:\\^)"),m("CARETTRIM",`(\\s*)${c[l.LONECARET]}\\s+`,!0),t.caretTrimReplace="$1^",m("CARET",`^${c[l.LONECARET]}${c[l.XRANGEPLAIN]}$`),m("CARETLOOSE",`^${c[l.LONECARET]}${c[l.XRANGEPLAINLOOSE]}$`),m("COMPARATORLOOSE",`^${c[l.GTLT]}\\s*(${c[l.LOOSEPLAIN]})$|^$`),m("COMPARATOR",`^${c[l.GTLT]}\\s*(${c[l.FULLPLAIN]})$|^$`),m("COMPARATORTRIM",`(\\s*)${c[l.GTLT]}\\s*(${c[l.LOOSEPLAIN]}|${c[l.XRANGEPLAIN]})`,!0),t.comparatorTrimReplace="$1$2$3",m("HYPHENRANGE",`^\\s*(${c[l.XRANGEPLAIN]})\\s+-\\s+(${c[l.XRANGEPLAIN]})\\s*$`),m("HYPHENRANGELOOSE",`^\\s*(${c[l.XRANGEPLAINLOOSE]})\\s+-\\s+(${c[l.XRANGEPLAINLOOSE]})\\s*$`),m("STAR","(<|>)?=?\\s*\\*"),m("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),m("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")}(re$2,re$2.exports);var reExports=re$2.exports;const looseOption=Object.freeze({loose:!0}),emptyOpts=Object.freeze({}),parseOptions$1=e=>e?"object"!=typeof e?looseOption:e:emptyOpts;var parseOptions_1=parseOptions$1;const numeric=/^[0-9]+$/,compareIdentifiers$1=(e,t)=>{const a=numeric.test(e),n=numeric.test(t);return a&&n&&(e=+e,t=+t),e===t?0:a&&!n?-1:n&&!a?1:e<t?-1:1},rcompareIdentifiers=(e,t)=>compareIdentifiers$1(t,e);var identifiers$1={compareIdentifiers:compareIdentifiers$1,rcompareIdentifiers:rcompareIdentifiers};const debug=debug_1,{MAX_LENGTH:MAX_LENGTH,MAX_SAFE_INTEGER:MAX_SAFE_INTEGER}=constants$1,{safeRe:re$1,t:t$1}=reExports,parseOptions=parseOptions_1,{compareIdentifiers:compareIdentifiers}=identifiers$1;let SemVer$1=class e{constructor(t,a){if(a=parseOptions(a),t instanceof e){if(t.loose===!!a.loose&&t.includePrerelease===!!a.includePrerelease)return t;t=t.version}else if("string"!=typeof t)throw new TypeError(`Invalid version. Must be a string. Got type "${typeof t}".`);if(t.length>MAX_LENGTH)throw new TypeError(`version is longer than ${MAX_LENGTH} characters`);debug("SemVer",t,a),this.options=a,this.loose=!!a.loose,this.includePrerelease=!!a.includePrerelease;const n=t.trim().match(a.loose?re$1[t$1.LOOSE]:re$1[t$1.FULL]);if(!n)throw new TypeError(`Invalid Version: ${t}`);if(this.raw=t,this.major=+n[1],this.minor=+n[2],this.patch=+n[3],this.major>MAX_SAFE_INTEGER||this.major<0)throw new TypeError("Invalid major version");if(this.minor>MAX_SAFE_INTEGER||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>MAX_SAFE_INTEGER||this.patch<0)throw new TypeError("Invalid patch version");n[4]?this.prerelease=n[4].split(".").map((e=>{if(/^[0-9]+$/.test(e)){const t=+e;if(t>=0&&t<MAX_SAFE_INTEGER)return t}return e})):this.prerelease=[],this.build=n[5]?n[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(t){if(debug("SemVer.compare",this.version,this.options,t),!(t instanceof e)){if("string"==typeof t&&t===this.version)return 0;t=new e(t,this.options)}return t.version===this.version?0:this.compareMain(t)||this.comparePre(t)}compareMain(t){return t instanceof e||(t=new e(t,this.options)),compareIdentifiers(this.major,t.major)||compareIdentifiers(this.minor,t.minor)||compareIdentifiers(this.patch,t.patch)}comparePre(t){if(t instanceof e||(t=new e(t,this.options)),this.prerelease.length&&!t.prerelease.length)return-1;if(!this.prerelease.length&&t.prerelease.length)return 1;if(!this.prerelease.length&&!t.prerelease.length)return 0;let a=0;do{const e=this.prerelease[a],n=t.prerelease[a];if(debug("prerelease compare",a,e,n),void 0===e&&void 0===n)return 0;if(void 0===n)return 1;if(void 0===e)return-1;if(e!==n)return compareIdentifiers(e,n)}while(++a)}compareBuild(t){t instanceof e||(t=new e(t,this.options));let a=0;do{const e=this.build[a],n=t.build[a];if(debug("build compare",a,e,n),void 0===e&&void 0===n)return 0;if(void 0===n)return 1;if(void 0===e)return-1;if(e!==n)return compareIdentifiers(e,n)}while(++a)}inc(e,t,a){switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t,a);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t,a);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t,a),this.inc("pre",t,a);break;case"prerelease":0===this.prerelease.length&&this.inc("patch",t,a),this.inc("pre",t,a);break;case"major":0===this.minor&&0===this.patch&&0!==this.prerelease.length||this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":0===this.patch&&0!==this.prerelease.length||this.minor++,this.patch=0,this.prerelease=[];break;case"patch":0===this.prerelease.length&&this.patch++,this.prerelease=[];break;case"pre":{const e=Number(a)?1:0;if(!t&&!1===a)throw new Error("invalid increment argument: identifier is empty");if(0===this.prerelease.length)this.prerelease=[e];else{let n=this.prerelease.length;for(;--n>=0;)"number"==typeof this.prerelease[n]&&(this.prerelease[n]++,n=-2);if(-1===n){if(t===this.prerelease.join(".")&&!1===a)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(e)}}if(t){let n=[t,e];!1===a&&(n=[t]),0===compareIdentifiers(this.prerelease[0],t)?isNaN(this.prerelease[1])&&(this.prerelease=n):this.prerelease=n}break}default:throw new Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}};var semver=SemVer$1;const SemVer=semver,compare$6=(e,t,a)=>new SemVer(e,a).compare(new SemVer(t,a));var compare_1=compare$6;const compare$5=compare_1,gt$1=(e,t,a)=>compare$5(e,t,a)>0;var gt_1=gt$1;const compare$4=compare_1,lt$1=(e,t,a)=>compare$4(e,t,a)<0;var lt_1=lt$1;const compare$3=compare_1,eq$1=(e,t,a)=>0===compare$3(e,t,a);var eq_1=eq$1;const compare$2=compare_1,neq$1=(e,t,a)=>0!==compare$2(e,t,a);var neq_1=neq$1;const compare$1=compare_1,gte$1=(e,t,a)=>compare$1(e,t,a)>=0;var gte_1=gte$1;const compare=compare_1,lte$1=(e,t,a)=>compare(e,t,a)<=0;var lte_1=lte$1;const eq=eq_1,neq=neq_1,gt=gt_1,gte=gte_1,lt=lt_1,lte=lte_1,cmp=(e,t,a,n)=>{switch(t){case"===":return"object"==typeof e&&(e=e.version),"object"==typeof a&&(a=a.version),e===a;case"!==":return"object"==typeof e&&(e=e.version),"object"==typeof a&&(a=a.version),e!==a;case"":case"=":case"==":return eq(e,a,n);case"!=":return neq(e,a,n);case">":return gt(e,a,n);case">=":return gte(e,a,n);case"<":return lt(e,a,n);case"<=":return lte(e,a,n);default:throw new TypeError(`Invalid operator: ${t}`)}};var cmp_1=cmp;const{safeRe:re,t:t}=reExports;class LRUCache{constructor(){this.max=1e3,this.map=new Map}get(e){const t=this.map.get(e);return void 0===t?void 0:(this.map.delete(e),this.map.set(e,t),t)}delete(e){return this.map.delete(e)}set(e,t){if(!this.delete(e)&&void 0!==t){if(this.map.size>=this.max){const e=this.map.keys().next().value;this.delete(e)}this.map.set(e,t)}return this}}var lrucache=LRUCache,range,hasRequiredRange,comparator,hasRequiredComparator;function requireRange(){if(hasRequiredRange)return range;hasRequiredRange=1;const e=/\s+/g;class t{constructor(a,o){if(o=n(o),a instanceof t)return a.loose===!!o.loose&&a.includePrerelease===!!o.includePrerelease?a:new t(a.raw,o);if(a instanceof i)return this.raw=a.value,this.set=[[a]],this.formatted=void 0,this;if(this.options=o,this.loose=!!o.loose,this.includePrerelease=!!o.includePrerelease,this.raw=a.trim().replace(e," "),this.set=this.raw.split("||").map((e=>this.parseRange(e.trim()))).filter((e=>e.length)),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const e=this.set[0];if(this.set=this.set.filter((e=>!h(e[0]))),0===this.set.length)this.set=[e];else if(this.set.length>1)for(const e of this.set)if(1===e.length&&f(e[0])){this.set=[e];break}}this.formatted=void 0}get range(){if(void 0===this.formatted){this.formatted="";for(let e=0;e<this.set.length;e++){e>0&&(this.formatted+="||");const t=this.set[e];for(let e=0;e<t.length;e++)e>0&&(this.formatted+=" "),this.formatted+=t[e].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(e){const t=((this.options.includePrerelease&&u)|(this.options.loose&&m))+":"+e,n=a.get(t);if(n)return n;const r=this.options.loose,f=r?s[c.HYPHENRANGELOOSE]:s[c.HYPHENRANGE];e=e.replace(f,O(this.options.includePrerelease)),o("hyphen replace",e),e=e.replace(s[c.COMPARATORTRIM],l),o("comparator trim",e),e=e.replace(s[c.TILDETRIM],p),o("tilde trim",e),e=e.replace(s[c.CARETTRIM],d),o("caret trim",e);let g=e.split(" ").map((e=>v(e,this.options))).join(" ").split(/\s+/).map((e=>T(e,this.options)));r&&(g=g.filter((e=>(o("loose invalid filter",e,this.options),!!e.match(s[c.COMPARATORLOOSE]))))),o("range list",g);const b=new Map,y=g.map((e=>new i(e,this.options)));for(const e of y){if(h(e))return[e];b.set(e.value,e)}b.size>1&&b.has("")&&b.delete("");const _=[...b.values()];return a.set(t,_),_}intersects(e,a){if(!(e instanceof t))throw new TypeError("a Range is required");return this.set.some((t=>g(t,a)&&e.set.some((e=>g(e,a)&&t.every((t=>e.every((e=>t.intersects(e,a)))))))))}test(e){if(!e)return!1;if("string"==typeof e)try{e=new r(e,this.options)}catch(e){return!1}for(let t=0;t<this.set.length;t++)if(k(this.set[t],e,this.options))return!0;return!1}}range=t;const a=new lrucache,n=parseOptions_1,i=requireComparator(),o=debug_1,r=semver,{safeRe:s,t:c,comparatorTrimReplace:l,tildeTrimReplace:p,caretTrimReplace:d}=reExports,{FLAG_INCLUDE_PRERELEASE:u,FLAG_LOOSE:m}=constants$1,h=e=>"<0.0.0-0"===e.value,f=e=>""===e.value,g=(e,t)=>{let a=!0;const n=e.slice();let i=n.pop();for(;a&&n.length;)a=n.every((e=>i.intersects(e,t))),i=n.pop();return a},v=(e,t)=>(o("comp",e,t),e=x(e,t),o("caret",e),e=y(e,t),o("tildes",e),e=E(e,t),o("xrange",e),e=$(e,t),o("stars",e),e),b=e=>!e||"x"===e.toLowerCase()||"*"===e,y=(e,t)=>e.trim().split(/\s+/).map((e=>_(e,t))).join(" "),_=(e,t)=>{const a=t.loose?s[c.TILDELOOSE]:s[c.TILDE];return e.replace(a,((t,a,n,i,r)=>{let s;return o("tilde",e,t,a,n,i,r),b(a)?s="":b(n)?s=`>=${a}.0.0 <${+a+1}.0.0-0`:b(i)?s=`>=${a}.${n}.0 <${a}.${+n+1}.0-0`:r?(o("replaceTilde pr",r),s=`>=${a}.${n}.${i}-${r} <${a}.${+n+1}.0-0`):s=`>=${a}.${n}.${i} <${a}.${+n+1}.0-0`,o("tilde return",s),s}))},x=(e,t)=>e.trim().split(/\s+/).map((e=>w(e,t))).join(" "),w=(e,t)=>{o("caret",e,t);const a=t.loose?s[c.CARETLOOSE]:s[c.CARET],n=t.includePrerelease?"-0":"";return e.replace(a,((t,a,i,r,s)=>{let c;return o("caret",e,t,a,i,r,s),b(a)?c="":b(i)?c=`>=${a}.0.0${n} <${+a+1}.0.0-0`:b(r)?c="0"===a?`>=${a}.${i}.0${n} <${a}.${+i+1}.0-0`:`>=${a}.${i}.0${n} <${+a+1}.0.0-0`:s?(o("replaceCaret pr",s),c="0"===a?"0"===i?`>=${a}.${i}.${r}-${s} <${a}.${i}.${+r+1}-0`:`>=${a}.${i}.${r}-${s} <${a}.${+i+1}.0-0`:`>=${a}.${i}.${r}-${s} <${+a+1}.0.0-0`):(o("no pr"),c="0"===a?"0"===i?`>=${a}.${i}.${r}${n} <${a}.${i}.${+r+1}-0`:`>=${a}.${i}.${r}${n} <${a}.${+i+1}.0-0`:`>=${a}.${i}.${r} <${+a+1}.0.0-0`),o("caret return",c),c}))},E=(e,t)=>(o("replaceXRanges",e,t),e.split(/\s+/).map((e=>S(e,t))).join(" ")),S=(e,t)=>{e=e.trim();const a=t.loose?s[c.XRANGELOOSE]:s[c.XRANGE];return e.replace(a,((a,n,i,r,s,c)=>{o("xRange",e,a,n,i,r,s,c);const l=b(i),p=l||b(r),d=p||b(s),u=d;return"="===n&&u&&(n=""),c=t.includePrerelease?"-0":"",l?a=">"===n||"<"===n?"<0.0.0-0":"*":n&&u?(p&&(r=0),s=0,">"===n?(n=">=",p?(i=+i+1,r=0,s=0):(r=+r+1,s=0)):"<="===n&&(n="<",p?i=+i+1:r=+r+1),"<"===n&&(c="-0"),a=`${n+i}.${r}.${s}${c}`):p?a=`>=${i}.0.0${c} <${+i+1}.0.0-0`:d&&(a=`>=${i}.${r}.0${c} <${i}.${+r+1}.0-0`),o("xRange return",a),a}))},$=(e,t)=>(o("replaceStars",e,t),e.trim().replace(s[c.STAR],"")),T=(e,t)=>(o("replaceGTE0",e,t),e.trim().replace(s[t.includePrerelease?c.GTE0PRE:c.GTE0],"")),O=e=>(t,a,n,i,o,r,s,c,l,p,d,u)=>`${a=b(n)?"":b(i)?`>=${n}.0.0${e?"-0":""}`:b(o)?`>=${n}.${i}.0${e?"-0":""}`:r?`>=${a}`:`>=${a}${e?"-0":""}`} ${c=b(l)?"":b(p)?`<${+l+1}.0.0-0`:b(d)?`<${l}.${+p+1}.0-0`:u?`<=${l}.${p}.${d}-${u}`:e?`<${l}.${p}.${+d+1}-0`:`<=${c}`}`.trim(),k=(e,t,a)=>{for(let a=0;a<e.length;a++)if(!e[a].test(t))return!1;if(t.prerelease.length&&!a.includePrerelease){for(let a=0;a<e.length;a++)if(o(e[a].semver),e[a].semver!==i.ANY&&e[a].semver.prerelease.length>0){const n=e[a].semver;if(n.major===t.major&&n.minor===t.minor&&n.patch===t.patch)return!0}return!1}return!0};return range}function requireComparator(){if(hasRequiredComparator)return comparator;hasRequiredComparator=1;const e=Symbol("SemVer ANY");class t{static get ANY(){return e}constructor(n,i){if(i=a(i),n instanceof t){if(n.loose===!!i.loose)return n;n=n.value}n=n.trim().split(/\s+/).join(" "),r("comparator",n,i),this.options=i,this.loose=!!i.loose,this.parse(n),this.semver===e?this.value="":this.value=this.operator+this.semver.version,r("comp",this)}parse(t){const a=this.options.loose?n[i.COMPARATORLOOSE]:n[i.COMPARATOR],o=t.match(a);if(!o)throw new TypeError(`Invalid comparator: ${t}`);this.operator=void 0!==o[1]?o[1]:"","="===this.operator&&(this.operator=""),o[2]?this.semver=new s(o[2],this.options.loose):this.semver=e}toString(){return this.value}test(t){if(r("Comparator.test",t,this.options.loose),this.semver===e||t===e)return!0;if("string"==typeof t)try{t=new s(t,this.options)}catch(e){return!1}return o(t,this.operator,this.semver,this.options)}intersects(e,n){if(!(e instanceof t))throw new TypeError("a Comparator is required");return""===this.operator?""===this.value||new c(e.value,n).test(this.value):""===e.operator?""===e.value||new c(this.value,n).test(e.semver):(!(n=a(n)).includePrerelease||"<0.0.0-0"!==this.value&&"<0.0.0-0"!==e.value)&&(!(!n.includePrerelease&&(this.value.startsWith("<0.0.0")||e.value.startsWith("<0.0.0")))&&(!(!this.operator.startsWith(">")||!e.operator.startsWith(">"))||(!(!this.operator.startsWith("<")||!e.operator.startsWith("<"))||(!(this.semver.version!==e.semver.version||!this.operator.includes("=")||!e.operator.includes("="))||(!!(o(this.semver,"<",e.semver,n)&&this.operator.startsWith(">")&&e.operator.startsWith("<"))||!!(o(this.semver,">",e.semver,n)&&this.operator.startsWith("<")&&e.operator.startsWith(">")))))))}}comparator=t;const a=parseOptions_1,{safeRe:n,t:i}=reExports,o=cmp_1,r=debug_1,s=semver,c=requireRange();return comparator}requireRange(),requireRange(),requireRange(),requireRange(),requireRange(),requireRange();const Comparator$1=requireComparator(),{ANY:ANY$1}=Comparator$1;requireRange(),requireRange(),requireRange();const Comparator=requireComparator(),{ANY:ANY}=Comparator;new Comparator(">=0.0.0-0"),new Comparator(">=0.0.0");const internalRe=reExports,constants=constants$1,identifiers=identifiers$1;function parsePromptIdentifier(e){if(!e||e.split("/").length>2||e.startsWith("/")||e.endsWith("/")||e.split(":").length>2)throw new Error(`Invalid identifier format: ${e}`);const[t,a]=e.split(":"),n=a||"latest";if(t.includes("/")){const[a,i]=t.split("/",2);if(!a||!i)throw new Error(`Invalid identifier format: ${e}`);return[a,i,n]}if(!t)throw new Error(`Invalid identifier format: ${e}`);return["-",t,n]}requireComparator(),requireRange(),internalRe.re,internalRe.src,internalRe.t,constants.SEMVER_SPEC_VERSION,constants.RELEASE_TYPES,identifiers.compareIdentifiers,identifiers.rcompareIdentifiers;class LangSmithConflictError extends Error{constructor(e){super(e),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="LangSmithConflictError",this.status=409}}async function raiseForStatus(e,t,a){let n;if(e.ok)return void(a&&(n=await e.text()));n=await e.text();const i=`Failed to ${t}. Received status [${e.status}]: ${e.statusText}. Server response: ${n}`;if(409===e.status)throw new LangSmithConflictError(i);const o=new Error(i);throw o.status=e.status,o}var LIMIT_REPLACE_NODE="[...]",CIRCULAR_REPLACE_NODE={result:"[Circular]"},arr=[],replacerStack=[];const encoder=new TextEncoder;function defaultOptions$1(){return{depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}}function encodeString(e){return encoder.encode(e)}function serialize(e,t,a,n,i){try{return encodeString(JSON.stringify(e,a,n))}catch(o){if(!o.message?.includes("Converting circular structure to JSON"))return console.warn("[WARNING]: LangSmith received unserializable value."+(t?`\nContext: ${t}`:"")),encodeString("[Unserializable]");let r;console.warn("[WARNING]: LangSmith received circular JSON. This will decrease tracer performance. "+(t?`\nContext: ${t}`:"")),void 0===i&&(i=defaultOptions$1()),decirc(e,"",0,[],void 0,0,i);try{r=0===replacerStack.length?JSON.stringify(e,a,n):JSON.stringify(e,replaceGetterValues(a),n)}catch(e){return encodeString("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;0!==arr.length;){const e=arr.pop();4===e.length?Object.defineProperty(e[0],e[1],e[3]):e[0][e[1]]=e[2]}}return encodeString(r)}}function setReplace(e,t,a,n){var i=Object.getOwnPropertyDescriptor(n,a);void 0!==i.get?i.configurable?(Object.defineProperty(n,a,{value:e}),arr.push([n,a,t,i])):replacerStack.push([t,a,e]):(n[a]=e,arr.push([n,a,t]))}function decirc(e,t,a,n,i,o,r){var s;if(o+=1,"object"==typeof e&&null!==e){for(s=0;s<n.length;s++)if(n[s]===e)return void setReplace(CIRCULAR_REPLACE_NODE,e,t,i);if(void 0!==r.depthLimit&&o>r.depthLimit)return void setReplace(LIMIT_REPLACE_NODE,e,t,i);if(void 0!==r.edgesLimit&&a+1>r.edgesLimit)return void setReplace(LIMIT_REPLACE_NODE,e,t,i);if(n.push(e),Array.isArray(e))for(s=0;s<e.length;s++)decirc(e[s],s,s,n,e,o,r);else{var c=Object.keys(e);for(s=0;s<c.length;s++){var l=c[s];decirc(e[l],l,s,n,e,o,r)}}n.pop()}}function replaceGetterValues(e){return e=void 0!==e?e:function(e,t){return t},function(t,a){if(replacerStack.length>0)for(var n=0;n<replacerStack.length;n++){var i=replacerStack[n];if(i[1]===t&&i[0]===a){a=i[2],replacerStack.splice(n,1);break}}return e.call(this,t,a)}}function mergeRuntimeEnvIntoRunCreate(e){const t=getRuntimeEnvironment(),a=getLangChainEnvVarsMetadata(),n=e.extra??{},i=n.metadata;return e.extra={...n,runtime:{...t,...n?.runtime},metadata:{...a,...a.revision_id||e.revision_id?{revision_id:e.revision_id??a.revision_id}:{},...i}},e}const getTracingSamplingRate=e=>{const t=e?.toString()??getLangSmithEnvironmentVariable("TRACING_SAMPLING_RATE");if(void 0===t)return;const a=parseFloat(t);if(a<0||a>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${a}`);return a},isLocalhost=e=>{const t=e.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return"localhost"===t||"127.0.0.1"===t||"::1"===t};async function toArray(e){const t=[];for await(const a of e)t.push(a);return t}function trimQuotes(e){if(void 0!==e)return e.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const handle429=async e=>{if(429===e?.status){const t=1e3*parseInt(e.headers.get("retry-after")??"30",10);if(t>0)return await new Promise((e=>setTimeout(e,t))),!0}return!1};function _formatFeedbackScore(e){return"number"==typeof e?Number(e.toFixed(4)):e}class AutoBatchQueue{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let t;const a=new Promise((e=>{t=e})),n=serialize(e.item,`Serializing run with id: ${e.item.id}`).length;return this.items.push({action:e.action,payload:e.item,itemPromiseResolve:t,itemPromise:a,size:n}),this.sizeBytes+=n,a}pop(e){if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");const t=[];let a=0;for(;a+(this.peek()?.size??0)<e&&this.items.length>0;){const e=this.items.shift();e&&(t.push(e),a+=e.size,this.sizeBytes-=e.size)}if(0===t.length&&this.items.length>0){const e=this.items.shift();t.push(e),a+=e.size,this.sizeBytes-=e.size}return[t.map((e=>({action:e.action,item:e.payload}))),()=>t.forEach((e=>e.itemPromiseResolve()))]}}const DEFAULT_BATCH_SIZE_LIMIT_BYTES=20971520,SERVER_INFO_REQUEST_TIMEOUT=2500;class Client{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new AutoBatchQueue}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:"false"===getEnvironmentVariable("LANGSMITH_TRACING_BACKGROUND")}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:"true"===getEnvironmentVariable("LANGSMITH_DEBUG")});const t=Client.getDefaultClientConfig();if(this.tracingSampleRate=getTracingSamplingRate(e.tracingSamplingRate),this.apiUrl=trimQuotes(e.apiUrl??t.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=trimQuotes(e.apiKey??t.apiKey),this.webUrl=trimQuotes(e.webUrl??t.webUrl),this.webUrl?.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.timeout_ms=e.timeout_ms??9e4,this.caller=new AsyncCaller$1({...e.callerOptions??{},debug:e.debug??this.debug}),this.traceBatchConcurrency=e.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.debug=e.debug??this.debug,this.batchIngestCaller=new AsyncCaller$1({maxRetries:2,maxConcurrency:this.traceBatchConcurrency,...e.callerOptions??{},onFailedResponseHook:handle429,debug:e.debug??this.debug}),this.hideInputs=e.hideInputs??e.anonymizer??t.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.fetchOptions=e.fetchOptions||{},this.manualFlushMode=e.manualFlushMode??this.manualFlushMode}static getDefaultClientConfig(){const e=getLangSmithEnvironmentVariable("API_KEY");return{apiUrl:getLangSmithEnvironmentVariable("ENDPOINT")??"https://api.smith.langchain.com",apiKey:e,webUrl:void 0,hideInputs:"true"===getLangSmithEnvironmentVariable("HIDE_INPUTS"),hideOutputs:"true"===getLangSmithEnvironmentVariable("HIDE_OUTPUTS")}}getHostUrl(){return this.webUrl?this.webUrl:isLocalhost(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.endsWith("/api/v1")?(this.webUrl=this.apiUrl.replace("/api/v1",""),this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("beta")?(this.webUrl="https://beta.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${__version__}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}async processInputs(e){return!1===this.hideInputs?e:!0===this.hideInputs?{}:"function"==typeof this.hideInputs?this.hideInputs(e):e}async processOutputs(e){return!1===this.hideOutputs?e:!0===this.hideOutputs?{}:"function"==typeof this.hideOutputs?this.hideOutputs(e):e}async prepareRunCreateOrUpdateInputs(e){const t={...e};return void 0!==t.inputs&&(t.inputs=await this.processInputs(t.inputs)),void 0!==t.outputs&&(t.outputs=await this.processOutputs(t.outputs)),t}async _getResponse(e,t){const a=t?.toString()??"",n=`${this.apiUrl}${e}?${a}`,i=await this.caller.call(_getFetchImplementation(this.debug),n,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await raiseForStatus(i,`Failed to fetch ${e}`),i}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams,a){let n=Number(t.get("offset"))||0;const i=Number(t.get("limit"))||100;for(;;){t.set("offset",String(n)),t.set("limit",String(i));const o=`${this.apiUrl}${e}?${t}`,r=await this.caller.call(_getFetchImplementation(this.debug),o,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(r,`Failed to fetch ${e}`);const s=a?a(await r.json()):await r.json();if(0===s.length)break;if(yield s,s.length<i)break;n+=s.length}}async*_getCursorPaginatedList(e,t=null,a="POST",n="runs"){const i=t?{...t}:{};for(;;){const t=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}${e}`,{method:a,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(i)}),o=await t.json();if(!o)break;if(!o[n])break;yield o[n];const r=o.cursors;if(!r)break;if(!r.next)break;i.cursor=r.next}}_shouldSample(){return void 0===this.tracingSampleRate||Math.random()<this.tracingSampleRate}_filterForSampling(e,t=!1){if(void 0===this.tracingSampleRate)return e;if(t){const t=[];for(const a of e)this.filteredPostUuids.has(a.id)?this.filteredPostUuids.delete(a.id):t.push(a);return t}{const t=[];for(const a of e){const e=a.trace_id??a.id;this.filteredPostUuids.has(e)||(a.id===e?this._shouldSample()?t.push(a):this.filteredPostUuids.add(e):t.push(a))}return t}}async _getBatchSizeLimitBytes(){const e=await this._ensureServerInfo();return this.batchSizeBytesLimit??e.batch_ingest_config?.size_limit_bytes??DEFAULT_BATCH_SIZE_LIMIT_BYTES}async _getMultiPartSupport(){const e=await this._ensureServerInfo();return e.instance_flags?.dataset_examples_multipart_enabled??!1}drainAutoBatchQueue(e){const t=[];for(;this.autoBatchQueue.items.length>0;){const[a,n]=this.autoBatchQueue.pop(e);if(!a.length){n();break}const i=this._processBatch(a,n).catch(console.error);t.push(i)}return Promise.all(t)}async _processBatch(e,t){if(e.length)try{const t={runCreates:e.filter((e=>"create"===e.action)).map((e=>e.item)),runUpdates:e.filter((e=>"update"===e.action)).map((e=>e.item))},a=await this._ensureServerInfo();a?.batch_ingest_config?.use_multipart_endpoint?await this.multipartIngestRuns(t):await this.batchIngestRuns(t)}finally{t()}else t()}async processRunOperation(e){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,"create"===e.action&&(e.item=mergeRuntimeEnvIntoRunCreate(e.item));const t=this.autoBatchQueue.push(e);if(this.manualFlushMode)return t;const a=await this._getBatchSizeLimitBytes();return this.autoBatchQueue.sizeBytes>a&&this.drainAutoBatchQueue(a),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout((()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue(a)}),this.autoBatchAggregationDelayMs)),t}async _getServerInfo(){const e=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(SERVER_INFO_REQUEST_TIMEOUT),...this.fetchOptions});await raiseForStatus(e,"get server info");const t=await e.json();return this.debug&&console.log("\n=== LangSmith Server Configuration ===\n"+JSON.stringify(t,null,2)+"\n"),t}async _ensureServerInfo(){return void 0===this._getServerInfoPromise&&(this._getServerInfoPromise=(async()=>{if(void 0===this._serverInfo)try{this._serverInfo=await this._getServerInfo()}catch(e){console.warn(`[WARNING]: LangSmith failed to fetch info on supported operations with status code ${e.status}. Falling back to batch operations and default limits.`)}return this._serverInfo??{}})()),this._getServerInfoPromise.then((e=>(void 0===this._serverInfo&&(this._getServerInfoPromise=void 0),e)))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){const e=await this._getBatchSizeLimitBytes();await this.drainAutoBatchQueue(e)}async createRun(e){if(!this._filterForSampling([e]).length)return;const t={...this.headers,"Content-Type":"application/json"},a=e.project_name;delete e.project_name;const n=await this.prepareRunCreateOrUpdateInputs({session_name:a,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&void 0!==n.trace_id&&void 0!==n.dotted_order)return void this.processRunOperation({action:"create",item:n}).catch(console.error);const i=mergeRuntimeEnvIntoRunCreate(n),o=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/runs`,{method:"POST",headers:t,body:serialize(i,`Creating run with id: ${i.id}`),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(o,"create run",!0)}async batchIngestRuns({runCreates:e,runUpdates:t}){if(void 0===e&&void 0===t)return;let a=await Promise.all(e?.map((e=>this.prepareRunCreateOrUpdateInputs(e)))??[]),n=await Promise.all(t?.map((e=>this.prepareRunCreateOrUpdateInputs(e)))??[]);if(a.length>0&&n.length>0){const e=a.reduce(((e,t)=>t.id?(e[t.id]=t,e):e),{}),t=[];for(const a of n)void 0!==a.id&&e[a.id]?e[a.id]={...e[a.id],...a}:t.push(a);a=Object.values(e),n=t}const i={post:a,patch:n};if(!i.post.length&&!i.patch.length)return;const o={post:[],patch:[]};for(const e of["post","patch"]){const t=e,a=i[t].reverse();let n=a.pop();for(;void 0!==n;)o[t].push(n),n=a.pop()}if(o.post.length>0||o.patch.length>0){const e=o.post.map((e=>e.id)).concat(o.patch.map((e=>e.id))).join(",");await this._postBatchIngestRuns(serialize(o,`Ingesting runs with ids: ${e}`))}}async _postBatchIngestRuns(e){const t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},a=await this.batchIngestCaller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(a,"batch create run",!0)}async multipartIngestRuns({runCreates:e,runUpdates:t}){if(void 0===e&&void 0===t)return;const a={};let n=[];for(const t of e??[]){const e=await this.prepareRunCreateOrUpdateInputs(t);void 0!==e.id&&void 0!==e.attachments&&(a[e.id]=e.attachments),delete e.attachments,n.push(e)}let i=[];for(const e of t??[])i.push(await this.prepareRunCreateOrUpdateInputs(e));if(void 0!==n.find((e=>void 0===e.trace_id||void 0===e.dotted_order)))throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(void 0!==i.find((e=>void 0===e.trace_id||void 0===e.dotted_order)))throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(n.length>0&&i.length>0){const e=n.reduce(((e,t)=>t.id?(e[t.id]=t,e):e),{}),t=[];for(const a of i)void 0!==a.id&&e[a.id]?e[a.id]={...e[a.id],...a}:t.push(a);n=Object.values(e),i=t}if(0===n.length&&0===i.length)return;const o=[],r=[];for(const[e,t]of[["post",n],["patch",i]])for(const n of t){const{inputs:t,outputs:i,events:s,attachments:c,...l}=n,p={inputs:t,outputs:i,events:s},d=serialize(l,`Serializing for multipart ingestion of run with id: ${l.id}`);r.push({name:`${e}.${l.id}`,payload:new Blob([d],{type:`application/json; length=${d.length}`})});for(const[t,a]of Object.entries(p)){if(void 0===a)continue;const n=serialize(a,`Serializing ${t} for multipart ingestion of run with id: ${l.id}`);r.push({name:`${e}.${l.id}.${t}`,payload:new Blob([n],{type:`application/json; length=${n.length}`})})}if(void 0!==l.id){const e=a[l.id];if(e){delete a[l.id];for(const[t,a]of Object.entries(e)){let e,n;Array.isArray(a)?[e,n]=a:(e=a.mimeType,n=a.data),t.includes(".")?console.warn(`Skipping attachment '${t}' for run ${l.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`):r.push({name:`attachment.${l.id}.${t}`,payload:new Blob([n],{type:`${e}; length=${n.byteLength}`})})}}}o.push(`trace=${l.trace_id},id=${l.id}`)}await this._sendMultipartRequest(r,o.join("; "))}async _createNodeFetchBody(e,t){const a=[];for(const n of e)a.push(new Blob([`--${t}\r\n`])),a.push(new Blob([`Content-Disposition: form-data; name="${n.name}"\r\n`,`Content-Type: ${n.payload.type}\r\n\r\n`])),a.push(n.payload),a.push(new Blob(["\r\n"]));a.push(new Blob([`--${t}--\r\n`]));const n=new Blob(a);return await n.arrayBuffer()}async _createMultipartStream(e,t){const a=new TextEncoder;return new ReadableStream({async start(n){const i=async e=>{"string"==typeof e?n.enqueue(a.encode(e)):n.enqueue(e)};for(const a of e){await i(`--${t}\r\n`),await i(`Content-Disposition: form-data; name="${a.name}"\r\n`),await i(`Content-Type: ${a.payload.type}\r\n\r\n`);const e=a.payload.stream().getReader();try{let t;for(;!(t=await e.read()).done;)n.enqueue(t.value)}finally{e.releaseLock()}await i("\r\n")}await i(`--${t}--\r\n`),n.close()}})}async _sendMultipartRequest(e,t){try{const t="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),a=await(_globalFetchImplementationIsNodeFetch()?this._createNodeFetchBody(e,t):this._createMultipartStream(e,t)),n=await this.batchIngestCaller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/runs/multipart`,{method:"POST",headers:{...this.headers,"Content-Type":`multipart/form-data; boundary=${t}`},body:a,duplex:"half",signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(n,"ingest multipart runs",!0)}catch(e){console.warn(`${e.message.trim()}\n\nContext: ${t}`)}}async updateRun(e,t){assertUuid(e),t.inputs&&(t.inputs=await this.processInputs(t.inputs)),t.outputs&&(t.outputs=await this.processOutputs(t.outputs));const a={...t,id:e};if(!this._filterForSampling([a],!0).length)return;if(this.autoBatchTracing&&void 0!==a.trace_id&&void 0!==a.dotted_order)return void 0!==t.end_time&&void 0===a.parent_run_id&&this.blockOnRootRunFinalization&&!this.manualFlushMode?void await this.processRunOperation({action:"update",item:a}).catch(console.error):void this.processRunOperation({action:"update",item:a}).catch(console.error);const n={...this.headers,"Content-Type":"application/json"},i=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:n,body:serialize(t,`Serializing payload to update run with id: ${e}`),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(i,"update run",!0)}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){assertUuid(e);let a=await this._get(`/runs/${e}`);return t&&(a=await this._loadChildRuns(a)),a}async getRunUrl({runId:e,run:t,projectOpts:a}){if(void 0!==t){let e;if(t.session_id)e=t.session_id;else if(a?.projectName)e=(await this.readProject({projectName:a?.projectName})).id;else if(a?.projectId)e=a?.projectId;else{e=(await this.readProject({projectName:getLangSmithEnvironmentVariable("PROJECT")||"default"})).id}const n=await this._getTenantId();return`${this.getHostUrl()}/o/${n}/projects/p/${e}/r/${t.id}?poll=true`}if(void 0!==e){const t=await this.readRun(e);if(!t.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${t.app_path}`}throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await toArray(this.listRuns({isRoot:!1,projectId:e.session_id,traceId:e.trace_id})),a={},n={};t.sort(((e,t)=>(e?.dotted_order??"").localeCompare(t?.dotted_order??"")));for(const i of t){if(null===i.parent_run_id||void 0===i.parent_run_id)throw new Error(`Child run ${i.id} has no parent`);i.dotted_order?.startsWith(e.dotted_order??"")&&i.id!==e.id&&(i.parent_run_id in a||(a[i.parent_run_id]=[]),a[i.parent_run_id].push(i),n[i.id]=i)}e.child_runs=a[e.id]||[];for(const t in a)t!==e.id&&(n[t].child_runs=a[t]);return e}async*listRuns(e){const{projectId:t,projectName:a,parentRunId:n,traceId:i,referenceExampleId:o,startTime:r,executionOrder:s,isRoot:c,runType:l,error:p,id:d,query:u,filter:m,traceFilter:h,treeFilter:f,limit:g,select:v,order:b}=e;let y=[];if(t&&(y=Array.isArray(t)?t:[t]),a){const e=Array.isArray(a)?a:[a],t=await Promise.all(e.map((e=>this.readProject({projectName:e}).then((e=>e.id)))));y.push(...t)}const _={session:y.length?y:null,run_type:l,reference_example:o,query:u,filter:m,trace_filter:h,tree_filter:f,execution_order:s,parent_run:n,start_time:r?r.toISOString():null,error:p,id:d,limit:g,trace:i,select:v||["app_path","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],is_root:c,order:b};let x=0;for await(const e of this._getCursorPaginatedList("/runs/query",_))if(g){if(x>=g)break;if(e.length+x>g){const t=e.slice(0,g-x);yield*t;break}x+=e.length,yield*e}else yield*e}async*listGroupRuns(e){const{projectId:t,projectName:a,groupBy:n,filter:i,startTime:o,endTime:r,limit:s,offset:c}=e,l={session_id:t||(await this.readProject({projectName:a})).id,group_by:n,filter:i,start_time:o?o.toISOString():null,end_time:r?r.toISOString():null,limit:Number(s)||100};let p=Number(c)||0;const d="/runs/group",u=`${this.apiUrl}${d}`;for(;;){const e={...l,offset:p},t=Object.fromEntries(Object.entries(e).filter((([e,t])=>void 0!==t))),a=await this.caller.call(_getFetchImplementation(),u,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(a,`Failed to fetch ${d}`);const n=await a.json(),{groups:i,total:o}=n;if(0===i.length)break;for(const e of i)yield e;if(p+=i.length,p>=o)break}}async getRunStats({id:e,trace:t,parentRun:a,runType:n,projectNames:i,projectIds:o,referenceExampleIds:r,startTime:s,endTime:c,error:l,query:p,filter:d,traceFilter:u,treeFilter:m,isRoot:h,dataSourceType:f}){let g=o||[];i&&(g=[...o||[],...await Promise.all(i.map((e=>this.readProject({projectName:e}).then((e=>e.id)))))]);const v={id:e,trace:t,parent_run:a,run_type:n,session:g,reference_example:r,start_time:s,end_time:c,error:l,query:p,filter:d,trace_filter:u,tree_filter:m,is_root:h,data_source_type:f},b=Object.fromEntries(Object.entries(v).filter((([e,t])=>void 0!==t))),y=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/runs/stats`,{method:"POST",headers:this.headers,body:JSON.stringify(b),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await y.json()}async shareRun(e,{shareId:t}={}){const a={run_id:e,share_token:t||v4()};assertUuid(e);const n=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),i=await n.json();if(null===i||!("share_token"in i))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${i.share_token}/r`}async unshareRun(e){assertUuid(e);const t=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(t,"unshare run",!0)}async readRunSharedLink(e){assertUuid(e);const t=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),a=await t.json();if(null!==a&&"share_token"in a)return`${this.getHostUrl()}/public/${a.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const a=new URLSearchParams({share_token:e});if(void 0!==t)for(const e of t)a.append("id",e);assertUuid(e);const n=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/public/${e}/runs${a}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await n.json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");if(!e){e=(await this.readDataset({datasetName:t})).id}assertUuid(e);const a=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),n=await a.json();return n.url=`${this.getHostUrl()}/public/${n.share_token}/d`,n}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");if(!e){e=(await this.readDataset({datasetName:t})).id}const a={dataset_id:e};assertUuid(e);const n=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),i=await n.json();return i.url=`${this.getHostUrl()}/public/${i.share_token}/d`,i}async unshareDataset(e){assertUuid(e);const t=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(t,"unshare dataset",!0)}async readSharedDataset(e){assertUuid(e);const t=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await t.json()}async listSharedExamples(e,t){const a={};t?.exampleIds&&(a.id=t.exampleIds);const n=new URLSearchParams;Object.entries(a).forEach((([e,t])=>{Array.isArray(t)?t.forEach((t=>n.append(e,t))):n.append(e,t)}));const i=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/public/${e}/examples?${n.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),o=await i.json();if(!i.ok){if("detail"in o)throw new Error(`Failed to list shared examples.\nStatus: ${i.status}\nMessage: ${Array.isArray(o.detail)?o.detail.join("\n"):"Unspecified error"}`);throw new Error(`Failed to list shared examples: ${i.status} ${i.statusText}`)}return o.map((e=>({...e,_hostUrl:this.getHostUrl()})))}async createProject({projectName:e,description:t=null,metadata:a=null,upsert:n=!1,projectExtra:i=null,referenceDatasetId:o=null}){const r=n?"?upsert=true":"",s=`${this.apiUrl}/sessions${r}`,c=i||{};a&&(c.metadata=a);const l={name:e,extra:c,description:t};null!==o&&(l.reference_dataset_id=o);const p=await this.caller.call(_getFetchImplementation(this.debug),s,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(p,"create project");return await p.json()}async updateProject(e,{name:t=null,description:a=null,metadata:n=null,projectExtra:i=null,endTime:o=null}){const r=`${this.apiUrl}/sessions/${e}`;let s=i;n&&(s={...s||{},metadata:n});const c={name:t,extra:s,description:a,end_time:o?new Date(o).toISOString():null},l=await this.caller.call(_getFetchImplementation(this.debug),r,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(l,"update project");return await l.json()}async hasProject({projectId:e,projectName:t}){let a="/sessions";const n=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)assertUuid(e),a+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");n.append("name",t)}const i=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}${a}?${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{const e=await i.json();return!!i.ok&&(!Array.isArray(e)||e.length>0)}catch(e){return!1}}async readProject({projectId:e,projectName:t,includeStats:a}){let n="/sessions";const i=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)assertUuid(e),n+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");i.append("name",t)}void 0!==a&&i.append("include_stats",a.toString());const o=await this._get(n,i);let r;if(Array.isArray(o)){if(0===o.length)throw new Error(`Project[id=${e}, name=${t}] not found`);r=o[0]}else r=o;return r}async getProjectUrl({projectId:e,projectName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either projectName or projectId");const a=await this.readProject({projectId:e,projectName:t}),n=await this._getTenantId();return`${this.getHostUrl()}/o/${n}/projects/p/${a.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either datasetName or datasetId");const a=await this.readDataset({datasetId:e,datasetName:t}),n=await this._getTenantId();return`${this.getHostUrl()}/o/${n}/datasets/${a.id}`}async _getTenantId(){if(null!==this._tenantId)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:a,referenceDatasetId:n,referenceDatasetName:i,referenceFree:o,metadata:r}={}){const s=new URLSearchParams;if(void 0!==e)for(const t of e)s.append("id",t);if(void 0!==t&&s.append("name",t),void 0!==a&&s.append("name_contains",a),void 0!==n)s.append("reference_dataset",n);else if(void 0!==i){const e=await this.readDataset({datasetName:i});s.append("reference_dataset",e.id)}void 0!==o&&s.append("reference_free",o.toString()),void 0!==r&&s.append("metadata",JSON.stringify(r));for await(const e of this._getPaginated("/sessions",s))yield*e}async deleteProject({projectId:e,projectName:t}){let a;if(void 0===e&&void 0===t)throw new Error("Must provide projectName or projectId");if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");a=void 0===e?(await this.readProject({projectName:t})).id:e,assertUuid(a);const n=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/sessions/${a}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(n,`delete session ${a} (${t})`,!0)}async uploadCsv({csvFile:e,fileName:t,inputKeys:a,outputKeys:n,description:i,dataType:o,name:r}){const s=`${this.apiUrl}/datasets/upload`,c=new FormData;c.append("file",e,t),a.forEach((e=>{c.append("input_keys",e)})),n.forEach((e=>{c.append("output_keys",e)})),i&&c.append("description",i),o&&c.append("data_type",o),r&&c.append("name",r);const l=await this.caller.call(_getFetchImplementation(this.debug),s,{method:"POST",headers:this.headers,body:c,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(l,"upload CSV");return await l.json()}async createDataset(e,{description:t,dataType:a,inputsSchema:n,outputsSchema:i,metadata:o}={}){const r={name:e,description:t,extra:o?{metadata:o}:void 0};a&&(r.data_type=a),n&&(r.inputs_schema_definition=n),i&&(r.outputs_schema_definition=i);const s=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(s,"create dataset");return await s.json()}async readDataset({datasetId:e,datasetName:t}){let a="/datasets";const n=new URLSearchParams({limit:"1"});if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)assertUuid(e),a+=`/${e}`;else{if(void 0===t)throw new Error("Must provide datasetName or datasetId");n.append("name",t)}const i=await this._get(a,n);let o;if(Array.isArray(i)){if(0===i.length)throw new Error(`Dataset[id=${e}, name=${t}] not found`);o=i[0]}else o=i;return o}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(e){if(e instanceof Error&&e.message.toLocaleLowerCase().includes("not found"))return!1;throw e}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:a,toVersion:n}){let i=e;if(void 0===i&&void 0===t)throw new Error("Must provide either datasetName or datasetId");if(void 0!==i&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===i){i=(await this.readDataset({datasetName:t})).id}const o=new URLSearchParams({from_version:"string"==typeof a?a:a.toISOString(),to_version:"string"==typeof n?n:n.toISOString()});return await this._get(`/datasets/${i}/versions/diff`,o)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){if(void 0!==e);else{if(void 0===t)throw new Error("Must provide either datasetName or datasetId");e=(await this.readDataset({datasetName:t})).id}const a=await this._getResponse(`/datasets/${e}/openai_ft`);return(await a.text()).trim().split("\n").map((e=>JSON.parse(e)))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:a,datasetName:n,datasetNameContains:i,metadata:o}={}){const r=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(void 0!==a)for(const e of a)r.append("id",e);void 0!==n&&r.append("name",n),void 0!==i&&r.append("name_contains",i),void 0!==o&&r.append("metadata",JSON.stringify(o));for await(const e of this._getPaginated("/datasets",r))yield*e}async updateDataset(e){const{datasetId:t,datasetName:a,...n}=e;if(!t&&!a)throw new Error("Must provide either datasetName or datasetId");const i=t??(await this.readDataset({datasetName:a})).id;assertUuid(i);const o=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/datasets/${i}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await raiseForStatus(o,"update dataset"),await o.json()}async updateDatasetTag(e){const{datasetId:t,datasetName:a,asOf:n,tag:i}=e;if(!t&&!a)throw new Error("Must provide either datasetName or datasetId");const o=t??(await this.readDataset({datasetName:a})).id;assertUuid(o);const r=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/datasets/${o}/tags`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({as_of:"string"==typeof n?n:n.toISOString(),tag:i}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(r,"update dataset tags")}async deleteDataset({datasetId:e,datasetName:t}){let a="/datasets",n=e;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==t){n=(await this.readDataset({datasetName:t})).id}if(void 0===n)throw new Error("Must provide datasetName or datasetId");assertUuid(n),a+=`/${n}`;const i=await this.caller.call(_getFetchImplementation(this.debug),this.apiUrl+a,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(i,`delete ${a}`),await i.json()}async indexDataset({datasetId:e,datasetName:t,tag:a}){let n=e;if(!n&&!t)throw new Error("Must provide either datasetName or datasetId");if(n&&t)throw new Error("Must provide either datasetName or datasetId, not both");if(!n){n=(await this.readDataset({datasetName:t})).id}assertUuid(n);const i={tag:a},o=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/datasets/${n}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(o,"index dataset"),await o.json()}async similarExamples(e,t,a,{filter:n}={}){const i={limit:a,inputs:e};void 0!==n&&(i.filter=n),assertUuid(t);const o=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/datasets/${t}/search`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(o,"fetch similar examples");return(await o.json()).examples}async createExample(e,t,a){if(isExampleCreate(e)&&(void 0!==t||void 0!==a))throw new Error("Cannot provide outputs or options when using ExampleCreate object");let n=t?a?.datasetId:e.dataset_id;const i=t?a?.datasetName:e.dataset_name;if(void 0===n&&void 0===i)throw new Error("Must provide either datasetName or datasetId");if(void 0!==n&&void 0!==i)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===n){n=(await this.readDataset({datasetName:i})).id}const o=(t?a?.createdAt:e.created_at)||new Date;let r;r=isExampleCreate(e)?e:{inputs:e,outputs:t,created_at:o?.toISOString(),id:a?.exampleId,metadata:a?.metadata,split:a?.split,source_run_id:a?.sourceRunId,use_source_run_io:a?.useSourceRunIO,use_source_run_attachments:a?.useSourceRunAttachments,attachments:a?.attachments};const s=await this._uploadExamplesMultipart(n,[r]);return await this.readExample(s.example_ids?.[0]??v4())}async createExamples(e){if(Array.isArray(e)){if(0===e.length)return[];const t=e;let a=t[0].dataset_id;const n=t[0].dataset_name;if(void 0===a&&void 0===n)throw new Error("Must provide either datasetName or datasetId");if(void 0!==a&&void 0!==n)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===a){a=(await this.readDataset({datasetName:n})).id}const i=await this._uploadExamplesMultipart(a,t);return await Promise.all(i.example_ids.map((e=>this.readExample(e))))}const{inputs:t,outputs:a,metadata:n,splits:i,sourceRunIds:o,useSourceRunIOs:r,useSourceRunAttachments:s,attachments:c,exampleIds:l,datasetId:p,datasetName:d}=e;if(void 0===t)throw new Error("Must provide inputs when using legacy parameters");let u=p;const m=d;if(void 0===u&&void 0===m)throw new Error("Must provide either datasetName or datasetId");if(void 0!==u&&void 0!==m)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===u){const e=await this.readDataset({datasetName:m});u=e.id}const h=t.map(((e,t)=>({dataset_id:u,inputs:e,outputs:a?.[t],metadata:n?.[t],split:i?.[t],id:l?.[t],attachments:c?.[t],source_run_id:o?.[t],use_source_run_io:r?.[t],use_source_run_attachments:s?.[t]}))),f=await this._uploadExamplesMultipart(u,h);return await Promise.all(f.example_ids.map((e=>this.readExample(e))))}async createLLMExample(e,t,a){return this.createExample({input:e},{output:t},a)}async createChatExample(e,t,a){const n=e.map((e=>isLangChainMessage(e)?convertLangChainMessageToExample(e):e)),i=isLangChainMessage(t)?convertLangChainMessageToExample(t):t;return this.createExample({input:n},{output:i},a)}async readExample(e){assertUuid(e);const t=`/examples/${e}`,a=await this._get(t),{attachment_urls:n,...i}=a,o=i;return n&&(o.attachments=Object.entries(n).reduce(((e,[t,a])=>(e[t.slice(11)]={presigned_url:a.presigned_url,mime_type:a.mime_type},e)),{})),o}async*listExamples({datasetId:e,datasetName:t,exampleIds:a,asOf:n,splits:i,inlineS3Urls:o,metadata:r,limit:s,offset:c,filter:l,includeAttachments:p}={}){let d;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)d=e;else{if(void 0===t)throw new Error("Must provide a datasetName or datasetId");d=(await this.readDataset({datasetName:t})).id}const u=new URLSearchParams({dataset:d}),m=n?"string"==typeof n?n:n?.toISOString():void 0;m&&u.append("as_of",m);const h=o??!0;if(u.append("inline_s3_urls",h.toString()),void 0!==a)for(const e of a)u.append("id",e);if(void 0!==i)for(const e of i)u.append("splits",e);if(void 0!==r){const e=JSON.stringify(r);u.append("metadata",e)}void 0!==s&&u.append("limit",s.toString()),void 0!==c&&u.append("offset",c.toString()),void 0!==l&&u.append("filter",l),!0===p&&["attachment_urls","outputs","metadata"].forEach((e=>u.append("select",e)));let f=0;for await(const e of this._getPaginated("/examples",u)){for(const t of e){const{attachment_urls:e,...a}=t,n=a;e&&(n.attachments=Object.entries(e).reduce(((e,[t,a])=>(e[t.slice(11)]={presigned_url:a.presigned_url,mime_type:a.mime_type||void 0},e)),{})),yield n,f++}if(void 0!==s&&f>=s)break}}async deleteExample(e){assertUuid(e);const t=`/examples/${e}`,a=await this.caller.call(_getFetchImplementation(this.debug),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(a,`delete ${t}`),await a.json()}async updateExample(e,t){let a,n,i;if(a=t?e:e.id,assertUuid(a),n=t?{id:a,...t}:e,void 0!==n.dataset_id)i=n.dataset_id;else{i=(await this.readExample(a)).dataset_id}return this._updateExamplesMultipart(i,[n])}async updateExamples(e){let t;if(void 0===e[0].dataset_id){t=(await this.readExample(e[0].id)).dataset_id}else t=e[0].dataset_id;return this._updateExamplesMultipart(t,e)}async readDatasetVersion({datasetId:e,datasetName:t,asOf:a,tag:n}){let i;if(e)i=e;else{i=(await this.readDataset({datasetName:t})).id}if(assertUuid(i),a&&n||!a&&!n)throw new Error("Exactly one of asOf and tag must be specified.");const o=new URLSearchParams;void 0!==a&&o.append("as_of","string"==typeof a?a:a.toISOString()),void 0!==n&&o.append("tag",n);const r=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/datasets/${i}/version?${o.toString()}`,{method:"GET",headers:{...this.headers},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await raiseForStatus(r,"read dataset version"),await r.json()}async listDatasetSplits({datasetId:e,datasetName:t,asOf:a}){let n;if(void 0===e&&void 0===t)throw new Error("Must provide dataset name or ID");if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===e){n=(await this.readDataset({datasetName:t})).id}else n=e;assertUuid(n);const i=new URLSearchParams,o=a?"string"==typeof a?a:a?.toISOString():void 0;o&&i.append("as_of",o);return await this._get(`/datasets/${n}/splits`,i)}async updateDatasetSplits({datasetId:e,datasetName:t,splitName:a,exampleIds:n,remove:i=!1}){let o;if(void 0===e&&void 0===t)throw new Error("Must provide dataset name or ID");if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===e){o=(await this.readDataset({datasetName:t})).id}else o=e;assertUuid(o);const r={split_name:a,examples:n.map((e=>(assertUuid(e),e))),remove:i},s=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/datasets/${o}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(s,"update dataset splits",!0)}async evaluateRun(e,t,{sourceInfo:a,loadChildRuns:n,referenceExample:i}={loadChildRuns:!1}){let o;if(warnOnce("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead."),"string"==typeof e)o=await this.readRun(e,{loadChildRuns:n});else{if("object"!=typeof e||!("id"in e))throw new Error("Invalid run type: "+typeof e);o=e}null!==o.reference_example_id&&void 0!==o.reference_example_id&&(i=await this.readExample(o.reference_example_id));const r=await t.evaluateRun(o,i),[s,c]=await this._logEvaluationFeedback(r,o,a);return c[0]}async createFeedback(e,t,{score:a,value:n,correction:i,comment:o,sourceInfo:r,feedbackSourceType:s="api",sourceRunId:c,feedbackId:l,feedbackConfig:p,projectId:d,comparativeExperimentId:u}){if(!e&&!d)throw new Error("One of runId or projectId must be provided");if(e&&d)throw new Error("Only one of runId or projectId can be provided");const m={type:s??"api",metadata:r??{}};void 0===c||void 0===m?.metadata||m.metadata.__run||(m.metadata.__run={run_id:c}),void 0!==m?.metadata&&void 0!==m.metadata.__run?.run_id&&assertUuid(m.metadata.__run.run_id);const h={id:l??v4(),run_id:e,key:t,score:_formatFeedbackScore(a),value:n,correction:i,comment:o,feedback_source:m,comparative_experiment_id:u,feedbackConfig:p,session_id:d},f=`${this.apiUrl}/feedback`,g=await this.caller.call(_getFetchImplementation(this.debug),f,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(h),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await raiseForStatus(g,"create feedback",!0),h}async updateFeedback(e,{score:t,value:a,correction:n,comment:i}){const o={};null!=t&&(o.score=_formatFeedbackScore(t)),null!=a&&(o.value=a),null!=n&&(o.correction=n),null!=i&&(o.comment=i),assertUuid(e);const r=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(r,"update feedback",!0)}async readFeedback(e){assertUuid(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){assertUuid(e);const t=`/feedback/${e}`,a=await this.caller.call(_getFetchImplementation(this.debug),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(a,`delete ${t}`),await a.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:a}={}){const n=new URLSearchParams;if(e&&n.append("run",e.join(",")),t)for(const e of t)n.append("key",e);if(a)for(const e of a)n.append("source",e);for await(const e of this._getPaginated("/feedback",n))yield*e}async createPresignedFeedbackToken(e,t,{expiration:a,feedbackConfig:n}={}){const i={run_id:e,feedback_key:t,feedback_config:n};a?"string"==typeof a?i.expires_at=a:(a?.hours||a?.minutes||a?.days)&&(i.expires_in=a):i.expires_in={hours:3};const o=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await o.json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:a,createdAt:n,description:i,metadata:o,id:r}){if(0===t.length)throw new Error("At least one experiment is required");if(a||(a=(await this.readProject({projectId:t[0]})).reference_dataset_id),null==!a)throw new Error("A reference dataset is required");const s={id:r,name:e,experiment_ids:t,reference_dataset_id:a,description:i,created_at:(n??new Date)?.toISOString(),extra:{}};o&&(s.extra.metadata=o);const c=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await c.json()}async*listPresignedFeedbackTokens(e){assertUuid(e);const t=new URLSearchParams({run_id:e});for await(const e of this._getPaginated("/feedback/tokens",t))yield*e}_selectEvalResults(e){let t;return t="results"in e?e.results:Array.isArray(e)?e:[e],t}async _logEvaluationFeedback(e,t,a){const n=this._selectEvalResults(e),i=[];for(const e of n){let n=a||{};e.evaluatorInfo&&(n={...e.evaluatorInfo,...n});let o=null;e.targetRunId?o=e.targetRunId:t&&(o=t.id),i.push(await this.createFeedback(o,e.key,{score:e.score,value:e.value,comment:e.comment,correction:e.correction,sourceInfo:n,sourceRunId:e.sourceRunId,feedbackConfig:e.feedbackConfig,feedbackSourceType:"model"}))}return[n,i]}async logEvaluationFeedback(e,t,a){const[n]=await this._logEvaluationFeedback(e,t,a);return n}async*listAnnotationQueues(e={}){const{queueIds:t,name:a,nameContains:n,limit:i}=e,o=new URLSearchParams;t&&t.forEach(((e,t)=>{assertUuid(e,`queueIds[${t}]`),o.append("ids",e)})),a&&o.append("name",a),n&&o.append("name_contains",n),o.append("limit",(void 0!==i?Math.min(i,100):100).toString());let r=0;for await(const e of this._getPaginated("/annotation-queues",o))if(yield*e,r++,void 0!==i&&r>=i)break}async createAnnotationQueue(e){const{name:t,description:a,queueId:n,rubricInstructions:i}=e,o={name:t,description:a,id:n||v4(),rubric_instructions:i},r=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(Object.fromEntries(Object.entries(o).filter((([e,t])=>void 0!==t)))),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(r,"create annotation queue");return await r.json()}async readAnnotationQueue(e){const t=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/annotation-queues/${assertUuid(e,"queueId")}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(t,"read annotation queue");return await t.json()}async updateAnnotationQueue(e,t){const{name:a,description:n,rubricInstructions:i}=t,o=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/annotation-queues/${assertUuid(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({name:a,description:n,rubric_instructions:i}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(o,"update annotation queue")}async deleteAnnotationQueue(e){const t=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/annotation-queues/${assertUuid(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(t,"delete annotation queue")}async addRunsToAnnotationQueue(e,t){const a=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/annotation-queues/${assertUuid(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t.map(((e,t)=>assertUuid(e,`runIds[${t}]`).toString()))),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(a,"add runs to annotation queue")}async getRunFromAnnotationQueue(e,t){const a=`/annotation-queues/${assertUuid(e,"queueId")}/run`,n=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}${a}/${t}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await raiseForStatus(n,"get run from annotation queue"),await n.json()}async deleteRunFromAnnotationQueue(e,t){const a=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/annotation-queues/${assertUuid(e,"queueId")}/runs/${assertUuid(t,"queueRunId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(a,"delete run from annotation queue")}async getSizeFromAnnotationQueue(e){const t=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/annotation-queues/${assertUuid(e,"queueId")}/size`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await raiseForStatus(t,"get size from annotation queue"),await t.json()}async _currentTenantIsOwner(e){const t=await this._getSettings();return"-"==e||t.tenant_handle===e}async _ownerConflictError(e,t){const a=await this._getSettings();return new Error(`Cannot ${e} for another tenant.\n\n      Current tenant: ${a.tenant_handle}\n\n      Requested tenant: ${t}`)}async _getLatestCommitHash(e){const t=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),a=await t.json();if(!t.ok){const e="string"==typeof a.detail?a.detail:JSON.stringify(a.detail),n=new Error(`Error ${t.status}: ${t.statusText}\n${e}`);throw n.statusCode=t.status,n}if(0!==a.commits.length)return a.commits[0].commit_hash}async _likeOrUnlikePrompt(e,t){const[a,n,i]=parsePromptIdentifier(e),o=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/likes/${a}/${n}`,{method:"POST",body:JSON.stringify({like:t}),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await raiseForStatus(o,(t?"like":"unlike")+" prompt"),await o.json()}async _getPromptUrl(e){const[t,a,n]=parsePromptIdentifier(e);if(await this._currentTenantIsOwner(t)){const e=await this._getSettings();return"latest"!==n?`${this.getHostUrl()}/prompts/${a}/${n.substring(0,8)}?organizationId=${e.id}`:`${this.getHostUrl()}/prompts/${a}?organizationId=${e.id}`}return"latest"!==n?`${this.getHostUrl()}/hub/${t}/${a}/${n.substring(0,8)}`:`${this.getHostUrl()}/hub/${t}/${a}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(const t of this._getPaginated(`/commits/${e}/`,new URLSearchParams,(e=>e.commits)))yield*t}async*listPrompts(e){const t=new URLSearchParams;t.append("sort_field",e?.sortField??"updated_at"),t.append("sort_direction","desc"),t.append("is_archived",(!!e?.isArchived).toString()),void 0!==e?.isPublic&&t.append("is_public",e.isPublic.toString()),e?.query&&t.append("query",e.query);for await(const e of this._getPaginated("/repos",t,(e=>e.repos)))yield*e}async getPrompt(e){const[t,a,n]=parsePromptIdentifier(e),i=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/repos/${t}/${a}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(404===i.status)return null;await raiseForStatus(i,"get prompt");const o=await i.json();return o.repo?o.repo:null}async createPrompt(e,t){const a=await this._getSettings();if(t?.isPublic&&!a.tenant_handle)throw new Error("Cannot create a public prompt without first\n\n        creating a LangChain Hub handle. \n        You can add a handle by creating a public prompt at:\n\n        https://smith.langchain.com/prompts");const[n,i,o]=parsePromptIdentifier(e);if(!await this._currentTenantIsOwner(n))throw await this._ownerConflictError("create a prompt",n);const r={repo_handle:i,...t?.description&&{description:t.description},...t?.readme&&{readme:t.readme},...t?.tags&&{tags:t.tags},is_public:!!t?.isPublic},s=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(s,"create prompt");const{repo:c}=await s.json();return c}async createCommit(e,t,a){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[n,i,o]=parsePromptIdentifier(e),r="latest"!==a?.parentCommitHash&&a?.parentCommitHash?a?.parentCommitHash:await this._getLatestCommitHash(`${n}/${i}`),s={manifest:JSON.parse(JSON.stringify(t)),parent_commit:r},c=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/commits/${n}/${i}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(c,"create commit");const l=await c.json();return this._getPromptUrl(`${n}/${i}${l.commit_hash?`:${l.commit_hash}`:""}`)}async updateExamplesMultipart(e,t=[]){return this._updateExamplesMultipart(e,t)}async _updateExamplesMultipart(e,t=[]){if(!await this._getMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const a=new FormData;for(const e of t){const t=e.id,n=serialize({...e.metadata&&{metadata:e.metadata},...e.split&&{split:e.split}},`Serializing body for example with id: ${t}`),i=new Blob([n],{type:"application/json"});if(a.append(t,i),e.inputs){const n=serialize(e.inputs,`Serializing inputs for example with id: ${t}`),i=new Blob([n],{type:"application/json"});a.append(`${t}.inputs`,i)}if(e.outputs){const n=serialize(e.outputs,`Serializing outputs whle updating example with id: ${t}`),i=new Blob([n],{type:"application/json"});a.append(`${t}.outputs`,i)}if(e.attachments)for(const[n,i]of Object.entries(e.attachments)){let e,o;Array.isArray(i)?[e,o]=i:(e=i.mimeType,o=i.data);const r=new Blob([o],{type:`${e}; length=${o.byteLength}`});a.append(`${t}.attachment.${n}`,r)}if(e.attachments_operations){const n=serialize(e.attachments_operations,`Serializing attachments while updating example with id: ${t}`),i=new Blob([n],{type:"application/json"});a.append(`${t}.attachments_operations`,i)}}const n=e??t[0]?.dataset_id,i=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/v1/platform/datasets/${n}/examples`,{method:"PATCH",headers:this.headers,body:a});return await i.json()}async uploadExamplesMultipart(e,t=[]){return this._uploadExamplesMultipart(e,t)}async _uploadExamplesMultipart(e,t=[]){if(!await this._getMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const a=new FormData;for(const e of t){const t=(e.id??v4()).toString(),n=serialize({created_at:e.created_at,...e.metadata&&{metadata:e.metadata},...e.split&&{split:e.split},...e.source_run_id&&{source_run_id:e.source_run_id},...e.use_source_run_io&&{use_source_run_io:e.use_source_run_io},...e.use_source_run_attachments&&{use_source_run_attachments:e.use_source_run_attachments}},`Serializing body for uploaded example with id: ${t}`),i=new Blob([n],{type:"application/json"});if(a.append(t,i),e.inputs){const n=serialize(e.inputs,`Serializing inputs for uploaded example with id: ${t}`),i=new Blob([n],{type:"application/json"});a.append(`${t}.inputs`,i)}if(e.outputs){const n=serialize(e.outputs,`Serializing outputs for uploaded example with id: ${t}`),i=new Blob([n],{type:"application/json"});a.append(`${t}.outputs`,i)}if(e.attachments)for(const[n,i]of Object.entries(e.attachments)){let e,o;Array.isArray(i)?[e,o]=i:(e=i.mimeType,o=i.data);const r=new Blob([o],{type:`${e}; length=${o.byteLength}`});a.append(`${t}.attachment.${n}`,r)}}const n=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/v1/platform/datasets/${e}/examples`,{method:"POST",headers:this.headers,body:a});await raiseForStatus(n,"upload examples");return await n.json()}async updatePrompt(e,t){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[a,n]=parsePromptIdentifier(e);if(!await this._currentTenantIsOwner(a))throw await this._ownerConflictError("update a prompt",a);const i={};if(void 0!==t?.description&&(i.description=t.description),void 0!==t?.readme&&(i.readme=t.readme),void 0!==t?.tags&&(i.tags=t.tags),void 0!==t?.isPublic&&(i.is_public=t.isPublic),void 0!==t?.isArchived&&(i.is_archived=t.isArchived),0===Object.keys(i).length)throw new Error("No valid update options provided");const o=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/repos/${a}/${n}`,{method:"PATCH",body:JSON.stringify(i),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await raiseForStatus(o,"update prompt"),o.json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[t,a,n]=parsePromptIdentifier(e);if(!await this._currentTenantIsOwner(t))throw await this._ownerConflictError("delete a prompt",t);const i=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/repos/${t}/${a}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await i.json()}async pullPromptCommit(e,t){const[a,n,i]=parsePromptIdentifier(e),o=await this.caller.call(_getFetchImplementation(this.debug),`${this.apiUrl}/commits/${a}/${n}/${i}${t?.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await raiseForStatus(o,"pull prompt commit");const r=await o.json();return{owner:a,repo:n,commit_hash:r.commit_hash,manifest:r.manifest,examples:r.examples}}async _pullPrompt(e,t){const a=await this.pullPromptCommit(e,{includeModel:t?.includeModel});return JSON.stringify(a.manifest)}async pushPrompt(e,t){if(await this.promptExists(e)?t&&Object.keys(t).some((e=>"object"!==e))&&await this.updatePrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}):await this.createPrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}),!t?.object)return await this._getPromptUrl(e);return await this.createCommit(e,t?.object,{parentCommitHash:t?.parentCommitHash})}async clonePublicDataset(e,t={}){const{sourceApiUrl:a=this.apiUrl,datasetName:n}=t,[i,o]=this.parseTokenOrUrl(e,a),r=new Client({apiUrl:i,apiKey:"placeholder"}),s=await r.readSharedDataset(o),c=n||s.name;try{if(await this.hasDataset({datasetId:c}))return void console.log(`Dataset ${c} already exists in your tenant. Skipping.`)}catch(e){}const l=await r.listSharedExamples(o),p=await this.createDataset(c,{description:s.description,dataType:s.data_type||"kv",inputsSchema:s.inputs_schema_definition??void 0,outputsSchema:s.outputs_schema_definition??void 0});try{await this.createExamples({inputs:l.map((e=>e.inputs)),outputs:l.flatMap((e=>e.outputs?[e.outputs]:[])),datasetId:p.id})}catch(e){throw console.error(`An error occurred while creating dataset ${c}. You should delete it manually.`),e}}parseTokenOrUrl(e,t,a=2,n="dataset"){try{return assertUuid(e),[t,e]}catch(e){}try{const i=new URL(e).pathname.split("/").filter((e=>""!==e));if(i.length>=a){return[t,i[i.length-a]]}throw new Error(`Invalid public ${n} URL: ${e}`)}catch(t){throw new Error(`Invalid public ${n} URL or token: ${e}`)}}awaitPendingTraceBatches(){return this.manualFlushMode?(console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve()):Promise.all([...this.autoBatchQueue.items.map((({itemPromise:e})=>e)),this.batchIngestCaller.queue.onIdle()])}}function isExampleCreate(e){return"dataset_id"in e||"dataset_name"in e}const isTracingEnabled$1=e=>!!["TRACING_V2","TRACING"].find((e=>"true"===getLangSmithEnvironmentVariable(e))),_LC_CONTEXT_VARIABLES_KEY=Symbol.for("lc:context_variables");function stripNonAlphanumeric$1(e){return e.replace(/[-:.]/g,"")}function convertToDottedOrderFormat$1(e,t,a=1){const n=a.toFixed(0).slice(0,3).padStart(3,"0");return stripNonAlphanumeric$1(`${new Date(e).toISOString().slice(0,-1)}${n}Z`)+t}class Baggage{constructor(e,t,a,n){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=t,this.project_name=a,this.replicas=n}static fromHeader(e){const t=e.split(",");let a,n,i={},o=[];for(const e of t){const[t,r]=e.split("="),s=decodeURIComponent(r);"langsmith-metadata"===t?i=JSON.parse(s):"langsmith-tags"===t?o=s.split(","):"langsmith-project"===t?a=s:"langsmith-replicas"===t&&(n=JSON.parse(s))}return new Baggage(i,o,a,n)}toHeader(){const e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),this.project_name&&e.push(`langsmith-project=${encodeURIComponent(this.project_name)}`),e.join(",")}}class RunTree{constructor(e){if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),isRunTree(e))return void Object.assign(this,{...e});const t=RunTree.getDefaultConfig(),{metadata:a,...n}=e,i=n.client??RunTree.getSharedClient(),o={...a,...n?.extra?.metadata};if(n.extra={...n.extra,metadata:o},Object.assign(this,{...t,...n,client:i}),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.execution_order??=1,this.child_execution_order??=1,!this.dotted_order){const e=convertToDottedOrderFormat$1(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+e:this.dotted_order=e}}set metadata(e){this.extra={...this.extra,metadata:{...this.extra?.metadata,...e}}}get metadata(){return this.extra?.metadata}static getDefaultConfig(){return{id:v4(),run_type:"chain",project_name:getDefaultProjectName(),child_runs:[],api_url:getEnvironmentVariable("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:getEnvironmentVariable("LANGCHAIN_API_KEY"),caller_options:{},start_time:Date.now(),serialized:{},inputs:{},extra:{}}}static getSharedClient(){return RunTree.sharedClient||(RunTree.sharedClient=new Client),RunTree.sharedClient}createChild(e){const t=this.child_execution_order+1,a=new RunTree({...e,parent_run:this,project_name:this.project_name,replicas:this.replicas,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:t,child_execution_order:t});_LC_CONTEXT_VARIABLES_KEY in this&&(a[_LC_CONTEXT_VARIABLES_KEY]=this[_LC_CONTEXT_VARIABLES_KEY]);const n=Symbol.for("lc:child_config"),i=e.extra?.[n]??this.extra[n];if(isRunnableConfigLike(i)){const e={...i},t=isCallbackManagerLike(e.callbacks)?e.callbacks.copy?.():void 0;t&&(Object.assign(t,{_parentRunId:a.id}),t.handlers?.find(isLangChainTracerLike)?.updateFromRunTree?.(a),e.callbacks=t),a.extra[n]=e}const o=new Set;let r=this;for(;null!=r&&!o.has(r.id);)o.add(r.id),r.child_execution_order=Math.max(r.child_execution_order,t),r=r.parent_run;return this.child_runs.push(a),a}async end(e,t,a=Date.now(),n){this.outputs=this.outputs??e,this.error=this.error??t,this.end_time=this.end_time??a,n&&Object.keys(n).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...n}}:{metadata:n})}_convertToCreate(e,t,a=!0){const n=e.extra??{};if(void 0===n?.runtime?.library&&(n.runtime||(n.runtime={}),t))for(const[e,a]of Object.entries(t))n.runtime[e]||(n.runtime[e]=a);let i,o;return a?(o=e.parent_run?.id,i=[]):(i=e.child_runs.map((e=>this._convertToCreate(e,t,a))),o=void 0),{id:e.id,name:e.name,start_time:e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:n,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:i,parent_run_id:o,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags,attachments:e.attachments,events:e.events}}_remapForProject(e,t,a=!0){const n=this._convertToCreate(this,t,a);if(e===this.project_name)return n;const i=t=>v5(`${t}:${e}`,v5.DNS),o=i(n.id),r=n.trace_id?i(n.trace_id):void 0,s=n.parent_run_id?i(n.parent_run_id):void 0;let c;if(n.dotted_order){const e=_parseDottedOrder(n.dotted_order),t=[];for(let a=0;a<e.length-1;a++){const[n,o]=e[a],r=i(o);t.push(n.toISOString().replace(/[-:]/g,"").replace(".","")+r)}const[a]=e[e.length-1];t.push(a.toISOString().replace(/[-:]/g,"").replace(".","")+o),c=t.join(".")}else c=void 0;return{...n,id:o,trace_id:r,parent_run_id:s,dotted_order:c,session_name:e}}async postRun(e=!0){try{const t=getRuntimeEnvironment();if(this.replicas&&this.replicas.length>0)for(const[e]of this.replicas){const a=this._remapForProject(e,t,!0);await this.client.createRun(a)}else{const a=this._convertToCreate(this,t,e);await this.client.createRun(a)}if(!e){warnOnce("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(const e of this.child_runs)await e.postRun(!1)}}catch(e){console.error(`Error in postRun for run ${this.id}:`,e)}}async patchRun(){if(this.replicas&&this.replicas.length>0)for(const[e,t]of this.replicas){const a=this._remapForProject(e);await this.client.updateRun(a.id,{inputs:a.inputs,outputs:a.outputs,error:a.error,parent_run_id:a.parent_run_id,session_name:a.session_name,reference_example_id:a.reference_example_id,end_time:a.end_time,dotted_order:a.dotted_order,trace_id:a.trace_id,events:a.events,tags:a.tags,extra:a.extra,attachments:this.attachments,...t})}else try{const e={end_time:this.end_time,error:this.error,inputs:this.inputs,outputs:this.outputs,parent_run_id:this.parent_run?.id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments,session_name:this.project_name};await this.client.updateRun(this.id,e)}catch(e){console.error(`Error in patchRun for run ${this.id}`,e)}}toJSON(){return this._convertToCreate(this,void 0,!1)}addEvent(e){this.events||(this.events=[]),"string"==typeof e?this.events.push({name:"event",time:(new Date).toISOString(),message:e}):this.events.push({...e,time:e.time??(new Date).toISOString()})}static fromRunnableConfig(e,t){const a=e?.callbacks;let n,i,o,r=isTracingEnabled$1();if(a){const e=a?.getParentRunId?.()??"",t=a?.handlers?.find((e=>"langchain_tracer"==e?.name));n=t?.getRun?.(e),i=t?.projectName,o=t?.client,r=r||!!t}if(!n)return new RunTree({...t,client:o,tracingEnabled:r,project_name:i});return new RunTree({name:n.name,id:n.id,trace_id:n.trace_id,dotted_order:n.dotted_order,client:o,tracingEnabled:r,project_name:i,tags:[...new Set((n?.tags??[]).concat(e?.tags??[]))],extra:{metadata:{...n?.extra?.metadata,...e?.metadata}}}).createChild(t)}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,t){const a="get"in e&&"function"==typeof e.get?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,n=a["langsmith-trace"];if(!n||"string"!=typeof n)return;const i=n.trim(),o=i.split(".").map((e=>{const[t,a]=e.split("Z");return{strTime:t,time:Date.parse(t+"Z"),uuid:a}})),r=o[0].uuid,s={...t,name:t?.name??"parent",run_type:t?.run_type??"chain",start_time:t?.start_time??Date.now(),id:o.at(-1)?.uuid,trace_id:r,dotted_order:i};if(a.baggage&&"string"==typeof a.baggage){const e=Baggage.fromHeader(a.baggage);s.metadata=e.metadata,s.tags=e.tags,s.project_name=e.project_name,s.replicas=e.replicas}return new RunTree(s)}toHeaders(e){const t={"langsmith-trace":this.dotted_order,baggage:new Baggage(this.extra?.metadata,this.tags,this.project_name,this.replicas).toHeader()};if(e)for(const[a,n]of Object.entries(t))e.set(a,n);return t}}function isRunTree(e){return void 0!==e&&"function"==typeof e.createChild&&"function"==typeof e.postRun}function isLangChainTracerLike(e){return"object"==typeof e&&null!=e&&"string"==typeof e.name&&"langchain_tracer"===e.name}function containsLangChainTracerLike(e){return Array.isArray(e)&&e.some((e=>isLangChainTracerLike(e)))}function isCallbackManagerLike(e){return"object"==typeof e&&null!=e&&Array.isArray(e.handlers)}function isRunnableConfigLike(e){return void 0!==e&&"object"==typeof e.callbacks&&(containsLangChainTracerLike(e.callbacks?.handlers)||containsLangChainTracerLike(e.callbacks))}function _parseDottedOrder(e){return e.split(".").map((e=>{const t=e.slice(0,-36),a=e.slice(-36),n=parseInt(t.slice(0,4)),i=parseInt(t.slice(4,6))-1,o=parseInt(t.slice(6,8)),r=parseInt(t.slice(9,11)),s=parseInt(t.slice(11,13)),c=parseInt(t.slice(13,15)),l=parseInt(t.slice(15,21));return[new Date(n,i,o,r,s,c,l/1e3),a]}))}Object.defineProperty(RunTree,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null});const convertRunTreeToRun=e=>{if(e)return e.events=e.events??[],e.child_runs=e.child_runs??[],e};function convertRunToRunTree(e,t){if(e)return new RunTree({...e,parent_run:convertRunToRunTree(t),child_runs:e.child_runs.map((e=>convertRunToRunTree(e))).filter((e=>void 0!==e)),extra:{...e.extra,runtime:getRuntimeEnvironmentSync()},tracingEnabled:!1})}function _coerceToDict$1(e,t){return e&&!Array.isArray(e)&&"object"==typeof e?e:{[t]:e}}function stripNonAlphanumeric(e){return e.replace(/[-:.]/g,"")}function convertToDottedOrderFormat(e,t,a){const n=a.toFixed(0).slice(0,3).padStart(3,"0");return stripNonAlphanumeric(`${new Date(e).toISOString().slice(0,-1)}${n}Z`)+t}function isBaseTracer(e){return"function"==typeof e._addRunToRunMap}class BaseTracer extends BaseCallbackHandler{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"runTreeMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"usesRunTreeMap",{enumerable:!0,configurable:!0,writable:!0,value:!1})}copy(){return this}getRunById(e){if(void 0!==e)return this.usesRunTreeMap?convertRunTreeToRun(this.runTreeMap.get(e)):this.runMap.get(e)}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`\n\n${e.stack}`:""):"string"==typeof e?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}_addRunToRunMap(e){const t=convertToDottedOrderFormat(e.start_time,e.id,e.execution_order),a={...e},n=this.getRunById(a.parent_run_id);if(void 0!==a.parent_run_id?n&&(this._addChildRun(n,a),n.child_execution_order=Math.max(n.child_execution_order,a.child_execution_order),a.trace_id=n.trace_id,void 0!==n.dotted_order&&(a.dotted_order=[n.dotted_order,t].join("."))):(a.trace_id=a.id,a.dotted_order=t),this.usesRunTreeMap){const e=convertRunToRunTree(a,n);void 0!==e&&this.runTreeMap.set(a.id,e)}else this.runMap.set(a.id,a);return a}async _endTrace(e){const t=void 0!==e.parent_run_id&&this.getRunById(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),await(this.onRunUpdate?.(e)),this.usesRunTreeMap?this.runTreeMap.delete(e.id):this.runMap.delete(e.id)}_getExecutionOrder(e){const t=void 0!==e&&this.getRunById(e);return t?t.child_execution_order+1:1}_createRunForLLMStart(e,t,a,n,i,o,r,s){const c=this._getExecutionOrder(n),l=Date.now(),p=r?{...i,metadata:r}:i,d={id:a,name:s??e.id[e.id.length-1],parent_run_id:n,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{prompts:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:p??{},tags:o||[]};return this._addRunToRunMap(d)}async handleLLMStart(e,t,a,n,i,o,r,s){const c=this.getRunById(a)??this._createRunForLLMStart(e,t,a,n,i,o,r,s);return await(this.onRunCreate?.(c)),await(this.onLLMStart?.(c)),c}_createRunForChatModelStart(e,t,a,n,i,o,r,s){const c=this._getExecutionOrder(n),l=Date.now(),p=r?{...i,metadata:r}:i,d={id:a,name:s??e.id[e.id.length-1],parent_run_id:n,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{messages:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:p??{},tags:o||[]};return this._addRunToRunMap(d)}async handleChatModelStart(e,t,a,n,i,o,r,s){const c=this.getRunById(a)??this._createRunForChatModelStart(e,t,a,n,i,o,r,s);return await(this.onRunCreate?.(c)),await(this.onLLMStart?.(c)),c}async handleLLMEnd(e,t,a,n,i){const o=this.getRunById(t);if(!o||"llm"!==o?.run_type)throw new Error("No LLM run to end.");return o.end_time=Date.now(),o.outputs=e,o.events.push({name:"end",time:new Date(o.end_time).toISOString()}),o.extra={...o.extra,...i},await(this.onLLMEnd?.(o)),await this._endTrace(o),o}async handleLLMError(e,t,a,n,i){const o=this.getRunById(t);if(!o||"llm"!==o?.run_type)throw new Error("No LLM run to end.");return o.end_time=Date.now(),o.error=this.stringifyError(e),o.events.push({name:"error",time:new Date(o.end_time).toISOString()}),o.extra={...o.extra,...i},await(this.onLLMError?.(o)),await this._endTrace(o),o}_createRunForChainStart(e,t,a,n,i,o,r,s){const c=this._getExecutionOrder(n),l=Date.now(),p={id:a,name:s??e.id[e.id.length-1],parent_run_id:n,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:t,execution_order:c,child_execution_order:c,run_type:r??"chain",child_runs:[],extra:o?{metadata:o}:{},tags:i||[]};return this._addRunToRunMap(p)}async handleChainStart(e,t,a,n,i,o,r,s){const c=this.getRunById(a)??this._createRunForChainStart(e,t,a,n,i,o,r,s);return await(this.onRunCreate?.(c)),await(this.onChainStart?.(c)),c}async handleChainEnd(e,t,a,n,i){const o=this.getRunById(t);if(!o)throw new Error("No chain run to end.");return o.end_time=Date.now(),o.outputs=_coerceToDict$1(e,"output"),o.events.push({name:"end",time:new Date(o.end_time).toISOString()}),void 0!==i?.inputs&&(o.inputs=_coerceToDict$1(i.inputs,"input")),await(this.onChainEnd?.(o)),await this._endTrace(o),o}async handleChainError(e,t,a,n,i){const o=this.getRunById(t);if(!o)throw new Error("No chain run to end.");return o.end_time=Date.now(),o.error=this.stringifyError(e),o.events.push({name:"error",time:new Date(o.end_time).toISOString()}),void 0!==i?.inputs&&(o.inputs=_coerceToDict$1(i.inputs,"input")),await(this.onChainError?.(o)),await this._endTrace(o),o}_createRunForToolStart(e,t,a,n,i,o,r){const s=this._getExecutionOrder(n),c=Date.now(),l={id:a,name:r??e.id[e.id.length-1],parent_run_id:n,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:t},execution_order:s,child_execution_order:s,run_type:"tool",child_runs:[],extra:o?{metadata:o}:{},tags:i||[]};return this._addRunToRunMap(l)}async handleToolStart(e,t,a,n,i,o,r){const s=this.getRunById(a)??this._createRunForToolStart(e,t,a,n,i,o,r);return await(this.onRunCreate?.(s)),await(this.onToolStart?.(s)),s}async handleToolEnd(e,t){const a=this.getRunById(t);if(!a||"tool"!==a?.run_type)throw new Error("No tool run to end");return a.end_time=Date.now(),a.outputs={output:e},a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),await(this.onToolEnd?.(a)),await this._endTrace(a),a}async handleToolError(e,t){const a=this.getRunById(t);if(!a||"tool"!==a?.run_type)throw new Error("No tool run to end");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),await(this.onToolError?.(a)),await this._endTrace(a),a}async handleAgentAction(e,t){const a=this.getRunById(t);if(!a||"chain"!==a?.run_type)return;const n=a;n.actions=n.actions||[],n.actions.push(e),n.events.push({name:"agent_action",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentAction?.(a))}async handleAgentEnd(e,t){const a=this.getRunById(t);a&&"chain"===a?.run_type&&(a.events.push({name:"agent_end",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentEnd?.(a)))}_createRunForRetrieverStart(e,t,a,n,i,o,r){const s=this._getExecutionOrder(n),c=Date.now(),l={id:a,name:r??e.id[e.id.length-1],parent_run_id:n,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:t},execution_order:s,child_execution_order:s,run_type:"retriever",child_runs:[],extra:o?{metadata:o}:{},tags:i||[]};return this._addRunToRunMap(l)}async handleRetrieverStart(e,t,a,n,i,o,r){const s=this.getRunById(a)??this._createRunForRetrieverStart(e,t,a,n,i,o,r);return await(this.onRunCreate?.(s)),await(this.onRetrieverStart?.(s)),s}async handleRetrieverEnd(e,t){const a=this.getRunById(t);if(!a||"retriever"!==a?.run_type)throw new Error("No retriever run to end");return a.end_time=Date.now(),a.outputs={documents:e},a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),await(this.onRetrieverEnd?.(a)),await this._endTrace(a),a}async handleRetrieverError(e,t){const a=this.getRunById(t);if(!a||"retriever"!==a?.run_type)throw new Error("No retriever run to end");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),await(this.onRetrieverError?.(a)),await this._endTrace(a),a}async handleText(e,t){const a=this.getRunById(t);a&&"chain"===a?.run_type&&(a.events.push({name:"text",time:(new Date).toISOString(),kwargs:{text:e}}),await(this.onText?.(a)))}async handleLLMNewToken(e,t,a,n,i,o){const r=this.getRunById(a);if(!r||"llm"!==r?.run_type)throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return r.events.push({name:"new_token",time:(new Date).toISOString(),kwargs:{token:e,idx:t,chunk:o?.chunk}}),await(this.onLLMNewToken?.(r,e,{chunk:o?.chunk})),r}}function wrap(e,t){return`${e.open}${t}${e.close}`}function tryJsonStringify(e,t){try{return JSON.stringify(e,null,2)}catch(e){return t}}function formatKVMapItem(e){return"string"==typeof e?e.trim():null==e?e:tryJsonStringify(e,e.toString())}function elapsed(e){if(!e.end_time)return"";const t=e.end_time-e.start_time;return t<1e3?`${t}ms`:`${(t/1e3).toFixed(2)}s`}const{color:color}=styles;class ConsoleCallbackHandler extends BaseTracer{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let a=e;for(;a.parent_run_id;){const e=this.runMap.get(a.parent_run_id);if(!e)break;t.push(e),a=e}return t}getBreadcrumbs(e){const t=[...this.getParents(e).reverse(),e].map(((e,t,a)=>{const n=`${e.execution_order}:${e.run_type}:${e.name}`;return t===a.length-1?wrap(styles.bold,n):n})).join(" > ");return wrap(color.grey,t)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${wrap(color.green,"[chain/start]")} [${t}] Entering Chain run with input: ${tryJsonStringify(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${wrap(color.cyan,"[chain/end]")} [${t}] [${elapsed(e)}] Exiting Chain run with output: ${tryJsonStringify(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${wrap(color.red,"[chain/error]")} [${t}] [${elapsed(e)}] Chain run errored with error: ${tryJsonStringify(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),a="prompts"in e.inputs?{prompts:e.inputs.prompts.map((e=>e.trim()))}:e.inputs;console.log(`${wrap(color.green,"[llm/start]")} [${t}] Entering LLM run with input: ${tryJsonStringify(a,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${wrap(color.cyan,"[llm/end]")} [${t}] [${elapsed(e)}] Exiting LLM run with output: ${tryJsonStringify(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${wrap(color.red,"[llm/error]")} [${t}] [${elapsed(e)}] LLM run errored with error: ${tryJsonStringify(e.error,"[error]")}`)}onToolStart(e){const t=this.getBreadcrumbs(e);console.log(`${wrap(color.green,"[tool/start]")} [${t}] Entering Tool run with input: "${formatKVMapItem(e.inputs.input)}"`)}onToolEnd(e){const t=this.getBreadcrumbs(e);console.log(`${wrap(color.cyan,"[tool/end]")} [${t}] [${elapsed(e)}] Exiting Tool run with output: "${formatKVMapItem(e.outputs?.output)}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${wrap(color.red,"[tool/error]")} [${t}] [${elapsed(e)}] Tool run errored with error: ${tryJsonStringify(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${wrap(color.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${tryJsonStringify(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${wrap(color.cyan,"[retriever/end]")} [${t}] [${elapsed(e)}] Exiting Retriever run with output: ${tryJsonStringify(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${wrap(color.red,"[retriever/error]")} [${t}] [${elapsed(e)}] Retriever run errored with error: ${tryJsonStringify(e.error,"[error]")}`)}onAgentAction(e){const t=e,a=this.getBreadcrumbs(e);console.log(`${wrap(color.blue,"[agent/action]")} [${a}] Agent selected action: ${tryJsonStringify(t.actions[t.actions.length-1],"[action]")}`)}}function _isToolCall(e){return!(!e||"object"!=typeof e||!("type"in e)||"tool_call"!==e.type)}function _configHasToolCallId(e){return!!(e&&"object"==typeof e&&"toolCall"in e&&null!=e.toolCall&&"object"==typeof e.toolCall&&"id"in e.toolCall&&"string"==typeof e.toolCall.id)}class ToolInputParsingException extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}}function parsePartialJson(e){if(void 0===e)return null;try{return JSON.parse(e)}catch(e){}let t="";const a=[];let n=!1,i=!1;for(let o of e){if(n)'"'!==o||i?"\n"!==o||i?i="\\"===o&&!i:o="\\n":n=!1;else if('"'===o)n=!0,i=!1;else if("{"===o)a.push("}");else if("["===o)a.push("]");else if("}"===o||"]"===o){if(!a||a[a.length-1]!==o)return null;a.pop()}t+=o}n&&(t+='"');for(let e=a.length-1;e>=0;e-=1)t+=a[e];try{return JSON.parse(t)}catch(e){return null}}function isDataContentBlock(e){return"object"==typeof e&&null!==e&&"type"in e&&"string"==typeof e.type&&"source_type"in e&&("url"===e.source_type||"base64"===e.source_type||"text"===e.source_type||"id"===e.source_type)}function mergeContent(e,t){return"string"==typeof e?""===e?t:"string"==typeof t?e+t:Array.isArray(t)&&t.some((e=>isDataContentBlock(e)))?[{type:"text",source_type:"text",text:e},...t]:[{type:"text",text:e},...t]:Array.isArray(t)?_mergeLists(e,t)??[...e,...t]:""===t?e:Array.isArray(e)&&e.some((e=>isDataContentBlock(e)))?[...e,{type:"file",source_type:"text",text:t}]:[...e,{type:"text",text:t}]}function stringifyWithDepthLimit(e,t){return JSON.stringify(function e(a,n){if("object"!=typeof a||null==a)return a;if(n>=t)return Array.isArray(a)?"[Array]":"[Object]";if(Array.isArray(a))return a.map((t=>e(t,n+1)));const i={};for(const t of Object.keys(a))i[t]=e(a[t],n+1);return i}(e,0),null,2)}class BaseMessage extends Serializable{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return"string"==typeof this.content?this.content:Array.isArray(this.content)?this.content.map((e=>"string"==typeof e?e:"text"===e.type?e.text:"")).join(""):""}getType(){return this._getType()}constructor(e,t){"string"==typeof e&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(null===e)return this;const t=stringifyWithDepthLimit(this._printableFields,Math.max(4,e));return`${this.constructor.lc_name()} ${t}`}}function _mergeDicts(e,t){const a={...e};for(const[e,n]of Object.entries(t))if(null==a[e])a[e]=n;else{if(null==n)continue;if(typeof a[e]!=typeof n||Array.isArray(a[e])!==Array.isArray(n))throw new Error(`field[${e}] already exists in the message chunk, but with a different type.`);if("string"==typeof a[e]){if("type"===e)continue;a[e]+=n}else if("object"!=typeof a[e]||Array.isArray(a[e]))if(Array.isArray(a[e]))a[e]=_mergeLists(a[e],n);else{if(a[e]===n)continue;console.warn(`field[${e}] already exists in this message chunk and value has unsupported type.`)}else a[e]=_mergeDicts(a[e],n)}return a}function _mergeLists(e,t){if(void 0!==e||void 0!==t){if(void 0===e||void 0===t)return e||t;{const a=[...e];for(const e of t)if("object"==typeof e&&"index"in e&&"number"==typeof e.index){const t=a.findIndex((t=>t.index===e.index));-1!==t?a[t]=_mergeDicts(a[t],e):a.push(e)}else{if("object"==typeof e&&"text"in e&&""===e.text)continue;a.push(e)}return a}}}class BaseMessageChunk extends BaseMessage{}function isDirectToolOutput(e){return null!=e&&"object"==typeof e&&"lc_direct_tool_output"in e&&!0===e.lc_direct_tool_output}class ToolMessage extends BaseMessage{static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}constructor(e,t,a){"string"==typeof e&&(e={content:e,name:a,tool_call_id:t}),super(e),Object.defineProperty(this,"lc_direct_tool_output",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}_getType(){return"tool"}static isInstance(e){return"tool"===e._getType()}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}class AIMessageChunk extends BaseMessageChunk{constructor(e){let t;if("string"==typeof e)t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(void 0===e.tool_call_chunks)t={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:void 0!==e.usage_metadata?e.usage_metadata:void 0};else{const a=[],n=[];for(const t of e.tool_call_chunks){let e={};try{if(e=parsePartialJson(t.args||"{}"),null===e||"object"!=typeof e||Array.isArray(e))throw new Error("Malformed tool call chunk args.");a.push({name:t.name??"",args:e,id:t.id,type:"tool_call"})}catch(e){n.push({name:t.name,args:t.args,id:t.id,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:a,invalid_tool_calls:n,usage_metadata:void 0!==e.usage_metadata?e.usage_metadata:void 0}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){const t={content:mergeContent(this.content,e.content),additional_kwargs:_mergeDicts(this.additional_kwargs,e.additional_kwargs),response_metadata:_mergeDicts(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(void 0!==this.tool_call_chunks||void 0!==e.tool_call_chunks){const a=_mergeLists(this.tool_call_chunks,e.tool_call_chunks);void 0!==a&&a.length>0&&(t.tool_call_chunks=a)}if(void 0!==this.usage_metadata||void 0!==e.usage_metadata){const a={...(void 0!==this.usage_metadata?.input_token_details?.audio||void 0!==e.usage_metadata?.input_token_details?.audio)&&{audio:(this.usage_metadata?.input_token_details?.audio??0)+(e.usage_metadata?.input_token_details?.audio??0)},...(void 0!==this.usage_metadata?.input_token_details?.cache_read||void 0!==e.usage_metadata?.input_token_details?.cache_read)&&{cache_read:(this.usage_metadata?.input_token_details?.cache_read??0)+(e.usage_metadata?.input_token_details?.cache_read??0)},...(void 0!==this.usage_metadata?.input_token_details?.cache_creation||void 0!==e.usage_metadata?.input_token_details?.cache_creation)&&{cache_creation:(this.usage_metadata?.input_token_details?.cache_creation??0)+(e.usage_metadata?.input_token_details?.cache_creation??0)}},n={...(void 0!==this.usage_metadata?.output_token_details?.audio||void 0!==e.usage_metadata?.output_token_details?.audio)&&{audio:(this.usage_metadata?.output_token_details?.audio??0)+(e.usage_metadata?.output_token_details?.audio??0)},...(void 0!==this.usage_metadata?.output_token_details?.reasoning||void 0!==e.usage_metadata?.output_token_details?.reasoning)&&{reasoning:(this.usage_metadata?.output_token_details?.reasoning??0)+(e.usage_metadata?.output_token_details?.reasoning??0)}},i=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},o=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},r={input_tokens:i.input_tokens+o.input_tokens,output_tokens:i.output_tokens+o.output_tokens,total_tokens:i.total_tokens+o.total_tokens,...Object.keys(a).length>0&&{input_token_details:a},...Object.keys(n).length>0&&{output_token_details:n}};t.usage_metadata=r}return new AIMessageChunk(t)}}function getBufferString(e,t="Human",a="AI"){const n=[];for(const i of e){let e;if("human"===i._getType())e=t;else if("ai"===i._getType())e=a;else if("system"===i._getType())e="System";else if("function"===i._getType())e="Function";else if("tool"===i._getType())e="Tool";else{if("generic"!==i._getType())throw new Error(`Got unsupported message type: ${i._getType()}`);e=i.role}const o=i.name?`${i.name}, `:"",r="string"==typeof i.content?i.content:JSON.stringify(i.content,null,2);n.push(`${e}: ${o}${r}`)}return n.join("\n")}let MockAsyncLocalStorage$1=class{getStore(){}run(e,t){return t()}};const TRACING_ALS_KEY$1=Symbol.for("ls:tracing_async_local_storage"),mockAsyncLocalStorage$1=new MockAsyncLocalStorage$1;let AsyncLocalStorageProvider$1=class{getInstance(){return globalThis[TRACING_ALS_KEY$1]??mockAsyncLocalStorage$1}initializeGlobalInstance(e){void 0===globalThis[TRACING_ALS_KEY$1]&&(globalThis[TRACING_ALS_KEY$1]=e)}};const AsyncLocalStorageProviderSingleton$1=new AsyncLocalStorageProvider$1;function getCurrentRunTree(e=!1){const t=AsyncLocalStorageProviderSingleton$1.getInstance().getStore();if(!e&&!isRunTree(t))throw new Error("Could not get the current run tree.\n\nPlease make sure you are calling this method within a traceable function and that tracing is enabled.");return t}function isTraceableFunction(e){return"function"==typeof e&&"langsmith:traceable"in e}let client;const getDefaultLangChainClientSingleton=()=>{if(void 0===client){const e="false"===getEnvironmentVariable$1("LANGCHAIN_CALLBACKS_BACKGROUND")?{blockOnRootRunFinalization:!0}:{};client=new Client(e)}return client};class LangChainTracer extends BaseTracer{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"usesRunTreeMap",{enumerable:!0,configurable:!0,writable:!0,value:!0});const{exampleId:t,projectName:a,client:n,replicas:i}=e;this.projectName=a??getDefaultProjectName(),this.replicas=i,this.exampleId=t,this.client=n??getDefaultLangChainClientSingleton();const o=LangChainTracer.getTraceableRunTree();o&&this.updateFromRunTree(o)}async persistRun(e){}async onRunCreate(e){const t=this.getRunTreeWithTracingConfig(e.id);await(t?.postRun())}async onRunUpdate(e){const t=this.getRunTreeWithTracingConfig(e.id);await(t?.patchRun())}getRun(e){return this.runTreeMap.get(e)}updateFromRunTree(e){let t=e;const a=new Set;for(;t.parent_run&&!a.has(t.id)&&(a.add(t.id),t.parent_run);)t=t.parent_run;a.clear();const n=[t];for(;n.length>0;){const e=n.shift();e&&!a.has(e.id)&&(a.add(e.id),this.runTreeMap.set(e.id,e),e.child_runs&&n.push(...e.child_runs))}this.client=e.client??this.client,this.replicas=e.replicas??this.replicas,this.projectName=e.project_name??this.projectName,this.exampleId=e.reference_example_id??this.exampleId}getRunTreeWithTracingConfig(e){const t=this.runTreeMap.get(e);if(t)return new RunTree({...t,client:this.client,project_name:this.projectName,replicas:this.replicas,reference_example_id:this.exampleId,tracingEnabled:!0})}static getTraceableRunTree(){try{return getCurrentRunTree(!0)}catch{return}}}const TRACING_ALS_KEY=Symbol.for("ls:tracing_async_local_storage"),_CONTEXT_VARIABLES_KEY=Symbol.for("lc:context_variables"),setGlobalAsyncLocalStorageInstance=e=>{globalThis[TRACING_ALS_KEY]=e},getGlobalAsyncLocalStorageInstance=()=>globalThis[TRACING_ALS_KEY];let queue;function createQueue(){return new("default"in _default?_default.default:_default)({autoStart:!0,concurrency:1})}function getQueue(){return void 0===queue&&(queue=createQueue()),queue}async function consumeCallback(e,t){if(!0===t){const t=getGlobalAsyncLocalStorageInstance();void 0!==t?await t.run(void 0,(async()=>e())):await e()}else queue=getQueue(),queue.add((async()=>{const t=getGlobalAsyncLocalStorageInstance();void 0!==t?await t.run(void 0,(async()=>e())):await e()}))}const isTracingEnabled=e=>!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find((e=>"true"===getEnvironmentVariable$1(e)));function getContextVariable(e){const t=getGlobalAsyncLocalStorageInstance();if(void 0===t)return;const a=t.getStore();return a?.[_CONTEXT_VARIABLES_KEY]?.[e]}const LC_CONFIGURE_HOOKS_KEY=Symbol("lc:configure_hooks"),_getConfigureHooks=()=>getContextVariable(LC_CONFIGURE_HOOKS_KEY)||[];function parseCallbackConfigArg(e){return e?Array.isArray(e)||"name"in e?{callbacks:e}:e:{}}class BaseCallbackManager{setHandler(e){return this.setHandlers([e])}}class BaseRunManager{constructor(e,t,a,n,i,o,r,s){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:s})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map((t=>consumeCallback((async()=>{try{await(t.handleText?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleText: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleCustomEvent(e,t,a,n,i){await Promise.all(this.handlers.map((a=>consumeCallback((async()=>{try{await(a.handleCustomEvent?.(e,t,this.runId,this.tags,this.metadata))}catch(e){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleCustomEvent: ${e}`),a.raiseError)throw e}}),a.awaitHandlers))))}}class CallbackManagerForRetrieverRun extends BaseRunManager{getChild(e){const t=new CallbackManager(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map((t=>consumeCallback((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleRetrieverError(e){await Promise.all(this.handlers.map((t=>consumeCallback((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags))}catch(a){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetrieverError: ${a}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class CallbackManagerForLLMRun extends BaseRunManager{async handleLLMNewToken(e,t,a,n,i,o){await Promise.all(this.handlers.map((a=>consumeCallback((async()=>{if(!a.ignoreLLM)try{await(a.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,o))}catch(e){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleLLMNewToken: ${e}`),a.raiseError)throw e}}),a.awaitHandlers))))}async handleLLMError(e,t,a,n,i){await Promise.all(this.handlers.map((t=>consumeCallback((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags,i))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMError: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleLLMEnd(e,t,a,n,i){await Promise.all(this.handlers.map((t=>consumeCallback((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags,i))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class CallbackManagerForChainRun extends BaseRunManager{getChild(e){const t=new CallbackManager(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,a,n,i){await Promise.all(this.handlers.map((t=>consumeCallback((async()=>{if(!t.ignoreChain)try{await(t.handleChainError?.(e,this.runId,this._parentRunId,this.tags,i))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleChainError: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleChainEnd(e,t,a,n,i){await Promise.all(this.handlers.map((t=>consumeCallback((async()=>{if(!t.ignoreChain)try{await(t.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,i))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleChainEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleAgentAction(e){await Promise.all(this.handlers.map((t=>consumeCallback((async()=>{if(!t.ignoreAgent)try{await(t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentAction: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleAgentEnd(e){await Promise.all(this.handlers.map((t=>consumeCallback((async()=>{if(!t.ignoreAgent)try{await(t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class CallbackManagerForToolRun extends BaseRunManager{getChild(e){const t=new CallbackManager(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map((t=>consumeCallback((async()=>{if(!t.ignoreAgent)try{await(t.handleToolError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolError: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleToolEnd(e){await Promise.all(this.handlers.map((t=>consumeCallback((async()=>{if(!t.ignoreAgent)try{await(t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class CallbackManager extends BaseCallbackManager{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,a=void 0,n=void 0,i=void 0,o=void 0,r=void 0,s=void 0){return Promise.all(t.map((async(t,n)=>{const o=0===n&&a?a:v4$1();return await Promise.all(this.handlers.map((a=>{if(!a.ignoreLLM)return isBaseTracer(a)&&a._createRunForLLMStart(e,[t],o,this._parentRunId,i,this.tags,this.metadata,s),consumeCallback((async()=>{try{await(a.handleLLMStart?.(e,[t],o,this._parentRunId,i,this.tags,this.metadata,s))}catch(e){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleLLMStart: ${e}`),a.raiseError)throw e}}),a.awaitHandlers)}))),new CallbackManagerForLLMRun(o,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)})))}async handleChatModelStart(e,t,a=void 0,n=void 0,i=void 0,o=void 0,r=void 0,s=void 0){return Promise.all(t.map((async(t,n)=>{const o=0===n&&a?a:v4$1();return await Promise.all(this.handlers.map((a=>{if(!a.ignoreLLM)return isBaseTracer(a)&&a._createRunForChatModelStart(e,[t],o,this._parentRunId,i,this.tags,this.metadata,s),consumeCallback((async()=>{try{if(a.handleChatModelStart)await(a.handleChatModelStart?.(e,[t],o,this._parentRunId,i,this.tags,this.metadata,s));else if(a.handleLLMStart){const n=getBufferString(t);await(a.handleLLMStart?.(e,[n],o,this._parentRunId,i,this.tags,this.metadata,s))}}catch(e){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleLLMStart: ${e}`),a.raiseError)throw e}}),a.awaitHandlers)}))),new CallbackManagerForLLMRun(o,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)})))}async handleChainStart(e,t,a=v4$1(),n=void 0,i=void 0,o=void 0,r=void 0){return await Promise.all(this.handlers.map((i=>{if(!i.ignoreChain)return isBaseTracer(i)&&i._createRunForChainStart(e,t,a,this._parentRunId,this.tags,this.metadata,n,r),consumeCallback((async()=>{try{await(i.handleChainStart?.(e,t,a,this._parentRunId,this.tags,this.metadata,n,r))}catch(e){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainStart: ${e}`),i.raiseError)throw e}}),i.awaitHandlers)}))),new CallbackManagerForChainRun(a,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,a=v4$1(),n=void 0,i=void 0,o=void 0,r=void 0){return await Promise.all(this.handlers.map((n=>{if(!n.ignoreAgent)return isBaseTracer(n)&&n._createRunForToolStart(e,t,a,this._parentRunId,this.tags,this.metadata,r),consumeCallback((async()=>{try{await(n.handleToolStart?.(e,t,a,this._parentRunId,this.tags,this.metadata,r))}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleToolStart: ${e}`),n.raiseError)throw e}}),n.awaitHandlers)}))),new CallbackManagerForToolRun(a,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,a=v4$1(),n=void 0,i=void 0,o=void 0,r=void 0){return await Promise.all(this.handlers.map((n=>{if(!n.ignoreRetriever)return isBaseTracer(n)&&n._createRunForRetrieverStart(e,t,a,this._parentRunId,this.tags,this.metadata,r),consumeCallback((async()=>{try{await(n.handleRetrieverStart?.(e,t,a,this._parentRunId,this.tags,this.metadata,r))}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleRetrieverStart: ${e}`),n.raiseError)throw e}}),n.awaitHandlers)}))),new CallbackManagerForRetrieverRun(a,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,t,a,n,i){await Promise.all(this.handlers.map((n=>consumeCallback((async()=>{if(!n.ignoreCustomEvent)try{await(n.handleCustomEvent?.(e,t,a,this.tags,this.metadata))}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleCustomEvent: ${e}`),n.raiseError)throw e}}),n.awaitHandlers))))}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter((t=>t!==e)),this.inheritableHandlers=this.inheritableHandlers.filter((t=>t!==e))}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const a of e)this.addHandler(a,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter((t=>!e.includes(t))),this.inheritableTags=this.inheritableTags.filter((t=>!e.includes(t)))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const a=new CallbackManager(this._parentRunId);for(const e of this.handlers){const t=this.inheritableHandlers.includes(e);a.addHandler(e,t)}for(const e of this.tags){const t=this.inheritableTags.includes(e);a.addTags([e],t)}for(const e of Object.keys(this.metadata)){const t=Object.keys(this.inheritableMetadata).includes(e);a.addMetadata({[e]:this.metadata[e]},t)}for(const n of e)a.handlers.filter((e=>"console_callback_handler"===e.name)).some((e=>e.name===n.name))||a.addHandler(n,t);return a}static fromHandlers(e){const t=new this;return t.addHandler(new class extends BaseCallbackHandler{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:v4$1()}),Object.assign(this,e)}}),t}static configure(e,t,a,n,i,o,r){return this._configureSync(e,t,a,n,i,o,r)}static _configureSync(e,t,a,n,i,o,r){let s;(e||t)&&(Array.isArray(e)||!e?(s=new CallbackManager,s.setHandlers(e?.map(ensureHandler)??[],!0)):s=e,s=s.copy(Array.isArray(t)?t.map(ensureHandler):t?.handlers,!1));const c="true"===getEnvironmentVariable$1("LANGCHAIN_VERBOSE")||r?.verbose,l=LangChainTracer.getTraceableRunTree()?.tracingEnabled||isTracingEnabled(),p=l||(getEnvironmentVariable$1("LANGCHAIN_TRACING")??!1);if(c||p){if(s||(s=new CallbackManager),c&&!s.handlers.some((e=>e.name===ConsoleCallbackHandler.prototype.name))){const e=new ConsoleCallbackHandler;s.addHandler(e,!0)}if(p&&!s.handlers.some((e=>"langchain_tracer"===e.name))&&l){const e=new LangChainTracer;s.addHandler(e,!0),s._parentRunId=LangChainTracer.getTraceableRunTree()?.id??s._parentRunId}}for(const{contextVar:e,inheritable:t=!0,handlerClass:a,envVar:n}of _getConfigureHooks()){const i=n&&"true"===getEnvironmentVariable$1(n)&&a;let o;const r=void 0!==e?getContextVariable(e):void 0;r&&isBaseCallbackHandler(r)?o=r:i&&(o=new a({})),void 0!==o&&(s||(s=new CallbackManager),s.handlers.some((e=>e.name===o.name))||s.addHandler(o,t))}return(a||n)&&s&&(s.addTags(a??[]),s.addTags(n??[],!1)),(i||o)&&s&&(s.addMetadata(i??{}),s.addMetadata(o??{},!1)),s}}function ensureHandler(e){return"name"in e?e:BaseCallbackHandler.fromMethods(e)}const STATUS_NO_RETRY=[400,401,402,403,404,405,406,407,409],defaultFailedAttemptHandler=e=>{if(e.message.startsWith("Cancel")||e.message.startsWith("AbortError")||"AbortError"===e.name)throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response?.status??e?.status;if(t&&STATUS_NO_RETRY.includes(+t))throw e;if("insufficient_quota"===e?.error?.code){const t=new Error(e?.message);throw t.name="InsufficientQuotaError",t}};class AsyncCaller{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??defaultFailedAttemptHandler;const t="default"in _default?_default.default:_default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add((()=>pRetry$1((()=>e(...t).catch((e=>{throw e instanceof Error?e:new Error(e)}))),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0})),{throwOnTimeout:!0})}callWithOptions(e,t,...a){return e.signal?Promise.race([this.call(t,...a),new Promise(((t,a)=>{e.signal?.addEventListener("abort",(()=>{a(new Error("AbortError"))}))}))]):this.call(t,...a)}fetch(...e){return this.call((()=>fetch(...e).then((e=>e.ok?e:Promise.reject(e)))))}}var base64Js={};base64Js.byteLength=byteLength,base64Js.toByteArray=toByteArray,base64Js.fromByteArray=fromByteArray;for(var lookup=[],revLookup=[],Arr="undefined"!=typeof Uint8Array?Uint8Array:Array,code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=0,len=code.length;i<len;++i)lookup[i]=code[i],revLookup[code.charCodeAt(i)]=i;function getLens(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var a=e.indexOf("=");return-1===a&&(a=t),[a,a===t?0:4-a%4]}function byteLength(e){var t=getLens(e),a=t[0],n=t[1];return 3*(a+n)/4-n}function _byteLength(e,t,a){return 3*(t+a)/4-a}function toByteArray(e){var t,a,n=getLens(e),i=n[0],o=n[1],r=new Arr(_byteLength(e,i,o)),s=0,c=o>0?i-4:i;for(a=0;a<c;a+=4)t=revLookup[e.charCodeAt(a)]<<18|revLookup[e.charCodeAt(a+1)]<<12|revLookup[e.charCodeAt(a+2)]<<6|revLookup[e.charCodeAt(a+3)],r[s++]=t>>16&255,r[s++]=t>>8&255,r[s++]=255&t;return 2===o&&(t=revLookup[e.charCodeAt(a)]<<2|revLookup[e.charCodeAt(a+1)]>>4,r[s++]=255&t),1===o&&(t=revLookup[e.charCodeAt(a)]<<10|revLookup[e.charCodeAt(a+1)]<<4|revLookup[e.charCodeAt(a+2)]>>2,r[s++]=t>>8&255,r[s++]=255&t),r}function tripletToBase64(e){return lookup[e>>18&63]+lookup[e>>12&63]+lookup[e>>6&63]+lookup[63&e]}function encodeChunk(e,t,a){for(var n,i=[],o=t;o<a;o+=3)n=(e[o]<<16&16711680)+(e[o+1]<<8&65280)+(255&e[o+2]),i.push(tripletToBase64(n));return i.join("")}function fromByteArray(e){for(var t,a=e.length,n=a%3,i=[],o=16383,r=0,s=a-n;r<s;r+=o)i.push(encodeChunk(e,r,r+o>s?s:r+o));return 1===n?(t=e[a-1],i.push(lookup[t>>2]+lookup[t<<4&63]+"==")):2===n&&(t=(e[a-2]<<8)+e[a-1],i.push(lookup[t>>10]+lookup[t>>4&63]+lookup[t<<2&63]+"=")),i.join("")}revLookup["-".charCodeAt(0)]=62,revLookup["_".charCodeAt(0)]=63;var __defProp=Object.defineProperty,__defNormalProp=(e,t,a)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,__publicField=(e,t,a)=>(__defNormalProp(e,t+"",a),a);function bytePairMerge(e,t){let a=Array.from({length:e.length},((e,t)=>({start:t,end:t+1})));for(;a.length>1;){let n=null;for(let i=0;i<a.length-1;i++){const o=e.slice(a[i].start,a[i+1].end),r=t.get(o.join(","));null!=r&&((null==n||r<n[0])&&(n=[r,i]))}if(null==n)break;{const e=n[1];a[e]={start:a[e].start,end:a[e+1].end},a.splice(e+1,1)}}return a}function bytePairEncode(e,t){return 1===e.length?[t.get(e.join(","))]:bytePairMerge(e,t).map((a=>t.get(e.slice(a.start,a.end).join(",")))).filter((e=>null!=e))}function escapeRegex(e){return e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var _Tiktoken=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(e,t){this.patStr=e.pat_str;const a=e.bpe_ranks.split("\n").filter(Boolean).reduce(((e,t)=>{const[a,n,...i]=t.split(" "),o=Number.parseInt(n,10);return i.forEach(((t,a)=>e[t]=o+a)),e}),{});for(const[e,t]of Object.entries(a)){const a=base64Js.toByteArray(e);this.rankMap.set(a.join(","),t),this.textMap.set(t,a)}this.specialTokens={...e.special_tokens,...t},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce(((e,[t,a])=>(e[a]=this.textEncoder.encode(t),e)),{})}encode(e,t=[],a="all"){const n=new RegExp(this.patStr,"ug"),i=_Tiktoken.specialTokenRegex(Object.keys(this.specialTokens)),o=[],r=new Set("all"===t?Object.keys(this.specialTokens):t),s=new Set("all"===a?Object.keys(this.specialTokens).filter((e=>!r.has(e))):a);if(s.size>0){const t=_Tiktoken.specialTokenRegex([...s]),a=e.match(t);if(null!=a)throw new Error(`The text contains a special token that is not allowed: ${a[0]}`)}let c=0;for(;;){let t=null,a=c;for(;i.lastIndex=a,t=i.exec(e),null!=t&&!r.has(t[0]);)a=t.index+1;const s=t?.index??e.length;for(const t of e.substring(c,s).matchAll(n)){const e=this.textEncoder.encode(t[0]),a=this.rankMap.get(e.join(","));null==a?o.push(...bytePairEncode(e,this.rankMap)):o.push(a)}if(null==t)break;let l=this.specialTokens[t[0]];o.push(l),c=t.index+t[0].length}return o}decode(e){const t=[];let a=0;for(let n=0;n<e.length;++n){const i=e[n],o=this.textMap.get(i)??this.inverseSpecialTokens[i];null!=o&&(t.push(o),a+=o.length)}const n=new Uint8Array(a);let i=0;for(const e of t)n.set(e,i),i+=e.length;return this.textDecoder.decode(n)}},Tiktoken=_Tiktoken;__publicField(Tiktoken,"specialTokenRegex",(e=>new RegExp(e.map((e=>escapeRegex(e))).join("|"),"g")));
/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2017-2022 Joachim Wester
 * MIT licensed
 */
const _hasOwnProperty=Object.prototype.hasOwnProperty;function hasOwnProperty(e,t){return _hasOwnProperty.call(e,t)}function _objectKeys(e){if(Array.isArray(e)){const t=new Array(e.length);for(let e=0;e<t.length;e++)t[e]=""+e;return t}if(Object.keys)return Object.keys(e);let t=[];for(let a in e)hasOwnProperty(e,a)&&t.push(a);return t}function _deepClone(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function isInteger(e){let t=0;const a=e.length;let n;for(;t<a;){if(n=e.charCodeAt(t),!(n>=48&&n<=57))return!1;t++}return!0}function unescapePathComponent(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function hasUndefined(e){if(void 0===e)return!0;if(e)if(Array.isArray(e)){for(let t=0,a=e.length;t<a;t++)if(hasUndefined(e[t]))return!0}else if("object"==typeof e){const a=_objectKeys(e),n=a.length;for(var t=0;t<n;t++)if(hasUndefined(e[a[t]]))return!0}return!1}function patchErrorMessageFormatter(e,t){const a=[e];for(const e in t){const n="object"==typeof t[e]?JSON.stringify(t[e],null,2):t[e];void 0!==n&&a.push(`${e}: ${n}`)}return a.join("\n")}class PatchError extends Error{constructor(e,t,a,n,i){super(patchErrorMessageFormatter(e,{name:t,index:a,operation:n,tree:i})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.setPrototypeOf(this,new.target.prototype),this.message=patchErrorMessageFormatter(e,{name:t,index:a,operation:n,tree:i})}}const JsonPatchError=PatchError,objOps={add:function(e,t,a){return e[t]=this.value,{newDocument:a}},remove:function(e,t,a){var n=e[t];return delete e[t],{newDocument:a,removed:n}},replace:function(e,t,a){var n=e[t];return e[t]=this.value,{newDocument:a,removed:n}},move:function(e,t,a){let n=getValueByPointer(a,this.path);n&&(n=_deepClone(n));const i=applyOperation(a,{op:"remove",path:this.from}).removed;return applyOperation(a,{op:"add",path:this.path,value:i}),{newDocument:a,removed:n}},copy:function(e,t,a){const n=getValueByPointer(a,this.from);return applyOperation(a,{op:"add",path:this.path,value:_deepClone(n)}),{newDocument:a}},test:function(e,t,a){return{newDocument:a,test:_areEquals(e[t],this.value)}},_get:function(e,t,a){return this.value=e[t],{newDocument:a}}};var arrOps={add:function(e,t,a){return isInteger(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:a,index:t}},remove:function(e,t,a){return{newDocument:a,removed:e.splice(t,1)[0]}},replace:function(e,t,a){var n=e[t];return e[t]=this.value,{newDocument:a,removed:n}},move:objOps.move,copy:objOps.copy,test:objOps.test,_get:objOps._get};function getValueByPointer(e,t){if(""==t)return e;var a={op:"_get",path:t};return applyOperation(e,a),a.value}function applyOperation(e,t,a=!1,n=!0,i=!0,o=0){if(a&&("function"==typeof a?a(t,0,e,t.path):validator(t,0)),""===t.path){let n={newDocument:e};if("add"===t.op)return n.newDocument=t.value,n;if("replace"===t.op)return n.newDocument=t.value,n.removed=e,n;if("move"===t.op||"copy"===t.op)return n.newDocument=getValueByPointer(e,t.from),"move"===t.op&&(n.removed=e),n;if("test"===t.op){if(n.test=_areEquals(e,t.value),!1===n.test)throw new JsonPatchError("Test operation failed","TEST_OPERATION_FAILED",o,t,e);return n.newDocument=e,n}if("remove"===t.op)return n.removed=e,n.newDocument=null,n;if("_get"===t.op)return t.value=e,n;if(a)throw new JsonPatchError("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",o,t,e);return n}{n||(e=_deepClone(e));const r=(t.path||"").split("/");let s,c,l,p=e,d=1,u=r.length;for(l="function"==typeof a?a:validator;;){if(c=r[d],c&&-1!=c.indexOf("~")&&(c=unescapePathComponent(c)),i&&("__proto__"==c||"prototype"==c&&d>0&&"constructor"==r[d-1]))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(a&&void 0===s&&(void 0===p[c]?s=r.slice(0,d).join("/"):d==u-1&&(s=t.path),void 0!==s&&l(t,0,e,s)),d++,Array.isArray(p)){if("-"===c)c=p.length;else{if(a&&!isInteger(c))throw new JsonPatchError("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",o,t,e);isInteger(c)&&(c=~~c)}if(d>=u){if(a&&"add"===t.op&&c>p.length)throw new JsonPatchError("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",o,t,e);const n=arrOps[t.op].call(t,p,c,e);if(!1===n.test)throw new JsonPatchError("Test operation failed","TEST_OPERATION_FAILED",o,t,e);return n}}else if(d>=u){const a=objOps[t.op].call(t,p,c,e);if(!1===a.test)throw new JsonPatchError("Test operation failed","TEST_OPERATION_FAILED",o,t,e);return a}if(p=p[c],a&&d<u&&(!p||"object"!=typeof p))throw new JsonPatchError("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",o,t,e)}}}function applyPatch(e,t,a,n=!0,i=!0){if(a&&!Array.isArray(t))throw new JsonPatchError("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");n||(e=_deepClone(e));const o=new Array(t.length);for(let n=0,r=t.length;n<r;n++)o[n]=applyOperation(e,t[n],a,!0,i,n),e=o[n].newDocument;return o.newDocument=e,o}function validator(e,t,a,n){if("object"!=typeof e||null===e||Array.isArray(e))throw new JsonPatchError("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,a);if(!objOps[e.op])throw new JsonPatchError("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,a);if("string"!=typeof e.path)throw new JsonPatchError("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,a);if(0!==e.path.indexOf("/")&&e.path.length>0)throw new JsonPatchError('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,a);if(("move"===e.op||"copy"===e.op)&&"string"!=typeof e.from)throw new JsonPatchError("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,a);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&void 0===e.value)throw new JsonPatchError("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,a);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&hasUndefined(e.value))throw new JsonPatchError("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,a);if(a)if("add"==e.op){var i=e.path.split("/").length,o=n.split("/").length;if(i!==o+1&&i!==o)throw new JsonPatchError("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,a)}else if("replace"===e.op||"remove"===e.op||"_get"===e.op){if(e.path!==n)throw new JsonPatchError("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,a)}else if("move"===e.op||"copy"===e.op){var r=validate([{op:"_get",path:e.from,value:void 0}],a);if(r&&"OPERATION_PATH_UNRESOLVABLE"===r.name)throw new JsonPatchError("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,a)}}function validate(e,t,a){try{if(!Array.isArray(e))throw new JsonPatchError("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)applyPatch(_deepClone(t),_deepClone(e),a||!0);else{a=a||validator;for(var n=0;n<e.length;n++)a(e[n],n,t,void 0)}}catch(e){if(e instanceof JsonPatchError)return e;throw e}}function _areEquals(e,t){if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){var a,n,i,o=Array.isArray(e),r=Array.isArray(t);if(o&&r){if((n=e.length)!=t.length)return!1;for(a=n;0!=a--;)if(!_areEquals(e[a],t[a]))return!1;return!0}if(o!=r)return!1;var s=Object.keys(e);if((n=s.length)!==Object.keys(t).length)return!1;for(a=n;0!=a--;)if(!t.hasOwnProperty(s[a]))return!1;for(a=n;0!=a--;)if(!_areEquals(e[i=s[a]],t[i]))return!1;return!0}return e!=e&&t!=t}class MockAsyncLocalStorage{getStore(){}run(e,t){return t()}enterWith(e){}}const mockAsyncLocalStorage=new MockAsyncLocalStorage,LC_CHILD_KEY=Symbol.for("lc:child_config");class AsyncLocalStorageProvider{getInstance(){return getGlobalAsyncLocalStorageInstance()??mockAsyncLocalStorage}getRunnableConfig(){const e=this.getInstance();return e.getStore()?.extra?.[LC_CHILD_KEY]}runWithConfig(e,t,a){const n=CallbackManager._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata),i=this.getInstance(),o=i.getStore(),r=n?.getParentRunId(),s=n?.handlers?.find((e=>"langchain_tracer"===e?.name));let c;return s&&r?c=s.getRunTreeWithTracingConfig(r):a||(c=new RunTree({name:"<runnable_lambda>",tracingEnabled:!1})),c&&(c.extra={...c.extra,[LC_CHILD_KEY]:e}),void 0!==o&&void 0!==o[_CONTEXT_VARIABLES_KEY]&&(void 0===c&&(c={}),c[_CONTEXT_VARIABLES_KEY]=o[_CONTEXT_VARIABLES_KEY]),i.run(c,t)}initializeGlobalInstance(e){void 0===getGlobalAsyncLocalStorageInstance()&&setGlobalAsyncLocalStorageInstance(e)}}const AsyncLocalStorageProviderSingleton=new AsyncLocalStorageProvider,DEFAULT_RECURSION_LIMIT=25;async function getCallbackManagerForConfig(e){return CallbackManager._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)}function mergeConfigs(...e){const t={};for(const a of e.filter((e=>!!e)))for(const e of Object.keys(a))if("metadata"===e)t[e]={...t[e],...a[e]};else if("tags"===e){const n=t[e]??[];t[e]=[...new Set(n.concat(a[e]??[]))]}else if("configurable"===e)t[e]={...t[e],...a[e]};else if("timeout"===e)void 0===t.timeout?t.timeout=a.timeout:void 0!==a.timeout&&(t.timeout=Math.min(t.timeout,a.timeout));else if("signal"===e)void 0===t.signal?t.signal=a.signal:void 0!==a.signal&&("any"in AbortSignal?t.signal=AbortSignal.any([t.signal,a.signal]):t.signal=a.signal);else if("callbacks"===e){const e=t.callbacks,n=a.callbacks;if(Array.isArray(n))if(e)if(Array.isArray(e))t.callbacks=e.concat(n);else{const a=e.copy();for(const e of n)a.addHandler(ensureHandler(e),!0);t.callbacks=a}else t.callbacks=n;else if(n)if(e)if(Array.isArray(e)){const a=n.copy();for(const t of e)a.addHandler(ensureHandler(t),!0);t.callbacks=a}else t.callbacks=new CallbackManager(n._parentRunId,{handlers:e.handlers.concat(n.handlers),inheritableHandlers:e.inheritableHandlers.concat(n.inheritableHandlers),tags:Array.from(new Set(e.tags.concat(n.tags))),inheritableTags:Array.from(new Set(e.inheritableTags.concat(n.inheritableTags))),metadata:{...e.metadata,...n.metadata}});else t.callbacks=n}else{const n=e;t[n]=a[n]??t[n]}return t}const PRIMITIVES=new Set(["string","number","boolean"]);function ensureConfig(e){const t=AsyncLocalStorageProviderSingleton.getRunnableConfig();let a={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(t){const{runId:e,runName:n,...i}=t;a=Object.entries(i).reduce(((e,[t,a])=>(void 0!==a&&(e[t]=a),e)),a)}if(e&&(a=Object.entries(e).reduce(((e,[t,a])=>(void 0!==a&&(e[t]=a),e)),a)),a?.configurable)for(const e of Object.keys(a.configurable))PRIMITIVES.has(typeof a.configurable[e])&&!a.metadata?.[e]&&(a.metadata||(a.metadata={}),a.metadata[e]=a.configurable[e]);if(void 0!==a.timeout){if(a.timeout<=0)throw new Error("Timeout must be a positive number");const e=AbortSignal.timeout(a.timeout);void 0!==a.signal?"any"in AbortSignal&&(a.signal=AbortSignal.any([a.signal,e])):a.signal=e,delete a.timeout}return a}function patchConfig(e={},{callbacks:t,maxConcurrency:a,recursionLimit:n,runName:i,configurable:o,runId:r}={}){const s=ensureConfig(e);return void 0!==t&&(delete s.runName,s.callbacks=t),void 0!==n&&(s.recursionLimit=n),void 0!==a&&(s.maxConcurrency=a),void 0!==i&&(s.runName=i),void 0!==o&&(s.configurable={...s.configurable,...o}),void 0!==r&&delete s.runId,s}function pickRunnableConfigKeys(e){return e?{configurable:e.configurable,recursionLimit:e.recursionLimit,callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,maxConcurrency:e.maxConcurrency,timeout:e.timeout,signal:e.signal}:void 0}async function raceWithSignal(e,t){if(void 0===t)return e;let a;return Promise.race([e.catch((e=>{if(!t?.aborted)throw e})),new Promise(((e,n)=>{a=()=>{n(new Error("Aborted"))},t.addEventListener("abort",a),t.aborted&&n(new Error("Aborted"))}))]).finally((()=>t.removeEventListener("abort",a)))}class IterableReadableStream extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}throw e}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(e){const t=e.getReader();return new IterableReadableStream({start:e=>function a(){return t.read().then((({done:t,value:n})=>{if(!t)return e.enqueue(n),a();e.close()}))}(),cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new IterableReadableStream({async pull(t){const{value:a,done:n}=await e.next();n&&t.close(),t.enqueue(a)},async cancel(t){await e.return(t)}})}}function atee(e,t=2){const a=Array.from({length:t},(()=>[]));return a.map((async function*(t){for(;;)if(0===t.length){const t=await e.next();for(const e of a)e.push(t)}else{if(t[0].done)return;yield t.shift().value}}))}function concat(e,t){if(Array.isArray(e)&&Array.isArray(t))return e.concat(t);if("string"==typeof e&&"string"==typeof t)return e+t;if("number"==typeof e&&"number"==typeof t)return e+t;if("concat"in e&&"function"==typeof e.concat)return e.concat(t);if("object"==typeof e&&"object"==typeof t){const a={...e};for(const[e,n]of Object.entries(t))e in a&&!Array.isArray(a[e])?a[e]=concat(a[e],n):a[e]=n;return a}throw new Error(`Cannot concat ${typeof e} and ${typeof t}`)}class AsyncGeneratorWithSetup{constructor(e){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"signal",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.signal=e.signal??this.config?.signal,this.setup=new Promise(((t,a)=>{AsyncLocalStorageProviderSingleton.runWithConfig(pickRunnableConfigKeys(e.config),(async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,a):this.firstResult.then((e=>t(void 0)),a)}),!0)}))}async next(...e){return this.signal?.throwIfAborted(),this.firstResultUsed?AsyncLocalStorageProviderSingleton.runWithConfig(pickRunnableConfigKeys(this.config),this.signal?async()=>raceWithSignal(this.generator.next(...e),this.signal):async()=>this.generator.next(...e),!0):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}}async function pipeGeneratorWithSetup(e,t,a,n,...i){const o=new AsyncGeneratorWithSetup({generator:t,startSetup:a,signal:n}),r=await o.setup;return{output:e(o,r,...i),setup:r}}class RunLogPatch{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){const t=this.ops.concat(e.ops),a=applyPatch({},t);return new RunLog({ops:t,state:a[a.length-1].newDocument})}}class RunLog extends RunLogPatch{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),a=applyPatch(this.state,e.ops);return new RunLog({ops:t,state:a[a.length-1].newDocument})}static fromRunLogPatch(e){const t=applyPatch({},e.ops);return new RunLog({ops:e.ops,state:t[t.length-1].newDocument})}}const isLogStreamHandler=e=>"log_stream_tracer"===e.name;async function _getStandardizedInputs(e,t){if("original"===t)throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:a}=e;return["retriever","llm","prompt"].includes(e.run_type)?a:1!==Object.keys(a).length||""!==a?.input?a.input:void 0}async function _getStandardizedOutputs(e,t){const{outputs:a}=e;return"original"===t||["retriever","llm","prompt"].includes(e.run_type)?a:void 0!==a&&1===Object.keys(a).length&&void 0!==a?.output?a.output:a}function isChatGenerationChunk(e){return void 0!==e&&void 0!==e.message}class LogStreamCallbackHandler extends BaseTracer{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=IterableReadableStream.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let a=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(a=a||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(a=a||this.includeTypes.includes(e.run_type)),void 0!==this.includeTags&&(a=a||void 0!==t.find((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(a=a&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(a=a&&!this.excludeTypes.includes(e.run_type)),void 0!==this.excludeTags&&(a=a&&t.every((e=>!this.excludeTags?.includes(e)))),a}async*tapOutputIterable(e,t){for await(const a of t){if(e!==this.rootId){const t=this.keyMapByRunId[e];t&&await this.writer.write(new RunLogPatch({ops:[{op:"add",path:`/logs/${t}/streamed_output/-`,value:a}]}))}yield a}}async onRunCreate(e){if(void 0===this.rootId&&(this.rootId=e.id,await this.writer.write(new RunLogPatch({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;void 0===this.counterMapByRunName[e.name]&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=1===t?e.name:`${e.name}:${t}`;const a={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};"streaming_events"===this._schemaFormat&&(a.inputs=await _getStandardizedInputs(e,this._schemaFormat)),await this.writer.write(new RunLogPatch({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:a}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(void 0===t)return;const a=[];"streaming_events"===this._schemaFormat&&a.push({op:"replace",path:`/logs/${t}/inputs`,value:await _getStandardizedInputs(e,this._schemaFormat)}),a.push({op:"add",path:`/logs/${t}/final_output`,value:await _getStandardizedOutputs(e,this._schemaFormat)}),void 0!==e.end_time&&a.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const n=new RunLogPatch({ops:a});await this.writer.write(n)}finally{if(e.id===this.rootId){const t=new RunLogPatch({ops:[{op:"replace",path:"/final_output",value:await _getStandardizedOutputs(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,a){const n=this.keyMapByRunId[e.id];if(void 0===n)return;let i;i=void 0!==e.inputs.messages?isChatGenerationChunk(a?.chunk)?a?.chunk:new AIMessageChunk({id:`run-${e.id}`,content:t}):t;const o=new RunLogPatch({ops:[{op:"add",path:`/logs/${n}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${n}/streamed_output/-`,value:i}]});await this.writer.write(o)}}class GenerationChunk{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new GenerationChunk({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}function assignName({name:e,serialized:t}){return void 0!==e?e:void 0!==t?.name?t.name:void 0!==t?.id&&Array.isArray(t?.id)?t.id[t.id.length-1]:"Unnamed"}const isStreamEventsHandler=e=>"event_stream_tracer"===e.name;class EventStreamCallbackHandler extends BaseTracer{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=IterableReadableStream.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){const t=e.tags??[];let a=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(a=a||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(a=a||this.includeTypes.includes(e.runType)),void 0!==this.includeTags&&(a=a||void 0!==t.find((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(a=a&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(a=a&&!this.excludeTypes.includes(e.runType)),void 0!==this.excludeTags&&(a=a&&t.every((e=>!this.excludeTags?.includes(e)))),a}async*tapOutputIterable(e,t){const a=await t.next();if(a.done)return;const n=this.runInfoMap.get(e);if(void 0===n)return void(yield a.value);function i(e,t){return"llm"===e&&"string"==typeof t?new GenerationChunk({text:t}):t}let o=this.tappedPromises.get(e);if(void 0===o){let r;o=new Promise((e=>{r=e})),this.tappedPromises.set(e,o);try{const o={event:`on_${n.runType}_stream`,run_id:e,name:n.name,tags:n.tags,metadata:n.metadata,data:{}};await this.send({...o,data:{chunk:i(n.runType,a.value)}},n),yield a.value;for await(const e of t)"tool"!==n.runType&&"retriever"!==n.runType&&await this.send({...o,data:{chunk:i(n.runType,e)}},n),yield e}finally{r()}}else{yield a.value;for await(const e of t)yield e}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){const a=this.tappedPromises.get(e.run_id);void 0!==a?a.then((()=>{this.send(e,t)})):await this.send(e,t)}async onLLMStart(e){const t=assignName(e),a=void 0!==e.inputs.messages?"chat_model":"llm",n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:a,inputs:e.inputs};this.runInfoMap.set(e.id,n);const i=`on_${a}_start`;await this.send({event:i,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},n)}async onLLMNewToken(e,t,a){const n=this.runInfoMap.get(e.id);let i,o;if(void 0===n)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(1!==this.runInfoMap.size){if("chat_model"===n.runType)o="on_chat_model_stream",i=void 0===a?.chunk?new AIMessageChunk({content:t,id:`run-${e.id}`}):a.chunk.message;else{if("llm"!==n.runType)throw new Error(`Unexpected run type ${n.runType}`);o="on_llm_stream",i=void 0===a?.chunk?new GenerationChunk({text:t}):a.chunk}await this.send({event:o,data:{chunk:i},run_id:e.id,name:n.name,tags:n.tags,metadata:n.metadata},n)}}async onLLMEnd(e){const t=this.runInfoMap.get(e.id);let a;if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);const n=e.outputs?.generations;let i;if("chat_model"===t.runType){for(const e of n??[]){if(void 0!==i)break;i=e[0]?.message}a="on_chat_model_end"}else{if("llm"!==t.runType)throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);i={generations:n?.map((e=>e.map((e=>({text:e.text,generationInfo:e.generationInfo}))))),llmOutput:e.outputs?.llmOutput??{}},a="on_llm_end"}await this.sendEndEvent({event:a,data:{output:i,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){const t=assignName(e),a=e.run_type??"chain",n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type};let i={};""===e.inputs.input&&1===Object.keys(e.inputs).length?(i={},n.inputs={}):void 0!==e.inputs.input?(i.input=e.inputs.input,n.inputs=e.inputs.input):(i.input=e.inputs,n.inputs=e.inputs),this.runInfoMap.set(e.id,n),await this.send({event:`on_${a}_start`,data:i,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},n)}async onChainEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);const a=`on_${e.run_type}_end`,n=e.inputs??t.inputs??{},i={output:e.outputs?.output??e.outputs,input:n};n.input&&1===Object.keys(n).length&&(i.input=n.input,t.inputs=n.input),await this.sendEndEvent({event:a,data:i,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){const t=assignName(e),a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,a),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},a)}async onToolEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(void 0===t.inputs)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);const a=void 0===e.outputs?.output?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:a,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){const t=assignName(e),a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,a),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onRetrieverEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,a){const n=this.runInfoMap.get(a);if(void 0===n)throw new Error(`handleCustomEvent: Run ID ${a} not found in run map.`);await this.send({event:"on_custom_event",run_id:a,name:e,tags:n.tags,metadata:n.metadata,data:t},n)}async finish(){const e=[...this.tappedPromises.values()];Promise.all(e).finally((()=>{this.writer.close()}))}}class RootListenersTracer extends BaseTracer{constructor({config:e,onStart:t,onEnd:a,onError:n}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=a,this.argOnError=n}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}}function isRunnableInterface(e){return!!e&&e.lc_runnable}class _RootEventFilter{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let a=void 0===this.includeNames&&void 0===this.includeTypes&&void 0===this.includeTags;const n=e.tags??[];return void 0!==this.includeNames&&(a=a||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(a=a||this.includeTypes.includes(t)),void 0!==this.includeTags&&(a=a||n.some((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(a=a&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(a=a&&!this.excludeTypes.includes(t)),void 0!==this.excludeTags&&(a=a&&n.every((e=>!this.excludeTags?.includes(e)))),a}}function _escapeNodeLabel(e){return e.replace(/[^a-zA-Z-_0-9]/g,"_")}const MARKDOWN_SPECIAL_CHARS=["*","_","`"];function _generateMermaidGraphStyles(e){let t="";for(const[a,n]of Object.entries(e))t+=`\tclassDef ${a} ${n};\n`;return t}function drawMermaid(e,t,a){const{firstNode:n,lastNode:i,nodeColors:o,withStyles:r=!0,curveStyle:s="linear",wrapLabelNWords:c=9}=a??{};let l=r?`%%{init: {'flowchart': {'curve': '${s}'}}}%%\ngraph TD;\n`:"graph TD;\n";if(r){const t="default",a={[t]:"{0}({1})"};void 0!==n&&(a[n]="{0}([{1}]):::first"),void 0!==i&&(a[i]="{0}([{1}]):::last");for(const[n,i]of Object.entries(e)){const e=i.name.split(":").pop()??"";let o=MARKDOWN_SPECIAL_CHARS.some((t=>e.startsWith(t)&&e.endsWith(t)))?`<p>${e}</p>`:e;Object.keys(i.metadata??{}).length&&(o+=`<hr/><small><em>${Object.entries(i.metadata??{}).map((([e,t])=>`${e} = ${t}`)).join("\n")}</em></small>`);const r=(a[n]??a[t]).replace("{0}",_escapeNodeLabel(n)).replace("{1}",o);l+=`\t${r}\n`}}const p={};for(const e of t){const t=e.source.split(":"),a=e.target.split(":"),n=t.filter(((e,t)=>e===a[t])).join(":");p[n]||(p[n]=[]),p[n].push(e)}const d=new Set;function u(e,t){const a=1===e.length&&e[0].source===e[0].target;if(t&&!a){const e=t.split(":").pop();if(d.has(e))throw new Error(`Found duplicate subgraph '${e}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);d.add(e),l+=`\tsubgraph ${e}\n`}for(const t of e){const{source:e,target:a,data:n,conditional:i}=t;let o="";if(void 0!==n){let e=n;const t=e.split(" ");t.length>c&&(e=Array.from({length:Math.ceil(t.length/c)},((e,a)=>t.slice(a*c,(a+1)*c).join(" "))).join("&nbsp;<br>&nbsp;")),o=i?` -. &nbsp;${e}&nbsp; .-> `:` -- &nbsp;${e}&nbsp; --\x3e `}else o=i?" -.-> ":" --\x3e ";l+=`\t${_escapeNodeLabel(e)}${o}${_escapeNodeLabel(a)};\n`}for(const e in p)e.startsWith(`${t}:`)&&e!==t&&u(p[e],e);t&&!a&&(l+="\tend\n")}u(p[""]??[],"");for(const e in p)e.includes(":")||""===e||u(p[e],e);return r&&(l+=_generateMermaidGraphStyles(o??{})),l}async function drawMermaidPng(e,t){let{backgroundColor:a="white"}=t??{};const n=btoa(e);if(void 0!==a){/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(a)||(a=`!${a}`)}const i=`https://mermaid.ink/img/${n}?bgColor=${a}`,o=await fetch(i);if(!o.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${o.status}`,`Status text: ${o.statusText}`].join("\n"));return await o.blob()}const ignoreOverride=Symbol("Let zodToJsonSchema decide on which parser to use"),defaultOptions={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},getDefaultOptions=e=>({...defaultOptions,...e}),getRefs=e=>{const t=getDefaultOptions(e),a=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,currentPath:a,propertyPath:void 0,seen:new Map(Object.entries(t.definitions).map((([e,a])=>[a._def,{def:a._def,path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}])))}};function addErrorMessage(e,t,a,n){n?.errorMessages&&a&&(e.errorMessage={...e.errorMessage,[t]:a})}function setResponseValueAndErrors(e,t,a,n,i){e[t]=a,addErrorMessage(e,t,n,i)}function parseAnyDef(){return{}}function parseArrayDef(e,t){const a={type:"array"};return e.type?._def&&e.type?._def?.typeName!==zod.ZodFirstPartyTypeKind.ZodAny&&(a.items=parseDef(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&setResponseValueAndErrors(a,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&setResponseValueAndErrors(a,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(setResponseValueAndErrors(a,"minItems",e.exactLength.value,e.exactLength.message,t),setResponseValueAndErrors(a,"maxItems",e.exactLength.value,e.exactLength.message,t)),a}function parseBigintDef(e,t){const a={type:"integer",format:"int64"};if(!e.checks)return a;for(const n of e.checks)switch(n.kind){case"min":"jsonSchema7"===t.target?n.inclusive?setResponseValueAndErrors(a,"minimum",n.value,n.message,t):setResponseValueAndErrors(a,"exclusiveMinimum",n.value,n.message,t):(n.inclusive||(a.exclusiveMinimum=!0),setResponseValueAndErrors(a,"minimum",n.value,n.message,t));break;case"max":"jsonSchema7"===t.target?n.inclusive?setResponseValueAndErrors(a,"maximum",n.value,n.message,t):setResponseValueAndErrors(a,"exclusiveMaximum",n.value,n.message,t):(n.inclusive||(a.exclusiveMaximum=!0),setResponseValueAndErrors(a,"maximum",n.value,n.message,t));break;case"multipleOf":setResponseValueAndErrors(a,"multipleOf",n.value,n.message,t)}return a}function parseBooleanDef(){return{type:"boolean"}}function parseBrandedDef(e,t){return parseDef(e.type._def,t)}const parseCatchDef=(e,t)=>parseDef(e.innerType._def,t);function parseDateDef(e,t,a){const n=a??t.dateStrategy;if(Array.isArray(n))return{anyOf:n.map(((a,n)=>parseDateDef(e,t,a)))};switch(n){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return integerDateParser(e,t)}}const integerDateParser=(e,t)=>{const a={type:"integer",format:"unix-time"};if("openApi3"===t.target)return a;for(const n of e.checks)switch(n.kind){case"min":setResponseValueAndErrors(a,"minimum",n.value,n.message,t);break;case"max":setResponseValueAndErrors(a,"maximum",n.value,n.message,t)}return a};function parseDefaultDef(e,t){return{...parseDef(e.innerType._def,t),default:e.defaultValue()}}function parseEffectsDef(e,t){return"input"===t.effectStrategy?parseDef(e.schema._def,t):{}}function parseEnumDef(e){return{type:"string",enum:Array.from(e.values)}}const isJsonSchema7AllOfType=e=>(!("type"in e)||"string"!==e.type)&&"allOf"in e;function parseIntersectionDef(e,t){const a=[parseDef(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),parseDef(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter((e=>!!e));let n="jsonSchema2019-09"===t.target?{unevaluatedProperties:!1}:void 0;const i=[];return a.forEach((e=>{if(isJsonSchema7AllOfType(e))i.push(...e.allOf),void 0===e.unevaluatedProperties&&(n=void 0);else{let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){const{additionalProperties:a,...n}=e;t=n}else n=void 0;i.push(t)}})),i.length?{allOf:i,...n}:void 0}function parseLiteralDef(e,t){const a=typeof e.value;return"bigint"!==a&&"number"!==a&&"boolean"!==a&&"string"!==a?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===t.target?{type:"bigint"===a?"integer":a,enum:[e.value]}:{type:"bigint"===a?"integer":a,const:e.value}}let emojiRegex;const zodPatterns={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(void 0===emojiRegex&&(emojiRegex=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),emojiRegex),uuid:/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/,ipv4:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv4Cidr:/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ipv6:/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,ipv6Cidr:/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,base64url:/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/,jwt:/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/};function parseStringDef(e,t){const a={type:"string"};if(e.checks)for(const n of e.checks)switch(n.kind){case"min":setResponseValueAndErrors(a,"minLength","number"==typeof a.minLength?Math.max(a.minLength,n.value):n.value,n.message,t);break;case"max":setResponseValueAndErrors(a,"maxLength","number"==typeof a.maxLength?Math.min(a.maxLength,n.value):n.value,n.message,t);break;case"email":switch(t.emailStrategy){case"format:email":addFormat(a,"email",n.message,t);break;case"format:idn-email":addFormat(a,"idn-email",n.message,t);break;case"pattern:zod":addPattern(a,zodPatterns.email,n.message,t)}break;case"url":addFormat(a,"uri",n.message,t);break;case"uuid":addFormat(a,"uuid",n.message,t);break;case"regex":addPattern(a,n.regex,n.message,t);break;case"cuid":addPattern(a,zodPatterns.cuid,n.message,t);break;case"cuid2":addPattern(a,zodPatterns.cuid2,n.message,t);break;case"startsWith":addPattern(a,RegExp(`^${escapeLiteralCheckValue(n.value,t)}`),n.message,t);break;case"endsWith":addPattern(a,RegExp(`${escapeLiteralCheckValue(n.value,t)}$`),n.message,t);break;case"datetime":addFormat(a,"date-time",n.message,t);break;case"date":addFormat(a,"date",n.message,t);break;case"time":addFormat(a,"time",n.message,t);break;case"duration":addFormat(a,"duration",n.message,t);break;case"length":setResponseValueAndErrors(a,"minLength","number"==typeof a.minLength?Math.max(a.minLength,n.value):n.value,n.message,t),setResponseValueAndErrors(a,"maxLength","number"==typeof a.maxLength?Math.min(a.maxLength,n.value):n.value,n.message,t);break;case"includes":addPattern(a,RegExp(escapeLiteralCheckValue(n.value,t)),n.message,t);break;case"ip":"v6"!==n.version&&addFormat(a,"ipv4",n.message,t),"v4"!==n.version&&addFormat(a,"ipv6",n.message,t);break;case"base64url":addPattern(a,zodPatterns.base64url,n.message,t);break;case"jwt":addPattern(a,zodPatterns.jwt,n.message,t);break;case"cidr":"v6"!==n.version&&addPattern(a,zodPatterns.ipv4Cidr,n.message,t),"v4"!==n.version&&addPattern(a,zodPatterns.ipv6Cidr,n.message,t);break;case"emoji":addPattern(a,zodPatterns.emoji(),n.message,t);break;case"ulid":addPattern(a,zodPatterns.ulid,n.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":addFormat(a,"binary",n.message,t);break;case"contentEncoding:base64":setResponseValueAndErrors(a,"contentEncoding","base64",n.message,t);break;case"pattern:zod":addPattern(a,zodPatterns.base64,n.message,t)}break;case"nanoid":addPattern(a,zodPatterns.nanoid,n.message,t)}return a}function escapeLiteralCheckValue(e,t){return"escape"===t.patternStrategy?escapeNonAlphaNumeric(e):e}const ALPHA_NUMERIC=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function escapeNonAlphaNumeric(e){let t="";for(let a=0;a<e.length;a++)ALPHA_NUMERIC.has(e[a])||(t+="\\"),t+=e[a];return t}function addFormat(e,t,a,n){e.format||e.anyOf?.some((e=>e.format))?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&n.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...a&&n.errorMessages&&{errorMessage:{format:a}}})):setResponseValueAndErrors(e,"format",t,a,n)}function addPattern(e,t,a,n){e.pattern||e.allOf?.some((e=>e.pattern))?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&n.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:stringifyRegExpWithFlags(t,n),...a&&n.errorMessages&&{errorMessage:{pattern:a}}})):setResponseValueAndErrors(e,"pattern",stringifyRegExpWithFlags(t,n),a,n)}function stringifyRegExpWithFlags(e,t){if(!t.applyRegexFlags||!e.flags)return e.source;const a=e.flags.includes("i"),n=e.flags.includes("m"),i=e.flags.includes("s"),o=a?e.source.toLowerCase():e.source;let r="",s=!1,c=!1,l=!1;for(let e=0;e<o.length;e++)if(s)r+=o[e],s=!1;else{if(a)if(c){if(o[e].match(/[a-z]/)){l?(r+=o[e],r+=`${o[e-2]}-${o[e]}`.toUpperCase(),l=!1):"-"===o[e+1]&&o[e+2]?.match(/[a-z]/)?(r+=o[e],l=!0):r+=`${o[e]}${o[e].toUpperCase()}`;continue}}else if(o[e].match(/[a-z]/)){r+=`[${o[e]}${o[e].toUpperCase()}]`;continue}if(n){if("^"===o[e]){r+="(^|(?<=[\r\n]))";continue}if("$"===o[e]){r+="($|(?=[\r\n]))";continue}}i&&"."===o[e]?r+=c?`${o[e]}\r\n`:`[${o[e]}\r\n]`:(r+=o[e],"\\"===o[e]?s=!0:c&&"]"===o[e]?c=!1:c||"["!==o[e]||(c=!0))}try{new RegExp(r)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),e.source}return r}function parseRecordDef(e,t){if("openAi"===t.target&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),"openApi3"===t.target&&e.keyType?._def.typeName===zod.ZodFirstPartyTypeKind.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce(((a,n)=>({...a,[n]:parseDef(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",n]})??{}})),{}),additionalProperties:!1};const a={type:"object",additionalProperties:parseDef(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??{}};if("openApi3"===t.target)return a;if(e.keyType?._def.typeName===zod.ZodFirstPartyTypeKind.ZodString&&e.keyType._def.checks?.length){const{type:n,...i}=parseStringDef(e.keyType._def,t);return{...a,propertyNames:i}}if(e.keyType?._def.typeName===zod.ZodFirstPartyTypeKind.ZodEnum)return{...a,propertyNames:{enum:e.keyType._def.values}};if(e.keyType?._def.typeName===zod.ZodFirstPartyTypeKind.ZodBranded&&e.keyType._def.type._def.typeName===zod.ZodFirstPartyTypeKind.ZodString&&e.keyType._def.type._def.checks?.length){const{type:n,...i}=parseBrandedDef(e.keyType._def,t);return{...a,propertyNames:i}}return a}function parseMapDef(e,t){if("record"===t.mapStrategy)return parseRecordDef(e,t);return{type:"array",maxItems:125,items:{type:"array",items:[parseDef(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||{},parseDef(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}}}function parseNativeEnumDef(e){const t=e.values,a=Object.keys(e.values).filter((e=>"number"!=typeof t[t[e]])),n=a.map((e=>t[e])),i=Array.from(new Set(n.map((e=>typeof e))));return{type:1===i.length?"string"===i[0]?"string":"number":["string","number"],enum:n}}function parseNeverDef(){return{not:{}}}function parseNullDef(e){return"openApi3"===e.target?{enum:["null"],nullable:!0}:{type:"null"}}const primitiveMappings={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function parseUnionDef(e,t){if("openApi3"===t.target)return asAnyOf(e,t);const a=e.options instanceof Map?Array.from(e.options.values()):e.options;if(a.every((e=>e._def.typeName in primitiveMappings&&(!e._def.checks||!e._def.checks.length)))){const e=a.reduce(((e,t)=>{const a=primitiveMappings[t._def.typeName];return a&&!e.includes(a)?[...e,a]:e}),[]);return{type:e.length>1?e:e[0]}}if(a.every((e=>"ZodLiteral"===e._def.typeName&&!e.description))){const e=a.reduce(((e,t)=>{const a=typeof t._def.value;switch(a){case"string":case"number":case"boolean":return[...e,a];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}}),[]);if(e.length===a.length){const t=e.filter(((e,t,a)=>a.indexOf(e)===t));return{type:t.length>1?t:t[0],enum:a.reduce(((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value]),[])}}}else if(a.every((e=>"ZodEnum"===e._def.typeName)))return{type:"string",enum:a.reduce(((e,t)=>[...e,...t._def.values.filter((t=>!e.includes(t)))]),[])};return asAnyOf(e,t)}const asAnyOf=(e,t)=>{const a=(e.options instanceof Map?Array.from(e.options.values()):e.options).map(((e,a)=>parseDef(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${a}`]}))).filter((e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0)));return a.length?{anyOf:a}:void 0};function parseNullableDef(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===t.target?{type:primitiveMappings[e.innerType._def.typeName],nullable:!0}:{type:[primitiveMappings[e.innerType._def.typeName],"null"]};if("openApi3"===t.target){const a=parseDef(e.innerType._def,{...t,currentPath:[...t.currentPath]});return a&&"$ref"in a?{allOf:[a],nullable:!0}:a&&{...a,nullable:!0}}const a=parseDef(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return a&&{anyOf:[a,{type:"null"}]}}function parseNumberDef(e,t){const a={type:"number"};if(!e.checks)return a;for(const n of e.checks)switch(n.kind){case"int":a.type="integer",addErrorMessage(a,"type",n.message,t);break;case"min":"jsonSchema7"===t.target?n.inclusive?setResponseValueAndErrors(a,"minimum",n.value,n.message,t):setResponseValueAndErrors(a,"exclusiveMinimum",n.value,n.message,t):(n.inclusive||(a.exclusiveMinimum=!0),setResponseValueAndErrors(a,"minimum",n.value,n.message,t));break;case"max":"jsonSchema7"===t.target?n.inclusive?setResponseValueAndErrors(a,"maximum",n.value,n.message,t):setResponseValueAndErrors(a,"exclusiveMaximum",n.value,n.message,t):(n.inclusive||(a.exclusiveMaximum=!0),setResponseValueAndErrors(a,"maximum",n.value,n.message,t));break;case"multipleOf":setResponseValueAndErrors(a,"multipleOf",n.value,n.message,t)}return a}function decideAdditionalProperties(e,t){return"strict"===t.removeAdditionalStrategy?"ZodNever"===e.catchall._def.typeName?"strict"!==e.unknownKeys:parseDef(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0:"ZodNever"===e.catchall._def.typeName?"passthrough"===e.unknownKeys:parseDef(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0}function parseObjectDef(e,t){const a="openAi"===t.target,n={type:"object",...Object.entries(e.shape()).reduce(((e,[n,i])=>{if(void 0===i||void 0===i._def)return e;let o=i.isOptional();o&&a&&(i instanceof zod.ZodOptional&&(i=i._def.innerType),i.isNullable()||(i=i.nullable()),o=!1);const r=parseDef(i._def,{...t,currentPath:[...t.currentPath,"properties",n],propertyPath:[...t.currentPath,"properties",n]});return void 0===r?e:{properties:{...e.properties,[n]:r},required:o?e.required:[...e.required,n]}}),{properties:{},required:[]}),additionalProperties:decideAdditionalProperties(e,t)};return n.required.length||delete n.required,n}const parseOptionalDef=(e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return parseDef(e.innerType._def,t);const a=parseDef(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return a?{anyOf:[{not:{}},a]}:{}},parsePipelineDef=(e,t)=>{if("input"===t.pipeStrategy)return parseDef(e.in._def,t);if("output"===t.pipeStrategy)return parseDef(e.out._def,t);const a=parseDef(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]});return{allOf:[a,parseDef(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",a?"1":"0"]})].filter((e=>void 0!==e))}};function parsePromiseDef(e,t){return parseDef(e.type._def,t)}function parseSetDef(e,t){const a={type:"array",uniqueItems:!0,items:parseDef(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&setResponseValueAndErrors(a,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&setResponseValueAndErrors(a,"maxItems",e.maxSize.value,e.maxSize.message,t),a}function parseTupleDef(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map(((e,a)=>parseDef(e._def,{...t,currentPath:[...t.currentPath,"items",`${a}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[]),additionalItems:parseDef(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map(((e,a)=>parseDef(e._def,{...t,currentPath:[...t.currentPath,"items",`${a}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[])}}function parseUndefinedDef(){return{not:{}}}function parseUnknownDef(){return{}}const parseReadonlyDef=(e,t)=>parseDef(e.innerType._def,t),selectParser=(e,t,a)=>{switch(t){case zod.ZodFirstPartyTypeKind.ZodString:return parseStringDef(e,a);case zod.ZodFirstPartyTypeKind.ZodNumber:return parseNumberDef(e,a);case zod.ZodFirstPartyTypeKind.ZodObject:return parseObjectDef(e,a);case zod.ZodFirstPartyTypeKind.ZodBigInt:return parseBigintDef(e,a);case zod.ZodFirstPartyTypeKind.ZodBoolean:return parseBooleanDef();case zod.ZodFirstPartyTypeKind.ZodDate:return parseDateDef(e,a);case zod.ZodFirstPartyTypeKind.ZodUndefined:return parseUndefinedDef();case zod.ZodFirstPartyTypeKind.ZodNull:return parseNullDef(a);case zod.ZodFirstPartyTypeKind.ZodArray:return parseArrayDef(e,a);case zod.ZodFirstPartyTypeKind.ZodUnion:case zod.ZodFirstPartyTypeKind.ZodDiscriminatedUnion:return parseUnionDef(e,a);case zod.ZodFirstPartyTypeKind.ZodIntersection:return parseIntersectionDef(e,a);case zod.ZodFirstPartyTypeKind.ZodTuple:return parseTupleDef(e,a);case zod.ZodFirstPartyTypeKind.ZodRecord:return parseRecordDef(e,a);case zod.ZodFirstPartyTypeKind.ZodLiteral:return parseLiteralDef(e,a);case zod.ZodFirstPartyTypeKind.ZodEnum:return parseEnumDef(e);case zod.ZodFirstPartyTypeKind.ZodNativeEnum:return parseNativeEnumDef(e);case zod.ZodFirstPartyTypeKind.ZodNullable:return parseNullableDef(e,a);case zod.ZodFirstPartyTypeKind.ZodOptional:return parseOptionalDef(e,a);case zod.ZodFirstPartyTypeKind.ZodMap:return parseMapDef(e,a);case zod.ZodFirstPartyTypeKind.ZodSet:return parseSetDef(e,a);case zod.ZodFirstPartyTypeKind.ZodLazy:return()=>e.getter()._def;case zod.ZodFirstPartyTypeKind.ZodPromise:return parsePromiseDef(e,a);case zod.ZodFirstPartyTypeKind.ZodNaN:case zod.ZodFirstPartyTypeKind.ZodNever:return parseNeverDef();case zod.ZodFirstPartyTypeKind.ZodEffects:return parseEffectsDef(e,a);case zod.ZodFirstPartyTypeKind.ZodAny:return parseAnyDef();case zod.ZodFirstPartyTypeKind.ZodUnknown:return parseUnknownDef();case zod.ZodFirstPartyTypeKind.ZodDefault:return parseDefaultDef(e,a);case zod.ZodFirstPartyTypeKind.ZodBranded:return parseBrandedDef(e,a);case zod.ZodFirstPartyTypeKind.ZodReadonly:return parseReadonlyDef(e,a);case zod.ZodFirstPartyTypeKind.ZodCatch:return parseCatchDef(e,a);case zod.ZodFirstPartyTypeKind.ZodPipeline:return parsePipelineDef(e,a);case zod.ZodFirstPartyTypeKind.ZodFunction:case zod.ZodFirstPartyTypeKind.ZodVoid:case zod.ZodFirstPartyTypeKind.ZodSymbol:default:return}};function parseDef(e,t,a=!1){const n=t.seen.get(e);if(t.override){const i=t.override?.(e,t,n,a);if(i!==ignoreOverride)return i}if(n&&!a){const e=get$ref(n,t);if(void 0!==e)return e}const i={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,i);const o=selectParser(e,e.typeName,t),r="function"==typeof o?parseDef(o(),t):o;if(r&&addMeta(e,t,r),t.postProcess){const a=t.postProcess(r,e,t);return i.jsonSchema=r,a}return i.jsonSchema=r,r}const get$ref=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:getRelativePath(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every(((e,a)=>t.currentPath[a]===e))?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{}):"seen"===t.$refStrategy?{}:void 0}},getRelativePath=(e,t)=>{let a=0;for(;a<e.length&&a<t.length&&e[a]===t[a];a++);return[(e.length-a).toString(),...t.slice(a)].join("/")},addMeta=(e,t,a)=>(e.description&&(a.description=e.description,t.markdownDescription&&(a.markdownDescription=e.description)),a),zodToJsonSchema=(e,t)=>{const a=getRefs(t),n=void 0,i=t?.name,o=parseDef(e._def,a,!1)??{},r=void 0===i?o:{$ref:[..."relative"===a.$refStrategy?[]:a.basePath,a.definitionPath,i].join("/"),[a.definitionPath]:{...n,[i]:o}};return"jsonSchema7"===a.target?r.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"!==a.target&&"openAi"!==a.target||(r.$schema="https://json-schema.org/draft/2019-09/schema#"),"openAi"===a.target&&("anyOf"in r||"oneOf"in r||"allOf"in r||"type"in r&&Array.isArray(r.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),r};function isZodSchemaV4(e){if("object"!=typeof e||null===e)return!1;if(!("_zod"in e))return!1;const t=e._zod;return"object"==typeof t&&null!==t&&"def"in t}function isZodSchemaV3(e){if("object"!=typeof e||null===e)return!1;if(!("_def"in e)||"_zod"in e)return!1;const t=e._def;return"object"==typeof t&&null!=t&&"typeName"in t}function isInteropZodSchema(e){return!!e&&("object"==typeof e&&(!Array.isArray(e)&&!(!isZodSchemaV4(e)&&!isZodSchemaV3(e))))}async function interopParseAsync(e,t){if(isZodSchemaV4(e))return core.parse(e,t);if(isZodSchemaV3(e))return e.parse(t);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function getSchemaDescription(e){return isZodSchemaV4(e)?core.globalRegistry.get(e)?.description:isZodSchemaV3(e)||"description"in e&&"string"==typeof e.description?e.description:void 0}function isSimpleStringZodSchema(e){if(!isInteropZodSchema(e))return!1;if(isZodSchemaV3(e)){return"ZodString"===e._def.typeName}if(isZodSchemaV4(e)){return"string"===e._zod.def.type}return!1}function isZodObjectV4(e){return!!isZodSchemaV4(e)&&("object"==typeof e&&null!==e&&"_zod"in e&&"object"==typeof e._zod&&null!==e._zod&&"def"in e._zod&&"object"==typeof e._zod.def&&null!==e._zod.def&&"type"in e._zod.def&&"object"===e._zod.def.type)}function isZodArrayV4(e){return!!isZodSchemaV4(e)&&("object"==typeof e&&null!==e&&"_zod"in e&&"object"==typeof e._zod&&null!==e._zod&&"def"in e._zod&&"object"==typeof e._zod.def&&null!==e._zod.def&&"type"in e._zod.def&&"array"===e._zod.def.type)}function interopZodObjectStrict(e,t=!1){if(isZodSchemaV3(e))return e.strict();if(isZodObjectV4(e)){const a=e._zod.def.shape;if(t)for(const[n,i]of Object.entries(e._zod.def.shape)){if(isZodObjectV4(i)){const e=interopZodObjectStrict(i,t);a[n]=e}else if(isZodArrayV4(i)){let e=i._zod.def.element;isZodObjectV4(e)&&(e=interopZodObjectStrict(e,t)),a[n]=core.clone(i,{...i._zod.def,element:e})}else a[n]=i;const e=core.globalRegistry.get(i);e&&core.globalRegistry.add(a[n],e)}const n=core.clone(e,{...e._zod.def,shape:a,catchall:core._never(core.$ZodNever)}),i=core.globalRegistry.get(e);return i&&core.globalRegistry.add(n,i),n}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function isZodTransformV3(e){return isZodSchemaV3(e)&&"typeName"in e._def&&"ZodEffects"===e._def.typeName}function isZodTransformV4(e){return isZodSchemaV4(e)&&"pipe"===e._zod.def.type}function interopZodTransformInputSchema(e){if(isZodSchemaV3(e))return isZodTransformV3(e)?interopZodTransformInputSchema(e._def.schema):e;if(isZodSchemaV4(e)){if(isZodTransformV4(e)){return interopZodTransformInputSchema(e._zod.def.in)??e}return e}throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function toJsonSchema(e){if(isZodSchemaV4(e)){const t=interopZodTransformInputSchema(e);if(isZodObjectV4(t)){const e=interopZodObjectStrict(t,!0);return core.toJSONSchema(e)}return core.toJSONSchema(e)}return isZodSchemaV3(e)?zodToJsonSchema(e):e}function validatesOnlyStrings(e){if(!e||"object"!=typeof e||0===Object.keys(e).length||Array.isArray(e))return!1;if("type"in e)return"string"==typeof e.type?"string"===e.type:!!Array.isArray(e.type)&&e.type.every((e=>"string"===e));if("enum"in e)return Array.isArray(e.enum)&&e.enum.length>0&&e.enum.every((e=>"string"==typeof e));if("const"in e)return"string"==typeof e.const;if("allOf"in e&&Array.isArray(e.allOf))return e.allOf.some((e=>validatesOnlyStrings(e)));if("anyOf"in e&&Array.isArray(e.anyOf)||"oneOf"in e&&Array.isArray(e.oneOf)){const t="anyOf"in e?e.anyOf:e.oneOf;return t.length>0&&t.every((e=>validatesOnlyStrings(e)))}if("not"in e)return!1;if("$ref"in e&&"string"==typeof e.$ref){const t=e.$ref,a=dereference(e);return!!a[t]&&validatesOnlyStrings(a[t])}return!1}function nodeDataStr(e,t){if(void 0!==e&&!validate$2(e))return e;if(!isRunnableInterface(t))return t.name??"UnknownSchema";try{let e=t.getName();return e=e.startsWith("Runnable")?e.slice(8):e,e}catch(e){return t.getName()}}function nodeDataJson(e){return isRunnableInterface(e.data)?{type:"runnable",data:{id:e.data.lc_id,name:e.data.getName()}}:{type:"schema",data:{...toJsonSchema(e.data.schema),title:e.data.name}}}class Graph{constructor(e){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.nodes=e?.nodes??this.nodes,this.edges=e?.edges??this.edges}toJSON(){const e={};return Object.values(this.nodes).forEach(((t,a)=>{e[t.id]=validate$2(t.id)?a:t.id})),{nodes:Object.values(this.nodes).map((t=>({id:e[t.id],...nodeDataJson(t)}))),edges:this.edges.map((t=>{const a={source:e[t.source],target:e[t.target]};return void 0!==t.data&&(a.data=t.data),void 0!==t.conditional&&(a.conditional=t.conditional),a}))}}addNode(e,t,a){if(void 0!==t&&void 0!==this.nodes[t])throw new Error(`Node with id ${t} already exists`);const n=t??v4$1(),i={id:n,data:e,name:nodeDataStr(t,e),metadata:a};return this.nodes[n]=i,i}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter((t=>t.source!==e.id&&t.target!==e.id))}addEdge(e,t,a,n){if(void 0===this.nodes[e.id])throw new Error(`Source node ${e.id} not in graph`);if(void 0===this.nodes[t.id])throw new Error(`Target node ${t.id} not in graph`);const i={source:e.id,target:t.id,data:a,conditional:n};return this.edges.push(i),i}firstNode(){return _firstNode(this)}lastNode(){return _lastNode(this)}extend(e,t=""){let a=t;Object.values(e.nodes).map((e=>e.id)).every(validate$2)&&(a="");const n=e=>a?`${a}:${e}`:e;Object.entries(e.nodes).forEach((([e,t])=>{this.nodes[n(e)]={...t,id:n(e)}}));const i=e.edges.map((e=>({...e,source:n(e.source),target:n(e.target)})));this.edges=[...this.edges,...i];const o=e.firstNode(),r=e.lastNode();return[o?{id:n(o.id),data:o.data}:void 0,r?{id:n(r.id),data:r.data}:void 0]}trimFirstNode(){const e=this.firstNode();e&&_firstNode(this,[e.id])&&this.removeNode(e)}trimLastNode(){const e=this.lastNode();e&&_lastNode(this,[e.id])&&this.removeNode(e)}reid(){const e=Object.fromEntries(Object.values(this.nodes).map((e=>[e.id,e.name]))),t=new Map;Object.values(e).forEach((e=>{t.set(e,(t.get(e)||0)+1)}));const a=a=>{const n=e[a];return validate$2(a)&&1===t.get(n)?n:a};return new Graph({nodes:Object.fromEntries(Object.entries(this.nodes).map((([e,t])=>[a(e),{...t,id:a(e)}]))),edges:this.edges.map((e=>({...e,source:a(e.source),target:a(e.target)})))})}drawMermaid(e){const{withStyles:t,curveStyle:a,nodeColors:n={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:i}=e??{},o=this.reid(),r=o.firstNode(),s=o.lastNode();return drawMermaid(o.nodes,o.edges,{firstNode:r?.id,lastNode:s?.id,withStyles:t,curveStyle:a,nodeColors:n,wrapLabelNWords:i})}async drawMermaidPng(e){return drawMermaidPng(this.drawMermaid(e),{backgroundColor:e?.backgroundColor})}}function _firstNode(e,t=[]){const a=new Set(e.edges.filter((e=>!t.includes(e.source))).map((e=>e.target))),n=[];for(const i of Object.values(e.nodes))t.includes(i.id)||a.has(i.id)||n.push(i);return 1===n.length?n[0]:void 0}function _lastNode(e,t=[]){const a=new Set(e.edges.filter((e=>!t.includes(e.target))).map((e=>e.source))),n=[];for(const i of Object.values(e.nodes))t.includes(i.id)||a.has(i.id)||n.push(i);return 1===n.length?n[0]:void 0}function convertToHttpEventStream(e){const t=new TextEncoder,a=new ReadableStream({async start(a){for await(const n of e)a.enqueue(t.encode(`event: data\ndata: ${JSON.stringify(n)}\n\n`));a.enqueue(t.encode("event: end\n\n")),a.close()}});return IterableReadableStream.fromReadableStream(a)}function isIterableIterator(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.iterator]&&"function"==typeof e.next}const isIterator=e=>null!=e&&"object"==typeof e&&"next"in e&&"function"==typeof e.next;function isAsyncIterable(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.asyncIterator]}function*consumeIteratorInContext(e,t){for(;;){const{value:a,done:n}=AsyncLocalStorageProviderSingleton.runWithConfig(pickRunnableConfigKeys(e),t.next.bind(t),!0);if(n)break;yield a}}async function*consumeAsyncIterableInContext(e,t){const a=t[Symbol.asyncIterator]();for(;;){const{value:n,done:i}=await AsyncLocalStorageProviderSingleton.runWithConfig(pickRunnableConfigKeys(e),a.next.bind(t),!0);if(i)break;yield n}}function _coerceToDict(e,t){return!e||Array.isArray(e)||e instanceof Date||"object"!=typeof e?{[t]:e}:e}class Runnable extends Serializable{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new RunnableBinding({bound:this,kwargs:e,config:{}})}map(){return new RunnableEach({bound:this})}withRetry(e){return new RunnableRetry({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new RunnableBinding({bound:this,config:e,kwargs:{}})}withFallbacks(e){const t=Array.isArray(e)?e:e.fallbacks;return new RunnableWithFallbacks({runnable:this,fallbacks:t})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(ensureConfig);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const a=Object.fromEntries(Object.entries(e).filter((([e])=>"runId"!==e)));return Array.from({length:t},((t,n)=>ensureConfig(0===n?e:a)))}return Array.from({length:t},(()=>ensureConfig(e)))}async batch(e,t,a){const n=this._getOptionsList(t??{},e.length),i=n[0]?.maxConcurrency??a?.maxConcurrency,o=new AsyncCaller({maxConcurrency:i,onFailedAttempt:e=>{throw e}}),r=e.map(((e,t)=>o.call((async()=>{try{return await this.invoke(e,n[t])}catch(e){if(a?.returnExceptions)return e;throw e}}))));return Promise.all(r)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const a=ensureConfig(t),n=new AsyncGeneratorWithSetup({generator:this._streamIterator(e,a),config:a});return await n.setup,IterableReadableStream.fromAsyncGenerator(n)}_separateRunnableConfigFromCallOptions(e){let t;t=ensureConfig(void 0===e?e:{callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});const a={...e};return delete a.callbacks,delete a.tags,delete a.metadata,delete a.runName,delete a.configurable,delete a.recursionLimit,delete a.maxConcurrency,delete a.runId,delete a.timeout,delete a.signal,[t,a]}async _callWithConfig(e,t,a){const n=ensureConfig(a),i=await getCallbackManagerForConfig(n),o=await(i?.handleChainStart(this.toJSON(),_coerceToDict(t,"input"),n.runId,n?.runType,void 0,void 0,n?.runName??this.getName()));let r;delete n.runId;try{const i=e.call(this,t,n,o);r=await raceWithSignal(i,a?.signal)}catch(e){throw await(o?.handleChainError(e)),e}return await(o?.handleChainEnd(_coerceToDict(r,"output"))),r}async _batchWithConfig(e,t,a,n){const i=this._getOptionsList(a??{},t.length),o=await Promise.all(i.map(getCallbackManagerForConfig)),r=await Promise.all(o.map((async(e,a)=>{const n=await(e?.handleChainStart(this.toJSON(),_coerceToDict(t[a],"input"),i[a].runId,i[a].runType,void 0,void 0,i[a].runName??this.getName()));return delete i[a].runId,n})));let s;try{const a=e.call(this,t,i,r,n);s=await raceWithSignal(a,i?.[0]?.signal)}catch(e){throw await Promise.all(r.map((t=>t?.handleChainError(e)))),e}return await Promise.all(r.map((e=>e?.handleChainEnd(_coerceToDict(s,"output"))))),s}async*_transformStreamWithConfig(e,t,a){let n,i,o=!0,r=!0;const s=ensureConfig(a),c=await getCallbackManagerForConfig(s);let l;try{const p=await pipeGeneratorWithSetup(t.bind(this),async function*(){for await(const t of e){if(o)if(void 0===n)n=t;else try{n=concat(n,t)}catch{n=void 0,o=!1}yield t}}(),(async()=>c?.handleChainStart(this.toJSON(),{input:""},s.runId,s.runType,void 0,void 0,s.runName??this.getName())),a?.signal,s);delete s.runId,l=p.setup;const d=l?.handlers.find(isStreamEventsHandler);let u=p.output;void 0!==d&&void 0!==l&&(u=d.tapOutputIterable(l.runId,u));const m=l?.handlers.find(isLogStreamHandler);void 0!==m&&void 0!==l&&(u=m.tapOutputIterable(l.runId,u));for await(const e of u)if(yield e,r)if(void 0===i)i=e;else try{i=concat(i,e)}catch{i=void 0,r=!1}}catch(e){throw await(l?.handleChainError(e,void 0,void 0,void 0,{inputs:_coerceToDict(n,"input")})),e}await(l?.handleChainEnd(i??{},void 0,void 0,void 0,{inputs:_coerceToDict(n,"input")}))}getGraph(e){const t=new Graph,a=t.addNode({name:`${this.getName()}Input`,schema:v3.z.any()}),n=t.addNode(this),i=t.addNode({name:`${this.getName()}Output`,schema:v3.z.any()});return t.addEdge(a,n),t.addEdge(n,i),t}pipe(e){return new RunnableSequence({first:this,last:_coerceToRunnable(e)})}pick(e){return this.pipe(new RunnablePick(e))}assign(e){return this.pipe(new RunnableAssign(new RunnableMap({steps:e})))}async*transform(e,t){let a;for await(const t of e)a=void 0===a?t:concat(a,t);yield*this._streamIterator(a,ensureConfig(t))}async*streamLog(e,t,a){const n=new LogStreamCallbackHandler({...a,autoClose:!1,_schemaFormat:"original"}),i=ensureConfig(t);yield*this._streamLog(e,n,i)}async*_streamLog(e,t,a){const{callbacks:n}=a;if(void 0===n)a.callbacks=[t];else if(Array.isArray(n))a.callbacks=n.concat([t]);else{const e=n.copy();e.addHandler(t,!0),a.callbacks=e}const i=this.stream(e,a);const o=async function(){try{const e=await i;for await(const a of e){const e=new RunLogPatch({ops:[{op:"add",path:"/streamed_output/-",value:a}]});await t.writer.write(e)}}finally{await t.writer.close()}}();try{for await(const e of t)yield e}finally{await o}}streamEvents(e,t,a){let n;if("v1"===t.version)n=this._streamEventsV1(e,t,a);else{if("v2"!==t.version)throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');n=this._streamEventsV2(e,t,a)}return"text/event-stream"===t.encoding?convertToHttpEventStream(n):IterableReadableStream.fromAsyncGenerator(n)}async*_streamEventsV2(e,t,a){const n=new EventStreamCallbackHandler({...a,autoClose:!1}),i=ensureConfig(t),o=i.runId??v4$1();i.runId=o;const r=i.callbacks;if(void 0===r)i.callbacks=[n];else if(Array.isArray(r))i.callbacks=r.concat(n);else{const e=r.copy();e.addHandler(n,!0),i.callbacks=e}const s=new AbortController,c=this;const l=async function(){try{let a;t?.signal?"any"in AbortSignal?a=AbortSignal.any([s.signal,t.signal]):(a=t.signal,t.signal.addEventListener("abort",(()=>{s.abort()}),{once:!0})):a=s.signal;const r=await c.stream(e,{...i,signal:a}),l=n.tapOutputIterable(o,r);for await(const e of l)if(s.signal.aborted)break}finally{await n.finish()}}();let p,d=!1;try{for await(const t of n)d?(t.run_id===p&&t.event.endsWith("_end")&&t.data?.input&&delete t.data.input,yield t):(t.data.input=e,d=!0,p=t.run_id,yield t)}finally{s.abort(),await l}}async*_streamEventsV1(e,t,a){let n,i=!1;const o=ensureConfig(t),r=o.tags??[],s=o.metadata??{},c=o.runName??this.getName(),l=new LogStreamCallbackHandler({...a,autoClose:!1,_schemaFormat:"streaming_events"}),p=new _RootEventFilter({...a}),d=this._streamLog(e,l,o);for await(const t of d){if(n=n?n.concat(t):RunLog.fromRunLogPatch(t),void 0===n.state)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!i){i=!0;const t={...n.state},a={run_id:t.id,event:`on_${t.type}_start`,name:c,tags:r,metadata:s,data:{input:e}};p.includeEvent(a,t.type)&&(yield a)}const a=t.ops.filter((e=>e.path.startsWith("/logs/"))).map((e=>e.path.split("/")[2])),o=[...new Set(a)];for(const e of o){let t,a={};const i=n.state.logs[e];if(t=void 0===i.end_time?i.streamed_output.length>0?"stream":"start":"end","start"===t)void 0!==i.inputs&&(a.input=i.inputs);else if("end"===t)void 0!==i.inputs&&(a.input=i.inputs),a.output=i.final_output;else if("stream"===t){const e=i.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${i.name}"`);a={chunk:i.streamed_output[0]},i.streamed_output=[]}yield{event:`on_${i.type}_${t}`,name:i.name,run_id:i.id,tags:i.tags,metadata:i.metadata,data:a}}const{state:l}=n;if(l.streamed_output.length>0){const e=l.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${l.name}"`);const t={chunk:l.streamed_output[0]};l.streamed_output=[];const a={event:`on_${l.type}_stream`,run_id:l.id,tags:r,metadata:s,name:c,data:t};p.includeEvent(a,l.type)&&(yield a)}}const u=n?.state;if(void 0!==u){const e={event:`on_${u.type}_end`,name:c,run_id:u.id,tags:r,metadata:s,data:{output:u.final_output}};p.includeEvent(e,u.type)&&(yield e)}}static isRunnable(e){return isRunnableInterface(e)}withListeners({onStart:e,onEnd:t,onError:a}){return new RunnableBinding({bound:this,config:{},configFactories:[n=>({callbacks:[new RootListenersTracer({config:n,onStart:e,onEnd:t,onError:a})]})]})}asTool(e){return convertRunnableToTool(this,e)}}class RunnableBinding extends Runnable{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const t=mergeConfigs(this.config,...e);return mergeConfigs(t,...this.configFactories?await Promise.all(this.configFactories.map((async e=>await e(t)))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new RunnableRetry({bound:this.bound,kwargs:this.kwargs,config:this.config,maxAttemptNumber:e?.stopAfterAttempt,...e})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(ensureConfig(t),this.kwargs))}async batch(e,t,a){const n=Array.isArray(t)?await Promise.all(t.map((async e=>this._mergeConfig(ensureConfig(e),this.kwargs)))):await this._mergeConfig(ensureConfig(t),this.kwargs);return this.bound.batch(e,n,a)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(ensureConfig(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(ensureConfig(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(ensureConfig(t),this.kwargs))}streamEvents(e,t,a){const n=this;return IterableReadableStream.fromAsyncGenerator(async function*(){yield*n.bound.streamEvents(e,{...await n._mergeConfig(ensureConfig(t),n.kwargs),version:t.version},a)}())}static isRunnableBinding(e){return e.bound&&Runnable.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:a}){return new RunnableBinding({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[n=>({callbacks:[new RootListenersTracer({config:n,onStart:e,onEnd:t,onError:a})]})]})}}class RunnableEach extends Runnable{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new RunnableEach({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _invoke(e,t,a){return this.bound.batch(e,patchConfig(t,{callbacks:a?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:a}){return new RunnableEach({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:a})})}}class RunnableRetry extends RunnableBinding{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,a){const n=e>1?`retry:attempt:${e}`:void 0;return patchConfig(t,{callbacks:a?.getChild(n)})}async _invoke(e,t,a){return pRetry$1((n=>super.invoke(e,this._patchConfigForRetry(n,t,a))),{onFailedAttempt:t=>this.onFailedAttempt(t,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _batch(e,t,a,n){const i={};try{await pRetry$1((async o=>{const r=e.map(((e,t)=>t)).filter((e=>void 0===i[e.toString()]||i[e.toString()]instanceof Error)),s=r.map((t=>e[t])),c=r.map((e=>this._patchConfigForRetry(o,t?.[e],a?.[e]))),l=await super.batch(s,c,{...n,returnExceptions:!0});let p;for(let e=0;e<l.length;e+=1){const t=l[e],a=r[e];t instanceof Error&&void 0===p&&(p=t,p.input=s[e]),i[a.toString()]=t}if(p)throw p;return l}),{onFailedAttempt:e=>this.onFailedAttempt(e,e.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(e){if(!0!==n?.returnExceptions)throw e}return Object.keys(i).sort(((e,t)=>parseInt(e,10)-parseInt(t,10))).map((e=>i[parseInt(e,10)]))}async batch(e,t,a){return this._batchWithConfig(this._batch.bind(this),e,t,a)}}class RunnableSequence extends Runnable{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"omitSequenceTags",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name,this.omitSequenceTags=e.omitSequenceTags??this.omitSequenceTags}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){const a=ensureConfig(t),n=await getCallbackManagerForConfig(a),i=await(n?.handleChainStart(this.toJSON(),_coerceToDict(e,"input"),a.runId,void 0,void 0,void 0,a?.runName));delete a.runId;let o,r=e;try{const e=[this.first,...this.middle];for(let n=0;n<e.length;n+=1){const o=e[n].invoke(r,patchConfig(a,{callbacks:i?.getChild(this.omitSequenceTags?void 0:`seq:step:${n+1}`)}));r=await raceWithSignal(o,t?.signal)}if(t?.signal?.aborted)throw new Error("Aborted");o=await this.last.invoke(r,patchConfig(a,{callbacks:i?.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(e){throw await(i?.handleChainError(e)),e}return await(i?.handleChainEnd(_coerceToDict(o,"output"))),o}async batch(e,t,a){const n=this._getOptionsList(t??{},e.length),i=await Promise.all(n.map(getCallbackManagerForConfig)),o=await Promise.all(i.map((async(t,a)=>{const i=await(t?.handleChainStart(this.toJSON(),_coerceToDict(e[a],"input"),n[a].runId,void 0,void 0,void 0,n[a].runName));return delete n[a].runId,i})));let r=e;try{for(let e=0;e<this.steps.length;e+=1){const t=this.steps[e].batch(r,o.map(((t,a)=>{const i=t?.getChild(this.omitSequenceTags?void 0:`seq:step:${e+1}`);return patchConfig(n[a],{callbacks:i})})),a);r=await raceWithSignal(t,n[0]?.signal)}}catch(e){throw await Promise.all(o.map((t=>t?.handleChainError(e)))),e}return await Promise.all(o.map((e=>e?.handleChainEnd(_coerceToDict(r,"output"))))),r}async*_streamIterator(e,t){const a=await getCallbackManagerForConfig(t),{runId:n,...i}=t??{},o=await(a?.handleChainStart(this.toJSON(),_coerceToDict(e,"input"),n,void 0,void 0,void 0,i?.runName)),r=[this.first,...this.middle,this.last];let s,c=!0;try{let a=r[0].transform(async function*(){yield e}(),patchConfig(i,{callbacks:o?.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let e=1;e<r.length;e+=1){const t=r[e];a=await t.transform(a,patchConfig(i,{callbacks:o?.getChild(this.omitSequenceTags?void 0:`seq:step:${e+1}`)}))}for await(const e of a)if(t?.signal?.throwIfAborted(),yield e,c)if(void 0===s)s=e;else try{s=concat(s,e)}catch(e){s=void 0,c=!1}}catch(e){throw await(o?.handleChainError(e)),e}await(o?.handleChainEnd(_coerceToDict(s,"output")))}getGraph(e){const t=new Graph;let a=null;return this.steps.forEach(((n,i)=>{const o=n.getGraph(e);0!==i&&o.trimFirstNode(),i!==this.steps.length-1&&o.trimLastNode(),t.extend(o);const r=o.firstNode();if(!r)throw new Error(`Runnable ${n} has no first node`);a&&t.addEdge(a,r),a=o.lastNode()})),t}pipe(e){return RunnableSequence.isRunnableSequence(e)?new RunnableSequence({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new RunnableSequence({first:this.first,middle:[...this.middle,this.last],last:_coerceToRunnable(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&Runnable.isRunnable(e)}static from([e,...t],a){let n={};return"string"==typeof a?n.name=a:void 0!==a&&(n=a),new RunnableSequence({...n,first:_coerceToRunnable(e),middle:t.slice(0,-1).map(_coerceToRunnable),last:_coerceToRunnable(t[t.length-1])})}}class RunnableMap extends Runnable{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,a]of Object.entries(e.steps))this.steps[t]=_coerceToRunnable(a)}static from(e){return new RunnableMap({steps:e})}async invoke(e,t){const a=ensureConfig(t),n=await getCallbackManagerForConfig(a),i=await(n?.handleChainStart(this.toJSON(),{input:e},a.runId,void 0,void 0,void 0,a?.runName));delete a.runId;const o={};try{const n=Object.entries(this.steps).map((async([t,n])=>{o[t]=await n.invoke(e,patchConfig(a,{callbacks:i?.getChild(`map:key:${t}`)}))}));await raceWithSignal(Promise.all(n),t?.signal)}catch(e){throw await(i?.handleChainError(e)),e}return await(i?.handleChainEnd(o)),o}async*_transform(e,t,a){const n={...this.steps},i=atee(e,Object.keys(n).length),o=new Map(Object.entries(n).map((([e,n],o)=>{const r=n.transform(i[o],patchConfig(a,{callbacks:t?.getChild(`map:key:${e}`)}));return[e,r.next().then((t=>({key:e,gen:r,result:t})))]})));for(;o.size;){const e=Promise.race(o.values()),{key:t,result:n,gen:i}=await raceWithSignal(e,a?.signal);o.delete(t),n.done||(yield{[t]:n.value},o.set(t,i.next().then((e=>({key:t,gen:i,result:e})))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const a=ensureConfig(t),n=new AsyncGeneratorWithSetup({generator:this.transform(async function*(){yield e}(),a),config:a});return await n.setup,IterableReadableStream.fromAsyncGenerator(n)}}class RunnableTraceable extends Runnable{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!isTraceableFunction(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){const[a]=this._getOptionsList(t??{},1),n=await getCallbackManagerForConfig(a);return raceWithSignal(this.func(patchConfig(a,{callbacks:n}),e),a?.signal)}async*_streamIterator(e,t){const[a]=this._getOptionsList(t??{},1),n=await this.invoke(e,t);if(isAsyncIterable(n))for await(const e of n)a?.signal?.throwIfAborted(),yield e;else if(isIterator(n))for(;;){a?.signal?.throwIfAborted();const e=n.next();if(e.done)break;yield e.value}else yield n}static from(e){return new RunnableTraceable({func:e})}}function assertNonTraceableFunction(e){if(isTraceableFunction(e))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}class RunnableLambda extends Runnable{static lc_name(){return"RunnableLambda"}constructor(e){if(isTraceableFunction(e.func))return RunnableTraceable.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),assertNonTraceableFunction(e.func),this.func=e.func}static from(e){return new RunnableLambda({func:e})}async _invoke(e,t,a){return new Promise(((n,i)=>{const o=patchConfig(t,{callbacks:a?.getChild(),recursionLimit:(t?.recursionLimit??DEFAULT_RECURSION_LIMIT)-1});AsyncLocalStorageProviderSingleton.runWithConfig(pickRunnableConfigKeys(o),(async()=>{try{let a=await this.func(e,{...o});if(a&&Runnable.isRunnable(a)){if(0===t?.recursionLimit)throw new Error("Recursion limit reached.");a=await a.invoke(e,{...o,recursionLimit:(o.recursionLimit??DEFAULT_RECURSION_LIMIT)-1})}else if(isAsyncIterable(a)){let e;for await(const n of consumeAsyncIterableInContext(o,a))if(t?.signal?.throwIfAborted(),void 0===e)e=n;else try{e=concat(e,n)}catch(t){e=n}a=e}else if(isIterableIterator(a)){let e;for(const n of consumeIteratorInContext(o,a))if(t?.signal?.throwIfAborted(),void 0===e)e=n;else try{e=concat(e,n)}catch(t){e=n}a=e}n(a)}catch(e){i(e)}}))}))}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async*_transform(e,t,a){let n;for await(const t of e)if(void 0===n)n=t;else try{n=concat(n,t)}catch(e){n=t}const i=patchConfig(a,{callbacks:t?.getChild(),recursionLimit:(a?.recursionLimit??DEFAULT_RECURSION_LIMIT)-1}),o=await new Promise(((e,t)=>{AsyncLocalStorageProviderSingleton.runWithConfig(pickRunnableConfigKeys(i),(async()=>{try{const t=await this.func(n,{...i,config:i});e(t)}catch(e){t(e)}}))}));if(o&&Runnable.isRunnable(o)){if(0===a?.recursionLimit)throw new Error("Recursion limit reached.");const e=await o.stream(n,i);for await(const t of e)yield t}else if(isAsyncIterable(o))for await(const e of consumeAsyncIterableInContext(i,o))a?.signal?.throwIfAborted(),yield e;else if(isIterableIterator(o))for(const e of consumeIteratorInContext(i,o))a?.signal?.throwIfAborted(),yield e;else yield o}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const a=ensureConfig(t),n=new AsyncGeneratorWithSetup({generator:this.transform(async function*(){yield e}(),a),config:a});return await n.setup,IterableReadableStream.fromAsyncGenerator(n)}}class RunnableWithFallbacks extends Runnable{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const a=ensureConfig(t),n=await getCallbackManagerForConfig(a),{runId:i,...o}=a,r=await(n?.handleChainStart(this.toJSON(),_coerceToDict(e,"input"),i,void 0,void 0,void 0,o?.runName)),s=patchConfig(o,{callbacks:r?.getChild()});return await AsyncLocalStorageProviderSingleton.runWithConfig(s,(async()=>{let t;for(const n of this.runnables()){a?.signal?.throwIfAborted();try{const t=await n.invoke(e,s);return await(r?.handleChainEnd(_coerceToDict(t,"output"))),t}catch(e){void 0===t&&(t=e)}}if(void 0===t)throw new Error("No error stored at end of fallback.");throw await(r?.handleChainError(t)),t}))}async*_streamIterator(e,t){const a=ensureConfig(t),n=await getCallbackManagerForConfig(a),{runId:i,...o}=a,r=await(n?.handleChainStart(this.toJSON(),_coerceToDict(e,"input"),i,void 0,void 0,void 0,o?.runName));let s,c,l;for(const t of this.runnables()){a?.signal?.throwIfAborted();const n=patchConfig(o,{callbacks:r?.getChild()});try{c=consumeAsyncIterableInContext(n,await t.stream(e,n));break}catch(e){void 0===s&&(s=e)}}if(void 0===c){const e=s??new Error("No error stored at end of fallback.");throw await(r?.handleChainError(e)),e}try{for await(const e of c){yield e;try{l=void 0===l?l:concat(l,e)}catch(e){l=void 0}}}catch(e){throw await(r?.handleChainError(e)),e}await(r?.handleChainEnd(_coerceToDict(l,"output")))}async batch(e,t,a){if(a?.returnExceptions)throw new Error("Not implemented.");const n=this._getOptionsList(t??{},e.length),i=await Promise.all(n.map((e=>getCallbackManagerForConfig(e)))),o=await Promise.all(i.map((async(t,a)=>{const i=await(t?.handleChainStart(this.toJSON(),_coerceToDict(e[a],"input"),n[a].runId,void 0,void 0,void 0,n[a].runName));return delete n[a].runId,i})));let r;for(const t of this.runnables()){n[0].signal?.throwIfAborted();try{const i=await t.batch(e,o.map(((e,t)=>patchConfig(n[t],{callbacks:e?.getChild()}))),a);return await Promise.all(o.map(((e,t)=>e?.handleChainEnd(_coerceToDict(i[t],"output"))))),i}catch(e){void 0===r&&(r=e)}}if(!r)throw new Error("No error stored at end of fallbacks.");throw await Promise.all(o.map((e=>e?.handleChainError(r)))),r}}function _coerceToRunnable(e){if("function"==typeof e)return new RunnableLambda({func:e});if(Runnable.isRunnable(e))return e;if(Array.isArray(e)||"object"!=typeof e)throw new Error("Expected a Runnable, function or object.\nInstead got an unsupported type.");{const t={};for(const[a,n]of Object.entries(e))t[a]=_coerceToRunnable(n);return new RunnableMap({steps:t})}}class RunnableAssign extends Runnable{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof RunnableMap&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){const a=await this.mapper.invoke(e,t);return{...e,...a}}async*_transform(e,t,a){const n=this.mapper.getStepsKeys(),[i,o]=atee(e),r=this.mapper.transform(o,patchConfig(a,{callbacks:t?.getChild()})),s=r.next();for await(const e of i){if("object"!=typeof e||Array.isArray(e))throw new Error("RunnableAssign can only be used with objects as input, got "+typeof e);const t=Object.fromEntries(Object.entries(e).filter((([e])=>!n.includes(e))));Object.keys(t).length>0&&(yield t)}yield(await s).value;for await(const e of r)yield e}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const a=ensureConfig(t),n=new AsyncGeneratorWithSetup({generator:this.transform(async function*(){yield e}(),a),config:a});return await n.setup,IterableReadableStream.fromAsyncGenerator(n)}}class RunnablePick extends Runnable{static lc_name(){return"RunnablePick"}constructor(e){("string"==typeof e||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if("string"==typeof this.keys)return e[this.keys];{const t=this.keys.map((t=>[t,e[t]])).filter((e=>void 0!==e[1]));return 0===t.length?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const e=await this._pick(t);void 0!==e&&(yield e)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const a=ensureConfig(t),n=new AsyncGeneratorWithSetup({generator:this.transform(async function*(){yield e}(),a),config:a});return await n.setup,IterableReadableStream.fromAsyncGenerator(n)}}class RunnableToolLike extends RunnableBinding{constructor(e){super({bound:RunnableSequence.from([RunnableLambda.from((async e=>{let t;if(_isToolCall(e))try{t=await interopParseAsync(this.schema,e.args)}catch(t){throw new ToolInputParsingException("Received tool input did not match expected schema",JSON.stringify(e.args))}else t=e;return t})).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name}),config:e.config??{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}}function convertRunnableToTool(e,t){const a=t.name??e.getName(),n=t.description??getSchemaDescription(t.schema);return isSimpleStringZodSchema(t.schema)?new RunnableToolLike({name:a,description:n,schema:v3.z.object({input:v3.z.string()}).transform((e=>e.input)),bound:e}):new RunnableToolLike({name:a,description:n,schema:t.schema,bound:e})}const getVerbosity=()=>!1;class BaseLangChain extends Runnable{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??getVerbosity(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class StructuredTool extends BaseLangChain{get lc_namespace(){return["langchain","tools"]}constructor(e){super(e??{}),Object.defineProperty(this,"returnDirect",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"verboseParsingErrors",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"content"}),this.verboseParsingErrors=e?.verboseParsingErrors??this.verboseParsingErrors,this.responseFormat=e?.responseFormat??this.responseFormat}async invoke(e,t){let a,n=ensureConfig(t);return _isToolCall(e)?(a=e.args,n={...n,toolCall:e}):a=e,this.call(a,n)}async call(e,t,a){const n=_isToolCall(e)?e.args:e;let i;if(isInteropZodSchema(this.schema))try{i=await interopParseAsync(this.schema,n)}catch(t){let a="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(a=`${a}\nDetails: ${t.message}`),new ToolInputParsingException(a,JSON.stringify(e))}else{const t=validate$3(n,this.schema);if(!t.valid){let a="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(a=`${a}\nDetails: ${t.errors.map((e=>`${e.keywordLocation}: ${e.error}`)).join("\n")}`),new ToolInputParsingException(a,JSON.stringify(e))}i=n}const o=parseCallbackConfigArg(t),r=CallbackManager.configure(o.callbacks,this.callbacks,o.tags||a,this.tags,o.metadata,this.metadata,{verbose:this.verbose}),s=await(r?.handleToolStart(this.toJSON(),"string"==typeof e?e:JSON.stringify(e),o.runId,void 0,void 0,void 0,o.runName));let c,l,p,d;delete o.runId;try{c=await this._call(i,s,o)}catch(e){throw await(s?.handleToolError(e)),e}if("content_and_artifact"===this.responseFormat){if(!Array.isArray(c)||2!==c.length)throw new Error(`Tool response format is "content_and_artifact" but the output was not a two-tuple.\nResult: ${JSON.stringify(c)}`);[l,p]=c}else l=c;_isToolCall(e)&&(d=e.id),!d&&_configHasToolCallId(o)&&(d=o.toolCall.id);const u=_formatToolOutput({content:l,artifact:p,toolCallId:d,name:this.name});return await(s?.handleToolEnd(u)),u}}class Tool extends StructuredTool{constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:v3.z.object({input:v3.z.string().optional()}).transform((e=>e.input))})}call(e,t){const a="string"==typeof e||null==e?{input:e}:e;return super.call(a,t)}}class DynamicTool extends Tool{static lc_name(){return"DynamicTool"}constructor(e){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.func=e.func,this.returnDirect=e.returnDirect??this.returnDirect}async call(e,t){const a=parseCallbackConfigArg(t);return void 0===a.runName&&(a.runName=this.name),super.call(e,a)}async _call(e,t,a){return this.func(e,t,a)}}class DynamicStructuredTool extends StructuredTool{static lc_name(){return"DynamicStructuredTool"}constructor(e){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.func=e.func,this.returnDirect=e.returnDirect??this.returnDirect,this.schema=e.schema}async call(e,t,a){const n=parseCallbackConfigArg(t);return void 0===n.runName&&(n.runName=this.name),super.call(e,n,a)}_call(e,t,a){return this.func(e,t,a)}}function tool(e,t){const a=isSimpleStringZodSchema(t.schema),n=validatesOnlyStrings(t.schema);if(!t.schema||a||n)return new DynamicTool({...t,description:t.description??t.schema?.description??`${t.name} tool`,func:async(t,a,n)=>new Promise(((i,o)=>{const r=patchConfig(n,{callbacks:a?.getChild()});AsyncLocalStorageProviderSingleton.runWithConfig(pickRunnableConfigKeys(r),(async()=>{try{i(e(t,r))}catch(e){o(e)}}))}))});const i=t.schema,o=t.description??t.schema.description??`${t.name} tool`;return new DynamicStructuredTool({...t,description:o,schema:i,func:async(t,a,n)=>new Promise(((i,o)=>{const r=patchConfig(n,{callbacks:a?.getChild()});AsyncLocalStorageProviderSingleton.runWithConfig(pickRunnableConfigKeys(r),(async()=>{try{i(e(t,r))}catch(e){o(e)}}))}))})}function _formatToolOutput(e){const{content:t,artifact:a,toolCallId:n}=e;return n&&!isDirectToolOutput(t)?"string"==typeof t||Array.isArray(t)&&t.every((e=>"object"==typeof e))?new ToolMessage({content:t,artifact:a,tool_call_id:n,name:e.name}):new ToolMessage({content:_stringify(t),artifact:a,tool_call_id:n,name:e.name}):t}function _stringify(e){try{return JSON.stringify(e,null,2)??""}catch(t){return`${e}`}}const memoryInstructions="The system automatically stores important user information and can update or delete memories based on user requests, enabling dynamic memory management.",getDefaultInstructions=(e,t)=>`Use the \`set_memory\` tool to save important information about the user, but ONLY when the user has explicitly provided this information. If there is nothing to note about the user specifically, END THE TURN IMMEDIATELY.\n\n  The \`delete_memory\` tool should only be used in two scenarios:\n  1. When the user explicitly asks to forget or remove specific information\n  2. When updating existing memories, use the \`set_memory\` tool instead of deleting and re-adding the memory.\n  \n  ${e&&e.length>0?`CRITICAL INSTRUCTION: Only the following keys are valid for storing memories:\n  ${e.map((e=>`- ${e}`)).join("\n  ")}`:"You can use any appropriate key to store memories about the user."}\n\n  ${t?`⚠️ TOKEN LIMIT: Each memory value must not exceed ${t} tokens. Be concise and store only essential information.`:""}\n\n  ⚠️ WARNING ⚠️\n  DO NOT STORE ANY INFORMATION UNLESS THE USER HAS EXPLICITLY PROVIDED IT.\n  ONLY store information the user has EXPLICITLY shared.\n  NEVER guess or assume user information.\n  ALL memory values must be factual statements about THIS specific user.\n  If nothing needs to be stored, DO NOT CALL any memory tools.\n  If you're unsure whether to store something, DO NOT store it.\n  If nothing needs to be stored, END THE TURN IMMEDIATELY.`,createMemoryTool=({userId:e,setMemory:t,validKeys:a,tokenLimit:n,totalTokens:i=0})=>tool((({key:o,value:r})=>__awaiter(void 0,void 0,void 0,(function*(){try{if(a&&a.length>0&&!a.includes(o))return dataSchemas.logger.warn(`Memory Agent failed to set memory: Invalid key "${o}". Must be one of: ${a.join(", ")}`),`Invalid key "${o}". Must be one of: ${a.join(", ")}`;const s=TokenizerSingleton.getTokenCount(r,"o200k_base");if(n&&s>n)return dataSchemas.logger.warn(`Memory Agent failed to set memory: Value exceeds token limit. Value has ${s} tokens, but limit is ${n}`),`Memory value too large: ${s} tokens exceeds limit of ${n}`;if(n&&i+s>n){const e=n-i;return dataSchemas.logger.warn(`Memory Agent failed to set memory: Would exceed total token limit. Current usage: ${i}, new memory: ${s} tokens, limit: ${n}`),`Cannot add memory: would exceed token limit. Current usage: ${i}/${n} tokens. This memory requires ${s} tokens, but only ${e} tokens available.`}const c={[librechatDataProvider.Tools.memory]:{key:o,value:r,tokenCount:s,type:"update"}};return(yield t({userId:e,key:o,value:r,tokenCount:s})).ok?(dataSchemas.logger.debug(`Memory set for key "${o}" (${s} tokens) for user "${e}"`),[`Memory set for key "${o}" (${s} tokens)`,c]):(dataSchemas.logger.warn(`Failed to set memory for key "${o}" for user "${e}"`),[`Failed to set memory for key "${o}"`,void 0])}catch(e){return dataSchemas.logger.error("Memory Agent failed to set memory",e),[`Error setting memory for key "${o}"`,void 0]}}))),{name:"set_memory",description:"Saves important information about the user into memory.",responseFormat:"content_and_artifact",schema:zod.z.object({key:zod.z.string().describe(a&&a.length>0?`The key of the memory value. Must be one of: ${a.join(", ")}`:"The key identifier for this memory"),value:zod.z.string().describe("Value MUST be a complete sentence that fully describes relevant user information.")})}),createDeleteMemoryTool=({userId:e,deleteMemory:t,validKeys:a})=>tool((({key:n})=>__awaiter(void 0,void 0,void 0,(function*(){try{if(a&&a.length>0&&!a.includes(n))return dataSchemas.logger.warn(`Memory Agent failed to delete memory: Invalid key "${n}". Must be one of: ${a.join(", ")}`),`Invalid key "${n}". Must be one of: ${a.join(", ")}`;const i={[librechatDataProvider.Tools.memory]:{key:n,type:"delete"}};return(yield t({userId:e,key:n})).ok?(dataSchemas.logger.debug(`Memory deleted for key "${n}" for user "${e}"`),[`Memory deleted for key "${n}"`,i]):(dataSchemas.logger.warn(`Failed to delete memory for key "${n}" for user "${e}"`),[`Failed to delete memory for key "${n}"`,void 0])}catch(e){return dataSchemas.logger.error("Memory Agent failed to delete memory",e),[`Error deleting memory for key "${n}"`,void 0]}}))),{name:"delete_memory",description:"Deletes specific memory data about the user using the provided key. For updating existing memories, use the `set_memory` tool instead",responseFormat:"content_and_artifact",schema:zod.z.object({key:zod.z.string().describe(a&&a.length>0?`The key of the memory to delete. Must be one of: ${a.join(", ")}`:"The key identifier of the memory to delete")})});class BasicToolEndHandler{constructor(e){this.callback=e}handle(e,t,a){var n;if(!a)return void console.warn(`Graph or metadata not found in ${e} event`);const i=t;(null==i?void 0:i.output)?null===(n=this.callback)||void 0===n||n.call(this,i,a):console.warn("No output found in tool_end event")}}function processMemory({res:e,userId:t,setMemory:a,deleteMemory:n,messages:i,memory:o,messageId:r,conversationId:s,validKeys:c,instructions:l,llmConfig:p,tokenLimit:d,totalTokens:u=0}){return __awaiter(this,void 0,void 0,(function*(){try{const m=createMemoryTool({userId:t,tokenLimit:d,setMemory:a,validKeys:c,totalTokens:u}),h=createDeleteMemoryTool({userId:t,validKeys:c,deleteMemory:n});let f=`# Existing memory:\n${null!=o?o:"No existing memories"}`;if(d){f=`# Memory Status:\nCurrent memory usage: ${u} tokens\nToken limit: ${d} tokens\nRemaining capacity: ${d-u} tokens\n\n# Existing memory:\n${null!=o?o:"No existing memories"}`}const g={provider:agents.Providers.OPENAI,model:"gpt-4.1-mini",temperature:.4,streaming:!1,disableStreaming:!0},v=Object.assign(Object.assign(Object.assign({},g),p),{streaming:!1,disableStreaming:!0}),b=[],y=createMemoryCallback({res:e,artifactPromises:b}),_={[agents.GraphEvents.TOOL_END]:new BasicToolEndHandler(y)},x=yield agents.Run.create({runId:r,graphConfig:{type:"standard",llmConfig:v,tools:[m,h],instructions:l,additional_instructions:f,toolEnd:!0},customHandlers:_,returnContent:!0}),w={configurable:{provider:null==p?void 0:p.provider,thread_id:`memory-run-${s}`},streamMode:"values",version:"v2"},E={messages:i},S=yield x.processStream(E,w);return S?dataSchemas.logger.debug("Memory Agent processed memory successfully",S):dataSchemas.logger.warn("Memory Agent processed memory but returned no content"),yield Promise.all(b)}catch(e){dataSchemas.logger.error("Memory Agent failed to process memory",e)}}))}function createMemoryProcessor({res:e,userId:t,messageId:a,memoryMethods:n,conversationId:i,config:o={}}){return __awaiter(this,void 0,void 0,(function*(){const{validKeys:r,instructions:s,llmConfig:c,tokenLimit:l}=o,p=s||getDefaultInstructions(r,l),{withKeys:d,withoutKeys:u,totalTokens:m}=yield n.getFormattedMemories({userId:t});return[u,function(o){return __awaiter(this,void 0,void 0,(function*(){try{return yield processMemory({res:e,userId:t,messages:o,validKeys:r,llmConfig:c,messageId:a,tokenLimit:l,conversationId:i,memory:d,totalTokens:m||0,instructions:p,setMemory:n.setMemory,deleteMemory:n.deleteMemory})}catch(e){dataSchemas.logger.error("Memory Agent failed to process memory",e)}}))}]}))}function handleMemoryArtifact({res:e,data:t,metadata:a}){var n,i;return __awaiter(this,void 0,void 0,(function*(){const o=null==t?void 0:t.output;if(!o)return null;if(!o.artifact)return null;const r=o.artifact[librechatDataProvider.Tools.memory];if(!r)return null;const s={type:librechatDataProvider.Tools.memory,toolCallId:o.tool_call_id,messageId:null!==(n=null==a?void 0:a.run_id)&&void 0!==n?n:"",conversationId:null!==(i=null==a?void 0:a.thread_id)&&void 0!==i?i:"",[librechatDataProvider.Tools.memory]:r};return e.headersSent?(e.write(`event: attachment\ndata: ${JSON.stringify(s)}\n\n`),s):s}))}function createMemoryCallback({res:e,artifactPromises:t}){return(a,n)=>__awaiter(this,void 0,void 0,(function*(){var i;const o=null==a?void 0:a.output;null!=(null===(i=null==o?void 0:o.artifact)||void 0===i?void 0:i[librechatDataProvider.Tools.memory])&&t.push(handleMemoryArtifact({res:e,data:a,metadata:n}).catch((e=>(dataSchemas.logger.error("Error processing memory artifact content:",e),null))))}))}const addFileToResource=({file:e,resourceType:t,tool_resources:a,processedResourceFiles:n})=>{var i,o;if(!e.file_id)return;const r=`${t}:${e.file_id}`;if(n.has(r))return;const s=null!==(i=a[t])&&void 0!==i?i:{};s.files||(a[t]=Object.assign(Object.assign({},s),{files:[]}));const c=null===(o=a[t])||void 0===o?void 0:o.files,l=null==c?void 0:c.some((t=>t.file_id===e.file_id));l||(null==c||c.push(e),n.add(r))},categorizeFileForToolResources=({file:e,tool_resources:t,requestFileSet:a,processedResourceFiles:n})=>{var i;(null===(i=e.metadata)||void 0===i?void 0:i.fileIdentifier)?addFileToResource({file:e,resourceType:librechatDataProvider.EToolResources.execute_code,tool_resources:t,processedResourceFiles:n}):!0!==e.embedded?a.has(e.file_id)&&e.type.startsWith("image")&&e.height&&e.width&&addFileToResource({file:e,resourceType:librechatDataProvider.EToolResources.image_edit,tool_resources:t,processedResourceFiles:n}):addFileToResource({file:e,resourceType:librechatDataProvider.EToolResources.file_search,tool_resources:t,processedResourceFiles:n})},primeResources=({req:e,getFiles:t,requestFileSet:a,attachments:n,tool_resources:i})=>__awaiter(void 0,void 0,void 0,(function*(){var o,r,s,c,l;try{const l=[],p=new Set,d=new Set,u=null!=i?i:{};for(const[e,t]of Object.entries(u))if((null==t?void 0:t.files)&&Array.isArray(t.files))for(const a of t.files)(null==a?void 0:a.file_id)&&(d.add(`${e}:${a.file_id}`),e!==librechatDataProvider.EToolResources.ocr&&p.add(a.file_id));const m=(null!==(s=null===(r=null===(o=e.app.locals)||void 0===o?void 0:o[librechatDataProvider.EModelEndpoint.agents])||void 0===r?void 0:r.capabilities)&&void 0!==s?s:[]).includes(librechatDataProvider.AgentCapabilities.ocr);if((null===(c=u[librechatDataProvider.EToolResources.ocr])||void 0===c?void 0:c.file_ids)&&m){const e=yield t({file_id:{$in:u.ocr.file_ids}},{},{});for(const t of e)(null==t?void 0:t.file_id)&&(p.delete(t.file_id),l.push(t),p.add(t.file_id),categorizeFileForToolResources({file:t,tool_resources:u,requestFileSet:a,processedResourceFiles:d}))}if(!n)return{attachments:l.length>0?l:void 0,tool_resources:u};const h=yield n;for(const e of h)e&&(categorizeFileForToolResources({file:e,tool_resources:u,requestFileSet:a,processedResourceFiles:d}),e.file_id&&p.has(e.file_id)||(l.push(e),e.file_id&&p.add(e.file_id)));return{attachments:l.length>0?l:[],tool_resources:u}}catch(e){dataSchemas.logger.error("Error priming resources",e);let t=[];if(n)try{const e=yield n;t=null!==(l=null==e?void 0:e.filter((e=>!!e)))&&void 0!==l?l:[]}catch(e){dataSchemas.logger.error("Error resolving attachments in catch block",e),t=[]}return{attachments:t,tool_resources:i}}})),customProviders=new Set([agents.Providers.XAI,agents.Providers.OLLAMA,agents.Providers.DEEPSEEK,agents.Providers.OPENROUTER]);function createRun({runId:e,agent:t,signal:a,customHandlers:n,streaming:i=!0,streamUsage:o=!0}){var r,s,c;return __awaiter(this,void 0,void 0,(function*(){const l=null!==(r=librechatDataProvider.providerEndpointMap[t.provider])&&void 0!==r?r:t.provider,p=Object.assign({provider:l,streaming:i,streamUsage:o},t.model_parameters);let d;(customProviders.has(t.provider)||t.provider===agents.Providers.OPENAI&&t.endpoint!==t.provider)&&(p.streamUsage=!1,p.usage=!0),l===agents.Providers.GOOGLE||(null===(c=null===(s=p.configuration)||void 0===s?void 0:s.baseURL)||void 0===c?void 0:c.includes(librechatDataProvider.KnownEndpoints.openrouter))||t.endpoint&&t.endpoint.toLowerCase().includes(librechatDataProvider.KnownEndpoints.openrouter)?d="reasoning":!0!==p.useResponsesApi||l!==agents.Providers.OPENAI&&l!==agents.Providers.AZURE||(d="reasoning");const u={signal:a,llmConfig:p,reasoningKey:d,tools:t.tools,instructions:t.instructions,additional_instructions:t.additional_instructions};return t.provider!==agents.Providers.ANTHROPIC&&t.provider!==agents.Providers.BEDROCK||(u.streamBuffer=2e3),agents.Run.create({runId:e,graphConfig:u,customHandlers:n})}))}function getThresholdMapping(e){return/gemini-(1\.0|1\.5|pro$|1\.0-pro|1\.5-pro|1\.5-flash-001)/.test(e)?e=>"OFF"===e?"BLOCK_NONE":e:/(gemini-(1\.5-flash-8b|2\.0|exp)|learnlm)/.test(e)?e=>"OFF"===e||"HARM_BLOCK_THRESHOLD_UNSPECIFIED"===e?"BLOCK_NONE":e:e=>e}function getSafetySettings(e){if(isEnabled(process.env.GOOGLE_EXCLUDE_SAFETY_SETTINGS))return;const t=getThresholdMapping(null!=e?e:"");return[{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:t(process.env.GOOGLE_SAFETY_SEXUALLY_EXPLICIT||"HARM_BLOCK_THRESHOLD_UNSPECIFIED")},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:t(process.env.GOOGLE_SAFETY_HATE_SPEECH||"HARM_BLOCK_THRESHOLD_UNSPECIFIED")},{category:"HARM_CATEGORY_HARASSMENT",threshold:t(process.env.GOOGLE_SAFETY_HARASSMENT||"HARM_BLOCK_THRESHOLD_UNSPECIFIED")},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:t(process.env.GOOGLE_SAFETY_DANGEROUS_CONTENT||"HARM_BLOCK_THRESHOLD_UNSPECIFIED")},{category:"HARM_CATEGORY_CIVIC_INTEGRITY",threshold:t(process.env.GOOGLE_SAFETY_CIVIC_INTEGRITY||"BLOCK_NONE")}]}function getGoogleConfig(e,t={}){var a,n,i,o;let r={};if("string"==typeof e)try{r=JSON.parse(e)}catch(e){throw new Error(`Error parsing string credentials: ${e instanceof Error?e.message:"Unknown error"}`)}else e&&"object"==typeof e&&(r=e);const s=null!==(a=r[librechatDataProvider.AuthKeys.GOOGLE_SERVICE_KEY])&&void 0!==a?a:{},c="string"==typeof s?JSON.parse(s):null!=s?s:{},l=null!==(n=r[librechatDataProvider.AuthKeys.GOOGLE_API_KEY])&&void 0!==n?n:null,p=l?null:null!==(i=null==c?void 0:c.project_id)&&void 0!==i?i:null,d=t.reverseProxyUrl,u=t.authHeader,m=t.modelOptions||{},{grounding:h,thinking:f=librechatDataProvider.googleSettings.thinking.default,thinkingBudget:g=librechatDataProvider.googleSettings.thinkingBudget.default}=m,v=__rest(m,["grounding","thinking","thinkingBudget"]),b=Object.assign(Object.assign({},v||{}),{model:null!==(o=null==v?void 0:v.model)&&void 0!==o?o:"",maxRetries:2});let y;if(b.safetySettings=getSafetySettings(b.model),y=p?agents.Providers.VERTEXAI:agents.Providers.GOOGLE,y===agents.Providers.VERTEXAI)b.authOptions={credentials:Object.assign({},c),projectId:p},b.location=process.env.GOOGLE_LOC||"us-central1";else{if(!l||y!==agents.Providers.GOOGLE)throw new Error("Invalid credentials provided. Please provide either a valid API key or service account credentials for Google Cloud.");b.apiKey=l}const _=f&&null!=g&&(g>0||-1===g);_&&y===agents.Providers.GOOGLE?b.thinkingConfig={thinkingBudget:f?g:librechatDataProvider.googleSettings.thinkingBudget.default,includeThoughts:Boolean(f)}:_&&y===agents.Providers.VERTEXAI&&(b.thinkingBudget=f?g:librechatDataProvider.googleSettings.thinkingBudget.default,b.includeThoughts=Boolean(f)),d&&(b.baseUrl=d),u&&(b.customHeaders={Authorization:`Bearer ${l}`});const x=[];return h&&x.push({googleSearch:{}}),{tools:x,provider:y,llmConfig:b}}function hasReasoningParams({reasoning_effort:e,reasoning_summary:t}){return null!=e&&""!==e||null!=t&&""!==t}function getOpenAIConfig(e,t={},a){var n;const{modelOptions:i={},reverseProxyUrl:o,defaultQuery:r,headers:s,proxy:c,azure:l,streaming:p=!0,addParams:d,dropParams:u}=t,{reasoning_effort:m,reasoning_summary:h}=i,f=__rest(i,["reasoning_effort","reasoning_summary"]),g=Object.assign({streaming:p,model:null!==(n=f.model)&&void 0!==n?n:""},f);d&&"object"==typeof d&&Object.assign(g,d);let v=!1;const b={};if(o&&o.includes(librechatDataProvider.KnownEndpoints.openrouter)||a&&a.toLowerCase().includes(librechatDataProvider.KnownEndpoints.openrouter)?(v=!0,g.include_reasoning=!0,b.baseURL=o,b.defaultHeaders=Object.assign({"HTTP-Referer":"https://librechat.ai","X-Title":"LibreChat"},s)):o&&(b.baseURL=o,s&&(b.defaultHeaders=s)),r&&(b.defaultQuery=r),c){const e=new undici.ProxyAgent(c);b.fetchOptions={dispatcher:e}}if(l){const e=isEnabled(process.env.AZURE_USE_MODEL_AS_DEPLOYMENT_NAME),t=Object.assign({},l);if(t.azureOpenAIApiDeploymentName=e?sanitizeModelName(g.model||""):l.azureOpenAIApiDeploymentName,process.env.AZURE_OPENAI_DEFAULT_MODEL&&(g.model=process.env.AZURE_OPENAI_DEFAULT_MODEL),b.baseURL){const e=constructAzureURL({baseURL:b.baseURL,azureOptions:t});t.azureOpenAIBasePath=e.split(`/${t.azureOpenAIApiDeploymentName}`)[0]}Object.assign(g,t),g.model=t.azureOpenAIApiDeploymentName}else g.apiKey=e;if(process.env.OPENAI_ORGANIZATION&&l&&(b.organization=process.env.OPENAI_ORGANIZATION),hasReasoningParams({reasoning_effort:m,reasoning_summary:h})&&(!0===g.useResponsesApi||v)?g.reasoning=librechatDataProvider.removeNullishValues({effort:m,summary:h},!0):hasReasoningParams({reasoning_effort:m})&&(g.reasoning_effort=m),null!=g.max_tokens&&(g.maxTokens=g.max_tokens,delete g.max_tokens),f.model&&/gpt-4o.*search/.test(f.model)){[...new Set([...u||[],...["frequency_penalty","presence_penalty","reasoning","reasoning_effort","temperature","top_p","top_k","stop","logit_bias","seed","response_format","n","logprobs","user"]])].forEach((e=>{e in g&&delete g[e]}))}else u&&Array.isArray(u)&&u.forEach((e=>{e in g&&delete g[e]}));return{llmConfig:g,configOptions:b}}const initializeOpenAI=({req:e,overrideModel:t,endpointOption:a,overrideEndpoint:n,getUserKeyValues:i,checkUserKeyExpiry:o})=>__awaiter(void 0,void 0,void 0,(function*(){var r,s,c,l,p,d;const{PROXY:u,OPENAI_API_KEY:m,AZURE_API_KEY:h,OPENAI_REVERSE_PROXY:f,AZURE_OPENAI_BASEURL:g}=process.env,{key:v}=e.body,b=null!=t?t:e.body.model,y=null!=n?n:e.body.endpoint;if(!y)throw new Error("Endpoint is required");const _={[librechatDataProvider.EModelEndpoint.openAI]:m,[librechatDataProvider.EModelEndpoint.azureOpenAI]:h},x={[librechatDataProvider.EModelEndpoint.openAI]:f,[librechatDataProvider.EModelEndpoint.azureOpenAI]:g},w=isUserProvided(_[y]),E=isUserProvided(x[y]);let S=null;v&&(w||E)&&(o(v,y),S=yield i({userId:e.user.id,name:y}));let $=w?null==S?void 0:S.apiKey:_[y];const T={proxy:null!=u?u:void 0,reverseProxyUrl:(E?null==S?void 0:S.baseURL:x[y])||void 0,streaming:!0},O=y===librechatDataProvider.EModelEndpoint.azureOpenAI,k=O&&e.app.locals[librechatDataProvider.EModelEndpoint.azureOpenAI];if(O&&k){const{modelGroupMap:t,groupMap:a}=k,{azureOptions:n,baseURL:i,headers:o={},serverless:p}=librechatDataProvider.mapModelToAzureConfig({modelName:b||"",modelGroupMap:t,groupMap:a});T.reverseProxyUrl=null!=i?i:T.reverseProxyUrl,T.headers=resolveHeaders(Object.assign(Object.assign({},o),null!==(r=T.headers)&&void 0!==r?r:{}),e.user);const d=null===(s=t[b||""])||void 0===s?void 0:s.group;d&&a[d]&&(T.addParams=null===(c=a[d])||void 0===c?void 0:c.addParams,T.dropParams=null===(l=a[d])||void 0===l?void 0:l.dropParams),$=n.azureOpenAIApiKey,T.azure=p?void 0:n,!0===p&&(T.defaultQuery=n.azureOpenAIApiVersion?{"api-version":n.azureOpenAIApiVersion}:void 0,T.headers||(T.headers={}),T.headers["api-key"]=$)}else O&&(T.azure=w&&(null==S?void 0:S.apiKey)?JSON.parse(S.apiKey):getAzureCredentials(),$=null===(p=T.azure)||void 0===p?void 0:p.azureOpenAIApiKey);if(w&&!$)throw new Error(JSON.stringify({type:librechatDataProvider.ErrorTypes.NO_USER_KEY}));if(!$)throw new Error(`${y} API Key not provided.`);const I=Object.assign(Object.assign({},a.model_parameters),{model:b,user:e.user.id}),A=getOpenAIConfig($,Object.assign(Object.assign({},T),{modelOptions:I}),y),R=e.app.locals[librechatDataProvider.EModelEndpoint.openAI],C=e.app.locals.all,P=(null==b?void 0:b.includes("gpt-4"))?30:17;let N;O&&k?N=null!==(d=k.streamRate)&&void 0!==d?d:P:!O&&R&&(N=R.streamRate),(null==C?void 0:C.streamRate)&&(N=C.streamRate),N&&(A.llmConfig.callbacks=[{handleLLMNewToken:createHandleLLMNewToken(N)}]);return Object.assign(Object.assign({},A),{streamRate:N})}));var Stream$2=require$$0$1.Stream,util$2=require$$1,delayed_stream=DelayedStream$1;function DelayedStream$1(){this.source=null,this.dataSize=0,this.maxDataSize=1048576,this.pauseStream=!0,this._maxDataSizeExceeded=!1,this._released=!1,this._bufferedEvents=[]}util$2.inherits(DelayedStream$1,Stream$2),DelayedStream$1.create=function(e,t){var a=new this;for(var n in t=t||{})a[n]=t[n];a.source=e;var i=e.emit;return e.emit=function(){return a._handleEmit(arguments),i.apply(e,arguments)},e.on("error",(function(){})),a.pauseStream&&e.pause(),a},Object.defineProperty(DelayedStream$1.prototype,"readable",{configurable:!0,enumerable:!0,get:function(){return this.source.readable}}),DelayedStream$1.prototype.setEncoding=function(){return this.source.setEncoding.apply(this.source,arguments)},DelayedStream$1.prototype.resume=function(){this._released||this.release(),this.source.resume()},DelayedStream$1.prototype.pause=function(){this.source.pause()},DelayedStream$1.prototype.release=function(){this._released=!0,this._bufferedEvents.forEach(function(e){this.emit.apply(this,e)}.bind(this)),this._bufferedEvents=[]},DelayedStream$1.prototype.pipe=function(){var e=Stream$2.prototype.pipe.apply(this,arguments);return this.resume(),e},DelayedStream$1.prototype._handleEmit=function(e){this._released?this.emit.apply(this,e):("data"===e[0]&&(this.dataSize+=e[1].length,this._checkIfMaxDataSizeExceeded()),this._bufferedEvents.push(e))},DelayedStream$1.prototype._checkIfMaxDataSizeExceeded=function(){if(!(this._maxDataSizeExceeded||this.dataSize<=this.maxDataSize)){this._maxDataSizeExceeded=!0;var e="DelayedStream#maxDataSize of "+this.maxDataSize+" bytes exceeded.";this.emit("error",new Error(e))}};var util$1=require$$1,Stream$1=require$$0$1.Stream,DelayedStream=delayed_stream,combined_stream=CombinedStream$1;function CombinedStream$1(){this.writable=!1,this.readable=!0,this.dataSize=0,this.maxDataSize=2097152,this.pauseStreams=!0,this._released=!1,this._streams=[],this._currentStream=null,this._insideLoop=!1,this._pendingNext=!1}util$1.inherits(CombinedStream$1,Stream$1),CombinedStream$1.create=function(e){var t=new this;for(var a in e=e||{})t[a]=e[a];return t},CombinedStream$1.isStreamLike=function(e){return"function"!=typeof e&&"string"!=typeof e&&"boolean"!=typeof e&&"number"!=typeof e&&!Buffer.isBuffer(e)},CombinedStream$1.prototype.append=function(e){if(CombinedStream$1.isStreamLike(e)){if(!(e instanceof DelayedStream)){var t=DelayedStream.create(e,{maxDataSize:1/0,pauseStream:this.pauseStreams});e.on("data",this._checkDataSize.bind(this)),e=t}this._handleErrors(e),this.pauseStreams&&e.pause()}return this._streams.push(e),this},CombinedStream$1.prototype.pipe=function(e,t){return Stream$1.prototype.pipe.call(this,e,t),this.resume(),e},CombinedStream$1.prototype._getNext=function(){if(this._currentStream=null,this._insideLoop)this._pendingNext=!0;else{this._insideLoop=!0;try{do{this._pendingNext=!1,this._realGetNext()}while(this._pendingNext)}finally{this._insideLoop=!1}}},CombinedStream$1.prototype._realGetNext=function(){var e=this._streams.shift();void 0!==e?"function"==typeof e?e(function(e){CombinedStream$1.isStreamLike(e)&&(e.on("data",this._checkDataSize.bind(this)),this._handleErrors(e)),this._pipeNext(e)}.bind(this)):this._pipeNext(e):this.end()},CombinedStream$1.prototype._pipeNext=function(e){if(this._currentStream=e,CombinedStream$1.isStreamLike(e))return e.on("end",this._getNext.bind(this)),void e.pipe(this,{end:!1});var t=e;this.write(t),this._getNext()},CombinedStream$1.prototype._handleErrors=function(e){var t=this;e.on("error",(function(e){t._emitError(e)}))},CombinedStream$1.prototype.write=function(e){this.emit("data",e)},CombinedStream$1.prototype.pause=function(){this.pauseStreams&&(this.pauseStreams&&this._currentStream&&"function"==typeof this._currentStream.pause&&this._currentStream.pause(),this.emit("pause"))},CombinedStream$1.prototype.resume=function(){this._released||(this._released=!0,this.writable=!0,this._getNext()),this.pauseStreams&&this._currentStream&&"function"==typeof this._currentStream.resume&&this._currentStream.resume(),this.emit("resume")},CombinedStream$1.prototype.end=function(){this._reset(),this.emit("end")},CombinedStream$1.prototype.destroy=function(){this._reset(),this.emit("close")},CombinedStream$1.prototype._reset=function(){this.writable=!1,this._streams=[],this._currentStream=null},CombinedStream$1.prototype._checkDataSize=function(){if(this._updateDataSize(),!(this.dataSize<=this.maxDataSize)){var e="DelayedStream#maxDataSize of "+this.maxDataSize+" bytes exceeded.";this._emitError(new Error(e))}},CombinedStream$1.prototype._updateDataSize=function(){this.dataSize=0;var e=this;this._streams.forEach((function(t){t.dataSize&&(e.dataSize+=t.dataSize)})),this._currentStream&&this._currentStream.dataSize&&(this.dataSize+=this._currentStream.dataSize)},CombinedStream$1.prototype._emitError=function(e){this._reset(),this.emit("error",e)};var mimeTypes={},require$$0={"application/1d-interleaved-parityfec":{source:"iana"},"application/3gpdash-qoe-report+xml":{source:"iana",charset:"UTF-8",compressible:!0},"application/3gpp-ims+xml":{source:"iana",compressible:!0},"application/3gpphal+json":{source:"iana",compressible:!0},"application/3gpphalforms+json":{source:"iana",compressible:!0},"application/a2l":{source:"iana"},"application/ace+cbor":{source:"iana"},"application/activemessage":{source:"iana"},"application/activity+json":{source:"iana",compressible:!0},"application/alto-costmap+json":{source:"iana",compressible:!0},"application/alto-costmapfilter+json":{source:"iana",compressible:!0},"application/alto-directory+json":{source:"iana",compressible:!0},"application/alto-endpointcost+json":{source:"iana",compressible:!0},"application/alto-endpointcostparams+json":{source:"iana",compressible:!0},"application/alto-endpointprop+json":{source:"iana",compressible:!0},"application/alto-endpointpropparams+json":{source:"iana",compressible:!0},"application/alto-error+json":{source:"iana",compressible:!0},"application/alto-networkmap+json":{source:"iana",compressible:!0},"application/alto-networkmapfilter+json":{source:"iana",compressible:!0},"application/alto-updatestreamcontrol+json":{source:"iana",compressible:!0},"application/alto-updatestreamparams+json":{source:"iana",compressible:!0},"application/aml":{source:"iana"},"application/andrew-inset":{source:"iana",extensions:["ez"]},"application/applefile":{source:"iana"},"application/applixware":{source:"apache",extensions:["aw"]},"application/at+jwt":{source:"iana"},"application/atf":{source:"iana"},"application/atfx":{source:"iana"},"application/atom+xml":{source:"iana",compressible:!0,extensions:["atom"]},"application/atomcat+xml":{source:"iana",compressible:!0,extensions:["atomcat"]},"application/atomdeleted+xml":{source:"iana",compressible:!0,extensions:["atomdeleted"]},"application/atomicmail":{source:"iana"},"application/atomsvc+xml":{source:"iana",compressible:!0,extensions:["atomsvc"]},"application/atsc-dwd+xml":{source:"iana",compressible:!0,extensions:["dwd"]},"application/atsc-dynamic-event-message":{source:"iana"},"application/atsc-held+xml":{source:"iana",compressible:!0,extensions:["held"]},"application/atsc-rdt+json":{source:"iana",compressible:!0},"application/atsc-rsat+xml":{source:"iana",compressible:!0,extensions:["rsat"]},"application/atxml":{source:"iana"},"application/auth-policy+xml":{source:"iana",compressible:!0},"application/bacnet-xdd+zip":{source:"iana",compressible:!1},"application/batch-smtp":{source:"iana"},"application/bdoc":{compressible:!1,extensions:["bdoc"]},"application/beep+xml":{source:"iana",charset:"UTF-8",compressible:!0},"application/calendar+json":{source:"iana",compressible:!0},"application/calendar+xml":{source:"iana",compressible:!0,extensions:["xcs"]},"application/call-completion":{source:"iana"},"application/cals-1840":{source:"iana"},"application/captive+json":{source:"iana",compressible:!0},"application/cbor":{source:"iana"},"application/cbor-seq":{source:"iana"},"application/cccex":{source:"iana"},"application/ccmp+xml":{source:"iana",compressible:!0},"application/ccxml+xml":{source:"iana",compressible:!0,extensions:["ccxml"]},"application/cdfx+xml":{source:"iana",compressible:!0,extensions:["cdfx"]},"application/cdmi-capability":{source:"iana",extensions:["cdmia"]},"application/cdmi-container":{source:"iana",extensions:["cdmic"]},"application/cdmi-domain":{source:"iana",extensions:["cdmid"]},"application/cdmi-object":{source:"iana",extensions:["cdmio"]},"application/cdmi-queue":{source:"iana",extensions:["cdmiq"]},"application/cdni":{source:"iana"},"application/cea":{source:"iana"},"application/cea-2018+xml":{source:"iana",compressible:!0},"application/cellml+xml":{source:"iana",compressible:!0},"application/cfw":{source:"iana"},"application/city+json":{source:"iana",compressible:!0},"application/clr":{source:"iana"},"application/clue+xml":{source:"iana",compressible:!0},"application/clue_info+xml":{source:"iana",compressible:!0},"application/cms":{source:"iana"},"application/cnrp+xml":{source:"iana",compressible:!0},"application/coap-group+json":{source:"iana",compressible:!0},"application/coap-payload":{source:"iana"},"application/commonground":{source:"iana"},"application/conference-info+xml":{source:"iana",compressible:!0},"application/cose":{source:"iana"},"application/cose-key":{source:"iana"},"application/cose-key-set":{source:"iana"},"application/cpl+xml":{source:"iana",compressible:!0,extensions:["cpl"]},"application/csrattrs":{source:"iana"},"application/csta+xml":{source:"iana",compressible:!0},"application/cstadata+xml":{source:"iana",compressible:!0},"application/csvm+json":{source:"iana",compressible:!0},"application/cu-seeme":{source:"apache",extensions:["cu"]},"application/cwt":{source:"iana"},"application/cybercash":{source:"iana"},"application/dart":{compressible:!0},"application/dash+xml":{source:"iana",compressible:!0,extensions:["mpd"]},"application/dash-patch+xml":{source:"iana",compressible:!0,extensions:["mpp"]},"application/dashdelta":{source:"iana"},"application/davmount+xml":{source:"iana",compressible:!0,extensions:["davmount"]},"application/dca-rft":{source:"iana"},"application/dcd":{source:"iana"},"application/dec-dx":{source:"iana"},"application/dialog-info+xml":{source:"iana",compressible:!0},"application/dicom":{source:"iana"},"application/dicom+json":{source:"iana",compressible:!0},"application/dicom+xml":{source:"iana",compressible:!0},"application/dii":{source:"iana"},"application/dit":{source:"iana"},"application/dns":{source:"iana"},"application/dns+json":{source:"iana",compressible:!0},"application/dns-message":{source:"iana"},"application/docbook+xml":{source:"apache",compressible:!0,extensions:["dbk"]},"application/dots+cbor":{source:"iana"},"application/dskpp+xml":{source:"iana",compressible:!0},"application/dssc+der":{source:"iana",extensions:["dssc"]},"application/dssc+xml":{source:"iana",compressible:!0,extensions:["xdssc"]},"application/dvcs":{source:"iana"},"application/ecmascript":{source:"iana",compressible:!0,extensions:["es","ecma"]},"application/edi-consent":{source:"iana"},"application/edi-x12":{source:"iana",compressible:!1},"application/edifact":{source:"iana",compressible:!1},"application/efi":{source:"iana"},"application/elm+json":{source:"iana",charset:"UTF-8",compressible:!0},"application/elm+xml":{source:"iana",compressible:!0},"application/emergencycalldata.cap+xml":{source:"iana",charset:"UTF-8",compressible:!0},"application/emergencycalldata.comment+xml":{source:"iana",compressible:!0},"application/emergencycalldata.control+xml":{source:"iana",compressible:!0},"application/emergencycalldata.deviceinfo+xml":{source:"iana",compressible:!0},"application/emergencycalldata.ecall.msd":{source:"iana"},"application/emergencycalldata.providerinfo+xml":{source:"iana",compressible:!0},"application/emergencycalldata.serviceinfo+xml":{source:"iana",compressible:!0},"application/emergencycalldata.subscriberinfo+xml":{source:"iana",compressible:!0},"application/emergencycalldata.veds+xml":{source:"iana",compressible:!0},"application/emma+xml":{source:"iana",compressible:!0,extensions:["emma"]},"application/emotionml+xml":{source:"iana",compressible:!0,extensions:["emotionml"]},"application/encaprtp":{source:"iana"},"application/epp+xml":{source:"iana",compressible:!0},"application/epub+zip":{source:"iana",compressible:!1,extensions:["epub"]},"application/eshop":{source:"iana"},"application/exi":{source:"iana",extensions:["exi"]},"application/expect-ct-report+json":{source:"iana",compressible:!0},"application/express":{source:"iana",extensions:["exp"]},"application/fastinfoset":{source:"iana"},"application/fastsoap":{source:"iana"},"application/fdt+xml":{source:"iana",compressible:!0,extensions:["fdt"]},"application/fhir+json":{source:"iana",charset:"UTF-8",compressible:!0},"application/fhir+xml":{source:"iana",charset:"UTF-8",compressible:!0},"application/fido.trusted-apps+json":{compressible:!0},"application/fits":{source:"iana"},"application/flexfec":{source:"iana"},"application/font-sfnt":{source:"iana"},"application/font-tdpfr":{source:"iana",extensions:["pfr"]},"application/font-woff":{source:"iana",compressible:!1},"application/framework-attributes+xml":{source:"iana",compressible:!0},"application/geo+json":{source:"iana",compressible:!0,extensions:["geojson"]},"application/geo+json-seq":{source:"iana"},"application/geopackage+sqlite3":{source:"iana"},"application/geoxacml+xml":{source:"iana",compressible:!0},"application/gltf-buffer":{source:"iana"},"application/gml+xml":{source:"iana",compressible:!0,extensions:["gml"]},"application/gpx+xml":{source:"apache",compressible:!0,extensions:["gpx"]},"application/gxf":{source:"apache",extensions:["gxf"]},"application/gzip":{source:"iana",compressible:!1,extensions:["gz"]},"application/h224":{source:"iana"},"application/held+xml":{source:"iana",compressible:!0},"application/hjson":{extensions:["hjson"]},"application/http":{source:"iana"},"application/hyperstudio":{source:"iana",extensions:["stk"]},"application/ibe-key-request+xml":{source:"iana",compressible:!0},"application/ibe-pkg-reply+xml":{source:"iana",compressible:!0},"application/ibe-pp-data":{source:"iana"},"application/iges":{source:"iana"},"application/im-iscomposing+xml":{source:"iana",charset:"UTF-8",compressible:!0},"application/index":{source:"iana"},"application/index.cmd":{source:"iana"},"application/index.obj":{source:"iana"},"application/index.response":{source:"iana"},"application/index.vnd":{source:"iana"},"application/inkml+xml":{source:"iana",compressible:!0,extensions:["ink","inkml"]},"application/iotp":{source:"iana"},"application/ipfix":{source:"iana",extensions:["ipfix"]},"application/ipp":{source:"iana"},"application/isup":{source:"iana"},"application/its+xml":{source:"iana",compressible:!0,extensions:["its"]},"application/java-archive":{source:"apache",compressible:!1,extensions:["jar","war","ear"]},"application/java-serialized-object":{source:"apache",compressible:!1,extensions:["ser"]},"application/java-vm":{source:"apache",compressible:!1,extensions:["class"]},"application/javascript":{source:"iana",charset:"UTF-8",compressible:!0,extensions:["js","mjs"]},"application/jf2feed+json":{source:"iana",compressible:!0},"application/jose":{source:"iana"},"application/jose+json":{source:"iana",compressible:!0},"application/jrd+json":{source:"iana",compressible:!0},"application/jscalendar+json":{source:"iana",compressible:!0},"application/json":{source:"iana",charset:"UTF-8",compressible:!0,extensions:["json","map"]},"application/json-patch+json":{source:"iana",compressible:!0},"application/json-seq":{source:"iana"},"application/json5":{extensions:["json5"]},"application/jsonml+json":{source:"apache",compressible:!0,extensions:["jsonml"]},"application/jwk+json":{source:"iana",compressible:!0},"application/jwk-set+json":{source:"iana",compressible:!0},"application/jwt":{source:"iana"},"application/kpml-request+xml":{source:"iana",compressible:!0},"application/kpml-response+xml":{source:"iana",compressible:!0},"application/ld+json":{source:"iana",compressible:!0,extensions:["jsonld"]},"application/lgr+xml":{source:"iana",compressible:!0,extensions:["lgr"]},"application/link-format":{source:"iana"},"application/load-control+xml":{source:"iana",compressible:!0},"application/lost+xml":{source:"iana",compressible:!0,extensions:["lostxml"]},"application/lostsync+xml":{source:"iana",compressible:!0},"application/lpf+zip":{source:"iana",compressible:!1},"application/lxf":{source:"iana"},"application/mac-binhex40":{source:"iana",extensions:["hqx"]},"application/mac-compactpro":{source:"apache",extensions:["cpt"]},"application/macwriteii":{source:"iana"},"application/mads+xml":{source:"iana",compressible:!0,extensions:["mads"]},"application/manifest+json":{source:"iana",charset:"UTF-8",compressible:!0,extensions:["webmanifest"]},"application/marc":{source:"iana",extensions:["mrc"]},"application/marcxml+xml":{source:"iana",compressible:!0,extensions:["mrcx"]},"application/mathematica":{source:"iana",extensions:["ma","nb","mb"]},"application/mathml+xml":{source:"iana",compressible:!0,extensions:["mathml"]},"application/mathml-content+xml":{source:"iana",compressible:!0},"application/mathml-presentation+xml":{source:"iana",compressible:!0},"application/mbms-associated-procedure-description+xml":{source:"iana",compressible:!0},"application/mbms-deregister+xml":{source:"iana",compressible:!0},"application/mbms-envelope+xml":{source:"iana",compressible:!0},"application/mbms-msk+xml":{source:"iana",compressible:!0},"application/mbms-msk-response+xml":{source:"iana",compressible:!0},"application/mbms-protection-description+xml":{source:"iana",compressible:!0},"application/mbms-reception-report+xml":{source:"iana",compressible:!0},"application/mbms-register+xml":{source:"iana",compressible:!0},"application/mbms-register-response+xml":{source:"iana",compressible:!0},"application/mbms-schedule+xml":{source:"iana",compressible:!0},"application/mbms-user-service-description+xml":{source:"iana",compressible:!0},"application/mbox":{source:"iana",extensions:["mbox"]},"application/media-policy-dataset+xml":{source:"iana",compressible:!0,extensions:["mpf"]},"application/media_control+xml":{source:"iana",compressible:!0},"application/mediaservercontrol+xml":{source:"iana",compressible:!0,extensions:["mscml"]},"application/merge-patch+json":{source:"iana",compressible:!0},"application/metalink+xml":{source:"apache",compressible:!0,extensions:["metalink"]},"application/metalink4+xml":{source:"iana",compressible:!0,extensions:["meta4"]},"application/mets+xml":{source:"iana",compressible:!0,extensions:["mets"]},"application/mf4":{source:"iana"},"application/mikey":{source:"iana"},"application/mipc":{source:"iana"},"application/missing-blocks+cbor-seq":{source:"iana"},"application/mmt-aei+xml":{source:"iana",compressible:!0,extensions:["maei"]},"application/mmt-usd+xml":{source:"iana",compressible:!0,extensions:["musd"]},"application/mods+xml":{source:"iana",compressible:!0,extensions:["mods"]},"application/moss-keys":{source:"iana"},"application/moss-signature":{source:"iana"},"application/mosskey-data":{source:"iana"},"application/mosskey-request":{source:"iana"},"application/mp21":{source:"iana",extensions:["m21","mp21"]},"application/mp4":{source:"iana",extensions:["mp4s","m4p"]},"application/mpeg4-generic":{source:"iana"},"application/mpeg4-iod":{source:"iana"},"application/mpeg4-iod-xmt":{source:"iana"},"application/mrb-consumer+xml":{source:"iana",compressible:!0},"application/mrb-publish+xml":{source:"iana",compressible:!0},"application/msc-ivr+xml":{source:"iana",charset:"UTF-8",compressible:!0},"application/msc-mixer+xml":{source:"iana",charset:"UTF-8",compressible:!0},"application/msword":{source:"iana",compressible:!1,extensions:["doc","dot"]},"application/mud+json":{source:"iana",compressible:!0},"application/multipart-core":{source:"iana"},"application/mxf":{source:"iana",extensions:["mxf"]},"application/n-quads":{source:"iana",extensions:["nq"]},"application/n-triples":{source:"iana",extensions:["nt"]},"application/nasdata":{source:"iana"},"application/news-checkgroups":{source:"iana",charset:"US-ASCII"},"application/news-groupinfo":{source:"iana",charset:"US-ASCII"},"application/news-transmission":{source:"iana"},"application/nlsml+xml":{source:"iana",compressible:!0},"application/node":{source:"iana",extensions:["cjs"]},"application/nss":{source:"iana"},"application/oauth-authz-req+jwt":{source:"iana"},"application/oblivious-dns-message":{source:"iana"},"application/ocsp-request":{source:"iana"},"application/ocsp-response":{source:"iana"},"application/octet-stream":{source:"iana",compressible:!1,extensions:["bin","dms","lrf","mar","so","dist","distz","pkg","bpk","dump","elc","deploy","exe","dll","deb","dmg","iso","img","msi","msp","msm","buffer"]},"application/oda":{source:"iana",extensions:["oda"]},"application/odm+xml":{source:"iana",compressible:!0},"application/odx":{source:"iana"},"application/oebps-package+xml":{source:"iana",compressible:!0,extensions:["opf"]},"application/ogg":{source:"iana",compressible:!1,extensions:["ogx"]},"application/omdoc+xml":{source:"apache",compressible:!0,extensions:["omdoc"]},"application/onenote":{source:"apache",extensions:["onetoc","onetoc2","onetmp","onepkg"]},"application/opc-nodeset+xml":{source:"iana",compressible:!0},"application/oscore":{source:"iana"},"application/oxps":{source:"iana",extensions:["oxps"]},"application/p21":{source:"iana"},"application/p21+zip":{source:"iana",compressible:!1},"application/p2p-overlay+xml":{source:"iana",compressible:!0,extensions:["relo"]},"application/parityfec":{source:"iana"},"application/passport":{source:"iana"},"application/patch-ops-error+xml":{source:"iana",compressible:!0,extensions:["xer"]},"application/pdf":{source:"iana",compressible:!1,extensions:["pdf"]},"application/pdx":{source:"iana"},"application/pem-certificate-chain":{source:"iana"},"application/pgp-encrypted":{source:"iana",compressible:!1,extensions:["pgp"]},"application/pgp-keys":{source:"iana",extensions:["asc"]},"application/pgp-signature":{source:"iana",extensions:["asc","sig"]},"application/pics-rules":{source:"apache",extensions:["prf"]},"application/pidf+xml":{source:"iana",charset:"UTF-8",compressible:!0},"application/pidf-diff+xml":{source:"iana",charset:"UTF-8",compressible:!0},"application/pkcs10":{source:"iana",extensions:["p10"]},"application/pkcs12":{source:"iana"},"application/pkcs7-mime":{source:"iana",extensions:["p7m","p7c"]},"application/pkcs7-signature":{source:"iana",extensions:["p7s"]},"application/pkcs8":{source:"iana",extensions:["p8"]},"application/pkcs8-encrypted":{source:"iana"},"application/pkix-attr-cert":{source:"iana",extensions:["ac"]},"application/pkix-cert":{source:"iana",extensions:["cer"]},"application/pkix-crl":{source:"iana",extensions:["crl"]},"application/pkix-pkipath":{source:"iana",extensions:["pkipath"]},"application/pkixcmp":{source:"iana",extensions:["pki"]},"application/pls+xml":{source:"iana",compressible:!0,extensions:["pls"]},"application/poc-settings+xml":{source:"iana",charset:"UTF-8",compressible:!0},"application/postscript":{source:"iana",compressible:!0,extensions:["ai","eps","ps"]},"application/ppsp-tracker+json":{source:"iana",compressible:!0},"application/problem+json":{source:"iana",compressible:!0},"application/problem+xml":{source:"iana",compressible:!0},"application/provenance+xml":{source:"iana",compressible:!0,extensions:["provx"]},"application/prs.alvestrand.titrax-sheet":{source:"iana"},"application/prs.cww":{source:"iana",extensions:["cww"]},"application/prs.cyn":{source:"iana",charset:"7-BIT"},"application/prs.hpub+zip":{source:"iana",compressible:!1},"application/prs.nprend":{source:"iana"},"application/prs.plucker":{source:"iana"},"application/prs.rdf-xml-crypt":{source:"iana"},"application/prs.xsf+xml":{source:"iana",compressible:!0},"application/pskc+xml":{source:"iana",compressible:!0,extensions:["pskcxml"]},"application/pvd+json":{source:"iana",compressible:!0},"application/qsig":{source:"iana"},"application/raml+yaml":{compressible:!0,extensions:["raml"]},"application/raptorfec":{source:"iana"},"application/rdap+json":{source:"iana",compressible:!0},"application/rdf+xml":{source:"iana",compressible:!0,extensions:["rdf","owl"]},"application/reginfo+xml":{source:"iana",compressible:!0,extensions:["rif"]},"application/relax-ng-compact-syntax":{source:"iana",extensions:["rnc"]},"application/remote-printing":{source:"iana"},"application/reputon+json":{source:"iana",compressible:!0},"application/resource-lists+xml":{source:"iana",compressible:!0,extensions:["rl"]},"application/resource-lists-diff+xml":{source:"iana",compressible:!0,extensions:["rld"]},"application/rfc+xml":{source:"iana",compressible:!0},"application/riscos":{source:"iana"},"application/rlmi+xml":{source:"iana",compressible:!0},"application/rls-services+xml":{source:"iana",compressible:!0,extensions:["rs"]},"application/route-apd+xml":{source:"iana",compressible:!0,extensions:["rapd"]},"application/route-s-tsid+xml":{source:"iana",compressible:!0,extensions:["sls"]},"application/route-usd+xml":{source:"iana",compressible:!0,extensions:["rusd"]},"application/rpki-ghostbusters":{source:"iana",extensions:["gbr"]},"application/rpki-manifest":{source:"iana",extensions:["mft"]},"application/rpki-publication":{source:"iana"},"application/rpki-roa":{source:"iana",extensions:["roa"]},"application/rpki-updown":{source:"iana"},"application/rsd+xml":{source:"apache",compressible:!0,extensions:["rsd"]},"application/rss+xml":{source:"apache",compressible:!0,extensions:["rss"]},"application/rtf":{source:"iana",compressible:!0,extensions:["rtf"]},"application/rtploopback":{source:"iana"},"application/rtx":{source:"iana"},"application/samlassertion+xml":{source:"iana",compressible:!0},"application/samlmetadata+xml":{source:"iana",compressible:!0},"application/sarif+json":{source:"iana",compressible:!0},"application/sarif-external-properties+json":{source:"iana",compressible:!0},"application/sbe":{source:"iana"},"application/sbml+xml":{source:"iana",compressible:!0,extensions:["sbml"]},"application/scaip+xml":{source:"iana",compressible:!0},"application/scim+json":{source:"iana",compressible:!0},"application/scvp-cv-request":{source:"iana",extensions:["scq"]},"application/scvp-cv-response":{source:"iana",extensions:["scs"]},"application/scvp-vp-request":{source:"iana",extensions:["spq"]},"application/scvp-vp-response":{source:"iana",extensions:["spp"]},"application/sdp":{source:"iana",extensions:["sdp"]},"application/secevent+jwt":{source:"iana"},"application/senml+cbor":{source:"iana"},"application/senml+json":{source:"iana",compressible:!0},"application/senml+xml":{source:"iana",compressible:!0,extensions:["senmlx"]},"application/senml-etch+cbor":{source:"iana"},"application/senml-etch+json":{source:"iana",compressible:!0},"application/senml-exi":{source:"iana"},"application/sensml+cbor":{source:"iana"},"application/sensml+json":{source:"iana",compressible:!0},"application/sensml+xml":{source:"iana",compressible:!0,extensions:["sensmlx"]},"application/sensml-exi":{source:"iana"},"application/sep+xml":{source:"iana",compressible:!0},"application/sep-exi":{source:"iana"},"application/session-info":{source:"iana"},"application/set-payment":{source:"iana"},"application/set-payment-initiation":{source:"iana",extensions:["setpay"]},"application/set-registration":{source:"iana"},"application/set-registration-initiation":{source:"iana",extensions:["setreg"]},"application/sgml":{source:"iana"},"application/sgml-open-catalog":{source:"iana"},"application/shf+xml":{source:"iana",compressible:!0,extensions:["shf"]},"application/sieve":{source:"iana",extensions:["siv","sieve"]},"application/simple-filter+xml":{source:"iana",compressible:!0},"application/simple-message-summary":{source:"iana"},"application/simplesymbolcontainer":{source:"iana"},"application/sipc":{source:"iana"},"application/slate":{source:"iana"},"application/smil":{source:"iana"},"application/smil+xml":{source:"iana",compressible:!0,extensions:["smi","smil"]},"application/smpte336m":{source:"iana"},"application/soap+fastinfoset":{source:"iana"},"application/soap+xml":{source:"iana",compressible:!0},"application/sparql-query":{source:"iana",extensions:["rq"]},"application/sparql-results+xml":{source:"iana",compressible:!0,extensions:["srx"]},"application/spdx+json":{source:"iana",compressible:!0},"application/spirits-event+xml":{source:"iana",compressible:!0},"application/sql":{source:"iana"},"application/srgs":{source:"iana",extensions:["gram"]},"application/srgs+xml":{source:"iana",compressible:!0,extensions:["grxml"]},"application/sru+xml":{source:"iana",compressible:!0,extensions:["sru"]},"application/ssdl+xml":{source:"apache",compressible:!0,extensions:["ssdl"]},"application/ssml+xml":{source:"iana",compressible:!0,extensions:["ssml"]},"application/stix+json":{source:"iana",compressible:!0},"application/swid+xml":{source:"iana",compressible:!0,extensions:["swidtag"]},"application/tamp-apex-update":{source:"iana"},"application/tamp-apex-update-confirm":{source:"iana"},"application/tamp-community-update":{source:"iana"},"application/tamp-community-update-confirm":{source:"iana"},"application/tamp-error":{source:"iana"},"application/tamp-sequence-adjust":{source:"iana"},"application/tamp-sequence-adjust-confirm":{source:"iana"},"application/tamp-status-query":{source:"iana"},"application/tamp-status-response":{source:"iana"},"application/tamp-update":{source:"iana"},"application/tamp-update-confirm":{source:"iana"},"application/tar":{compressible:!0},"application/taxii+json":{source:"iana",compressible:!0},"application/td+json":{source:"iana",compressible:!0},"application/tei+xml":{source:"iana",compressible:!0,extensions:["tei","teicorpus"]},"application/tetra_isi":{source:"iana"},"application/thraud+xml":{source:"iana",compressible:!0,extensions:["tfi"]},"application/timestamp-query":{source:"iana"},"application/timestamp-reply":{source:"iana"},"application/timestamped-data":{source:"iana",extensions:["tsd"]},"application/tlsrpt+gzip":{source:"iana"},"application/tlsrpt+json":{source:"iana",compressible:!0},"application/tnauthlist":{source:"iana"},"application/token-introspection+jwt":{source:"iana"},"application/toml":{compressible:!0,extensions:["toml"]},"application/trickle-ice-sdpfrag":{source:"iana"},"application/trig":{source:"iana",extensions:["trig"]},"application/ttml+xml":{source:"iana",compressible:!0,extensions:["ttml"]},"application/tve-trigger":{source:"iana"},"application/tzif":{source:"iana"},"application/tzif-leap":{source:"iana"},"application/ubjson":{compressible:!1,extensions:["ubj"]},"application/ulpfec":{source:"iana"},"application/urc-grpsheet+xml":{source:"iana",compressible:!0},"application/urc-ressheet+xml":{source:"iana",compressible:!0,extensions:["rsheet"]},"application/urc-targetdesc+xml":{source:"iana",compressible:!0,extensions:["td"]},"application/urc-uisocketdesc+xml":{source:"iana",compressible:!0},"application/vcard+json":{source:"iana",compressible:!0},"application/vcard+xml":{source:"iana",compressible:!0},"application/vemmi":{source:"iana"},"application/vividence.scriptfile":{source:"apache"},"application/vnd.1000minds.decision-model+xml":{source:"iana",compressible:!0,extensions:["1km"]},"application/vnd.3gpp-prose+xml":{source:"iana",compressible:!0},"application/vnd.3gpp-prose-pc3ch+xml":{source:"iana",compressible:!0},"application/vnd.3gpp-v2x-local-service-information":{source:"iana"},"application/vnd.3gpp.5gnas":{source:"iana"},"application/vnd.3gpp.access-transfer-events+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.bsf+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.gmop+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.gtpc":{source:"iana"},"application/vnd.3gpp.interworking-data":{source:"iana"},"application/vnd.3gpp.lpp":{source:"iana"},"application/vnd.3gpp.mc-signalling-ear":{source:"iana"},"application/vnd.3gpp.mcdata-affiliation-command+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.mcdata-info+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.mcdata-payload":{source:"iana"},"application/vnd.3gpp.mcdata-service-config+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.mcdata-signalling":{source:"iana"},"application/vnd.3gpp.mcdata-ue-config+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.mcdata-user-profile+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.mcptt-affiliation-command+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.mcptt-floor-request+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.mcptt-info+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.mcptt-location-info+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.mcptt-mbms-usage-info+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.mcptt-service-config+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.mcptt-signed+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.mcptt-ue-config+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.mcptt-ue-init-config+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.mcptt-user-profile+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.mcvideo-affiliation-command+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.mcvideo-affiliation-info+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.mcvideo-info+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.mcvideo-location-info+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.mcvideo-mbms-usage-info+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.mcvideo-service-config+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.mcvideo-transmission-request+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.mcvideo-ue-config+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.mcvideo-user-profile+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.mid-call+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.ngap":{source:"iana"},"application/vnd.3gpp.pfcp":{source:"iana"},"application/vnd.3gpp.pic-bw-large":{source:"iana",extensions:["plb"]},"application/vnd.3gpp.pic-bw-small":{source:"iana",extensions:["psb"]},"application/vnd.3gpp.pic-bw-var":{source:"iana",extensions:["pvb"]},"application/vnd.3gpp.s1ap":{source:"iana"},"application/vnd.3gpp.sms":{source:"iana"},"application/vnd.3gpp.sms+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.srvcc-ext+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.srvcc-info+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.state-and-event-info+xml":{source:"iana",compressible:!0},"application/vnd.3gpp.ussd+xml":{source:"iana",compressible:!0},"application/vnd.3gpp2.bcmcsinfo+xml":{source:"iana",compressible:!0},"application/vnd.3gpp2.sms":{source:"iana"},"application/vnd.3gpp2.tcap":{source:"iana",extensions:["tcap"]},"application/vnd.3lightssoftware.imagescal":{source:"iana"},"application/vnd.3m.post-it-notes":{source:"iana",extensions:["pwn"]},"application/vnd.accpac.simply.aso":{source:"iana",extensions:["aso"]},"application/vnd.accpac.simply.imp":{source:"iana",extensions:["imp"]},"application/vnd.acucobol":{source:"iana",extensions:["acu"]},"application/vnd.acucorp":{source:"iana",extensions:["atc","acutc"]},"application/vnd.adobe.air-application-installer-package+zip":{source:"apache",compressible:!1,extensions:["air"]},"application/vnd.adobe.flash.movie":{source:"iana"},"application/vnd.adobe.formscentral.fcdt":{source:"iana",extensions:["fcdt"]},"application/vnd.adobe.fxp":{source:"iana",extensions:["fxp","fxpl"]},"application/vnd.adobe.partial-upload":{source:"iana"},"application/vnd.adobe.xdp+xml":{source:"iana",compressible:!0,extensions:["xdp"]},"application/vnd.adobe.xfdf":{source:"iana",extensions:["xfdf"]},"application/vnd.aether.imp":{source:"iana"},"application/vnd.afpc.afplinedata":{source:"iana"},"application/vnd.afpc.afplinedata-pagedef":{source:"iana"},"application/vnd.afpc.cmoca-cmresource":{source:"iana"},"application/vnd.afpc.foca-charset":{source:"iana"},"application/vnd.afpc.foca-codedfont":{source:"iana"},"application/vnd.afpc.foca-codepage":{source:"iana"},"application/vnd.afpc.modca":{source:"iana"},"application/vnd.afpc.modca-cmtable":{source:"iana"},"application/vnd.afpc.modca-formdef":{source:"iana"},"application/vnd.afpc.modca-mediummap":{source:"iana"},"application/vnd.afpc.modca-objectcontainer":{source:"iana"},"application/vnd.afpc.modca-overlay":{source:"iana"},"application/vnd.afpc.modca-pagesegment":{source:"iana"},"application/vnd.age":{source:"iana",extensions:["age"]},"application/vnd.ah-barcode":{source:"iana"},"application/vnd.ahead.space":{source:"iana",extensions:["ahead"]},"application/vnd.airzip.filesecure.azf":{source:"iana",extensions:["azf"]},"application/vnd.airzip.filesecure.azs":{source:"iana",extensions:["azs"]},"application/vnd.amadeus+json":{source:"iana",compressible:!0},"application/vnd.amazon.ebook":{source:"apache",extensions:["azw"]},"application/vnd.amazon.mobi8-ebook":{source:"iana"},"application/vnd.americandynamics.acc":{source:"iana",extensions:["acc"]},"application/vnd.amiga.ami":{source:"iana",extensions:["ami"]},"application/vnd.amundsen.maze+xml":{source:"iana",compressible:!0},"application/vnd.android.ota":{source:"iana"},"application/vnd.android.package-archive":{source:"apache",compressible:!1,extensions:["apk"]},"application/vnd.anki":{source:"iana"},"application/vnd.anser-web-certificate-issue-initiation":{source:"iana",extensions:["cii"]},"application/vnd.anser-web-funds-transfer-initiation":{source:"apache",extensions:["fti"]},"application/vnd.antix.game-component":{source:"iana",extensions:["atx"]},"application/vnd.apache.arrow.file":{source:"iana"},"application/vnd.apache.arrow.stream":{source:"iana"},"application/vnd.apache.thrift.binary":{source:"iana"},"application/vnd.apache.thrift.compact":{source:"iana"},"application/vnd.apache.thrift.json":{source:"iana"},"application/vnd.api+json":{source:"iana",compressible:!0},"application/vnd.aplextor.warrp+json":{source:"iana",compressible:!0},"application/vnd.apothekende.reservation+json":{source:"iana",compressible:!0},"application/vnd.apple.installer+xml":{source:"iana",compressible:!0,extensions:["mpkg"]},"application/vnd.apple.keynote":{source:"iana",extensions:["key"]},"application/vnd.apple.mpegurl":{source:"iana",extensions:["m3u8"]},"application/vnd.apple.numbers":{source:"iana",extensions:["numbers"]},"application/vnd.apple.pages":{source:"iana",extensions:["pages"]},"application/vnd.apple.pkpass":{compressible:!1,extensions:["pkpass"]},"application/vnd.arastra.swi":{source:"iana"},"application/vnd.aristanetworks.swi":{source:"iana",extensions:["swi"]},"application/vnd.artisan+json":{source:"iana",compressible:!0},"application/vnd.artsquare":{source:"iana"},"application/vnd.astraea-software.iota":{source:"iana",extensions:["iota"]},"application/vnd.audiograph":{source:"iana",extensions:["aep"]},"application/vnd.autopackage":{source:"iana"},"application/vnd.avalon+json":{source:"iana",compressible:!0},"application/vnd.avistar+xml":{source:"iana",compressible:!0},"application/vnd.balsamiq.bmml+xml":{source:"iana",compressible:!0,extensions:["bmml"]},"application/vnd.balsamiq.bmpr":{source:"iana"},"application/vnd.banana-accounting":{source:"iana"},"application/vnd.bbf.usp.error":{source:"iana"},"application/vnd.bbf.usp.msg":{source:"iana"},"application/vnd.bbf.usp.msg+json":{source:"iana",compressible:!0},"application/vnd.bekitzur-stech+json":{source:"iana",compressible:!0},"application/vnd.bint.med-content":{source:"iana"},"application/vnd.biopax.rdf+xml":{source:"iana",compressible:!0},"application/vnd.blink-idb-value-wrapper":{source:"iana"},"application/vnd.blueice.multipass":{source:"iana",extensions:["mpm"]},"application/vnd.bluetooth.ep.oob":{source:"iana"},"application/vnd.bluetooth.le.oob":{source:"iana"},"application/vnd.bmi":{source:"iana",extensions:["bmi"]},"application/vnd.bpf":{source:"iana"},"application/vnd.bpf3":{source:"iana"},"application/vnd.businessobjects":{source:"iana",extensions:["rep"]},"application/vnd.byu.uapi+json":{source:"iana",compressible:!0},"application/vnd.cab-jscript":{source:"iana"},"application/vnd.canon-cpdl":{source:"iana"},"application/vnd.canon-lips":{source:"iana"},"application/vnd.capasystems-pg+json":{source:"iana",compressible:!0},"application/vnd.cendio.thinlinc.clientconf":{source:"iana"},"application/vnd.century-systems.tcp_stream":{source:"iana"},"application/vnd.chemdraw+xml":{source:"iana",compressible:!0,extensions:["cdxml"]},"application/vnd.chess-pgn":{source:"iana"},"application/vnd.chipnuts.karaoke-mmd":{source:"iana",extensions:["mmd"]},"application/vnd.ciedi":{source:"iana"},"application/vnd.cinderella":{source:"iana",extensions:["cdy"]},"application/vnd.cirpack.isdn-ext":{source:"iana"},"application/vnd.citationstyles.style+xml":{source:"iana",compressible:!0,extensions:["csl"]},"application/vnd.claymore":{source:"iana",extensions:["cla"]},"application/vnd.cloanto.rp9":{source:"iana",extensions:["rp9"]},"application/vnd.clonk.c4group":{source:"iana",extensions:["c4g","c4d","c4f","c4p","c4u"]},"application/vnd.cluetrust.cartomobile-config":{source:"iana",extensions:["c11amc"]},"application/vnd.cluetrust.cartomobile-config-pkg":{source:"iana",extensions:["c11amz"]},"application/vnd.coffeescript":{source:"iana"},"application/vnd.collabio.xodocuments.document":{source:"iana"},"application/vnd.collabio.xodocuments.document-template":{source:"iana"},"application/vnd.collabio.xodocuments.presentation":{source:"iana"},"application/vnd.collabio.xodocuments.presentation-template":{source:"iana"},"application/vnd.collabio.xodocuments.spreadsheet":{source:"iana"},"application/vnd.collabio.xodocuments.spreadsheet-template":{source:"iana"},"application/vnd.collection+json":{source:"iana",compressible:!0},"application/vnd.collection.doc+json":{source:"iana",compressible:!0},"application/vnd.collection.next+json":{source:"iana",compressible:!0},"application/vnd.comicbook+zip":{source:"iana",compressible:!1},"application/vnd.comicbook-rar":{source:"iana"},"application/vnd.commerce-battelle":{source:"iana"},"application/vnd.commonspace":{source:"iana",extensions:["csp"]},"application/vnd.contact.cmsg":{source:"iana",extensions:["cdbcmsg"]},"application/vnd.coreos.ignition+json":{source:"iana",compressible:!0},"application/vnd.cosmocaller":{source:"iana",extensions:["cmc"]},"application/vnd.crick.clicker":{source:"iana",extensions:["clkx"]},"application/vnd.crick.clicker.keyboard":{source:"iana",extensions:["clkk"]},"application/vnd.crick.clicker.palette":{source:"iana",extensions:["clkp"]},"application/vnd.crick.clicker.template":{source:"iana",extensions:["clkt"]},"application/vnd.crick.clicker.wordbank":{source:"iana",extensions:["clkw"]},"application/vnd.criticaltools.wbs+xml":{source:"iana",compressible:!0,extensions:["wbs"]},"application/vnd.cryptii.pipe+json":{source:"iana",compressible:!0},"application/vnd.crypto-shade-file":{source:"iana"},"application/vnd.cryptomator.encrypted":{source:"iana"},"application/vnd.cryptomator.vault":{source:"iana"},"application/vnd.ctc-posml":{source:"iana",extensions:["pml"]},"application/vnd.ctct.ws+xml":{source:"iana",compressible:!0},"application/vnd.cups-pdf":{source:"iana"},"application/vnd.cups-postscript":{source:"iana"},"application/vnd.cups-ppd":{source:"iana",extensions:["ppd"]},"application/vnd.cups-raster":{source:"iana"},"application/vnd.cups-raw":{source:"iana"},"application/vnd.curl":{source:"iana"},"application/vnd.curl.car":{source:"apache",extensions:["car"]},"application/vnd.curl.pcurl":{source:"apache",extensions:["pcurl"]},"application/vnd.cyan.dean.root+xml":{source:"iana",compressible:!0},"application/vnd.cybank":{source:"iana"},"application/vnd.cyclonedx+json":{source:"iana",compressible:!0},"application/vnd.cyclonedx+xml":{source:"iana",compressible:!0},"application/vnd.d2l.coursepackage1p0+zip":{source:"iana",compressible:!1},"application/vnd.d3m-dataset":{source:"iana"},"application/vnd.d3m-problem":{source:"iana"},"application/vnd.dart":{source:"iana",compressible:!0,extensions:["dart"]},"application/vnd.data-vision.rdz":{source:"iana",extensions:["rdz"]},"application/vnd.datapackage+json":{source:"iana",compressible:!0},"application/vnd.dataresource+json":{source:"iana",compressible:!0},"application/vnd.dbf":{source:"iana",extensions:["dbf"]},"application/vnd.debian.binary-package":{source:"iana"},"application/vnd.dece.data":{source:"iana",extensions:["uvf","uvvf","uvd","uvvd"]},"application/vnd.dece.ttml+xml":{source:"iana",compressible:!0,extensions:["uvt","uvvt"]},"application/vnd.dece.unspecified":{source:"iana",extensions:["uvx","uvvx"]},"application/vnd.dece.zip":{source:"iana",extensions:["uvz","uvvz"]},"application/vnd.denovo.fcselayout-link":{source:"iana",extensions:["fe_launch"]},"application/vnd.desmume.movie":{source:"iana"},"application/vnd.dir-bi.plate-dl-nosuffix":{source:"iana"},"application/vnd.dm.delegation+xml":{source:"iana",compressible:!0},"application/vnd.dna":{source:"iana",extensions:["dna"]},"application/vnd.document+json":{source:"iana",compressible:!0},"application/vnd.dolby.mlp":{source:"apache",extensions:["mlp"]},"application/vnd.dolby.mobile.1":{source:"iana"},"application/vnd.dolby.mobile.2":{source:"iana"},"application/vnd.doremir.scorecloud-binary-document":{source:"iana"},"application/vnd.dpgraph":{source:"iana",extensions:["dpg"]},"application/vnd.dreamfactory":{source:"iana",extensions:["dfac"]},"application/vnd.drive+json":{source:"iana",compressible:!0},"application/vnd.ds-keypoint":{source:"apache",extensions:["kpxx"]},"application/vnd.dtg.local":{source:"iana"},"application/vnd.dtg.local.flash":{source:"iana"},"application/vnd.dtg.local.html":{source:"iana"},"application/vnd.dvb.ait":{source:"iana",extensions:["ait"]},"application/vnd.dvb.dvbisl+xml":{source:"iana",compressible:!0},"application/vnd.dvb.dvbj":{source:"iana"},"application/vnd.dvb.esgcontainer":{source:"iana"},"application/vnd.dvb.ipdcdftnotifaccess":{source:"iana"},"application/vnd.dvb.ipdcesgaccess":{source:"iana"},"application/vnd.dvb.ipdcesgaccess2":{source:"iana"},"application/vnd.dvb.ipdcesgpdd":{source:"iana"},"application/vnd.dvb.ipdcroaming":{source:"iana"},"application/vnd.dvb.iptv.alfec-base":{source:"iana"},"application/vnd.dvb.iptv.alfec-enhancement":{source:"iana"},"application/vnd.dvb.notif-aggregate-root+xml":{source:"iana",compressible:!0},"application/vnd.dvb.notif-container+xml":{source:"iana",compressible:!0},"application/vnd.dvb.notif-generic+xml":{source:"iana",compressible:!0},"application/vnd.dvb.notif-ia-msglist+xml":{source:"iana",compressible:!0},"application/vnd.dvb.notif-ia-registration-request+xml":{source:"iana",compressible:!0},"application/vnd.dvb.notif-ia-registration-response+xml":{source:"iana",compressible:!0},"application/vnd.dvb.notif-init+xml":{source:"iana",compressible:!0},"application/vnd.dvb.pfr":{source:"iana"},"application/vnd.dvb.service":{source:"iana",extensions:["svc"]},"application/vnd.dxr":{source:"iana"},"application/vnd.dynageo":{source:"iana",extensions:["geo"]},"application/vnd.dzr":{source:"iana"},"application/vnd.easykaraoke.cdgdownload":{source:"iana"},"application/vnd.ecdis-update":{source:"iana"},"application/vnd.ecip.rlp":{source:"iana"},"application/vnd.eclipse.ditto+json":{source:"iana",compressible:!0},"application/vnd.ecowin.chart":{source:"iana",extensions:["mag"]},"application/vnd.ecowin.filerequest":{source:"iana"},"application/vnd.ecowin.fileupdate":{source:"iana"},"application/vnd.ecowin.series":{source:"iana"},"application/vnd.ecowin.seriesrequest":{source:"iana"},"application/vnd.ecowin.seriesupdate":{source:"iana"},"application/vnd.efi.img":{source:"iana"},"application/vnd.efi.iso":{source:"iana"},"application/vnd.emclient.accessrequest+xml":{source:"iana",compressible:!0},"application/vnd.enliven":{source:"iana",extensions:["nml"]},"application/vnd.enphase.envoy":{source:"iana"},"application/vnd.eprints.data+xml":{source:"iana",compressible:!0},"application/vnd.epson.esf":{source:"iana",extensions:["esf"]},"application/vnd.epson.msf":{source:"iana",extensions:["msf"]},"application/vnd.epson.quickanime":{source:"iana",extensions:["qam"]},"application/vnd.epson.salt":{source:"iana",extensions:["slt"]},"application/vnd.epson.ssf":{source:"iana",extensions:["ssf"]},"application/vnd.ericsson.quickcall":{source:"iana"},"application/vnd.espass-espass+zip":{source:"iana",compressible:!1},"application/vnd.eszigno3+xml":{source:"iana",compressible:!0,extensions:["es3","et3"]},"application/vnd.etsi.aoc+xml":{source:"iana",compressible:!0},"application/vnd.etsi.asic-e+zip":{source:"iana",compressible:!1},"application/vnd.etsi.asic-s+zip":{source:"iana",compressible:!1},"application/vnd.etsi.cug+xml":{source:"iana",compressible:!0},"application/vnd.etsi.iptvcommand+xml":{source:"iana",compressible:!0},"application/vnd.etsi.iptvdiscovery+xml":{source:"iana",compressible:!0},"application/vnd.etsi.iptvprofile+xml":{source:"iana",compressible:!0},"application/vnd.etsi.iptvsad-bc+xml":{source:"iana",compressible:!0},"application/vnd.etsi.iptvsad-cod+xml":{source:"iana",compressible:!0},"application/vnd.etsi.iptvsad-npvr+xml":{source:"iana",compressible:!0},"application/vnd.etsi.iptvservice+xml":{source:"iana",compressible:!0},"application/vnd.etsi.iptvsync+xml":{source:"iana",compressible:!0},"application/vnd.etsi.iptvueprofile+xml":{source:"iana",compressible:!0},"application/vnd.etsi.mcid+xml":{source:"iana",compressible:!0},"application/vnd.etsi.mheg5":{source:"iana"},"application/vnd.etsi.overload-control-policy-dataset+xml":{source:"iana",compressible:!0},"application/vnd.etsi.pstn+xml":{source:"iana",compressible:!0},"application/vnd.etsi.sci+xml":{source:"iana",compressible:!0},"application/vnd.etsi.simservs+xml":{source:"iana",compressible:!0},"application/vnd.etsi.timestamp-token":{source:"iana"},"application/vnd.etsi.tsl+xml":{source:"iana",compressible:!0},"application/vnd.etsi.tsl.der":{source:"iana"},"application/vnd.eu.kasparian.car+json":{source:"iana",compressible:!0},"application/vnd.eudora.data":{source:"iana"},"application/vnd.evolv.ecig.profile":{source:"iana"},"application/vnd.evolv.ecig.settings":{source:"iana"},"application/vnd.evolv.ecig.theme":{source:"iana"},"application/vnd.exstream-empower+zip":{source:"iana",compressible:!1},"application/vnd.exstream-package":{source:"iana"},"application/vnd.ezpix-album":{source:"iana",extensions:["ez2"]},"application/vnd.ezpix-package":{source:"iana",extensions:["ez3"]},"application/vnd.f-secure.mobile":{source:"iana"},"application/vnd.familysearch.gedcom+zip":{source:"iana",compressible:!1},"application/vnd.fastcopy-disk-image":{source:"iana"},"application/vnd.fdf":{source:"iana",extensions:["fdf"]},"application/vnd.fdsn.mseed":{source:"iana",extensions:["mseed"]},"application/vnd.fdsn.seed":{source:"iana",extensions:["seed","dataless"]},"application/vnd.ffsns":{source:"iana"},"application/vnd.ficlab.flb+zip":{source:"iana",compressible:!1},"application/vnd.filmit.zfc":{source:"iana"},"application/vnd.fints":{source:"iana"},"application/vnd.firemonkeys.cloudcell":{source:"iana"},"application/vnd.flographit":{source:"iana",extensions:["gph"]},"application/vnd.fluxtime.clip":{source:"iana",extensions:["ftc"]},"application/vnd.font-fontforge-sfd":{source:"iana"},"application/vnd.framemaker":{source:"iana",extensions:["fm","frame","maker","book"]},"application/vnd.frogans.fnc":{source:"iana",extensions:["fnc"]},"application/vnd.frogans.ltf":{source:"iana",extensions:["ltf"]},"application/vnd.fsc.weblaunch":{source:"iana",extensions:["fsc"]},"application/vnd.fujifilm.fb.docuworks":{source:"iana"},"application/vnd.fujifilm.fb.docuworks.binder":{source:"iana"},"application/vnd.fujifilm.fb.docuworks.container":{source:"iana"},"application/vnd.fujifilm.fb.jfi+xml":{source:"iana",compressible:!0},"application/vnd.fujitsu.oasys":{source:"iana",extensions:["oas"]},"application/vnd.fujitsu.oasys2":{source:"iana",extensions:["oa2"]},"application/vnd.fujitsu.oasys3":{source:"iana",extensions:["oa3"]},"application/vnd.fujitsu.oasysgp":{source:"iana",extensions:["fg5"]},"application/vnd.fujitsu.oasysprs":{source:"iana",extensions:["bh2"]},"application/vnd.fujixerox.art-ex":{source:"iana"},"application/vnd.fujixerox.art4":{source:"iana"},"application/vnd.fujixerox.ddd":{source:"iana",extensions:["ddd"]},"application/vnd.fujixerox.docuworks":{source:"iana",extensions:["xdw"]},"application/vnd.fujixerox.docuworks.binder":{source:"iana",extensions:["xbd"]},"application/vnd.fujixerox.docuworks.container":{source:"iana"},"application/vnd.fujixerox.hbpl":{source:"iana"},"application/vnd.fut-misnet":{source:"iana"},"application/vnd.futoin+cbor":{source:"iana"},"application/vnd.futoin+json":{source:"iana",compressible:!0},"application/vnd.fuzzysheet":{source:"iana",extensions:["fzs"]},"application/vnd.genomatix.tuxedo":{source:"iana",extensions:["txd"]},"application/vnd.gentics.grd+json":{source:"iana",compressible:!0},"application/vnd.geo+json":{source:"iana",compressible:!0},"application/vnd.geocube+xml":{source:"iana",compressible:!0},"application/vnd.geogebra.file":{source:"iana",extensions:["ggb"]},"application/vnd.geogebra.slides":{source:"iana"},"application/vnd.geogebra.tool":{source:"iana",extensions:["ggt"]},"application/vnd.geometry-explorer":{source:"iana",extensions:["gex","gre"]},"application/vnd.geonext":{source:"iana",extensions:["gxt"]},"application/vnd.geoplan":{source:"iana",extensions:["g2w"]},"application/vnd.geospace":{source:"iana",extensions:["g3w"]},"application/vnd.gerber":{source:"iana"},"application/vnd.globalplatform.card-content-mgt":{source:"iana"},"application/vnd.globalplatform.card-content-mgt-response":{source:"iana"},"application/vnd.gmx":{source:"iana",extensions:["gmx"]},"application/vnd.google-apps.document":{compressible:!1,extensions:["gdoc"]},"application/vnd.google-apps.presentation":{compressible:!1,extensions:["gslides"]},"application/vnd.google-apps.spreadsheet":{compressible:!1,extensions:["gsheet"]},"application/vnd.google-earth.kml+xml":{source:"iana",compressible:!0,extensions:["kml"]},"application/vnd.google-earth.kmz":{source:"iana",compressible:!1,extensions:["kmz"]},"application/vnd.gov.sk.e-form+xml":{source:"iana",compressible:!0},"application/vnd.gov.sk.e-form+zip":{source:"iana",compressible:!1},"application/vnd.gov.sk.xmldatacontainer+xml":{source:"iana",compressible:!0},"application/vnd.grafeq":{source:"iana",extensions:["gqf","gqs"]},"application/vnd.gridmp":{source:"iana"},"application/vnd.groove-account":{source:"iana",extensions:["gac"]},"application/vnd.groove-help":{source:"iana",extensions:["ghf"]},"application/vnd.groove-identity-message":{source:"iana",extensions:["gim"]},"application/vnd.groove-injector":{source:"iana",extensions:["grv"]},"application/vnd.groove-tool-message":{source:"iana",extensions:["gtm"]},"application/vnd.groove-tool-template":{source:"iana",extensions:["tpl"]},"application/vnd.groove-vcard":{source:"iana",extensions:["vcg"]},"application/vnd.hal+json":{source:"iana",compressible:!0},"application/vnd.hal+xml":{source:"iana",compressible:!0,extensions:["hal"]},"application/vnd.handheld-entertainment+xml":{source:"iana",compressible:!0,extensions:["zmm"]},"application/vnd.hbci":{source:"iana",extensions:["hbci"]},"application/vnd.hc+json":{source:"iana",compressible:!0},"application/vnd.hcl-bireports":{source:"iana"},"application/vnd.hdt":{source:"iana"},"application/vnd.heroku+json":{source:"iana",compressible:!0},"application/vnd.hhe.lesson-player":{source:"iana",extensions:["les"]},"application/vnd.hl7cda+xml":{source:"iana",charset:"UTF-8",compressible:!0},"application/vnd.hl7v2+xml":{source:"iana",charset:"UTF-8",compressible:!0},"application/vnd.hp-hpgl":{source:"iana",extensions:["hpgl"]},"application/vnd.hp-hpid":{source:"iana",extensions:["hpid"]},"application/vnd.hp-hps":{source:"iana",extensions:["hps"]},"application/vnd.hp-jlyt":{source:"iana",extensions:["jlt"]},"application/vnd.hp-pcl":{source:"iana",extensions:["pcl"]},"application/vnd.hp-pclxl":{source:"iana",extensions:["pclxl"]},"application/vnd.httphone":{source:"iana"},"application/vnd.hydrostatix.sof-data":{source:"iana",extensions:["sfd-hdstx"]},"application/vnd.hyper+json":{source:"iana",compressible:!0},"application/vnd.hyper-item+json":{source:"iana",compressible:!0},"application/vnd.hyperdrive+json":{source:"iana",compressible:!0},"application/vnd.hzn-3d-crossword":{source:"iana"},"application/vnd.ibm.afplinedata":{source:"iana"},"application/vnd.ibm.electronic-media":{source:"iana"},"application/vnd.ibm.minipay":{source:"iana",extensions:["mpy"]},"application/vnd.ibm.modcap":{source:"iana",extensions:["afp","listafp","list3820"]},"application/vnd.ibm.rights-management":{source:"iana",extensions:["irm"]},"application/vnd.ibm.secure-container":{source:"iana",extensions:["sc"]},"application/vnd.iccprofile":{source:"iana",extensions:["icc","icm"]},"application/vnd.ieee.1905":{source:"iana"},"application/vnd.igloader":{source:"iana",extensions:["igl"]},"application/vnd.imagemeter.folder+zip":{source:"iana",compressible:!1},"application/vnd.imagemeter.image+zip":{source:"iana",compressible:!1},"application/vnd.immervision-ivp":{source:"iana",extensions:["ivp"]},"application/vnd.immervision-ivu":{source:"iana",extensions:["ivu"]},"application/vnd.ims.imsccv1p1":{source:"iana"},"application/vnd.ims.imsccv1p2":{source:"iana"},"application/vnd.ims.imsccv1p3":{source:"iana"},"application/vnd.ims.lis.v2.result+json":{source:"iana",compressible:!0},"application/vnd.ims.lti.v2.toolconsumerprofile+json":{source:"iana",compressible:!0},"application/vnd.ims.lti.v2.toolproxy+json":{source:"iana",compressible:!0},"application/vnd.ims.lti.v2.toolproxy.id+json":{source:"iana",compressible:!0},"application/vnd.ims.lti.v2.toolsettings+json":{source:"iana",compressible:!0},"application/vnd.ims.lti.v2.toolsettings.simple+json":{source:"iana",compressible:!0},"application/vnd.informedcontrol.rms+xml":{source:"iana",compressible:!0},"application/vnd.informix-visionary":{source:"iana"},"application/vnd.infotech.project":{source:"iana"},"application/vnd.infotech.project+xml":{source:"iana",compressible:!0},"application/vnd.innopath.wamp.notification":{source:"iana"},"application/vnd.insors.igm":{source:"iana",extensions:["igm"]},"application/vnd.intercon.formnet":{source:"iana",extensions:["xpw","xpx"]},"application/vnd.intergeo":{source:"iana",extensions:["i2g"]},"application/vnd.intertrust.digibox":{source:"iana"},"application/vnd.intertrust.nncp":{source:"iana"},"application/vnd.intu.qbo":{source:"iana",extensions:["qbo"]},"application/vnd.intu.qfx":{source:"iana",extensions:["qfx"]},"application/vnd.iptc.g2.catalogitem+xml":{source:"iana",compressible:!0},"application/vnd.iptc.g2.conceptitem+xml":{source:"iana",compressible:!0},"application/vnd.iptc.g2.knowledgeitem+xml":{source:"iana",compressible:!0},"application/vnd.iptc.g2.newsitem+xml":{source:"iana",compressible:!0},"application/vnd.iptc.g2.newsmessage+xml":{source:"iana",compressible:!0},"application/vnd.iptc.g2.packageitem+xml":{source:"iana",compressible:!0},"application/vnd.iptc.g2.planningitem+xml":{source:"iana",compressible:!0},"application/vnd.ipunplugged.rcprofile":{source:"iana",extensions:["rcprofile"]},"application/vnd.irepository.package+xml":{source:"iana",compressible:!0,extensions:["irp"]},"application/vnd.is-xpr":{source:"iana",extensions:["xpr"]},"application/vnd.isac.fcs":{source:"iana",extensions:["fcs"]},"application/vnd.iso11783-10+zip":{source:"iana",compressible:!1},"application/vnd.jam":{source:"iana",extensions:["jam"]},"application/vnd.japannet-directory-service":{source:"iana"},"application/vnd.japannet-jpnstore-wakeup":{source:"iana"},"application/vnd.japannet-payment-wakeup":{source:"iana"},"application/vnd.japannet-registration":{source:"iana"},"application/vnd.japannet-registration-wakeup":{source:"iana"},"application/vnd.japannet-setstore-wakeup":{source:"iana"},"application/vnd.japannet-verification":{source:"iana"},"application/vnd.japannet-verification-wakeup":{source:"iana"},"application/vnd.jcp.javame.midlet-rms":{source:"iana",extensions:["rms"]},"application/vnd.jisp":{source:"iana",extensions:["jisp"]},"application/vnd.joost.joda-archive":{source:"iana",extensions:["joda"]},"application/vnd.jsk.isdn-ngn":{source:"iana"},"application/vnd.kahootz":{source:"iana",extensions:["ktz","ktr"]},"application/vnd.kde.karbon":{source:"iana",extensions:["karbon"]},"application/vnd.kde.kchart":{source:"iana",extensions:["chrt"]},"application/vnd.kde.kformula":{source:"iana",extensions:["kfo"]},"application/vnd.kde.kivio":{source:"iana",extensions:["flw"]},"application/vnd.kde.kontour":{source:"iana",extensions:["kon"]},"application/vnd.kde.kpresenter":{source:"iana",extensions:["kpr","kpt"]},"application/vnd.kde.kspread":{source:"iana",extensions:["ksp"]},"application/vnd.kde.kword":{source:"iana",extensions:["kwd","kwt"]},"application/vnd.kenameaapp":{source:"iana",extensions:["htke"]},"application/vnd.kidspiration":{source:"iana",extensions:["kia"]},"application/vnd.kinar":{source:"iana",extensions:["kne","knp"]},"application/vnd.koan":{source:"iana",extensions:["skp","skd","skt","skm"]},"application/vnd.kodak-descriptor":{source:"iana",extensions:["sse"]},"application/vnd.las":{source:"iana"},"application/vnd.las.las+json":{source:"iana",compressible:!0},"application/vnd.las.las+xml":{source:"iana",compressible:!0,extensions:["lasxml"]},"application/vnd.laszip":{source:"iana"},"application/vnd.leap+json":{source:"iana",compressible:!0},"application/vnd.liberty-request+xml":{source:"iana",compressible:!0},"application/vnd.llamagraphics.life-balance.desktop":{source:"iana",extensions:["lbd"]},"application/vnd.llamagraphics.life-balance.exchange+xml":{source:"iana",compressible:!0,extensions:["lbe"]},"application/vnd.logipipe.circuit+zip":{source:"iana",compressible:!1},"application/vnd.loom":{source:"iana"},"application/vnd.lotus-1-2-3":{source:"iana",extensions:["123"]},"application/vnd.lotus-approach":{source:"iana",extensions:["apr"]},"application/vnd.lotus-freelance":{source:"iana",extensions:["pre"]},"application/vnd.lotus-notes":{source:"iana",extensions:["nsf"]},"application/vnd.lotus-organizer":{source:"iana",extensions:["org"]},"application/vnd.lotus-screencam":{source:"iana",extensions:["scm"]},"application/vnd.lotus-wordpro":{source:"iana",extensions:["lwp"]},"application/vnd.macports.portpkg":{source:"iana",extensions:["portpkg"]},"application/vnd.mapbox-vector-tile":{source:"iana",extensions:["mvt"]},"application/vnd.marlin.drm.actiontoken+xml":{source:"iana",compressible:!0},"application/vnd.marlin.drm.conftoken+xml":{source:"iana",compressible:!0},"application/vnd.marlin.drm.license+xml":{source:"iana",compressible:!0},"application/vnd.marlin.drm.mdcf":{source:"iana"},"application/vnd.mason+json":{source:"iana",compressible:!0},"application/vnd.maxar.archive.3tz+zip":{source:"iana",compressible:!1},"application/vnd.maxmind.maxmind-db":{source:"iana"},"application/vnd.mcd":{source:"iana",extensions:["mcd"]},"application/vnd.medcalcdata":{source:"iana",extensions:["mc1"]},"application/vnd.mediastation.cdkey":{source:"iana",extensions:["cdkey"]},"application/vnd.meridian-slingshot":{source:"iana"},"application/vnd.mfer":{source:"iana",extensions:["mwf"]},"application/vnd.mfmp":{source:"iana",extensions:["mfm"]},"application/vnd.micro+json":{source:"iana",compressible:!0},"application/vnd.micrografx.flo":{source:"iana",extensions:["flo"]},"application/vnd.micrografx.igx":{source:"iana",extensions:["igx"]},"application/vnd.microsoft.portable-executable":{source:"iana"},"application/vnd.microsoft.windows.thumbnail-cache":{source:"iana"},"application/vnd.miele+json":{source:"iana",compressible:!0},"application/vnd.mif":{source:"iana",extensions:["mif"]},"application/vnd.minisoft-hp3000-save":{source:"iana"},"application/vnd.mitsubishi.misty-guard.trustweb":{source:"iana"},"application/vnd.mobius.daf":{source:"iana",extensions:["daf"]},"application/vnd.mobius.dis":{source:"iana",extensions:["dis"]},"application/vnd.mobius.mbk":{source:"iana",extensions:["mbk"]},"application/vnd.mobius.mqy":{source:"iana",extensions:["mqy"]},"application/vnd.mobius.msl":{source:"iana",extensions:["msl"]},"application/vnd.mobius.plc":{source:"iana",extensions:["plc"]},"application/vnd.mobius.txf":{source:"iana",extensions:["txf"]},"application/vnd.mophun.application":{source:"iana",extensions:["mpn"]},"application/vnd.mophun.certificate":{source:"iana",extensions:["mpc"]},"application/vnd.motorola.flexsuite":{source:"iana"},"application/vnd.motorola.flexsuite.adsi":{source:"iana"},"application/vnd.motorola.flexsuite.fis":{source:"iana"},"application/vnd.motorola.flexsuite.gotap":{source:"iana"},"application/vnd.motorola.flexsuite.kmr":{source:"iana"},"application/vnd.motorola.flexsuite.ttc":{source:"iana"},"application/vnd.motorola.flexsuite.wem":{source:"iana"},"application/vnd.motorola.iprm":{source:"iana"},"application/vnd.mozilla.xul+xml":{source:"iana",compressible:!0,extensions:["xul"]},"application/vnd.ms-3mfdocument":{source:"iana"},"application/vnd.ms-artgalry":{source:"iana",extensions:["cil"]},"application/vnd.ms-asf":{source:"iana"},"application/vnd.ms-cab-compressed":{source:"iana",extensions:["cab"]},"application/vnd.ms-color.iccprofile":{source:"apache"},"application/vnd.ms-excel":{source:"iana",compressible:!1,extensions:["xls","xlm","xla","xlc","xlt","xlw"]},"application/vnd.ms-excel.addin.macroenabled.12":{source:"iana",extensions:["xlam"]},"application/vnd.ms-excel.sheet.binary.macroenabled.12":{source:"iana",extensions:["xlsb"]},"application/vnd.ms-excel.sheet.macroenabled.12":{source:"iana",extensions:["xlsm"]},"application/vnd.ms-excel.template.macroenabled.12":{source:"iana",extensions:["xltm"]},"application/vnd.ms-fontobject":{source:"iana",compressible:!0,extensions:["eot"]},"application/vnd.ms-htmlhelp":{source:"iana",extensions:["chm"]},"application/vnd.ms-ims":{source:"iana",extensions:["ims"]},"application/vnd.ms-lrm":{source:"iana",extensions:["lrm"]},"application/vnd.ms-office.activex+xml":{source:"iana",compressible:!0},"application/vnd.ms-officetheme":{source:"iana",extensions:["thmx"]},"application/vnd.ms-opentype":{source:"apache",compressible:!0},"application/vnd.ms-outlook":{compressible:!1,extensions:["msg"]},"application/vnd.ms-package.obfuscated-opentype":{source:"apache"},"application/vnd.ms-pki.seccat":{source:"apache",extensions:["cat"]},"application/vnd.ms-pki.stl":{source:"apache",extensions:["stl"]},"application/vnd.ms-playready.initiator+xml":{source:"iana",compressible:!0},"application/vnd.ms-powerpoint":{source:"iana",compressible:!1,extensions:["ppt","pps","pot"]},"application/vnd.ms-powerpoint.addin.macroenabled.12":{source:"iana",extensions:["ppam"]},"application/vnd.ms-powerpoint.presentation.macroenabled.12":{source:"iana",extensions:["pptm"]},"application/vnd.ms-powerpoint.slide.macroenabled.12":{source:"iana",extensions:["sldm"]},"application/vnd.ms-powerpoint.slideshow.macroenabled.12":{source:"iana",extensions:["ppsm"]},"application/vnd.ms-powerpoint.template.macroenabled.12":{source:"iana",extensions:["potm"]},"application/vnd.ms-printdevicecapabilities+xml":{source:"iana",compressible:!0},"application/vnd.ms-printing.printticket+xml":{source:"apache",compressible:!0},"application/vnd.ms-printschematicket+xml":{source:"iana",compressible:!0},"application/vnd.ms-project":{source:"iana",extensions:["mpp","mpt"]},"application/vnd.ms-tnef":{source:"iana"},"application/vnd.ms-windows.devicepairing":{source:"iana"},"application/vnd.ms-windows.nwprinting.oob":{source:"iana"},"application/vnd.ms-windows.printerpairing":{source:"iana"},"application/vnd.ms-windows.wsd.oob":{source:"iana"},"application/vnd.ms-wmdrm.lic-chlg-req":{source:"iana"},"application/vnd.ms-wmdrm.lic-resp":{source:"iana"},"application/vnd.ms-wmdrm.meter-chlg-req":{source:"iana"},"application/vnd.ms-wmdrm.meter-resp":{source:"iana"},"application/vnd.ms-word.document.macroenabled.12":{source:"iana",extensions:["docm"]},"application/vnd.ms-word.template.macroenabled.12":{source:"iana",extensions:["dotm"]},"application/vnd.ms-works":{source:"iana",extensions:["wps","wks","wcm","wdb"]},"application/vnd.ms-wpl":{source:"iana",extensions:["wpl"]},"application/vnd.ms-xpsdocument":{source:"iana",compressible:!1,extensions:["xps"]},"application/vnd.msa-disk-image":{source:"iana"},"application/vnd.mseq":{source:"iana",extensions:["mseq"]},"application/vnd.msign":{source:"iana"},"application/vnd.multiad.creator":{source:"iana"},"application/vnd.multiad.creator.cif":{source:"iana"},"application/vnd.music-niff":{source:"iana"},"application/vnd.musician":{source:"iana",extensions:["mus"]},"application/vnd.muvee.style":{source:"iana",extensions:["msty"]},"application/vnd.mynfc":{source:"iana",extensions:["taglet"]},"application/vnd.nacamar.ybrid+json":{source:"iana",compressible:!0},"application/vnd.ncd.control":{source:"iana"},"application/vnd.ncd.reference":{source:"iana"},"application/vnd.nearst.inv+json":{source:"iana",compressible:!0},"application/vnd.nebumind.line":{source:"iana"},"application/vnd.nervana":{source:"iana"},"application/vnd.netfpx":{source:"iana"},"application/vnd.neurolanguage.nlu":{source:"iana",extensions:["nlu"]},"application/vnd.nimn":{source:"iana"},"application/vnd.nintendo.nitro.rom":{source:"iana"},"application/vnd.nintendo.snes.rom":{source:"iana"},"application/vnd.nitf":{source:"iana",extensions:["ntf","nitf"]},"application/vnd.noblenet-directory":{source:"iana",extensions:["nnd"]},"application/vnd.noblenet-sealer":{source:"iana",extensions:["nns"]},"application/vnd.noblenet-web":{source:"iana",extensions:["nnw"]},"application/vnd.nokia.catalogs":{source:"iana"},"application/vnd.nokia.conml+wbxml":{source:"iana"},"application/vnd.nokia.conml+xml":{source:"iana",compressible:!0},"application/vnd.nokia.iptv.config+xml":{source:"iana",compressible:!0},"application/vnd.nokia.isds-radio-presets":{source:"iana"},"application/vnd.nokia.landmark+wbxml":{source:"iana"},"application/vnd.nokia.landmark+xml":{source:"iana",compressible:!0},"application/vnd.nokia.landmarkcollection+xml":{source:"iana",compressible:!0},"application/vnd.nokia.n-gage.ac+xml":{source:"iana",compressible:!0,extensions:["ac"]},"application/vnd.nokia.n-gage.data":{source:"iana",extensions:["ngdat"]},"application/vnd.nokia.n-gage.symbian.install":{source:"iana",extensions:["n-gage"]},"application/vnd.nokia.ncd":{source:"iana"},"application/vnd.nokia.pcd+wbxml":{source:"iana"},"application/vnd.nokia.pcd+xml":{source:"iana",compressible:!0},"application/vnd.nokia.radio-preset":{source:"iana",extensions:["rpst"]},"application/vnd.nokia.radio-presets":{source:"iana",extensions:["rpss"]},"application/vnd.novadigm.edm":{source:"iana",extensions:["edm"]},"application/vnd.novadigm.edx":{source:"iana",extensions:["edx"]},"application/vnd.novadigm.ext":{source:"iana",extensions:["ext"]},"application/vnd.ntt-local.content-share":{source:"iana"},"application/vnd.ntt-local.file-transfer":{source:"iana"},"application/vnd.ntt-local.ogw_remote-access":{source:"iana"},"application/vnd.ntt-local.sip-ta_remote":{source:"iana"},"application/vnd.ntt-local.sip-ta_tcp_stream":{source:"iana"},"application/vnd.oasis.opendocument.chart":{source:"iana",extensions:["odc"]},"application/vnd.oasis.opendocument.chart-template":{source:"iana",extensions:["otc"]},"application/vnd.oasis.opendocument.database":{source:"iana",extensions:["odb"]},"application/vnd.oasis.opendocument.formula":{source:"iana",extensions:["odf"]},"application/vnd.oasis.opendocument.formula-template":{source:"iana",extensions:["odft"]},"application/vnd.oasis.opendocument.graphics":{source:"iana",compressible:!1,extensions:["odg"]},"application/vnd.oasis.opendocument.graphics-template":{source:"iana",extensions:["otg"]},"application/vnd.oasis.opendocument.image":{source:"iana",extensions:["odi"]},"application/vnd.oasis.opendocument.image-template":{source:"iana",extensions:["oti"]},"application/vnd.oasis.opendocument.presentation":{source:"iana",compressible:!1,extensions:["odp"]},"application/vnd.oasis.opendocument.presentation-template":{source:"iana",extensions:["otp"]},"application/vnd.oasis.opendocument.spreadsheet":{source:"iana",compressible:!1,extensions:["ods"]},"application/vnd.oasis.opendocument.spreadsheet-template":{source:"iana",extensions:["ots"]},"application/vnd.oasis.opendocument.text":{source:"iana",compressible:!1,extensions:["odt"]},"application/vnd.oasis.opendocument.text-master":{source:"iana",extensions:["odm"]},"application/vnd.oasis.opendocument.text-template":{source:"iana",extensions:["ott"]},"application/vnd.oasis.opendocument.text-web":{source:"iana",extensions:["oth"]},"application/vnd.obn":{source:"iana"},"application/vnd.ocf+cbor":{source:"iana"},"application/vnd.oci.image.manifest.v1+json":{source:"iana",compressible:!0},"application/vnd.oftn.l10n+json":{source:"iana",compressible:!0},"application/vnd.oipf.contentaccessdownload+xml":{source:"iana",compressible:!0},"application/vnd.oipf.contentaccessstreaming+xml":{source:"iana",compressible:!0},"application/vnd.oipf.cspg-hexbinary":{source:"iana"},"application/vnd.oipf.dae.svg+xml":{source:"iana",compressible:!0},"application/vnd.oipf.dae.xhtml+xml":{source:"iana",compressible:!0},"application/vnd.oipf.mippvcontrolmessage+xml":{source:"iana",compressible:!0},"application/vnd.oipf.pae.gem":{source:"iana"},"application/vnd.oipf.spdiscovery+xml":{source:"iana",compressible:!0},"application/vnd.oipf.spdlist+xml":{source:"iana",compressible:!0},"application/vnd.oipf.ueprofile+xml":{source:"iana",compressible:!0},"application/vnd.oipf.userprofile+xml":{source:"iana",compressible:!0},"application/vnd.olpc-sugar":{source:"iana",extensions:["xo"]},"application/vnd.oma-scws-config":{source:"iana"},"application/vnd.oma-scws-http-request":{source:"iana"},"application/vnd.oma-scws-http-response":{source:"iana"},"application/vnd.oma.bcast.associated-procedure-parameter+xml":{source:"iana",compressible:!0},"application/vnd.oma.bcast.drm-trigger+xml":{source:"iana",compressible:!0},"application/vnd.oma.bcast.imd+xml":{source:"iana",compressible:!0},"application/vnd.oma.bcast.ltkm":{source:"iana"},"application/vnd.oma.bcast.notification+xml":{source:"iana",compressible:!0},"application/vnd.oma.bcast.provisioningtrigger":{source:"iana"},"application/vnd.oma.bcast.sgboot":{source:"iana"},"application/vnd.oma.bcast.sgdd+xml":{source:"iana",compressible:!0},"application/vnd.oma.bcast.sgdu":{source:"iana"},"application/vnd.oma.bcast.simple-symbol-container":{source:"iana"},"application/vnd.oma.bcast.smartcard-trigger+xml":{source:"iana",compressible:!0},"application/vnd.oma.bcast.sprov+xml":{source:"iana",compressible:!0},"application/vnd.oma.bcast.stkm":{source:"iana"},"application/vnd.oma.cab-address-book+xml":{source:"iana",compressible:!0},"application/vnd.oma.cab-feature-handler+xml":{source:"iana",compressible:!0},"application/vnd.oma.cab-pcc+xml":{source:"iana",compressible:!0},"application/vnd.oma.cab-subs-invite+xml":{source:"iana",compressible:!0},"application/vnd.oma.cab-user-prefs+xml":{source:"iana",compressible:!0},"application/vnd.oma.dcd":{source:"iana"},"application/vnd.oma.dcdc":{source:"iana"},"application/vnd.oma.dd2+xml":{source:"iana",compressible:!0,extensions:["dd2"]},"application/vnd.oma.drm.risd+xml":{source:"iana",compressible:!0},"application/vnd.oma.group-usage-list+xml":{source:"iana",compressible:!0},"application/vnd.oma.lwm2m+cbor":{source:"iana"},"application/vnd.oma.lwm2m+json":{source:"iana",compressible:!0},"application/vnd.oma.lwm2m+tlv":{source:"iana"},"application/vnd.oma.pal+xml":{source:"iana",compressible:!0},"application/vnd.oma.poc.detailed-progress-report+xml":{source:"iana",compressible:!0},"application/vnd.oma.poc.final-report+xml":{source:"iana",compressible:!0},"application/vnd.oma.poc.groups+xml":{source:"iana",compressible:!0},"application/vnd.oma.poc.invocation-descriptor+xml":{source:"iana",compressible:!0},"application/vnd.oma.poc.optimized-progress-report+xml":{source:"iana",compressible:!0},"application/vnd.oma.push":{source:"iana"},"application/vnd.oma.scidm.messages+xml":{source:"iana",compressible:!0},"application/vnd.oma.xcap-directory+xml":{source:"iana",compressible:!0},"application/vnd.omads-email+xml":{source:"iana",charset:"UTF-8",compressible:!0},"application/vnd.omads-file+xml":{source:"iana",charset:"UTF-8",compressible:!0},"application/vnd.omads-folder+xml":{source:"iana",charset:"UTF-8",compressible:!0},"application/vnd.omaloc-supl-init":{source:"iana"},"application/vnd.onepager":{source:"iana"},"application/vnd.onepagertamp":{source:"iana"},"application/vnd.onepagertamx":{source:"iana"},"application/vnd.onepagertat":{source:"iana"},"application/vnd.onepagertatp":{source:"iana"},"application/vnd.onepagertatx":{source:"iana"},"application/vnd.openblox.game+xml":{source:"iana",compressible:!0,extensions:["obgx"]},"application/vnd.openblox.game-binary":{source:"iana"},"application/vnd.openeye.oeb":{source:"iana"},"application/vnd.openofficeorg.extension":{source:"apache",extensions:["oxt"]},"application/vnd.openstreetmap.data+xml":{source:"iana",compressible:!0,extensions:["osm"]},"application/vnd.opentimestamps.ots":{source:"iana"},"application/vnd.openxmlformats-officedocument.custom-properties+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.customxmlproperties+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.drawing+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.drawingml.chart+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.drawingml.chartshapes+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.drawingml.diagramcolors+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.drawingml.diagramdata+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.drawingml.diagramlayout+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.drawingml.diagramstyle+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.extended-properties+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.presentationml.commentauthors+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.presentationml.comments+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.presentationml.handoutmaster+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.presentationml.notesmaster+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.presentationml.notesslide+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.presentationml.presentation":{source:"iana",compressible:!1,extensions:["pptx"]},"application/vnd.openxmlformats-officedocument.presentationml.presentation.main+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.presentationml.presprops+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.presentationml.slide":{source:"iana",extensions:["sldx"]},"application/vnd.openxmlformats-officedocument.presentationml.slide+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.presentationml.slidelayout+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.presentationml.slidemaster+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.presentationml.slideshow":{source:"iana",extensions:["ppsx"]},"application/vnd.openxmlformats-officedocument.presentationml.slideshow.main+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.presentationml.slideupdateinfo+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.presentationml.tablestyles+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.presentationml.tags+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.presentationml.template":{source:"iana",extensions:["potx"]},"application/vnd.openxmlformats-officedocument.presentationml.template.main+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.presentationml.viewprops+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.spreadsheetml.calcchain+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.spreadsheetml.chartsheet+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.spreadsheetml.comments+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.spreadsheetml.connections+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.spreadsheetml.dialogsheet+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.spreadsheetml.externallink+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.spreadsheetml.pivotcachedefinition+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.spreadsheetml.pivotcacherecords+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.spreadsheetml.pivottable+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.spreadsheetml.querytable+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.spreadsheetml.revisionheaders+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.spreadsheetml.revisionlog+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.spreadsheetml.sharedstrings+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":{source:"iana",compressible:!1,extensions:["xlsx"]},"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.spreadsheetml.sheetmetadata+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.spreadsheetml.table+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.spreadsheetml.tablesinglecells+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.spreadsheetml.template":{source:"iana",extensions:["xltx"]},"application/vnd.openxmlformats-officedocument.spreadsheetml.template.main+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.spreadsheetml.usernames+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.spreadsheetml.volatiledependencies+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.theme+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.themeoverride+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.vmldrawing":{source:"iana"},"application/vnd.openxmlformats-officedocument.wordprocessingml.comments+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.wordprocessingml.document":{source:"iana",compressible:!1,extensions:["docx"]},"application/vnd.openxmlformats-officedocument.wordprocessingml.document.glossary+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.wordprocessingml.endnotes+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.wordprocessingml.fonttable+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.wordprocessingml.footer+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.wordprocessingml.footnotes+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.wordprocessingml.numbering+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.wordprocessingml.settings+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.wordprocessingml.template":{source:"iana",extensions:["dotx"]},"application/vnd.openxmlformats-officedocument.wordprocessingml.template.main+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-officedocument.wordprocessingml.websettings+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-package.core-properties+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-package.digital-signature-xmlsignature+xml":{source:"iana",compressible:!0},"application/vnd.openxmlformats-package.relationships+xml":{source:"iana",compressible:!0},"application/vnd.oracle.resource+json":{source:"iana",compressible:!0},"application/vnd.orange.indata":{source:"iana"},"application/vnd.osa.netdeploy":{source:"iana"},"application/vnd.osgeo.mapguide.package":{source:"iana",extensions:["mgp"]},"application/vnd.osgi.bundle":{source:"iana"},"application/vnd.osgi.dp":{source:"iana",extensions:["dp"]},"application/vnd.osgi.subsystem":{source:"iana",extensions:["esa"]},"application/vnd.otps.ct-kip+xml":{source:"iana",compressible:!0},"application/vnd.oxli.countgraph":{source:"iana"},"application/vnd.pagerduty+json":{source:"iana",compressible:!0},"application/vnd.palm":{source:"iana",extensions:["pdb","pqa","oprc"]},"application/vnd.panoply":{source:"iana"},"application/vnd.paos.xml":{source:"iana"},"application/vnd.patentdive":{source:"iana"},"application/vnd.patientecommsdoc":{source:"iana"},"application/vnd.pawaafile":{source:"iana",extensions:["paw"]},"application/vnd.pcos":{source:"iana"},"application/vnd.pg.format":{source:"iana",extensions:["str"]},"application/vnd.pg.osasli":{source:"iana",extensions:["ei6"]},"application/vnd.piaccess.application-licence":{source:"iana"},"application/vnd.picsel":{source:"iana",extensions:["efif"]},"application/vnd.pmi.widget":{source:"iana",extensions:["wg"]},"application/vnd.poc.group-advertisement+xml":{source:"iana",compressible:!0},"application/vnd.pocketlearn":{source:"iana",extensions:["plf"]},"application/vnd.powerbuilder6":{source:"iana",extensions:["pbd"]},"application/vnd.powerbuilder6-s":{source:"iana"},"application/vnd.powerbuilder7":{source:"iana"},"application/vnd.powerbuilder7-s":{source:"iana"},"application/vnd.powerbuilder75":{source:"iana"},"application/vnd.powerbuilder75-s":{source:"iana"},"application/vnd.preminet":{source:"iana"},"application/vnd.previewsystems.box":{source:"iana",extensions:["box"]},"application/vnd.proteus.magazine":{source:"iana",extensions:["mgz"]},"application/vnd.psfs":{source:"iana"},"application/vnd.publishare-delta-tree":{source:"iana",extensions:["qps"]},"application/vnd.pvi.ptid1":{source:"iana",extensions:["ptid"]},"application/vnd.pwg-multiplexed":{source:"iana"},"application/vnd.pwg-xhtml-print+xml":{source:"iana",compressible:!0},"application/vnd.qualcomm.brew-app-res":{source:"iana"},"application/vnd.quarantainenet":{source:"iana"},"application/vnd.quark.quarkxpress":{source:"iana",extensions:["qxd","qxt","qwd","qwt","qxl","qxb"]},"application/vnd.quobject-quoxdocument":{source:"iana"},"application/vnd.radisys.moml+xml":{source:"iana",compressible:!0},"application/vnd.radisys.msml+xml":{source:"iana",compressible:!0},"application/vnd.radisys.msml-audit+xml":{source:"iana",compressible:!0},"application/vnd.radisys.msml-audit-conf+xml":{source:"iana",compressible:!0},"application/vnd.radisys.msml-audit-conn+xml":{source:"iana",compressible:!0},"application/vnd.radisys.msml-audit-dialog+xml":{source:"iana",compressible:!0},"application/vnd.radisys.msml-audit-stream+xml":{source:"iana",compressible:!0},"application/vnd.radisys.msml-conf+xml":{source:"iana",compressible:!0},"application/vnd.radisys.msml-dialog+xml":{source:"iana",compressible:!0},"application/vnd.radisys.msml-dialog-base+xml":{source:"iana",compressible:!0},"application/vnd.radisys.msml-dialog-fax-detect+xml":{source:"iana",compressible:!0},"application/vnd.radisys.msml-dialog-fax-sendrecv+xml":{source:"iana",compressible:!0},"application/vnd.radisys.msml-dialog-group+xml":{source:"iana",compressible:!0},"application/vnd.radisys.msml-dialog-speech+xml":{source:"iana",compressible:!0},"application/vnd.radisys.msml-dialog-transform+xml":{source:"iana",compressible:!0},"application/vnd.rainstor.data":{source:"iana"},"application/vnd.rapid":{source:"iana"},"application/vnd.rar":{source:"iana",extensions:["rar"]},"application/vnd.realvnc.bed":{source:"iana",extensions:["bed"]},"application/vnd.recordare.musicxml":{source:"iana",extensions:["mxl"]},"application/vnd.recordare.musicxml+xml":{source:"iana",compressible:!0,extensions:["musicxml"]},"application/vnd.renlearn.rlprint":{source:"iana"},"application/vnd.resilient.logic":{source:"iana"},"application/vnd.restful+json":{source:"iana",compressible:!0},"application/vnd.rig.cryptonote":{source:"iana",extensions:["cryptonote"]},"application/vnd.rim.cod":{source:"apache",extensions:["cod"]},"application/vnd.rn-realmedia":{source:"apache",extensions:["rm"]},"application/vnd.rn-realmedia-vbr":{source:"apache",extensions:["rmvb"]},"application/vnd.route66.link66+xml":{source:"iana",compressible:!0,extensions:["link66"]},"application/vnd.rs-274x":{source:"iana"},"application/vnd.ruckus.download":{source:"iana"},"application/vnd.s3sms":{source:"iana"},"application/vnd.sailingtracker.track":{source:"iana",extensions:["st"]},"application/vnd.sar":{source:"iana"},"application/vnd.sbm.cid":{source:"iana"},"application/vnd.sbm.mid2":{source:"iana"},"application/vnd.scribus":{source:"iana"},"application/vnd.sealed.3df":{source:"iana"},"application/vnd.sealed.csf":{source:"iana"},"application/vnd.sealed.doc":{source:"iana"},"application/vnd.sealed.eml":{source:"iana"},"application/vnd.sealed.mht":{source:"iana"},"application/vnd.sealed.net":{source:"iana"},"application/vnd.sealed.ppt":{source:"iana"},"application/vnd.sealed.tiff":{source:"iana"},"application/vnd.sealed.xls":{source:"iana"},"application/vnd.sealedmedia.softseal.html":{source:"iana"},"application/vnd.sealedmedia.softseal.pdf":{source:"iana"},"application/vnd.seemail":{source:"iana",extensions:["see"]},"application/vnd.seis+json":{source:"iana",compressible:!0},"application/vnd.sema":{source:"iana",extensions:["sema"]},"application/vnd.semd":{source:"iana",extensions:["semd"]},"application/vnd.semf":{source:"iana",extensions:["semf"]},"application/vnd.shade-save-file":{source:"iana"},"application/vnd.shana.informed.formdata":{source:"iana",extensions:["ifm"]},"application/vnd.shana.informed.formtemplate":{source:"iana",extensions:["itp"]},"application/vnd.shana.informed.interchange":{source:"iana",extensions:["iif"]},"application/vnd.shana.informed.package":{source:"iana",extensions:["ipk"]},"application/vnd.shootproof+json":{source:"iana",compressible:!0},"application/vnd.shopkick+json":{source:"iana",compressible:!0},"application/vnd.shp":{source:"iana"},"application/vnd.shx":{source:"iana"},"application/vnd.sigrok.session":{source:"iana"},"application/vnd.simtech-mindmapper":{source:"iana",extensions:["twd","twds"]},"application/vnd.siren+json":{source:"iana",compressible:!0},"application/vnd.smaf":{source:"iana",extensions:["mmf"]},"application/vnd.smart.notebook":{source:"iana"},"application/vnd.smart.teacher":{source:"iana",extensions:["teacher"]},"application/vnd.snesdev-page-table":{source:"iana"},"application/vnd.software602.filler.form+xml":{source:"iana",compressible:!0,extensions:["fo"]},"application/vnd.software602.filler.form-xml-zip":{source:"iana"},"application/vnd.solent.sdkm+xml":{source:"iana",compressible:!0,extensions:["sdkm","sdkd"]},"application/vnd.spotfire.dxp":{source:"iana",extensions:["dxp"]},"application/vnd.spotfire.sfs":{source:"iana",extensions:["sfs"]},"application/vnd.sqlite3":{source:"iana"},"application/vnd.sss-cod":{source:"iana"},"application/vnd.sss-dtf":{source:"iana"},"application/vnd.sss-ntf":{source:"iana"},"application/vnd.stardivision.calc":{source:"apache",extensions:["sdc"]},"application/vnd.stardivision.draw":{source:"apache",extensions:["sda"]},"application/vnd.stardivision.impress":{source:"apache",extensions:["sdd"]},"application/vnd.stardivision.math":{source:"apache",extensions:["smf"]},"application/vnd.stardivision.writer":{source:"apache",extensions:["sdw","vor"]},"application/vnd.stardivision.writer-global":{source:"apache",extensions:["sgl"]},"application/vnd.stepmania.package":{source:"iana",extensions:["smzip"]},"application/vnd.stepmania.stepchart":{source:"iana",extensions:["sm"]},"application/vnd.street-stream":{source:"iana"},"application/vnd.sun.wadl+xml":{source:"iana",compressible:!0,extensions:["wadl"]},"application/vnd.sun.xml.calc":{source:"apache",extensions:["sxc"]},"application/vnd.sun.xml.calc.template":{source:"apache",extensions:["stc"]},"application/vnd.sun.xml.draw":{source:"apache",extensions:["sxd"]},"application/vnd.sun.xml.draw.template":{source:"apache",extensions:["std"]},"application/vnd.sun.xml.impress":{source:"apache",extensions:["sxi"]},"application/vnd.sun.xml.impress.template":{source:"apache",extensions:["sti"]},"application/vnd.sun.xml.math":{source:"apache",extensions:["sxm"]},"application/vnd.sun.xml.writer":{source:"apache",extensions:["sxw"]},"application/vnd.sun.xml.writer.global":{source:"apache",extensions:["sxg"]},"application/vnd.sun.xml.writer.template":{source:"apache",extensions:["stw"]},"application/vnd.sus-calendar":{source:"iana",extensions:["sus","susp"]},"application/vnd.svd":{source:"iana",extensions:["svd"]},"application/vnd.swiftview-ics":{source:"iana"},"application/vnd.sycle+xml":{source:"iana",compressible:!0},"application/vnd.syft+json":{source:"iana",compressible:!0},"application/vnd.symbian.install":{source:"apache",extensions:["sis","sisx"]},"application/vnd.syncml+xml":{source:"iana",charset:"UTF-8",compressible:!0,extensions:["xsm"]},"application/vnd.syncml.dm+wbxml":{source:"iana",charset:"UTF-8",extensions:["bdm"]},"application/vnd.syncml.dm+xml":{source:"iana",charset:"UTF-8",compressible:!0,extensions:["xdm"]},"application/vnd.syncml.dm.notification":{source:"iana"},"application/vnd.syncml.dmddf+wbxml":{source:"iana"},"application/vnd.syncml.dmddf+xml":{source:"iana",charset:"UTF-8",compressible:!0,extensions:["ddf"]},"application/vnd.syncml.dmtnds+wbxml":{source:"iana"},"application/vnd.syncml.dmtnds+xml":{source:"iana",charset:"UTF-8",compressible:!0},"application/vnd.syncml.ds.notification":{source:"iana"},"application/vnd.tableschema+json":{source:"iana",compressible:!0},"application/vnd.tao.intent-module-archive":{source:"iana",extensions:["tao"]},"application/vnd.tcpdump.pcap":{source:"iana",extensions:["pcap","cap","dmp"]},"application/vnd.think-cell.ppttc+json":{source:"iana",compressible:!0},"application/vnd.tmd.mediaflex.api+xml":{source:"iana",compressible:!0},"application/vnd.tml":{source:"iana"},"application/vnd.tmobile-livetv":{source:"iana",extensions:["tmo"]},"application/vnd.tri.onesource":{source:"iana"},"application/vnd.trid.tpt":{source:"iana",extensions:["tpt"]},"application/vnd.triscape.mxs":{source:"iana",extensions:["mxs"]},"application/vnd.trueapp":{source:"iana",extensions:["tra"]},"application/vnd.truedoc":{source:"iana"},"application/vnd.ubisoft.webplayer":{source:"iana"},"application/vnd.ufdl":{source:"iana",extensions:["ufd","ufdl"]},"application/vnd.uiq.theme":{source:"iana",extensions:["utz"]},"application/vnd.umajin":{source:"iana",extensions:["umj"]},"application/vnd.unity":{source:"iana",extensions:["unityweb"]},"application/vnd.uoml+xml":{source:"iana",compressible:!0,extensions:["uoml"]},"application/vnd.uplanet.alert":{source:"iana"},"application/vnd.uplanet.alert-wbxml":{source:"iana"},"application/vnd.uplanet.bearer-choice":{source:"iana"},"application/vnd.uplanet.bearer-choice-wbxml":{source:"iana"},"application/vnd.uplanet.cacheop":{source:"iana"},"application/vnd.uplanet.cacheop-wbxml":{source:"iana"},"application/vnd.uplanet.channel":{source:"iana"},"application/vnd.uplanet.channel-wbxml":{source:"iana"},"application/vnd.uplanet.list":{source:"iana"},"application/vnd.uplanet.list-wbxml":{source:"iana"},"application/vnd.uplanet.listcmd":{source:"iana"},"application/vnd.uplanet.listcmd-wbxml":{source:"iana"},"application/vnd.uplanet.signal":{source:"iana"},"application/vnd.uri-map":{source:"iana"},"application/vnd.valve.source.material":{source:"iana"},"application/vnd.vcx":{source:"iana",extensions:["vcx"]},"application/vnd.vd-study":{source:"iana"},"application/vnd.vectorworks":{source:"iana"},"application/vnd.vel+json":{source:"iana",compressible:!0},"application/vnd.verimatrix.vcas":{source:"iana"},"application/vnd.veritone.aion+json":{source:"iana",compressible:!0},"application/vnd.veryant.thin":{source:"iana"},"application/vnd.ves.encrypted":{source:"iana"},"application/vnd.vidsoft.vidconference":{source:"iana"},"application/vnd.visio":{source:"iana",extensions:["vsd","vst","vss","vsw"]},"application/vnd.visionary":{source:"iana",extensions:["vis"]},"application/vnd.vividence.scriptfile":{source:"iana"},"application/vnd.vsf":{source:"iana",extensions:["vsf"]},"application/vnd.wap.sic":{source:"iana"},"application/vnd.wap.slc":{source:"iana"},"application/vnd.wap.wbxml":{source:"iana",charset:"UTF-8",extensions:["wbxml"]},"application/vnd.wap.wmlc":{source:"iana",extensions:["wmlc"]},"application/vnd.wap.wmlscriptc":{source:"iana",extensions:["wmlsc"]},"application/vnd.webturbo":{source:"iana",extensions:["wtb"]},"application/vnd.wfa.dpp":{source:"iana"},"application/vnd.wfa.p2p":{source:"iana"},"application/vnd.wfa.wsc":{source:"iana"},"application/vnd.windows.devicepairing":{source:"iana"},"application/vnd.wmc":{source:"iana"},"application/vnd.wmf.bootstrap":{source:"iana"},"application/vnd.wolfram.mathematica":{source:"iana"},"application/vnd.wolfram.mathematica.package":{source:"iana"},"application/vnd.wolfram.player":{source:"iana",extensions:["nbp"]},"application/vnd.wordperfect":{source:"iana",extensions:["wpd"]},"application/vnd.wqd":{source:"iana",extensions:["wqd"]},"application/vnd.wrq-hp3000-labelled":{source:"iana"},"application/vnd.wt.stf":{source:"iana",extensions:["stf"]},"application/vnd.wv.csp+wbxml":{source:"iana"},"application/vnd.wv.csp+xml":{source:"iana",compressible:!0},"application/vnd.wv.ssp+xml":{source:"iana",compressible:!0},"application/vnd.xacml+json":{source:"iana",compressible:!0},"application/vnd.xara":{source:"iana",extensions:["xar"]},"application/vnd.xfdl":{source:"iana",extensions:["xfdl"]},"application/vnd.xfdl.webform":{source:"iana"},"application/vnd.xmi+xml":{source:"iana",compressible:!0},"application/vnd.xmpie.cpkg":{source:"iana"},"application/vnd.xmpie.dpkg":{source:"iana"},"application/vnd.xmpie.plan":{source:"iana"},"application/vnd.xmpie.ppkg":{source:"iana"},"application/vnd.xmpie.xlim":{source:"iana"},"application/vnd.yamaha.hv-dic":{source:"iana",extensions:["hvd"]},"application/vnd.yamaha.hv-script":{source:"iana",extensions:["hvs"]},"application/vnd.yamaha.hv-voice":{source:"iana",extensions:["hvp"]},"application/vnd.yamaha.openscoreformat":{source:"iana",extensions:["osf"]},"application/vnd.yamaha.openscoreformat.osfpvg+xml":{source:"iana",compressible:!0,extensions:["osfpvg"]},"application/vnd.yamaha.remote-setup":{source:"iana"},"application/vnd.yamaha.smaf-audio":{source:"iana",extensions:["saf"]},"application/vnd.yamaha.smaf-phrase":{source:"iana",extensions:["spf"]},"application/vnd.yamaha.through-ngn":{source:"iana"},"application/vnd.yamaha.tunnel-udpencap":{source:"iana"},"application/vnd.yaoweme":{source:"iana"},"application/vnd.yellowriver-custom-menu":{source:"iana",extensions:["cmp"]},"application/vnd.youtube.yt":{source:"iana"},"application/vnd.zul":{source:"iana",extensions:["zir","zirz"]},"application/vnd.zzazz.deck+xml":{source:"iana",compressible:!0,extensions:["zaz"]},"application/voicexml+xml":{source:"iana",compressible:!0,extensions:["vxml"]},"application/voucher-cms+json":{source:"iana",compressible:!0},"application/vq-rtcpxr":{source:"iana"},"application/wasm":{source:"iana",compressible:!0,extensions:["wasm"]},"application/watcherinfo+xml":{source:"iana",compressible:!0,extensions:["wif"]},"application/webpush-options+json":{source:"iana",compressible:!0},"application/whoispp-query":{source:"iana"},"application/whoispp-response":{source:"iana"},"application/widget":{source:"iana",extensions:["wgt"]},"application/winhlp":{source:"apache",extensions:["hlp"]},"application/wita":{source:"iana"},"application/wordperfect5.1":{source:"iana"},"application/wsdl+xml":{source:"iana",compressible:!0,extensions:["wsdl"]},"application/wspolicy+xml":{source:"iana",compressible:!0,extensions:["wspolicy"]},"application/x-7z-compressed":{source:"apache",compressible:!1,extensions:["7z"]},"application/x-abiword":{source:"apache",extensions:["abw"]},"application/x-ace-compressed":{source:"apache",extensions:["ace"]},"application/x-amf":{source:"apache"},"application/x-apple-diskimage":{source:"apache",extensions:["dmg"]},"application/x-arj":{compressible:!1,extensions:["arj"]},"application/x-authorware-bin":{source:"apache",extensions:["aab","x32","u32","vox"]},"application/x-authorware-map":{source:"apache",extensions:["aam"]},"application/x-authorware-seg":{source:"apache",extensions:["aas"]},"application/x-bcpio":{source:"apache",extensions:["bcpio"]},"application/x-bdoc":{compressible:!1,extensions:["bdoc"]},"application/x-bittorrent":{source:"apache",extensions:["torrent"]},"application/x-blorb":{source:"apache",extensions:["blb","blorb"]},"application/x-bzip":{source:"apache",compressible:!1,extensions:["bz"]},"application/x-bzip2":{source:"apache",compressible:!1,extensions:["bz2","boz"]},"application/x-cbr":{source:"apache",extensions:["cbr","cba","cbt","cbz","cb7"]},"application/x-cdlink":{source:"apache",extensions:["vcd"]},"application/x-cfs-compressed":{source:"apache",extensions:["cfs"]},"application/x-chat":{source:"apache",extensions:["chat"]},"application/x-chess-pgn":{source:"apache",extensions:["pgn"]},"application/x-chrome-extension":{extensions:["crx"]},"application/x-cocoa":{source:"nginx",extensions:["cco"]},"application/x-compress":{source:"apache"},"application/x-conference":{source:"apache",extensions:["nsc"]},"application/x-cpio":{source:"apache",extensions:["cpio"]},"application/x-csh":{source:"apache",extensions:["csh"]},"application/x-deb":{compressible:!1},"application/x-debian-package":{source:"apache",extensions:["deb","udeb"]},"application/x-dgc-compressed":{source:"apache",extensions:["dgc"]},"application/x-director":{source:"apache",extensions:["dir","dcr","dxr","cst","cct","cxt","w3d","fgd","swa"]},"application/x-doom":{source:"apache",extensions:["wad"]},"application/x-dtbncx+xml":{source:"apache",compressible:!0,extensions:["ncx"]},"application/x-dtbook+xml":{source:"apache",compressible:!0,extensions:["dtb"]},"application/x-dtbresource+xml":{source:"apache",compressible:!0,extensions:["res"]},"application/x-dvi":{source:"apache",compressible:!1,extensions:["dvi"]},"application/x-envoy":{source:"apache",extensions:["evy"]},"application/x-eva":{source:"apache",extensions:["eva"]},"application/x-font-bdf":{source:"apache",extensions:["bdf"]},"application/x-font-dos":{source:"apache"},"application/x-font-framemaker":{source:"apache"},"application/x-font-ghostscript":{source:"apache",extensions:["gsf"]},"application/x-font-libgrx":{source:"apache"},"application/x-font-linux-psf":{source:"apache",extensions:["psf"]},"application/x-font-pcf":{source:"apache",extensions:["pcf"]},"application/x-font-snf":{source:"apache",extensions:["snf"]},"application/x-font-speedo":{source:"apache"},"application/x-font-sunos-news":{source:"apache"},"application/x-font-type1":{source:"apache",extensions:["pfa","pfb","pfm","afm"]},"application/x-font-vfont":{source:"apache"},"application/x-freearc":{source:"apache",extensions:["arc"]},"application/x-futuresplash":{source:"apache",extensions:["spl"]},"application/x-gca-compressed":{source:"apache",extensions:["gca"]},"application/x-glulx":{source:"apache",extensions:["ulx"]},"application/x-gnumeric":{source:"apache",extensions:["gnumeric"]},"application/x-gramps-xml":{source:"apache",extensions:["gramps"]},"application/x-gtar":{source:"apache",extensions:["gtar"]},"application/x-gzip":{source:"apache"},"application/x-hdf":{source:"apache",extensions:["hdf"]},"application/x-httpd-php":{compressible:!0,extensions:["php"]},"application/x-install-instructions":{source:"apache",extensions:["install"]},"application/x-iso9660-image":{source:"apache",extensions:["iso"]},"application/x-iwork-keynote-sffkey":{extensions:["key"]},"application/x-iwork-numbers-sffnumbers":{extensions:["numbers"]},"application/x-iwork-pages-sffpages":{extensions:["pages"]},"application/x-java-archive-diff":{source:"nginx",extensions:["jardiff"]},"application/x-java-jnlp-file":{source:"apache",compressible:!1,extensions:["jnlp"]},"application/x-javascript":{compressible:!0},"application/x-keepass2":{extensions:["kdbx"]},"application/x-latex":{source:"apache",compressible:!1,extensions:["latex"]},"application/x-lua-bytecode":{extensions:["luac"]},"application/x-lzh-compressed":{source:"apache",extensions:["lzh","lha"]},"application/x-makeself":{source:"nginx",extensions:["run"]},"application/x-mie":{source:"apache",extensions:["mie"]},"application/x-mobipocket-ebook":{source:"apache",extensions:["prc","mobi"]},"application/x-mpegurl":{compressible:!1},"application/x-ms-application":{source:"apache",extensions:["application"]},"application/x-ms-shortcut":{source:"apache",extensions:["lnk"]},"application/x-ms-wmd":{source:"apache",extensions:["wmd"]},"application/x-ms-wmz":{source:"apache",extensions:["wmz"]},"application/x-ms-xbap":{source:"apache",extensions:["xbap"]},"application/x-msaccess":{source:"apache",extensions:["mdb"]},"application/x-msbinder":{source:"apache",extensions:["obd"]},"application/x-mscardfile":{source:"apache",extensions:["crd"]},"application/x-msclip":{source:"apache",extensions:["clp"]},"application/x-msdos-program":{extensions:["exe"]},"application/x-msdownload":{source:"apache",extensions:["exe","dll","com","bat","msi"]},"application/x-msmediaview":{source:"apache",extensions:["mvb","m13","m14"]},"application/x-msmetafile":{source:"apache",extensions:["wmf","wmz","emf","emz"]},"application/x-msmoney":{source:"apache",extensions:["mny"]},"application/x-mspublisher":{source:"apache",extensions:["pub"]},"application/x-msschedule":{source:"apache",extensions:["scd"]},"application/x-msterminal":{source:"apache",extensions:["trm"]},"application/x-mswrite":{source:"apache",extensions:["wri"]},"application/x-netcdf":{source:"apache",extensions:["nc","cdf"]},"application/x-ns-proxy-autoconfig":{compressible:!0,extensions:["pac"]},"application/x-nzb":{source:"apache",extensions:["nzb"]},"application/x-perl":{source:"nginx",extensions:["pl","pm"]},"application/x-pilot":{source:"nginx",extensions:["prc","pdb"]},"application/x-pkcs12":{source:"apache",compressible:!1,extensions:["p12","pfx"]},"application/x-pkcs7-certificates":{source:"apache",extensions:["p7b","spc"]},"application/x-pkcs7-certreqresp":{source:"apache",extensions:["p7r"]},"application/x-pki-message":{source:"iana"},"application/x-rar-compressed":{source:"apache",compressible:!1,extensions:["rar"]},"application/x-redhat-package-manager":{source:"nginx",extensions:["rpm"]},"application/x-research-info-systems":{source:"apache",extensions:["ris"]},"application/x-sea":{source:"nginx",extensions:["sea"]},"application/x-sh":{source:"apache",compressible:!0,extensions:["sh"]},"application/x-shar":{source:"apache",extensions:["shar"]},"application/x-shockwave-flash":{source:"apache",compressible:!1,extensions:["swf"]},"application/x-silverlight-app":{source:"apache",extensions:["xap"]},"application/x-sql":{source:"apache",extensions:["sql"]},"application/x-stuffit":{source:"apache",compressible:!1,extensions:["sit"]},"application/x-stuffitx":{source:"apache",extensions:["sitx"]},"application/x-subrip":{source:"apache",extensions:["srt"]},"application/x-sv4cpio":{source:"apache",extensions:["sv4cpio"]},"application/x-sv4crc":{source:"apache",extensions:["sv4crc"]},"application/x-t3vm-image":{source:"apache",extensions:["t3"]},"application/x-tads":{source:"apache",extensions:["gam"]},"application/x-tar":{source:"apache",compressible:!0,extensions:["tar"]},"application/x-tcl":{source:"apache",extensions:["tcl","tk"]},"application/x-tex":{source:"apache",extensions:["tex"]},"application/x-tex-tfm":{source:"apache",extensions:["tfm"]},"application/x-texinfo":{source:"apache",extensions:["texinfo","texi"]},"application/x-tgif":{source:"apache",extensions:["obj"]},"application/x-ustar":{source:"apache",extensions:["ustar"]},"application/x-virtualbox-hdd":{compressible:!0,extensions:["hdd"]},"application/x-virtualbox-ova":{compressible:!0,extensions:["ova"]},"application/x-virtualbox-ovf":{compressible:!0,extensions:["ovf"]},"application/x-virtualbox-vbox":{compressible:!0,extensions:["vbox"]},"application/x-virtualbox-vbox-extpack":{compressible:!1,extensions:["vbox-extpack"]},"application/x-virtualbox-vdi":{compressible:!0,extensions:["vdi"]},"application/x-virtualbox-vhd":{compressible:!0,extensions:["vhd"]},"application/x-virtualbox-vmdk":{compressible:!0,extensions:["vmdk"]},"application/x-wais-source":{source:"apache",extensions:["src"]},"application/x-web-app-manifest+json":{compressible:!0,extensions:["webapp"]},"application/x-www-form-urlencoded":{source:"iana",compressible:!0},"application/x-x509-ca-cert":{source:"iana",extensions:["der","crt","pem"]},"application/x-x509-ca-ra-cert":{source:"iana"},"application/x-x509-next-ca-cert":{source:"iana"},"application/x-xfig":{source:"apache",extensions:["fig"]},"application/x-xliff+xml":{source:"apache",compressible:!0,extensions:["xlf"]},"application/x-xpinstall":{source:"apache",compressible:!1,extensions:["xpi"]},"application/x-xz":{source:"apache",extensions:["xz"]},"application/x-zmachine":{source:"apache",extensions:["z1","z2","z3","z4","z5","z6","z7","z8"]},"application/x400-bp":{source:"iana"},"application/xacml+xml":{source:"iana",compressible:!0},"application/xaml+xml":{source:"apache",compressible:!0,extensions:["xaml"]},"application/xcap-att+xml":{source:"iana",compressible:!0,extensions:["xav"]},"application/xcap-caps+xml":{source:"iana",compressible:!0,extensions:["xca"]},"application/xcap-diff+xml":{source:"iana",compressible:!0,extensions:["xdf"]},"application/xcap-el+xml":{source:"iana",compressible:!0,extensions:["xel"]},"application/xcap-error+xml":{source:"iana",compressible:!0},"application/xcap-ns+xml":{source:"iana",compressible:!0,extensions:["xns"]},"application/xcon-conference-info+xml":{source:"iana",compressible:!0},"application/xcon-conference-info-diff+xml":{source:"iana",compressible:!0},"application/xenc+xml":{source:"iana",compressible:!0,extensions:["xenc"]},"application/xhtml+xml":{source:"iana",compressible:!0,extensions:["xhtml","xht"]},"application/xhtml-voice+xml":{source:"apache",compressible:!0},"application/xliff+xml":{source:"iana",compressible:!0,extensions:["xlf"]},"application/xml":{source:"iana",compressible:!0,extensions:["xml","xsl","xsd","rng"]},"application/xml-dtd":{source:"iana",compressible:!0,extensions:["dtd"]},"application/xml-external-parsed-entity":{source:"iana"},"application/xml-patch+xml":{source:"iana",compressible:!0},"application/xmpp+xml":{source:"iana",compressible:!0},"application/xop+xml":{source:"iana",compressible:!0,extensions:["xop"]},"application/xproc+xml":{source:"apache",compressible:!0,extensions:["xpl"]},"application/xslt+xml":{source:"iana",compressible:!0,extensions:["xsl","xslt"]},"application/xspf+xml":{source:"apache",compressible:!0,extensions:["xspf"]},"application/xv+xml":{source:"iana",compressible:!0,extensions:["mxml","xhvml","xvml","xvm"]},"application/yang":{source:"iana",extensions:["yang"]},"application/yang-data+json":{source:"iana",compressible:!0},"application/yang-data+xml":{source:"iana",compressible:!0},"application/yang-patch+json":{source:"iana",compressible:!0},"application/yang-patch+xml":{source:"iana",compressible:!0},"application/yin+xml":{source:"iana",compressible:!0,extensions:["yin"]},"application/zip":{source:"iana",compressible:!1,extensions:["zip"]},"application/zlib":{source:"iana"},"application/zstd":{source:"iana"},"audio/1d-interleaved-parityfec":{source:"iana"},"audio/32kadpcm":{source:"iana"},"audio/3gpp":{source:"iana",compressible:!1,extensions:["3gpp"]},"audio/3gpp2":{source:"iana"},"audio/aac":{source:"iana"},"audio/ac3":{source:"iana"},"audio/adpcm":{source:"apache",extensions:["adp"]},"audio/amr":{source:"iana",extensions:["amr"]},"audio/amr-wb":{source:"iana"},"audio/amr-wb+":{source:"iana"},"audio/aptx":{source:"iana"},"audio/asc":{source:"iana"},"audio/atrac-advanced-lossless":{source:"iana"},"audio/atrac-x":{source:"iana"},"audio/atrac3":{source:"iana"},"audio/basic":{source:"iana",compressible:!1,extensions:["au","snd"]},"audio/bv16":{source:"iana"},"audio/bv32":{source:"iana"},"audio/clearmode":{source:"iana"},"audio/cn":{source:"iana"},"audio/dat12":{source:"iana"},"audio/dls":{source:"iana"},"audio/dsr-es201108":{source:"iana"},"audio/dsr-es202050":{source:"iana"},"audio/dsr-es202211":{source:"iana"},"audio/dsr-es202212":{source:"iana"},"audio/dv":{source:"iana"},"audio/dvi4":{source:"iana"},"audio/eac3":{source:"iana"},"audio/encaprtp":{source:"iana"},"audio/evrc":{source:"iana"},"audio/evrc-qcp":{source:"iana"},"audio/evrc0":{source:"iana"},"audio/evrc1":{source:"iana"},"audio/evrcb":{source:"iana"},"audio/evrcb0":{source:"iana"},"audio/evrcb1":{source:"iana"},"audio/evrcnw":{source:"iana"},"audio/evrcnw0":{source:"iana"},"audio/evrcnw1":{source:"iana"},"audio/evrcwb":{source:"iana"},"audio/evrcwb0":{source:"iana"},"audio/evrcwb1":{source:"iana"},"audio/evs":{source:"iana"},"audio/flexfec":{source:"iana"},"audio/fwdred":{source:"iana"},"audio/g711-0":{source:"iana"},"audio/g719":{source:"iana"},"audio/g722":{source:"iana"},"audio/g7221":{source:"iana"},"audio/g723":{source:"iana"},"audio/g726-16":{source:"iana"},"audio/g726-24":{source:"iana"},"audio/g726-32":{source:"iana"},"audio/g726-40":{source:"iana"},"audio/g728":{source:"iana"},"audio/g729":{source:"iana"},"audio/g7291":{source:"iana"},"audio/g729d":{source:"iana"},"audio/g729e":{source:"iana"},"audio/gsm":{source:"iana"},"audio/gsm-efr":{source:"iana"},"audio/gsm-hr-08":{source:"iana"},"audio/ilbc":{source:"iana"},"audio/ip-mr_v2.5":{source:"iana"},"audio/isac":{source:"apache"},"audio/l16":{source:"iana"},"audio/l20":{source:"iana"},"audio/l24":{source:"iana",compressible:!1},"audio/l8":{source:"iana"},"audio/lpc":{source:"iana"},"audio/melp":{source:"iana"},"audio/melp1200":{source:"iana"},"audio/melp2400":{source:"iana"},"audio/melp600":{source:"iana"},"audio/mhas":{source:"iana"},"audio/midi":{source:"apache",extensions:["mid","midi","kar","rmi"]},"audio/mobile-xmf":{source:"iana",extensions:["mxmf"]},"audio/mp3":{compressible:!1,extensions:["mp3"]},"audio/mp4":{source:"iana",compressible:!1,extensions:["m4a","mp4a"]},"audio/mp4a-latm":{source:"iana"},"audio/mpa":{source:"iana"},"audio/mpa-robust":{source:"iana"},"audio/mpeg":{source:"iana",compressible:!1,extensions:["mpga","mp2","mp2a","mp3","m2a","m3a"]},"audio/mpeg4-generic":{source:"iana"},"audio/musepack":{source:"apache"},"audio/ogg":{source:"iana",compressible:!1,extensions:["oga","ogg","spx","opus"]},"audio/opus":{source:"iana"},"audio/parityfec":{source:"iana"},"audio/pcma":{source:"iana"},"audio/pcma-wb":{source:"iana"},"audio/pcmu":{source:"iana"},"audio/pcmu-wb":{source:"iana"},"audio/prs.sid":{source:"iana"},"audio/qcelp":{source:"iana"},"audio/raptorfec":{source:"iana"},"audio/red":{source:"iana"},"audio/rtp-enc-aescm128":{source:"iana"},"audio/rtp-midi":{source:"iana"},"audio/rtploopback":{source:"iana"},"audio/rtx":{source:"iana"},"audio/s3m":{source:"apache",extensions:["s3m"]},"audio/scip":{source:"iana"},"audio/silk":{source:"apache",extensions:["sil"]},"audio/smv":{source:"iana"},"audio/smv-qcp":{source:"iana"},"audio/smv0":{source:"iana"},"audio/sofa":{source:"iana"},"audio/sp-midi":{source:"iana"},"audio/speex":{source:"iana"},"audio/t140c":{source:"iana"},"audio/t38":{source:"iana"},"audio/telephone-event":{source:"iana"},"audio/tetra_acelp":{source:"iana"},"audio/tetra_acelp_bb":{source:"iana"},"audio/tone":{source:"iana"},"audio/tsvcis":{source:"iana"},"audio/uemclip":{source:"iana"},"audio/ulpfec":{source:"iana"},"audio/usac":{source:"iana"},"audio/vdvi":{source:"iana"},"audio/vmr-wb":{source:"iana"},"audio/vnd.3gpp.iufp":{source:"iana"},"audio/vnd.4sb":{source:"iana"},"audio/vnd.audiokoz":{source:"iana"},"audio/vnd.celp":{source:"iana"},"audio/vnd.cisco.nse":{source:"iana"},"audio/vnd.cmles.radio-events":{source:"iana"},"audio/vnd.cns.anp1":{source:"iana"},"audio/vnd.cns.inf1":{source:"iana"},"audio/vnd.dece.audio":{source:"iana",extensions:["uva","uvva"]},"audio/vnd.digital-winds":{source:"iana",extensions:["eol"]},"audio/vnd.dlna.adts":{source:"iana"},"audio/vnd.dolby.heaac.1":{source:"iana"},"audio/vnd.dolby.heaac.2":{source:"iana"},"audio/vnd.dolby.mlp":{source:"iana"},"audio/vnd.dolby.mps":{source:"iana"},"audio/vnd.dolby.pl2":{source:"iana"},"audio/vnd.dolby.pl2x":{source:"iana"},"audio/vnd.dolby.pl2z":{source:"iana"},"audio/vnd.dolby.pulse.1":{source:"iana"},"audio/vnd.dra":{source:"iana",extensions:["dra"]},"audio/vnd.dts":{source:"iana",extensions:["dts"]},"audio/vnd.dts.hd":{source:"iana",extensions:["dtshd"]},"audio/vnd.dts.uhd":{source:"iana"},"audio/vnd.dvb.file":{source:"iana"},"audio/vnd.everad.plj":{source:"iana"},"audio/vnd.hns.audio":{source:"iana"},"audio/vnd.lucent.voice":{source:"iana",extensions:["lvp"]},"audio/vnd.ms-playready.media.pya":{source:"iana",extensions:["pya"]},"audio/vnd.nokia.mobile-xmf":{source:"iana"},"audio/vnd.nortel.vbk":{source:"iana"},"audio/vnd.nuera.ecelp4800":{source:"iana",extensions:["ecelp4800"]},"audio/vnd.nuera.ecelp7470":{source:"iana",extensions:["ecelp7470"]},"audio/vnd.nuera.ecelp9600":{source:"iana",extensions:["ecelp9600"]},"audio/vnd.octel.sbc":{source:"iana"},"audio/vnd.presonus.multitrack":{source:"iana"},"audio/vnd.qcelp":{source:"iana"},"audio/vnd.rhetorex.32kadpcm":{source:"iana"},"audio/vnd.rip":{source:"iana",extensions:["rip"]},"audio/vnd.rn-realaudio":{compressible:!1},"audio/vnd.sealedmedia.softseal.mpeg":{source:"iana"},"audio/vnd.vmx.cvsd":{source:"iana"},"audio/vnd.wave":{compressible:!1},"audio/vorbis":{source:"iana",compressible:!1},"audio/vorbis-config":{source:"iana"},"audio/wav":{compressible:!1,extensions:["wav"]},"audio/wave":{compressible:!1,extensions:["wav"]},"audio/webm":{source:"apache",compressible:!1,extensions:["weba"]},"audio/x-aac":{source:"apache",compressible:!1,extensions:["aac"]},"audio/x-aiff":{source:"apache",extensions:["aif","aiff","aifc"]},"audio/x-caf":{source:"apache",compressible:!1,extensions:["caf"]},"audio/x-flac":{source:"apache",extensions:["flac"]},"audio/x-m4a":{source:"nginx",extensions:["m4a"]},"audio/x-matroska":{source:"apache",extensions:["mka"]},"audio/x-mpegurl":{source:"apache",extensions:["m3u"]},"audio/x-ms-wax":{source:"apache",extensions:["wax"]},"audio/x-ms-wma":{source:"apache",extensions:["wma"]},"audio/x-pn-realaudio":{source:"apache",extensions:["ram","ra"]},"audio/x-pn-realaudio-plugin":{source:"apache",extensions:["rmp"]},"audio/x-realaudio":{source:"nginx",extensions:["ra"]},"audio/x-tta":{source:"apache"},"audio/x-wav":{source:"apache",extensions:["wav"]},"audio/xm":{source:"apache",extensions:["xm"]},"chemical/x-cdx":{source:"apache",extensions:["cdx"]},"chemical/x-cif":{source:"apache",extensions:["cif"]},"chemical/x-cmdf":{source:"apache",extensions:["cmdf"]},"chemical/x-cml":{source:"apache",extensions:["cml"]},"chemical/x-csml":{source:"apache",extensions:["csml"]},"chemical/x-pdb":{source:"apache"},"chemical/x-xyz":{source:"apache",extensions:["xyz"]},"font/collection":{source:"iana",extensions:["ttc"]},"font/otf":{source:"iana",compressible:!0,extensions:["otf"]},"font/sfnt":{source:"iana"},"font/ttf":{source:"iana",compressible:!0,extensions:["ttf"]},"font/woff":{source:"iana",extensions:["woff"]},"font/woff2":{source:"iana",extensions:["woff2"]},"image/aces":{source:"iana",extensions:["exr"]},"image/apng":{compressible:!1,extensions:["apng"]},"image/avci":{source:"iana",extensions:["avci"]},"image/avcs":{source:"iana",extensions:["avcs"]},"image/avif":{source:"iana",compressible:!1,extensions:["avif"]},"image/bmp":{source:"iana",compressible:!0,extensions:["bmp"]},"image/cgm":{source:"iana",extensions:["cgm"]},"image/dicom-rle":{source:"iana",extensions:["drle"]},"image/emf":{source:"iana",extensions:["emf"]},"image/fits":{source:"iana",extensions:["fits"]},"image/g3fax":{source:"iana",extensions:["g3"]},"image/gif":{source:"iana",compressible:!1,extensions:["gif"]},"image/heic":{source:"iana",extensions:["heic"]},"image/heic-sequence":{source:"iana",extensions:["heics"]},"image/heif":{source:"iana",extensions:["heif"]},"image/heif-sequence":{source:"iana",extensions:["heifs"]},"image/hej2k":{source:"iana",extensions:["hej2"]},"image/hsj2":{source:"iana",extensions:["hsj2"]},"image/ief":{source:"iana",extensions:["ief"]},"image/jls":{source:"iana",extensions:["jls"]},"image/jp2":{source:"iana",compressible:!1,extensions:["jp2","jpg2"]},"image/jpeg":{source:"iana",compressible:!1,extensions:["jpeg","jpg","jpe"]},"image/jph":{source:"iana",extensions:["jph"]},"image/jphc":{source:"iana",extensions:["jhc"]},"image/jpm":{source:"iana",compressible:!1,extensions:["jpm"]},"image/jpx":{source:"iana",compressible:!1,extensions:["jpx","jpf"]},"image/jxr":{source:"iana",extensions:["jxr"]},"image/jxra":{source:"iana",extensions:["jxra"]},"image/jxrs":{source:"iana",extensions:["jxrs"]},"image/jxs":{source:"iana",extensions:["jxs"]},"image/jxsc":{source:"iana",extensions:["jxsc"]},"image/jxsi":{source:"iana",extensions:["jxsi"]},"image/jxss":{source:"iana",extensions:["jxss"]},"image/ktx":{source:"iana",extensions:["ktx"]},"image/ktx2":{source:"iana",extensions:["ktx2"]},"image/naplps":{source:"iana"},"image/pjpeg":{compressible:!1},"image/png":{source:"iana",compressible:!1,extensions:["png"]},"image/prs.btif":{source:"iana",extensions:["btif"]},"image/prs.pti":{source:"iana",extensions:["pti"]},"image/pwg-raster":{source:"iana"},"image/sgi":{source:"apache",extensions:["sgi"]},"image/svg+xml":{source:"iana",compressible:!0,extensions:["svg","svgz"]},"image/t38":{source:"iana",extensions:["t38"]},"image/tiff":{source:"iana",compressible:!1,extensions:["tif","tiff"]},"image/tiff-fx":{source:"iana",extensions:["tfx"]},"image/vnd.adobe.photoshop":{source:"iana",compressible:!0,extensions:["psd"]},"image/vnd.airzip.accelerator.azv":{source:"iana",extensions:["azv"]},"image/vnd.cns.inf2":{source:"iana"},"image/vnd.dece.graphic":{source:"iana",extensions:["uvi","uvvi","uvg","uvvg"]},"image/vnd.djvu":{source:"iana",extensions:["djvu","djv"]},"image/vnd.dvb.subtitle":{source:"iana",extensions:["sub"]},"image/vnd.dwg":{source:"iana",extensions:["dwg"]},"image/vnd.dxf":{source:"iana",extensions:["dxf"]},"image/vnd.fastbidsheet":{source:"iana",extensions:["fbs"]},"image/vnd.fpx":{source:"iana",extensions:["fpx"]},"image/vnd.fst":{source:"iana",extensions:["fst"]},"image/vnd.fujixerox.edmics-mmr":{source:"iana",extensions:["mmr"]},"image/vnd.fujixerox.edmics-rlc":{source:"iana",extensions:["rlc"]},"image/vnd.globalgraphics.pgb":{source:"iana"},"image/vnd.microsoft.icon":{source:"iana",compressible:!0,extensions:["ico"]},"image/vnd.mix":{source:"iana"},"image/vnd.mozilla.apng":{source:"iana"},"image/vnd.ms-dds":{compressible:!0,extensions:["dds"]},"image/vnd.ms-modi":{source:"iana",extensions:["mdi"]},"image/vnd.ms-photo":{source:"apache",extensions:["wdp"]},"image/vnd.net-fpx":{source:"iana",extensions:["npx"]},"image/vnd.pco.b16":{source:"iana",extensions:["b16"]},"image/vnd.radiance":{source:"iana"},"image/vnd.sealed.png":{source:"iana"},"image/vnd.sealedmedia.softseal.gif":{source:"iana"},"image/vnd.sealedmedia.softseal.jpg":{source:"iana"},"image/vnd.svf":{source:"iana"},"image/vnd.tencent.tap":{source:"iana",extensions:["tap"]},"image/vnd.valve.source.texture":{source:"iana",extensions:["vtf"]},"image/vnd.wap.wbmp":{source:"iana",extensions:["wbmp"]},"image/vnd.xiff":{source:"iana",extensions:["xif"]},"image/vnd.zbrush.pcx":{source:"iana",extensions:["pcx"]},"image/webp":{source:"apache",extensions:["webp"]},"image/wmf":{source:"iana",extensions:["wmf"]},"image/x-3ds":{source:"apache",extensions:["3ds"]},"image/x-cmu-raster":{source:"apache",extensions:["ras"]},"image/x-cmx":{source:"apache",extensions:["cmx"]},"image/x-freehand":{source:"apache",extensions:["fh","fhc","fh4","fh5","fh7"]},"image/x-icon":{source:"apache",compressible:!0,extensions:["ico"]},"image/x-jng":{source:"nginx",extensions:["jng"]},"image/x-mrsid-image":{source:"apache",extensions:["sid"]},"image/x-ms-bmp":{source:"nginx",compressible:!0,extensions:["bmp"]},"image/x-pcx":{source:"apache",extensions:["pcx"]},"image/x-pict":{source:"apache",extensions:["pic","pct"]},"image/x-portable-anymap":{source:"apache",extensions:["pnm"]},"image/x-portable-bitmap":{source:"apache",extensions:["pbm"]},"image/x-portable-graymap":{source:"apache",extensions:["pgm"]},"image/x-portable-pixmap":{source:"apache",extensions:["ppm"]},"image/x-rgb":{source:"apache",extensions:["rgb"]},"image/x-tga":{source:"apache",extensions:["tga"]},"image/x-xbitmap":{source:"apache",extensions:["xbm"]},"image/x-xcf":{compressible:!1},"image/x-xpixmap":{source:"apache",extensions:["xpm"]},"image/x-xwindowdump":{source:"apache",extensions:["xwd"]},"message/cpim":{source:"iana"},"message/delivery-status":{source:"iana"},"message/disposition-notification":{source:"iana",extensions:["disposition-notification"]},"message/external-body":{source:"iana"},"message/feedback-report":{source:"iana"},"message/global":{source:"iana",extensions:["u8msg"]},"message/global-delivery-status":{source:"iana",extensions:["u8dsn"]},"message/global-disposition-notification":{source:"iana",extensions:["u8mdn"]},"message/global-headers":{source:"iana",extensions:["u8hdr"]},"message/http":{source:"iana",compressible:!1},"message/imdn+xml":{source:"iana",compressible:!0},"message/news":{source:"iana"},"message/partial":{source:"iana",compressible:!1},"message/rfc822":{source:"iana",compressible:!0,extensions:["eml","mime"]},"message/s-http":{source:"iana"},"message/sip":{source:"iana"},"message/sipfrag":{source:"iana"},"message/tracking-status":{source:"iana"},"message/vnd.si.simp":{source:"iana"},"message/vnd.wfa.wsc":{source:"iana",extensions:["wsc"]},"model/3mf":{source:"iana",extensions:["3mf"]},"model/e57":{source:"iana"},"model/gltf+json":{source:"iana",compressible:!0,extensions:["gltf"]},"model/gltf-binary":{source:"iana",compressible:!0,extensions:["glb"]},"model/iges":{source:"iana",compressible:!1,extensions:["igs","iges"]},"model/mesh":{source:"iana",compressible:!1,extensions:["msh","mesh","silo"]},"model/mtl":{source:"iana",extensions:["mtl"]},"model/obj":{source:"iana",extensions:["obj"]},"model/step":{source:"iana"},"model/step+xml":{source:"iana",compressible:!0,extensions:["stpx"]},"model/step+zip":{source:"iana",compressible:!1,extensions:["stpz"]},"model/step-xml+zip":{source:"iana",compressible:!1,extensions:["stpxz"]},"model/stl":{source:"iana",extensions:["stl"]},"model/vnd.collada+xml":{source:"iana",compressible:!0,extensions:["dae"]},"model/vnd.dwf":{source:"iana",extensions:["dwf"]},"model/vnd.flatland.3dml":{source:"iana"},"model/vnd.gdl":{source:"iana",extensions:["gdl"]},"model/vnd.gs-gdl":{source:"apache"},"model/vnd.gs.gdl":{source:"iana"},"model/vnd.gtw":{source:"iana",extensions:["gtw"]},"model/vnd.moml+xml":{source:"iana",compressible:!0},"model/vnd.mts":{source:"iana",extensions:["mts"]},"model/vnd.opengex":{source:"iana",extensions:["ogex"]},"model/vnd.parasolid.transmit.binary":{source:"iana",extensions:["x_b"]},"model/vnd.parasolid.transmit.text":{source:"iana",extensions:["x_t"]},"model/vnd.pytha.pyox":{source:"iana"},"model/vnd.rosette.annotated-data-model":{source:"iana"},"model/vnd.sap.vds":{source:"iana",extensions:["vds"]},"model/vnd.usdz+zip":{source:"iana",compressible:!1,extensions:["usdz"]},"model/vnd.valve.source.compiled-map":{source:"iana",extensions:["bsp"]},"model/vnd.vtu":{source:"iana",extensions:["vtu"]},"model/vrml":{source:"iana",compressible:!1,extensions:["wrl","vrml"]},"model/x3d+binary":{source:"apache",compressible:!1,extensions:["x3db","x3dbz"]},"model/x3d+fastinfoset":{source:"iana",extensions:["x3db"]},"model/x3d+vrml":{source:"apache",compressible:!1,extensions:["x3dv","x3dvz"]},"model/x3d+xml":{source:"iana",compressible:!0,extensions:["x3d","x3dz"]},"model/x3d-vrml":{source:"iana",extensions:["x3dv"]},"multipart/alternative":{source:"iana",compressible:!1},"multipart/appledouble":{source:"iana"},"multipart/byteranges":{source:"iana"},"multipart/digest":{source:"iana"},"multipart/encrypted":{source:"iana",compressible:!1},"multipart/form-data":{source:"iana",compressible:!1},"multipart/header-set":{source:"iana"},"multipart/mixed":{source:"iana"},"multipart/multilingual":{source:"iana"},"multipart/parallel":{source:"iana"},"multipart/related":{source:"iana",compressible:!1},"multipart/report":{source:"iana"},"multipart/signed":{source:"iana",compressible:!1},"multipart/vnd.bint.med-plus":{source:"iana"},"multipart/voice-message":{source:"iana"},"multipart/x-mixed-replace":{source:"iana"},"text/1d-interleaved-parityfec":{source:"iana"},"text/cache-manifest":{source:"iana",compressible:!0,extensions:["appcache","manifest"]},"text/calendar":{source:"iana",extensions:["ics","ifb"]},"text/calender":{compressible:!0},"text/cmd":{compressible:!0},"text/coffeescript":{extensions:["coffee","litcoffee"]},"text/cql":{source:"iana"},"text/cql-expression":{source:"iana"},"text/cql-identifier":{source:"iana"},"text/css":{source:"iana",charset:"UTF-8",compressible:!0,extensions:["css"]},"text/csv":{source:"iana",compressible:!0,extensions:["csv"]},"text/csv-schema":{source:"iana"},"text/directory":{source:"iana"},"text/dns":{source:"iana"},"text/ecmascript":{source:"iana"},"text/encaprtp":{source:"iana"},"text/enriched":{source:"iana"},"text/fhirpath":{source:"iana"},"text/flexfec":{source:"iana"},"text/fwdred":{source:"iana"},"text/gff3":{source:"iana"},"text/grammar-ref-list":{source:"iana"},"text/html":{source:"iana",compressible:!0,extensions:["html","htm","shtml"]},"text/jade":{extensions:["jade"]},"text/javascript":{source:"iana",compressible:!0},"text/jcr-cnd":{source:"iana"},"text/jsx":{compressible:!0,extensions:["jsx"]},"text/less":{compressible:!0,extensions:["less"]},"text/markdown":{source:"iana",compressible:!0,extensions:["markdown","md"]},"text/mathml":{source:"nginx",extensions:["mml"]},"text/mdx":{compressible:!0,extensions:["mdx"]},"text/mizar":{source:"iana"},"text/n3":{source:"iana",charset:"UTF-8",compressible:!0,extensions:["n3"]},"text/parameters":{source:"iana",charset:"UTF-8"},"text/parityfec":{source:"iana"},"text/plain":{source:"iana",compressible:!0,extensions:["txt","text","conf","def","list","log","in","ini"]},"text/provenance-notation":{source:"iana",charset:"UTF-8"},"text/prs.fallenstein.rst":{source:"iana"},"text/prs.lines.tag":{source:"iana",extensions:["dsc"]},"text/prs.prop.logic":{source:"iana"},"text/raptorfec":{source:"iana"},"text/red":{source:"iana"},"text/rfc822-headers":{source:"iana"},"text/richtext":{source:"iana",compressible:!0,extensions:["rtx"]},"text/rtf":{source:"iana",compressible:!0,extensions:["rtf"]},"text/rtp-enc-aescm128":{source:"iana"},"text/rtploopback":{source:"iana"},"text/rtx":{source:"iana"},"text/sgml":{source:"iana",extensions:["sgml","sgm"]},"text/shaclc":{source:"iana"},"text/shex":{source:"iana",extensions:["shex"]},"text/slim":{extensions:["slim","slm"]},"text/spdx":{source:"iana",extensions:["spdx"]},"text/strings":{source:"iana"},"text/stylus":{extensions:["stylus","styl"]},"text/t140":{source:"iana"},"text/tab-separated-values":{source:"iana",compressible:!0,extensions:["tsv"]},"text/troff":{source:"iana",extensions:["t","tr","roff","man","me","ms"]},"text/turtle":{source:"iana",charset:"UTF-8",extensions:["ttl"]},"text/ulpfec":{source:"iana"},"text/uri-list":{source:"iana",compressible:!0,extensions:["uri","uris","urls"]},"text/vcard":{source:"iana",compressible:!0,extensions:["vcard"]},"text/vnd.a":{source:"iana"},"text/vnd.abc":{source:"iana"},"text/vnd.ascii-art":{source:"iana"},"text/vnd.curl":{source:"iana",extensions:["curl"]},"text/vnd.curl.dcurl":{source:"apache",extensions:["dcurl"]},"text/vnd.curl.mcurl":{source:"apache",extensions:["mcurl"]},"text/vnd.curl.scurl":{source:"apache",extensions:["scurl"]},"text/vnd.debian.copyright":{source:"iana",charset:"UTF-8"},"text/vnd.dmclientscript":{source:"iana"},"text/vnd.dvb.subtitle":{source:"iana",extensions:["sub"]},"text/vnd.esmertec.theme-descriptor":{source:"iana",charset:"UTF-8"},"text/vnd.familysearch.gedcom":{source:"iana",extensions:["ged"]},"text/vnd.ficlab.flt":{source:"iana"},"text/vnd.fly":{source:"iana",extensions:["fly"]},"text/vnd.fmi.flexstor":{source:"iana",extensions:["flx"]},"text/vnd.gml":{source:"iana"},"text/vnd.graphviz":{source:"iana",extensions:["gv"]},"text/vnd.hans":{source:"iana"},"text/vnd.hgl":{source:"iana"},"text/vnd.in3d.3dml":{source:"iana",extensions:["3dml"]},"text/vnd.in3d.spot":{source:"iana",extensions:["spot"]},"text/vnd.iptc.newsml":{source:"iana"},"text/vnd.iptc.nitf":{source:"iana"},"text/vnd.latex-z":{source:"iana"},"text/vnd.motorola.reflex":{source:"iana"},"text/vnd.ms-mediapackage":{source:"iana"},"text/vnd.net2phone.commcenter.command":{source:"iana"},"text/vnd.radisys.msml-basic-layout":{source:"iana"},"text/vnd.senx.warpscript":{source:"iana"},"text/vnd.si.uricatalogue":{source:"iana"},"text/vnd.sosi":{source:"iana"},"text/vnd.sun.j2me.app-descriptor":{source:"iana",charset:"UTF-8",extensions:["jad"]},"text/vnd.trolltech.linguist":{source:"iana",charset:"UTF-8"},"text/vnd.wap.si":{source:"iana"},"text/vnd.wap.sl":{source:"iana"},"text/vnd.wap.wml":{source:"iana",extensions:["wml"]},"text/vnd.wap.wmlscript":{source:"iana",extensions:["wmls"]},"text/vtt":{source:"iana",charset:"UTF-8",compressible:!0,extensions:["vtt"]},"text/x-asm":{source:"apache",extensions:["s","asm"]},"text/x-c":{source:"apache",extensions:["c","cc","cxx","cpp","h","hh","dic"]},"text/x-component":{source:"nginx",extensions:["htc"]},"text/x-fortran":{source:"apache",extensions:["f","for","f77","f90"]},"text/x-gwt-rpc":{compressible:!0},"text/x-handlebars-template":{extensions:["hbs"]},"text/x-java-source":{source:"apache",extensions:["java"]},"text/x-jquery-tmpl":{compressible:!0},"text/x-lua":{extensions:["lua"]},"text/x-markdown":{compressible:!0,extensions:["mkd"]},"text/x-nfo":{source:"apache",extensions:["nfo"]},"text/x-opml":{source:"apache",extensions:["opml"]},"text/x-org":{compressible:!0,extensions:["org"]},"text/x-pascal":{source:"apache",extensions:["p","pas"]},"text/x-processing":{compressible:!0,extensions:["pde"]},"text/x-sass":{extensions:["sass"]},"text/x-scss":{extensions:["scss"]},"text/x-setext":{source:"apache",extensions:["etx"]},"text/x-sfv":{source:"apache",extensions:["sfv"]},"text/x-suse-ymp":{compressible:!0,extensions:["ymp"]},"text/x-uuencode":{source:"apache",extensions:["uu"]},"text/x-vcalendar":{source:"apache",extensions:["vcs"]},"text/x-vcard":{source:"apache",extensions:["vcf"]},"text/xml":{source:"iana",compressible:!0,extensions:["xml"]},"text/xml-external-parsed-entity":{source:"iana"},"text/yaml":{compressible:!0,extensions:["yaml","yml"]},"video/1d-interleaved-parityfec":{source:"iana"},"video/3gpp":{source:"iana",extensions:["3gp","3gpp"]},"video/3gpp-tt":{source:"iana"},"video/3gpp2":{source:"iana",extensions:["3g2"]},"video/av1":{source:"iana"},"video/bmpeg":{source:"iana"},"video/bt656":{source:"iana"},"video/celb":{source:"iana"},"video/dv":{source:"iana"},"video/encaprtp":{source:"iana"},"video/ffv1":{source:"iana"},"video/flexfec":{source:"iana"},"video/h261":{source:"iana",extensions:["h261"]},"video/h263":{source:"iana",extensions:["h263"]},"video/h263-1998":{source:"iana"},"video/h263-2000":{source:"iana"},"video/h264":{source:"iana",extensions:["h264"]},"video/h264-rcdo":{source:"iana"},"video/h264-svc":{source:"iana"},"video/h265":{source:"iana"},"video/iso.segment":{source:"iana",extensions:["m4s"]},"video/jpeg":{source:"iana",extensions:["jpgv"]},"video/jpeg2000":{source:"iana"},"video/jpm":{source:"apache",extensions:["jpm","jpgm"]},"video/jxsv":{source:"iana"},"video/mj2":{source:"iana",extensions:["mj2","mjp2"]},"video/mp1s":{source:"iana"},"video/mp2p":{source:"iana"},"video/mp2t":{source:"iana",extensions:["ts"]},"video/mp4":{source:"iana",compressible:!1,extensions:["mp4","mp4v","mpg4"]},"video/mp4v-es":{source:"iana"},"video/mpeg":{source:"iana",compressible:!1,extensions:["mpeg","mpg","mpe","m1v","m2v"]},"video/mpeg4-generic":{source:"iana"},"video/mpv":{source:"iana"},"video/nv":{source:"iana"},"video/ogg":{source:"iana",compressible:!1,extensions:["ogv"]},"video/parityfec":{source:"iana"},"video/pointer":{source:"iana"},"video/quicktime":{source:"iana",compressible:!1,extensions:["qt","mov"]},"video/raptorfec":{source:"iana"},"video/raw":{source:"iana"},"video/rtp-enc-aescm128":{source:"iana"},"video/rtploopback":{source:"iana"},"video/rtx":{source:"iana"},"video/scip":{source:"iana"},"video/smpte291":{source:"iana"},"video/smpte292m":{source:"iana"},"video/ulpfec":{source:"iana"},"video/vc1":{source:"iana"},"video/vc2":{source:"iana"},"video/vnd.cctv":{source:"iana"},"video/vnd.dece.hd":{source:"iana",extensions:["uvh","uvvh"]},"video/vnd.dece.mobile":{source:"iana",extensions:["uvm","uvvm"]},"video/vnd.dece.mp4":{source:"iana"},"video/vnd.dece.pd":{source:"iana",extensions:["uvp","uvvp"]},"video/vnd.dece.sd":{source:"iana",extensions:["uvs","uvvs"]},"video/vnd.dece.video":{source:"iana",extensions:["uvv","uvvv"]},"video/vnd.directv.mpeg":{source:"iana"},"video/vnd.directv.mpeg-tts":{source:"iana"},"video/vnd.dlna.mpeg-tts":{source:"iana"},"video/vnd.dvb.file":{source:"iana",extensions:["dvb"]},"video/vnd.fvt":{source:"iana",extensions:["fvt"]},"video/vnd.hns.video":{source:"iana"},"video/vnd.iptvforum.1dparityfec-1010":{source:"iana"},"video/vnd.iptvforum.1dparityfec-2005":{source:"iana"},"video/vnd.iptvforum.2dparityfec-1010":{source:"iana"},"video/vnd.iptvforum.2dparityfec-2005":{source:"iana"},"video/vnd.iptvforum.ttsavc":{source:"iana"},"video/vnd.iptvforum.ttsmpeg2":{source:"iana"},"video/vnd.motorola.video":{source:"iana"},"video/vnd.motorola.videop":{source:"iana"},"video/vnd.mpegurl":{source:"iana",extensions:["mxu","m4u"]},"video/vnd.ms-playready.media.pyv":{source:"iana",extensions:["pyv"]},"video/vnd.nokia.interleaved-multimedia":{source:"iana"},"video/vnd.nokia.mp4vr":{source:"iana"},"video/vnd.nokia.videovoip":{source:"iana"},"video/vnd.objectvideo":{source:"iana"},"video/vnd.radgamettools.bink":{source:"iana"},"video/vnd.radgamettools.smacker":{source:"iana"},"video/vnd.sealed.mpeg1":{source:"iana"},"video/vnd.sealed.mpeg4":{source:"iana"},"video/vnd.sealed.swf":{source:"iana"},"video/vnd.sealedmedia.softseal.mov":{source:"iana"},"video/vnd.uvvu.mp4":{source:"iana",extensions:["uvu","uvvu"]},"video/vnd.vivo":{source:"iana",extensions:["viv"]},"video/vnd.youtube.yt":{source:"iana"},"video/vp8":{source:"iana"},"video/vp9":{source:"iana"},"video/webm":{source:"apache",compressible:!1,extensions:["webm"]},"video/x-f4v":{source:"apache",extensions:["f4v"]},"video/x-fli":{source:"apache",extensions:["fli"]},"video/x-flv":{source:"apache",compressible:!1,extensions:["flv"]},"video/x-m4v":{source:"apache",extensions:["m4v"]},"video/x-matroska":{source:"apache",compressible:!1,extensions:["mkv","mk3d","mks"]},"video/x-mng":{source:"apache",extensions:["mng"]},"video/x-ms-asf":{source:"apache",extensions:["asf","asx"]},"video/x-ms-vob":{source:"apache",extensions:["vob"]},"video/x-ms-wm":{source:"apache",extensions:["wm"]},"video/x-ms-wmv":{source:"apache",compressible:!1,extensions:["wmv"]},"video/x-ms-wmx":{source:"apache",extensions:["wmx"]},"video/x-ms-wvx":{source:"apache",extensions:["wvx"]},"video/x-msvideo":{source:"apache",extensions:["avi"]},"video/x-sgi-movie":{source:"apache",extensions:["movie"]},"video/x-smv":{source:"apache",extensions:["smv"]},"x-conference/x-cooltalk":{source:"apache",extensions:["ice"]},"x-shader/x-fragment":{compressible:!0},"x-shader/x-vertex":{compressible:!0}},mimeDb=require$$0;
/*!
 * mime-types
 * Copyright(c) 2014 Jonathan Ong
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */
!function(e){var t,a,n,i=mimeDb,o=path$2.extname,r=/^\s*([^;\s]*)(?:;|\s|$)/,s=/^text\//i;function c(e){if(!e||"string"!=typeof e)return!1;var t=r.exec(e),a=t&&i[t[1].toLowerCase()];return a&&a.charset?a.charset:!(!t||!s.test(t[1]))&&"UTF-8"}e.charset=c,e.charsets={lookup:c},e.contentType=function(t){if(!t||"string"!=typeof t)return!1;var a=-1===t.indexOf("/")?e.lookup(t):t;if(!a)return!1;if(-1===a.indexOf("charset")){var n=e.charset(a);n&&(a+="; charset="+n.toLowerCase())}return a},e.extension=function(t){if(!t||"string"!=typeof t)return!1;var a=r.exec(t),n=a&&e.extensions[a[1].toLowerCase()];if(!n||!n.length)return!1;return n[0]},e.extensions=Object.create(null),e.lookup=function(t){if(!t||"string"!=typeof t)return!1;var a=o("x."+t).toLowerCase().substr(1);if(!a)return!1;return e.types[a]||!1},e.types=Object.create(null),t=e.extensions,a=e.types,n=["nginx","apache",void 0,"iana"],Object.keys(i).forEach((function(e){var o=i[e],r=o.extensions;if(r&&r.length){t[e]=r;for(var s=0;s<r.length;s++){var c=r[s];if(a[c]){var l=n.indexOf(i[a[c]].source),p=n.indexOf(o.source);if("application/octet-stream"!==a[c]&&(l>p||l===p&&"application/"===a[c].substr(0,12)))continue}a[c]=e}}}))}(mimeTypes);var defer_1=defer$1;function defer$1(e){var t="function"==typeof setImmediate?setImmediate:"object"==typeof process&&"function"==typeof process.nextTick?process.nextTick:null;t?t(e):setTimeout(e,0)}var defer=defer_1,async_1=async$2;function async$2(e){var t=!1;return defer((function(){t=!0})),function(a,n){t?e(a,n):defer((function(){e(a,n)}))}}var abort_1=abort$2;function abort$2(e){Object.keys(e.jobs).forEach(clean.bind(e)),e.jobs={}}function clean(e){"function"==typeof this.jobs[e]&&this.jobs[e]()}var async$1=async_1,abort$1=abort_1,iterate_1=iterate$2;function iterate$2(e,t,a,n){var i=a.keyedList?a.keyedList[a.index]:a.index;a.jobs[i]=runJob(t,i,e[i],(function(e,t){i in a.jobs&&(delete a.jobs[i],e?abort$1(a):a.results[i]=t,n(e,a.results))}))}function runJob(e,t,a,n){return 2==e.length?e(a,async$1(n)):e(a,t,async$1(n))}var state_1=state;function state(e,t){var a=!Array.isArray(e),n={index:0,keyedList:a||t?Object.keys(e):null,jobs:{},results:a?{}:[],size:a?Object.keys(e).length:e.length};return t&&n.keyedList.sort(a?t:function(a,n){return t(e[a],e[n])}),n}var abort=abort_1,async=async_1,terminator_1=terminator$2;function terminator$2(e){Object.keys(this.jobs).length&&(this.index=this.size,abort(this),async(e)(null,this.results))}var iterate$1=iterate_1,initState$1=state_1,terminator$1=terminator_1,parallel_1=parallel;function parallel(e,t,a){for(var n=initState$1(e);n.index<(n.keyedList||e).length;)iterate$1(e,t,n,(function(e,t){e?a(e,t):0!==Object.keys(n.jobs).length||a(null,n.results)})),n.index++;return terminator$1.bind(n,a)}var serialOrdered$2={exports:{}},iterate=iterate_1,initState=state_1,terminator=terminator_1;function serialOrdered$1(e,t,a,n){var i=initState(e,a);return iterate(e,t,i,(function a(o,r){o?n(o,r):(i.index++,i.index<(i.keyedList||e).length?iterate(e,t,i,a):n(null,i.results))})),terminator.bind(i,n)}function ascending(e,t){return e<t?-1:e>t?1:0}function descending(e,t){return-1*ascending(e,t)}serialOrdered$2.exports=serialOrdered$1,serialOrdered$2.exports.ascending=ascending,serialOrdered$2.exports.descending=descending;var serialOrderedExports=serialOrdered$2.exports,serialOrdered=serialOrderedExports,serial_1=serial;function serial(e,t,a){return serialOrdered(e,t,null,a)}var asynckit$1={parallel:parallel_1,serial:serial_1,serialOrdered:serialOrderedExports},populate$1=function(e,t){return Object.keys(t).forEach((function(a){e[a]=e[a]||t[a]})),e},CombinedStream=combined_stream,util=require$$1,path=path$2,http=require$$3$1,https=require$$4$1,parseUrl=require$$5.parse,fs=fs$2,Stream=require$$0$1.Stream,mime=mimeTypes,asynckit=asynckit$1,populate=populate$1,form_data=FormData$1;function FormData$1(e){if(!(this instanceof FormData$1))return new FormData$1(e);for(var t in this._overheadLength=0,this._valueLength=0,this._valuesToMeasure=[],CombinedStream.call(this),e=e||{})this[t]=e[t]}util.inherits(FormData$1,CombinedStream),FormData$1.LINE_BREAK="\r\n",FormData$1.DEFAULT_CONTENT_TYPE="application/octet-stream",FormData$1.prototype.append=function(e,t,a){"string"==typeof(a=a||{})&&(a={filename:a});var n=CombinedStream.prototype.append.bind(this);if("number"==typeof t&&(t=""+t),util.isArray(t))this._error(new Error("Arrays are not supported."));else{var i=this._multiPartHeader(e,t,a),o=this._multiPartFooter();n(i),n(t),n(o),this._trackLength(i,t,a)}},FormData$1.prototype._trackLength=function(e,t,a){var n=0;null!=a.knownLength?n+=+a.knownLength:Buffer.isBuffer(t)?n=t.length:"string"==typeof t&&(n=Buffer.byteLength(t)),this._valueLength+=n,this._overheadLength+=Buffer.byteLength(e)+FormData$1.LINE_BREAK.length,t&&(t.path||t.readable&&t.hasOwnProperty("httpVersion")||t instanceof Stream)&&(a.knownLength||this._valuesToMeasure.push(t))},FormData$1.prototype._lengthRetriever=function(e,t){e.hasOwnProperty("fd")?null!=e.end&&e.end!=1/0&&null!=e.start?t(null,e.end+1-(e.start?e.start:0)):fs.stat(e.path,(function(a,n){var i;a?t(a):(i=n.size-(e.start?e.start:0),t(null,i))})):e.hasOwnProperty("httpVersion")?t(null,+e.headers["content-length"]):e.hasOwnProperty("httpModule")?(e.on("response",(function(a){e.pause(),t(null,+a.headers["content-length"])})),e.resume()):t("Unknown stream")},FormData$1.prototype._multiPartHeader=function(e,t,a){if("string"==typeof a.header)return a.header;var n,i=this._getContentDisposition(t,a),o=this._getContentType(t,a),r="",s={"Content-Disposition":["form-data",'name="'+e+'"'].concat(i||[]),"Content-Type":[].concat(o||[])};for(var c in"object"==typeof a.header&&populate(s,a.header),s)s.hasOwnProperty(c)&&null!=(n=s[c])&&(Array.isArray(n)||(n=[n]),n.length&&(r+=c+": "+n.join("; ")+FormData$1.LINE_BREAK));return"--"+this.getBoundary()+FormData$1.LINE_BREAK+r+FormData$1.LINE_BREAK},FormData$1.prototype._getContentDisposition=function(e,t){var a,n;return"string"==typeof t.filepath?a=path.normalize(t.filepath).replace(/\\/g,"/"):t.filename||e.name||e.path?a=path.basename(t.filename||e.name||e.path):e.readable&&e.hasOwnProperty("httpVersion")&&(a=path.basename(e.client._httpMessage.path||"")),a&&(n='filename="'+a+'"'),n},FormData$1.prototype._getContentType=function(e,t){var a=t.contentType;return!a&&e.name&&(a=mime.lookup(e.name)),!a&&e.path&&(a=mime.lookup(e.path)),!a&&e.readable&&e.hasOwnProperty("httpVersion")&&(a=e.headers["content-type"]),a||!t.filepath&&!t.filename||(a=mime.lookup(t.filepath||t.filename)),a||"object"!=typeof e||(a=FormData$1.DEFAULT_CONTENT_TYPE),a},FormData$1.prototype._multiPartFooter=function(){return function(e){var t=FormData$1.LINE_BREAK;0===this._streams.length&&(t+=this._lastBoundary()),e(t)}.bind(this)},FormData$1.prototype._lastBoundary=function(){return"--"+this.getBoundary()+"--"+FormData$1.LINE_BREAK},FormData$1.prototype.getHeaders=function(e){var t,a={"content-type":"multipart/form-data; boundary="+this.getBoundary()};for(t in e)e.hasOwnProperty(t)&&(a[t.toLowerCase()]=e[t]);return a},FormData$1.prototype.setBoundary=function(e){this._boundary=e},FormData$1.prototype.getBoundary=function(){return this._boundary||this._generateBoundary(),this._boundary},FormData$1.prototype.getBuffer=function(){for(var e=new Buffer.alloc(0),t=this.getBoundary(),a=0,n=this._streams.length;a<n;a++)"function"!=typeof this._streams[a]&&(e=Buffer.isBuffer(this._streams[a])?Buffer.concat([e,this._streams[a]]):Buffer.concat([e,Buffer.from(this._streams[a])]),"string"==typeof this._streams[a]&&this._streams[a].substring(2,t.length+2)===t||(e=Buffer.concat([e,Buffer.from(FormData$1.LINE_BREAK)])));return Buffer.concat([e,Buffer.from(this._lastBoundary())])},FormData$1.prototype._generateBoundary=function(){for(var e="--------------------------",t=0;t<24;t++)e+=Math.floor(10*Math.random()).toString(16);this._boundary=e},FormData$1.prototype.getLengthSync=function(){var e=this._overheadLength+this._valueLength;return this._streams.length&&(e+=this._lastBoundary().length),this.hasKnownLength()||this._error(new Error("Cannot calculate proper length in synchronous way.")),e},FormData$1.prototype.hasKnownLength=function(){var e=!0;return this._valuesToMeasure.length&&(e=!1),e},FormData$1.prototype.getLength=function(e){var t=this._overheadLength+this._valueLength;this._streams.length&&(t+=this._lastBoundary().length),this._valuesToMeasure.length?asynckit.parallel(this._valuesToMeasure,this._lengthRetriever,(function(a,n){a?e(a):(n.forEach((function(e){t+=e})),e(null,t))})):process.nextTick(e.bind(this,null,t))},FormData$1.prototype.submit=function(e,t){var a,n,i={method:"post"};return"string"==typeof e?(e=parseUrl(e),n=populate({port:e.port,path:e.pathname,host:e.hostname,protocol:e.protocol},i)):(n=populate(e,i)).port||(n.port="https:"==n.protocol?443:80),n.headers=this.getHeaders(e.headers),a="https:"==n.protocol?https.request(n):http.request(n),this.getLength(function(e,n){if(e&&"Unknown stream"!==e)this._error(e);else if(n&&a.setHeader("Content-Length",n),this.pipe(a),t){var i,o=function(e,n){return a.removeListener("error",o),a.removeListener("response",i),t.call(this,e,n)};i=o.bind(this,null),a.on("error",o),a.on("response",i)}}.bind(this)),a},FormData$1.prototype._error=function(e){this.error||(this.error=e,this.pause(),this.emit("error",e))},FormData$1.prototype.toString=function(){return"[object FormData]"};var FormData$2=getDefaultExportFromCjs(form_data);const axios=createAxiosInstance(),DEFAULT_MISTRAL_BASE_URL="https://api.mistral.ai/v1",DEFAULT_MISTRAL_MODEL="mistral-ocr-latest";function uploadDocumentToMistral({apiKey:e,filePath:t,baseURL:a=DEFAULT_MISTRAL_BASE_URL,fileName:n=""}){return __awaiter(this,void 0,void 0,(function*(){const i=new FormData$2;i.append("purpose","ocr");const o=n||path__namespace.basename(t),r=fs__namespace.createReadStream(t);return i.append("file",r,{filename:o}),axios.post(`${a}/files`,i,{headers:Object.assign({Authorization:`Bearer ${e}`},i.getHeaders()),maxBodyLength:1/0,maxContentLength:1/0}).then((e=>e.data)).catch((e=>{throw e}))}))}function getSignedUrl({apiKey:e,fileId:t,expiry:a=24,baseURL:n=DEFAULT_MISTRAL_BASE_URL}){return __awaiter(this,void 0,void 0,(function*(){return axios.get(`${n}/files/${t}/url?expiry=${a}`,{headers:{Authorization:`Bearer ${e}`}}).then((e=>e.data)).catch((e=>{throw dataSchemas.logger.error("Error fetching signed URL:",e.message),e}))}))}function performOCR({url:e,apiKey:t,model:a=DEFAULT_MISTRAL_MODEL,baseURL:n=DEFAULT_MISTRAL_BASE_URL,documentType:i="document_url"}){return __awaiter(this,void 0,void 0,(function*(){const o="image_url"===i?"image_url":"document_url";return axios.post(`${n}/ocr`,{model:a,image_limit:0,include_image_base64:!1,document:{type:i,[o]:e}},{headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`}}).then((e=>e.data)).catch((e=>{throw dataSchemas.logger.error("Error performing OCR:",e.message),e}))}))}function needsEnvLoad(e){return librechatDataProvider.envVarRegex.test(e)||!e.trim()}function getEnvVarName(e,t){return librechatDataProvider.envVarRegex.test(e)&&librechatDataProvider.extractVariableName(e)||t}function resolveConfigValue(e,t,a,n){return __awaiter(this,void 0,void 0,(function*(){if(!needsEnvLoad(e))return e;const i=getEnvVarName(e,t);return a[i]||n||""}))}function loadAuthConfig(e){var t,a;return __awaiter(this,void 0,void 0,(function*(){const n=null===(t=e.req.app.locals)||void 0===t?void 0:t.ocr,i=(null==n?void 0:n.apiKey)||"",o=(null==n?void 0:n.baseURL)||"";if(!needsEnvLoad(i)&&!needsEnvLoad(o))return{apiKey:i,baseURL:o};const r=[];needsEnvLoad(o)&&r.push(getEnvVarName(o,"OCR_BASEURL")),needsEnvLoad(i)&&r.push(getEnvVarName(i,"OCR_API_KEY"));const s=yield e.loadAuthValues({userId:(null===(a=e.req.user)||void 0===a?void 0:a.id)||"",authFields:r,optional:new Set(["OCR_BASEURL"])});return{apiKey:yield resolveConfigValue(i,"OCR_API_KEY",s),baseURL:yield resolveConfigValue(o,"OCR_BASEURL",s,DEFAULT_MISTRAL_BASE_URL)}}))}function getModelConfig(e){const t=(null==e?void 0:e.mistralModel)||"";return t.trim()?librechatDataProvider.envVarRegex.test(t)?librechatDataProvider.extractEnvVariable(t)||DEFAULT_MISTRAL_MODEL:t.trim():DEFAULT_MISTRAL_MODEL}function getDocumentType(e){const t=(e.mimetype||"").toLowerCase(),a=e.originalname||"";return t.startsWith("image")||/\.(png|jpe?g|gif|bmp|webp|tiff?)$/i.test(a)?"image_url":"document_url"}function processOCRResult(e){let t="";const a=[];return e.pages.forEach(((n,i)=>{e.pages.length>1&&(t+=`# PAGE ${i+1}\n`),t+=n.markdown+"\n\n",n.images&&0!==n.images.length&&n.images.forEach((e=>{e.image_base64&&a.push(e.image_base64)}))})),{text:t,images:a}}function createOCRError(e,t){var a,n,i,o;const r=e,s=(null===(n=null===(a=null==r?void 0:r.response)||void 0===a?void 0:a.data)||void 0===n?void 0:n.detail)||t,c=null===(o=null===(i=null==r?void 0:r.response)||void 0===i?void 0:i.data)||void 0===o?void 0:o.message,l=logAxiosError({error:r,message:s});return new Error(c?`${l} - ${c}`:l)}const uploadMistralOCR=e=>__awaiter(void 0,void 0,void 0,(function*(){var t;try{const{apiKey:a,baseURL:n}=yield loadAuthConfig(e),i=getModelConfig(null===(t=e.req.app.locals)||void 0===t?void 0:t.ocr),o=yield uploadDocumentToMistral({filePath:e.file.path,fileName:e.file.originalname,apiKey:a,baseURL:n}),r=yield getSignedUrl({apiKey:a,baseURL:n,fileId:o.id}),s=getDocumentType(e.file),c=yield performOCR({apiKey:a,baseURL:n,model:i,url:r.url,documentType:s});if(!c||!c.pages||0===c.pages.length)throw new Error("No OCR result returned from service, may be down or the file is not supported.");const{text:l,images:p}=processOCRResult(c);return{filename:e.file.originalname,bytes:4*l.length,filepath:librechatDataProvider.FileSources.mistral_ocr,text:l,images:p}}catch(e){throw createOCRError(e,"Error uploading document to Mistral OCR API:")}})),uploadAzureMistralOCR=e=>__awaiter(void 0,void 0,void 0,(function*(){var t;try{const{apiKey:a,baseURL:n}=yield loadAuthConfig(e),i=getModelConfig(null===(t=e.req.app.locals)||void 0===t?void 0:t.ocr),o=fs__namespace.readFileSync(e.file.path).toString("base64"),r=`data:${e.file.mimetype||"image/jpeg"};base64,`,s=getDocumentType(e.file),c=yield performOCR({apiKey:a,baseURL:n,model:i,url:`${r}${o}`,documentType:s});if(!c||!c.pages||0===c.pages.length)throw new Error("No OCR result returned from service, may be down or the file is not supported.");const{text:l,images:p}=processOCRResult(c);return{filename:e.file.originalname,bytes:4*l.length,filepath:librechatDataProvider.FileSources.azure_mistral_ocr,text:l,images:p}}catch(e){throw createOCRError(e,"Error uploading document to Azure Mistral OCR API:")}}));function loadGoogleAuthConfig(){return __awaiter(this,void 0,void 0,(function*(){const e=process.env.GOOGLE_SERVICE_KEY_FILE_PATH||path__namespace.join(__dirname,"..","..","..","api","data","auth.json"),t=path__namespace.isAbsolute(e)?e:path__namespace.resolve(e);let a;try{const e=fs__namespace.readFileSync(t,"utf8");a=JSON.parse(e)}catch(e){throw new Error(`Google service account not found at ${t}`)}if(!a.client_email||!a.private_key||!a.project_id)throw new Error("Invalid Google service account configuration");const n=yield createJWT(a);return{serviceAccount:a,accessToken:yield exchangeJWTForAccessToken(n)}}))}function createJWT(e){return __awaiter(this,void 0,void 0,(function*(){const t=yield import("crypto"),a=Math.floor(Date.now()/1e3),n={iss:e.client_email,scope:"https://www.googleapis.com/auth/cloud-platform",aud:"https://oauth2.googleapis.com/token",exp:a+3600,iat:a},i=`${Buffer.from(JSON.stringify({alg:"RS256",typ:"JWT"})).toString("base64url")}.${Buffer.from(JSON.stringify(n)).toString("base64url")}`,o=t.createSign("RSA-SHA256");o.update(i),o.end();return`${i}.${o.sign(e.private_key,"base64url")}`}))}function exchangeJWTForAccessToken(e){var t;return __awaiter(this,void 0,void 0,(function*(){const a=yield axios.post("https://oauth2.googleapis.com/token",new URLSearchParams({grant_type:"urn:ietf:params:oauth:grant-type:jwt-bearer",assertion:e}),{headers:{"Content-Type":"application/x-www-form-urlencoded"}});if(!(null===(t=a.data)||void 0===t?void 0:t.access_token))throw new Error("No access token in response");return a.data.access_token}))}function performGoogleVertexOCR({url:e,accessToken:t,projectId:a,model:n,documentType:i="document_url"}){return __awaiter(this,void 0,void 0,(function*(){const o=process.env.GOOGLE_LOC||"us-central1",r=n||"mistral-ocr-2505";let s;s="global"===o?`https://aiplatform.googleapis.com/v1/projects/${a}/locations/global/publishers/mistralai/models/${r}:rawPredict`:`https://${o}-aiplatform.googleapis.com/v1/projects/${a}/locations/${o}/publishers/mistralai/models/${r}:rawPredict`;const c="image_url"===i?"image_url":"document_url",l={model:r,document:{type:i,[c]:e},include_image_base64:!0};return dataSchemas.logger.debug("Sending request to Google Vertex AI:",{url:s,body:Object.assign(Object.assign({},l),{document:Object.assign(Object.assign({},l.document),{[c]:"base64_data_hidden"})})}),axios.post(s,l,{headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`,Accept:"application/json"}}).then((e=>(dataSchemas.logger.debug("Google Vertex AI response received"),e.data))).catch((e=>{var t;throw(null===(t=e.response)||void 0===t?void 0:t.data)&&dataSchemas.logger.error("Vertex AI error response: "+JSON.stringify(e.response.data,null,2)),new Error(logAxiosError({error:e,message:"Error calling Google Vertex AI Mistral OCR"}))}))}))}const uploadGoogleVertexMistralOCR=e=>__awaiter(void 0,void 0,void 0,(function*(){var t;try{const{serviceAccount:a,accessToken:n}=yield loadGoogleAuthConfig(),i=getModelConfig(null===(t=e.req.app.locals)||void 0===t?void 0:t.ocr),o=fs__namespace.readFileSync(e.file.path).toString("base64"),r=`data:${e.file.mimetype||"application/pdf"};base64,`,s=getDocumentType(e.file),c=yield performGoogleVertexOCR({url:`${r}${o}`,accessToken:n,projectId:a.project_id,model:i,documentType:s});if(!c||!c.pages||0===c.pages.length)throw new Error("No OCR result returned from service, may be down or the file is not supported.");const{text:l,images:p}=processOCRResult(c);return{filename:e.file.originalname,bytes:4*l.length,filepath:librechatDataProvider.FileSources.vertexai_mistral_ocr,text:l,images:p}}catch(e){throw createOCRError(e,"Error uploading document to Google Vertex AI Mistral OCR:")}}));exports.BasicToolEndHandler=BasicToolEndHandler,exports.DEFAULT_RETENTION_HOURS=DEFAULT_RETENTION_HOURS,exports.FlowStateManager=FlowStateManager,exports.MAX_RETENTION_HOURS=MAX_RETENTION_HOURS,exports.MCPManager=MCPManager,exports.MCPOAuthHandler=MCPOAuthHandler,exports.MCPTokenStorage=MCPTokenStorage,exports.MIN_RETENTION_HOURS=MIN_RETENTION_HOURS,exports.Tokenizer=TokenizerSingleton,exports.agentsConfigSetup=agentsConfigSetup,exports.checkAccess=checkAccess,exports.constructAzureURL=constructAzureURL,exports.createAxiosInstance=createAxiosInstance,exports.createFetch=createFetch,exports.createHandleLLMNewToken=createHandleLLMNewToken,exports.createHandleOAuthToken=createHandleOAuthToken,exports.createMemoryCallback=createMemoryCallback,exports.createMemoryProcessor=createMemoryProcessor,exports.createRun=createRun,exports.createStreamEventHandlers=createStreamEventHandlers,exports.createTempChatExpirationDate=createTempChatExpirationDate,exports.decrypt=decrypt,exports.decryptV2=decryptV2,exports.decryptV3=decryptV3,exports.encrypt=encrypt,exports.encryptV2=encryptV2,exports.encryptV3=encryptV3,exports.extractLibreChatParams=extractLibreChatParams,exports.genAzureChatCompletion=genAzureChatCompletion,exports.genAzureEndpoint=genAzureEndpoint,exports.generateCheckAccess=generateCheckAccess,exports.getAccessToken=getAccessToken,exports.getAzureCredentials=getAzureCredentials,exports.getGoogleConfig=getGoogleConfig,exports.getOpenAIConfig=getOpenAIConfig,exports.getRandomValues=getRandomValues$2,exports.getSafetySettings=getSafetySettings,exports.getSignedUrl=getSignedUrl,exports.getTempChatRetentionHours=getTempChatRetentionHours,exports.getUserMCPAuthMap=getUserMCPAuthMap,exports.handleError=handleError,exports.hashBackupCode=hashBackupCode,exports.initializeOpenAI=initializeOpenAI,exports.isEnabled=isEnabled,exports.isUserProvided=isUserProvided,exports.loadYaml=loadYaml,exports.logAxiosError=logAxiosError,exports.logHeaders=logHeaders,exports.math=math,exports.mcpToolPattern=mcpToolPattern,exports.memoryInstructions=memoryInstructions,exports.normalizeServerName=normalizeServerName,exports.optionalChainWithEmptyCheck=optionalChainWithEmptyCheck,exports.performOCR=performOCR,exports.primeResources=primeResources,exports.processMCPEnv=processMCPEnv,exports.processMemory=processMemory,exports.refreshAccessToken=refreshAccessToken,exports.resolveHeaders=resolveHeaders,exports.safeStringify=safeStringify,exports.sanitizeFilename=sanitizeFilename,exports.sanitizeModelName=sanitizeModelName,exports.sendEvent=sendEvent,exports.skipAgentCheck=skipAgentCheck,exports.uploadAzureMistralOCR=uploadAzureMistralOCR,exports.uploadDocumentToMistral=uploadDocumentToMistral,exports.uploadGoogleVertexMistralOCR=uploadGoogleVertexMistralOCR,exports.uploadMistralOCR=uploadMistralOCR;
//# sourceMappingURL=index.js.map
